<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>線上學習系統</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* ==================== 全域樣式 ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary-color: #2563eb;
      --secondary-color: #3b82f6;
      --success-color: #10b981;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --info-color: #06b6d4;
      --dark-color: #1f2937;
      --light-color: #f3f4f6;
      --border-color: #e5e7eb;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--text-primary);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* ==================== 登入頁面 ==================== */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .login-box {
      background: white;
      border-radius: 20px;
      box-shadow: var(--shadow-lg);
      padding: 50px;
      width: 100%;
      max-width: 450px;
      animation: fadeInUp 0.5s ease;
    }
    
    .login-header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .login-header i {
      font-size: 60px;
      color: var(--primary-color);
      margin-bottom: 20px;
    }
    
    .login-header h1 {
      font-size: 28px;
      color: var(--text-primary);
      margin-bottom: 10px;
    }
    
    .login-header p {
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-weight: 500;
      font-size: 14px;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .btn {
      display: inline-block;
      padding: 12px 30px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      text-decoration: none;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-secondary {
      background: var(--text-secondary);
      color: white;
    }
    
    .btn-success {
      background: var(--success-color);
      color: white;
    }
    
    .btn-danger {
      background: var(--danger-color);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning-color);
      color: white;
    }
    
    .btn-sm {
      padding: 8px 16px;
      font-size: 12px;
    }
    
    /* ==================== 主應用程式介面 ==================== */
    .app-container {
      display: none;
      min-height: 100vh;
      background: var(--light-color);
    }
    
    .app-container.active {
      display: block;
    }
    
    /* 頂部導航列 */
    .navbar {
      background: white;
      box-shadow: var(--shadow);
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .navbar-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .navbar-brand i {
      font-size: 28px;
    }
    
    .navbar-menu {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    .navbar-item {
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      color: var(--text-primary);
      font-size: 14px;
    }
    
    .navbar-item:hover {
      background: var(--light-color);
      color: var(--primary-color);
    }
    
    .navbar-item.active {
      background: var(--primary-color);
      color: white;
    }
    
    .navbar-user {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 8px 16px;
      background: var(--light-color);
      border-radius: 10px;
    }
    
    .navbar-user-info {
      text-align: right;
    }
    
    .navbar-user-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }
    
    .navbar-user-dept {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .navbar-user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }
    
    .btn-logout {
      background: var(--danger-color);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .btn-logout:hover {
      background: #dc2626;
    }
    
    /* 主內容區 */
    .main-content {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
    }
    
    .page-section {
      display: none;
    }
    
    .page-section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    /* ==================== 儀錶板 ==================== */
    .dashboard-header {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }
    
    .dashboard-welcome {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
    }
    
    .dashboard-subtitle {
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: all 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: white;
    }
    
    .stat-icon.blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-icon.green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .stat-icon.orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .stat-icon.red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    
    .stat-info {
      flex: 1;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    /* 公告區塊 */
    .announcements-section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-title i {
      color: var(--primary-color);
    }
    
    .announcement-item {
      padding: 15px;
      border-left: 4px solid var(--primary-color);
      background: var(--light-color);
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .announcement-item.pinned {
      border-left-color: var(--danger-color);
      background: #fef2f2;
    }
    
    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .announcement-time {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .announcement-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      background: var(--danger-color);
      color: white;
    }
    
    .announcement-content {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.6;
    }
    
    /* 課程列表 */
    .course-filters {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    
    .filter-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .filter-group select,
    .filter-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
    }
    
    .courses-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
    }
    
    .course-card {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .course-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .course-card-header {
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .course-card-header.required {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .course-card-header.completed {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .course-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.3);
      margin-bottom: 10px;
    }
    
    .course-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .course-id {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .course-card-body {
      padding: 20px;
    }
    
    .course-desc {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 15px;
      line-height: 1.6;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .course-meta {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      font-size: 13px;
    }
    
    .course-meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--text-secondary);
    }
    
    .course-meta-item i {
      color: var(--primary-color);
    }
    
    .course-deadline {
      padding: 10px;
      background: var(--light-color);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 15px;
    }
    
    .course-deadline.warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .course-deadline.danger {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .course-actions {
      display: flex;
      gap: 10px;
    }
    
    .course-actions .btn {
      flex: 1;
    }
    
    /* ==================== 課程播放器 ==================== */
    .player-container {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    
    .player-header {
      padding: 25px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .player-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .player-meta {
      display: flex;
      gap: 20px;
      font-size: 14px;
      opacity: 0.9;
    }
    
    .player-body {
      padding: 30px;
    }
    
    .video-wrapper {
      position: relative;
      padding-bottom: 56.25%; /* 16:9 */
      height: 0;
      overflow: hidden;
      background: #000;
      border-radius: 10px;
      margin-bottom: 30px;
    }
    
    .video-wrapper iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .progress-bar {
      background: var(--light-color);
      border-radius: 10px;
      height: 30px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }
    
    .course-description {
      background: var(--light-color);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .course-description h3 {
      font-size: 16px;
      margin-bottom: 10px;
      color: var(--text-primary);
    }
    
    .course-description p {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    /* ==================== 測驗頁面 ==================== */
    .exam-container {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: var(--shadow);
      max-width: 800px;
      margin: 0 auto;
    }
    
    .exam-header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
    }
    
    .exam-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
    }
    
    .exam-info {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .question-card {
      background: var(--light-color);
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 25px;
    }
    
    .question-number {
      display: inline-block;
      background: var(--primary-color);
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .question-text {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .options-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .option-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .option-item:hover {
      border-color: var(--primary-color);
      background: #eff6ff;
    }
    
    .option-item input[type="radio"] {
      margin-right: 12px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .option-item label {
      flex: 1;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-primary);
    }
    
    .option-item.correct {
      border-color: var(--success-color);
      background: #f0fdf4;
    }
    
    .option-item.incorrect {
      border-color: var(--danger-color);
      background: #fef2f2;
    }
    
    .exam-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }
    
    /* 測驗結果 */
    .exam-result {
      text-align: center;
      padding: 40px;
    }
    
    .result-icon {
      font-size: 80px;
      margin-bottom: 20px;
    }
    
    .result-icon.pass {
      color: var(--success-color);
    }
    
    .result-icon.fail {
      color: var(--danger-color);
    }
    
    .result-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .result-score {
      font-size: 48px;
      font-weight: 700;
      color: var(--primary-color);
      margin: 20px 0;
    }
    
    .result-details {
      background: var(--light-color);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }
    
    .result-detail-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .result-detail-item:last-child {
      border-bottom: none;
    }
    
    /* ==================== 管理後台 ==================== */
    .admin-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      background: white;
      padding: 10px;
      border-radius: 15px;
      box-shadow: var(--shadow);
    }
    
    .admin-tab {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: transparent;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.3s;
    }
    
    .admin-tab:hover {
      background: var(--light-color);
    }
    
    .admin-tab.active {
      background: var(--primary-color);
      color: white;
    }
    
    .admin-panel {
      display: none;
    }
    
    .admin-panel.active {
      display: block;
    }
    
    .admin-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }
    
    .admin-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
    }
    
    .admin-card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    /* 表格 */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .data-table thead {
      background: var(--light-color);
    }
    
    .data-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
    }
    
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-secondary);
    }
    
    .data-table tbody tr:hover {
      background: var(--light-color);
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .status-badge.active {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-badge.inactive {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .status-badge.pass {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-badge.fail {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .btn-icon {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }
    
    .btn-icon i {
      pointer-events: none;
    }
    
    /* ==================== Modal ==================== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }
    
    .modal-close:hover {
      background: var(--light-color);
      color: var(--text-primary);
    }
    
    .modal-body {
      margin-bottom: 20px;
    }
    
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
        /* ==================== Loading & Alert ==================== */
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 99999;
      justify-content: center;
      align-items: center;
    }
    
    .loading.active {
      display: flex;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: var(--shadow-lg);
      z-index: 10000;
      display: none;
      animation: slideInRight 0.3s ease;
      max-width: 400px;
    }
    
    .alert.active {
      display: block;
    }
    
    .alert-success {
      background: var(--success-color);
      color: white;
    }
    
    .alert-error {
      background: var(--danger-color);
      color: white;
    }
    
    .alert-warning {
      background: var(--warning-color);
      color: white;
    }
    
    .alert-info {
      background: var(--info-color);
      color: white;
    }
    
    /* ==================== Animations ==================== */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
      }
      to {
        transform: translateX(0);
      }
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    /* ==================== Responsive ==================== */
    @media (max-width: 768px) {
      .navbar-menu {
        display: none;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .courses-grid {
        grid-template-columns: 1fr;
      }
      
      .filter-row {
        flex-direction: column;
      }
      
      .filter-group {
        width: 100%;
      }
      
      .admin-tabs {
        flex-direction: column;
      }
      
      .data-table {
        font-size: 12px;
      }
      
      .data-table th,
      .data-table td {
        padding: 8px;
      }
    }
    
    /* ==================== Utility Classes ==================== */
    .hidden {
      display: none !important;
    }
    
    .text-center {
      text-align: center;
    }
    
    .text-right {
      text-align: right;
    }
    
    .mt-10 { margin-top: 10px; }
    .mt-20 { margin-top: 20px; }
    .mt-30 { margin-top: 30px; }
    
    .mb-10 { margin-bottom: 10px; }
    .mb-20 { margin-bottom: 20px; }
    .mb-30 { margin-bottom: 30px; }
    
    .p-10 { padding: 10px; }
    .p-20 { padding: 20px; }
    .p-30 { padding: 30px; }
  </style>
</head>
<body>

  <!-- Loading 動畫 -->
  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
  </div>

  <!-- Alert 通知 -->
  <div id="alert" class="alert"></div>

  <!-- ==================== 登入頁面 ==================== -->
  <div id="loginPage" class="login-container">
    <div class="login-box">
      <div class="login-header">
        <i class="fas fa-graduation-cap"></i>
        <h1>線上學習系統</h1>
        <p>請使用您的工號和密碼登入</p>
      </div>
      
      <form id="loginForm">
        <div class="form-group">
          <label for="empId">
            <i class="fas fa-user"></i> 工號
          </label>
          <input type="text" id="empId" placeholder="請輸入工號" required>
        </div>
        
        <div class="form-group">
          <label for="password">
            <i class="fas fa-lock"></i> 密碼
          </label>
          <input type="password" id="password" placeholder="請輸入密碼" required>
        </div>
        
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-sign-in-alt"></i> 登入
        </button>
      </form>
    </div>
  </div>

  <!-- ==================== 主應用程式 ==================== -->
  <div id="appContainer" class="app-container">
    
    <!-- 頂部導航列 -->
    <nav class="navbar">
      <div class="navbar-content">
        <div class="navbar-brand">
          <i class="fas fa-graduation-cap"></i>
          <span>線上學習系統</span>
        </div>
        
        <div class="navbar-menu">
          <div class="navbar-item active" data-page="dashboard">
            <i class="fas fa-home"></i> 首頁
          </div>
          <div class="navbar-item" data-page="courses">
            <i class="fas fa-book"></i> 課程
          </div>
          <div class="navbar-item" data-page="mylearning">
            <i class="fas fa-chart-line"></i> 我的學習
          </div>
          <div class="navbar-item admin-only hidden" data-page="admin">
            <i class="fas fa-cog"></i> 管理後台
          </div>
        </div>
        
        <div class="navbar-user">
          <div class="navbar-user-info">
            <div class="navbar-user-name" id="userName">使用者</div>
            <div class="navbar-user-dept" id="userDept">部門</div>
          </div>
          <div class="navbar-user-avatar" id="userAvatar">U</div>
          <button class="btn-logout" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> 登出
          </button>
        </div>
      </div>
    </nav>

    <!-- 主內容區 -->
    <div class="main-content">
      
      <!-- ==================== 儀錶板頁面 ==================== -->
      <div id="dashboardPage" class="page-section active">
        <div class="dashboard-header">
          <h1 class="dashboard-welcome">歡迎回來,<span id="welcomeName"></span>!</h1>
          <p class="dashboard-subtitle">繼續您的學習旅程</p>
        </div>
        
        <!-- 統計卡片 -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon blue">
              <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">累積點數</div>
              <div class="stat-value" id="totalPoints">0</div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon green">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">已完成課程</div>
              <div class="stat-value" id="completedCount">0</div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon orange">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">進行中課程</div>
              <div class="stat-value" id="inProgressCount">0</div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon red">
              <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">待完成必修</div>
              <div class="stat-value" id="requiredCount">0</div>
            </div>
          </div>
        </div>
        
        <!-- 公告區塊 -->
        <div class="announcements-section">
          <h2 class="section-title">
            <i class="fas fa-bullhorn"></i>
            最新公告
          </h2>
          <div id="announcementsList"></div>
        </div>
        
        <!-- 待完成必修課程 -->
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">
              <i class="fas fa-exclamation-triangle"></i> 待完成必修課程
            </h3>
          </div>
          <div id="requiredCoursesList"></div>
        </div>
        
        <!-- 進行中的課程 -->
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">
              <i class="fas fa-play-circle"></i> 進行中的課程
            </h3>
          </div>
          <div id="inProgressCoursesList"></div>
        </div>
      </div>

      <!-- ==================== 課程瀏覽頁面 ==================== -->
      <div id="coursesPage" class="page-section">
        <!-- 篩選器 -->
        <div class="course-filters">
          <div class="filter-row">
            <div class="filter-group">
              <label>課群</label>
              <select id="filterCourseGroup">
                <option value="">全部</option>
                <option value="A">A - 新人訓練</option>
                <option value="B">B - 專業技能</option>
                <option value="C">C - 管理課程</option>
                <option value="D">D - 法規遵循</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>課門</label>
              <select id="filterCourseCategory">
                <option value="">全部</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>課程類型</label>
              <select id="filterCourseType">
                <option value="">全部</option>
                <option value="required">必修</option>
                <option value="optional">選修</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>狀態</label>
              <select id="filterStatus">
                <option value="">全部</option>
                <option value="notStarted">未開始</option>
                <option value="inProgress">進行中</option>
                <option value="completed">已完成</option>
              </select>
            </div>
            
            <div class="filter-group" style="display: flex; align-items: flex-end;">
              <button class="btn btn-primary" onclick="applyCourseFilters()">
                <i class="fas fa-search"></i> 搜尋
              </button>
            </div>
          </div>
        </div>
        
        <!-- 課程列表 -->
        <div id="coursesList" class="courses-grid"></div>
      </div>

      <!-- ==================== 課程播放頁面 ==================== -->
      <div id="playerPage" class="page-section">
        <div class="player-container">
          <div class="player-header">
            <h1 class="player-title" id="playerCourseTitle">課程名稱</h1>
            <div class="player-meta">
              <span><i class="fas fa-tag"></i> <span id="playerCourseId"></span></span>
              <span><i class="fas fa-star"></i> <span id="playerCoursePoints"></span> 點</span>
              <span><i class="fas fa-calendar"></i> 截止日期: <span id="playerDeadline"></span></span>
            </div>
          </div>
          
          <div class="player-body">
            <!-- 影片播放器 -->
            <div class="video-wrapper" id="videoWrapper">
              <iframe id="videoPlayer" 
                      src="" 
                      frameborder="0" 
                      allow="autoplay; encrypted-media" 
                      allowfullscreen>
              </iframe>
            </div>
            
            <!-- 進度條 -->
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width: 0%">
                0%
              </div>
            </div>
            
            <!-- 課程說明 -->
            <div class="course-description">
              <h3><i class="fas fa-info-circle"></i> 課程說明</h3>
              <p id="playerCourseDesc"></p>
            </div>
            
            <!-- 操作按鈕 -->
            <div class="course-actions">
              <button class="btn btn-secondary" onclick="backToCourses()">
                <i class="fas fa-arrow-left"></i> 返回課程列表
              </button>
              <button class="btn btn-success" id="btnStartExam" onclick="startExam()" disabled>
                <i class="fas fa-pencil-alt"></i> 開始測驗
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== 測驗頁面 ==================== -->
      <div id="examPage" class="page-section">
        <div class="exam-container">
          <div class="exam-header">
            <h1 class="exam-title" id="examCourseTitle">課程測驗</h1>
            <p class="exam-info">
              請仔細閱讀每個題目,選擇正確答案。及格分數: <strong id="examPassScore">60</strong> 分
            </p>
          </div>
          
          <div id="examQuestions"></div>
          
          <div class="exam-actions">
            <button class="btn btn-secondary" onclick="backToPlayer()">
              <i class="fas fa-arrow-left"></i> 返回課程
            </button>
            <button class="btn btn-primary" onclick="submitExam()">
              <i class="fas fa-check"></i> 提交測驗
            </button>
          </div>
        </div>
      </div>

      <!-- ==================== 我的學習頁面 ==================== -->
      <div id="mylearningPage" class="page-section">
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">
              <i class="fas fa-history"></i> 學習紀錄
            </h3>
          </div>
          
          <table class="data-table">
            <thead>
              <tr>
                <th>課程名稱</th>
                <th>開始時間</th>
                <th>完成時間</th>
                <th>測驗分數</th>
                <th>獲得點數</th>
                <th>狀態</th>
              </tr>
            </thead>
            <tbody id="myLearningRecords">
              <tr>
                <td colspan="6" class="text-center">載入中...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">
              <i class="fas fa-coins"></i> 點數紀錄
            </h3>
          </div>
          
          <table class="data-table">
            <thead>
              <tr>
                <th>課程名稱</th>
                <th>獲得點數</th>
                <th>獲得時間</th>
              </tr>
            </thead>
            <tbody id="myPointRecords">
              <tr>
                <td colspan="3" class="text-center">載入中...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ==================== 管理後台頁面 ==================== -->
      <div id="adminPage" class="page-section">
        <!-- 管理標籤 -->
        <div class="admin-tabs">
          <button class="admin-tab active" data-tab="courses">
            <i class="fas fa-book"></i> 課程管理
          </button>
          <button class="admin-tab" data-tab="questions">
            <i class="fas fa-question-circle"></i> 題目管理
          </button>
          <button class="admin-tab" data-tab="accounts">
            <i class="fas fa-users"></i> 帳號管理
          </button>
          <button class="admin-tab" data-tab="records">
            <i class="fas fa-chart-bar"></i> 學習紀錄
          </button>
          <button class="admin-tab" data-tab="announcements">
            <i class="fas fa-bullhorn"></i> 公告管理
          </button>
          <button class="admin-tab" data-tab="settings">
            <i class="fas fa-cog"></i> 系統設定
          </button>
        </div>

        <!-- 課程管理面板 -->
        <div id="adminCoursesPanel" class="admin-panel active">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">課程列表</h3>
              <button class="btn btn-primary btn-sm" onclick="showAddCourseModal()">
                <i class="fas fa-plus"></i> 新增課程
              </button>
            </div>
            
            <table class="data-table">
              <thead>
                <tr>
                  <th>課程ID</th>
                  <th>課程名稱</th>
                  <th>課群</th>
                  <th>課門</th>
                  <th>點數</th>
                  <th>截止日期</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="adminCoursesList">
                <tr>
                  <td colspan="8" class="text-center">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 題目管理面板 -->
        <div id="adminQuestionsPanel" class="admin-panel">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">題目列表</h3>
              <div>
                <select id="adminQuestionCourseFilter" onchange="loadAdminQuestions()">
                  <option value="">選擇課程</option>
                </select>
                <button class="btn btn-primary btn-sm" onclick="showAddQuestionModal()">
                  <i class="fas fa-plus"></i> 新增題目
                </button>
              </div>
            </div>
            
            <table class="data-table">
              <thead>
                <tr>
                  <th>題目ID</th>
                  <th>題目內容</th>
                  <th>正確答案</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="adminQuestionsList">
                <tr>
                  <td colspan="4" class="text-center">請選擇課程</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 帳號管理面板 -->
        <div id="adminAccountsPanel" class="admin-panel">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">帳號列表</h3>
              <button class="btn btn-primary btn-sm" onclick="showAddAccountModal()">
                <i class="fas fa-plus"></i> 新增帳號
              </button>
            </div>
            
            <table class="data-table">
              <thead>
                <tr>
                  <th>工號</th>
                  <th>姓名</th>
                  <th>部門</th>
                  <th>Email</th>
                  <th>權限</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="adminAccountsList">
                <tr>
                  <td colspan="6" class="text-center">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 學習紀錄面板 -->
        <div id="adminRecordsPanel" class="admin-panel">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">學習紀錄</h3>
              <button class="btn btn-success btn-sm" onclick="exportRecords()">
                <i class="fas fa-download"></i> 匯出報表
              </button>
            </div>
            
            <table class="data-table">
              <thead>
                <tr>
                  <th>工號</th>
                  <th>姓名</th>
                  <th>課程名稱</th>
                  <th>開始時間</th>
                  <th>完成時間</th>
                  <th>測驗分數</th>
                  <th>獲得點數</th>
                </tr>
              </thead>
              <tbody id="adminRecordsList">
                <tr>
                  <td colspan="7" class="text-center">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 公告管理面板 -->
        <div id="adminAnnouncementsPanel" class="admin-panel">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">公告列表</h3>
              <button class="btn btn-primary btn-sm" onclick="showAddAnnouncementModal()">
                <i class="fas fa-plus"></i> 新增公告
              </button>
            </div>
            
            <table class="data-table">
              <thead>
                <tr>
                  <th>時間</th>
                  <th>公告內容</th>
                  <th>發布對象</th>
                  <th>是否置頂</th>
                  <th>有效期限</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="adminAnnouncementsList">
                <tr>
                  <td colspan="6" class="text-center">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 系統設定面板 -->
        <div id="adminSettingsPanel" class="admin-panel">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">系統設定</h3>
            </div>
            
            <form id="systemSettingsForm">
              <div class="form-group">
                <label>測驗題數</label>
                <input type="number" id="settingQuestionCount" min="1" max="20" value="5">
              </div>
              
              <div class="form-group">
                <label>測驗及格分數</label>
                <input type="number" id="settingPassScore" min="0" max="100" value="60">
              </div>
              
              <div class="form-group">
                <label>截止日提醒天數</label>
                <input type="number" id="settingReminderDays" min="1" max="30" value="5">
              </div>
              
              <div class="form-group">
                <label>Session 有效時間(分鐘)</label>
                <input type="number" id="settingSessionTimeout" min="30" max="1440" value="480">
              </div>
              
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> 儲存設定
              </button>
            </form>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ==================== Modals ==================== -->
  
  <!-- 新增/編輯課程 Modal -->
  <div id="courseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="courseModalTitle">新增課程</h3>
        <button class="modal-close" onclick="closeCourseModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="courseForm">
          <input type="hidden" id="courseFormId">
          
          <div class="form-group">
            <label>課群 *</label>
            <select id="courseFormGroup" required>
              <option value="">請選擇</option>
              <option value="A">A - 新人訓練</option>
              <option value="B">B - 專業技能</option>
              <option value="C">C - 管理課程</option>
              <option value="D">D - 法規遵循</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>課門 *</label>
            <input type="text" id="courseFormCategory" placeholder="例如: 資訊安全" required>
          </div>
          
          <div class="form-group">
            <label>課程名稱 *</label>
            <input type="text" id="courseFormName" placeholder="例如: 資訊安全基礎訓練" required>
          </div>
          
          <div class="form-group">
            <label>課程說明</label>
            <textarea id="courseFormDesc" rows="3" placeholder="課程說明"></textarea>
          </div>
          
          <div class="form-group">
            <label>影片連結(Google Drive) *</label>
            <input type="url" id="courseFormVideo" placeholder="https://drive.google.com/..." required>
          </div>
          
          <div class="form-group">
            <label>必修對象(部門,逗號分隔)</label>
            <input type="text" id="courseFormRequired" placeholder="例如: IT,HR,Finance">
          </div>
          
          <div class="form-group">
            <label>選修對象(部門,逗號分隔)</label>
            <input type="text" id="courseFormOptional" placeholder="例如: Sales,Marketing">
          </div>
          
          <div class="form-group">
            <label>開始時間 *</label>
            <input type="date" id="courseFormStart" required>
          </div>
          
          <div class="form-group">
            <label>截止時間 *</label>
            <input type="date" id="courseFormDeadline" required>
          </div>
          
          <div class="form-group">
            <label>點數 *</label>
            <input type="number" id="courseFormPoints" min="0" value="10" required>
          </div>
          
          <div class="form-group">
            <label>前置課程ID</label>
            <input type="text" id="courseFormPrerequisite" placeholder="選填">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCourseModal()">取消</button>
        <button class="btn btn-primary" onclick="saveCourse()">儲存</button>
      </div>
    </div>
  </div>

  <!-- 新增/編輯題目 Modal -->
  <div id="questionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="questionModalTitle">新增題目</h3>
        <button class="modal-close" onclick="closeQuestionModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="questionForm">
          <input type="hidden" id="questionFormId">
          
          <div class="form-group">
            <label>課程 *</label>
                        <select id="questionFormCourse" required>
              <option value="">請選擇課程</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>題目內容 *</label>
            <textarea id="questionFormText" rows="3" placeholder="請輸入題目內容" required></textarea>
          </div>
          
          <div class="form-group">
            <label>選項A *</label>
            <input type="text" id="questionFormOptionA" placeholder="選項A" required>
          </div>
          
          <div class="form-group">
            <label>選項B *</label>
            <input type="text" id="questionFormOptionB" placeholder="選項B" required>
          </div>
          
          <div class="form-group">
            <label>選項C *</label>
            <input type="text" id="questionFormOptionC" placeholder="選項C" required>
          </div>
          
          <div class="form-group">
            <label>選項D *</label>
            <input type="text" id="questionFormOptionD" placeholder="選項D" required>
          </div>
          
          <div class="form-group">
            <label>正確答案 *</label>
            <select id="questionFormAnswer" required>
              <option value="">請選擇</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeQuestionModal()">取消</button>
        <button class="btn btn-primary" onclick="saveQuestion()">儲存</button>
      </div>
    </div>
  </div>

  <!-- 新增/編輯帳號 Modal -->
  <div id="accountModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="accountModalTitle">新增帳號</h3>
        <button class="modal-close" onclick="closeAccountModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="accountForm">
          <div class="form-group">
            <label>工號 *</label>
            <input type="text" id="accountFormEmpId" placeholder="例如: E001" required>
          </div>
          
          <div class="form-group">
            <label>姓名 *</label>
            <input type="text" id="accountFormName" placeholder="例如: 王小明" required>
          </div>
          
          <div class="form-group">
            <label>部門 *</label>
            <input type="text" id="accountFormDept" placeholder="例如: IT" required>
          </div>
          
          <div class="form-group">
            <label>密碼 *</label>
            <input type="password" id="accountFormPassword" placeholder="預設密碼" required>
          </div>
          
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="accountFormEmail" placeholder="example@company.com">
          </div>
          
          <div class="form-group">
            <label>權限 *</label>
            <select id="accountFormPermission" required>
              <option value="s1">s1 - 一般員工</option>
              <option value="s2">s2 - 部門主管</option>
              <option value="s3">s3 - 高階主管</option>
              <option value="s4">s4 - 系統管理員</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAccountModal()">取消</button>
        <button class="btn btn-primary" onclick="saveAccount()">儲存</button>
      </div>
    </div>
  </div>

  <!-- 新增公告 Modal -->
  <div id="announcementModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">新增公告</h3>
        <button class="modal-close" onclick="closeAnnouncementModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="announcementForm">
          <div class="form-group">
            <label>公告內容 *</label>
            <textarea id="announcementFormContent" rows="4" placeholder="請輸入公告內容" required></textarea>
          </div>
          
          <div class="form-group">
            <label>發布對象(部門,逗號分隔)</label>
            <input type="text" id="announcementFormTarget" placeholder="留空表示全公司,例如: IT,HR">
          </div>
          
          <div class="form-group">
            <label>
              <input type="checkbox" id="announcementFormPinned">
              是否置頂
            </label>
          </div>
          
          <div class="form-group">
            <label>有效期限</label>
            <input type="date" id="announcementFormExpiry">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAnnouncementModal()">取消</button>
        <button class="btn btn-primary" onclick="saveAnnouncement()">發布</button>
      </div>
    </div>
  </div>

  <!-- 測驗結果 Modal -->
  <div id="examResultModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">測驗結果</h3>
        <button class="modal-close" onclick="closeExamResultModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="exam-result">
          <div class="result-icon" id="resultIcon">
            <i class="fas fa-check-circle"></i>
          </div>
          <h2 class="result-title" id="resultTitle">測驗通過!</h2>
          <div class="result-score" id="resultScore">0</div>
          
          <div class="result-details">
            <div class="result-detail-item">
              <span>正確題數</span>
              <strong id="resultCorrect">0</strong>
            </div>
            <div class="result-detail-item">
              <span>總題數</span>
              <strong id="resultTotal">0</strong>
            </div>
            <div class="result-detail-item">
              <span>及格分數</span>
              <strong id="resultPassScore">60</strong>
            </div>
            <div class="result-detail-item" id="resultPointsRow">
              <span>獲得點數</span>
              <strong id="resultPoints">0</strong>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeExamResultModal()">確定</button>
      </div>
    </div>
  </div>

  <!-- ==================== JavaScript ==================== -->
  <script>
    // ==================== 全域變數 ==================== 
    let API_URL = 'https://script.google.com/macros/s/AKfycbyrP1dtZasv-aeeiV4gWliNFBF9ABYoGD3Awyp2YdXnJceEtghlXxwFoTdegHtygt3V_Q/exec'; // 請替換成您的 Web App URL
    let sessionToken = null;
    let currentUser = null;
    let currentCourse = null;
    let currentRecordId = null;
    let videoStartTime = null;
    let watchedSeconds = 0;
    let videoCheckInterval = null;
    let allCourses = [];
    let currentExamQuestions = [];

    // ==================== 初始化 ==================== 
    document.addEventListener('DOMContentLoaded', function() {
      // 檢查是否已登入
      const savedToken = localStorage.getItem('sessionToken');
      if (savedToken) {
        sessionToken = savedToken;
        validateSession();
      }

      // 登入表單提交
      document.getElementById('loginForm').addEventListener('submit', handleLogin);

      // 導航選單點擊
      document.querySelectorAll('.navbar-item').forEach(item => {
        item.addEventListener('click', function() {
          const page = this.dataset.page;
          navigateToPage(page);
        });
      });

      // 管理後台標籤切換
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.dataset.tab;
          switchAdminTab(tabName);
        });
      });

      // 系統設定表單提交
      document.getElementById('systemSettingsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveSystemSettings();
      });
    });

    // ==================== API 呼叫函數 ==================== 
async function callAPI(action, data = {}) {
  showLoading();
  
  try {
    // ✅ 使用 JSONP
    const params = new URLSearchParams({
      action: action,
      callback: 'handleResponse',
      ...data
    });
    
    if (sessionToken) {
      params.append('sessionToken', sessionToken);
    }
    
    const url = `${API_URL}?${params.toString()}`;
    
    return new Promise((resolve, reject) => {
      // 建立 callback 函數
      window.handleResponse = function(response) {
        hideLoading();
        
        if (!response.success && response.message === 'Session 無效') {
          logout();
          resolve(null);
        } else {
          resolve(response);
        }
        
        // 清理
        delete window.handleResponse;
        document.body.removeChild(script);
      };
      
      // 建立 script 標籤
      const script = document.createElement('script');
      script.src = url;
      script.onerror = function() {
        hideLoading();
        console.error('API Error: Failed to load script');
        showAlert('系統錯誤,請稍後再試', 'error');
        reject(new Error('Failed to load script'));
        delete window.handleResponse;
        document.body.removeChild(script);
      };
      
      document.body.appendChild(script);
    });
    
  } catch (error) {
    hideLoading();
    console.error('API Error:', error);
    showAlert('系統錯誤,請稍後再試', 'error');
    return null;
  }
}



    // ==================== 登入相關 ==================== 
    async function handleLogin(e) {
      e.preventDefault();
      
      const empId = document.getElementById('empId').value.trim();
      const password = document.getElementById('password').value;

      if (!empId || !password) {
        showAlert('請輸入工號和密碼', 'warning');
        return;
      }

      const result = await callAPI('login', { empId, password });

      if (result && result.success) {
        sessionToken = result.data.sessionToken;
        currentUser = result.data.user;
        
        localStorage.setItem('sessionToken', sessionToken);
        
        showAlert('登入成功!', 'success');
        showApp();
      } else {
        showAlert(result?.message || '登入失敗', 'error');
      }
    }

    async function validateSession() {
      const result = await callAPI('validateSession');
      
      if (result && result.success) {
        currentUser = result.data;
        showApp();
      } else {
        logout();
      }
    }

    function logout() {
      sessionToken = null;
      currentUser = null;
      localStorage.removeItem('sessionToken');
      
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('appContainer').classList.remove('active');
      
      showAlert('已登出', 'info');
    }

    function showApp() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('appContainer').classList.add('active');
      
      // 更新使用者資訊
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userDept').textContent = currentUser.department;
      document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
      document.getElementById('welcomeName').textContent = currentUser.name;

      // 顯示/隱藏管理選單
      if (currentUser.permission === 's4' || currentUser.permission === 's3') {
        document.querySelectorAll('.admin-only').forEach(el => {
          el.classList.remove('hidden');
        });
      }

      // 載入儀錶板
      loadDashboard();
    }

    // ==================== 頁面導航 ==================== 
    function navigateToPage(pageName) {
      // 更新導航選單
      document.querySelectorAll('.navbar-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.page === pageName) {
          item.classList.add('active');
        }
      });

      // 切換頁面
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.remove('active');
      });

      const targetPage = document.getElementById(pageName + 'Page');
      if (targetPage) {
        targetPage.classList.add('active');
      }

      // 載入對應頁面資料
      switch(pageName) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'courses':
          loadCourses();
          break;
        case 'mylearning':
          loadMyLearning();
          break;
        case 'admin':
          loadAdminData();
          break;
      }
    }

    // ==================== 儀錶板 ==================== 
    async function loadDashboard() {
      const result = await callAPI('getPersonalDashboard');

      if (result && result.success) {
        const data = result.data;

        // 更新統計卡片
        document.getElementById('totalPoints').textContent = data.user.totalPoints;
        document.getElementById('completedCount').textContent = data.completedCourses.length;
        document.getElementById('inProgressCount').textContent = data.inProgressCourses.length;
        document.getElementById('requiredCount').textContent = data.requiredCourses.length;

        // 顯示公告
        displayAnnouncements(data.announcements);

        // 顯示待完成必修課程
        displayRequiredCourses(data.requiredCourses);

        // 顯示進行中的課程
        displayInProgressCourses(data.inProgressCourses);
      }
    }

    function displayAnnouncements(announcements) {
      const container = document.getElementById('announcementsList');
      
      if (announcements.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">目前沒有公告</p>';
        return;
      }

      container.innerHTML = announcements.map(ann => `
        <div class="announcement-item ${ann.isPinned ? 'pinned' : ''}">
          <div class="announcement-header">
            <span class="announcement-time">${ann.time}</span>
            ${ann.isPinned ? '<span class="announcement-badge">置頂</span>' : ''}
          </div>
          <div class="announcement-content">${ann.content}</div>
        </div>
      `).join('');
    }

    function displayRequiredCourses(courses) {
      const container = document.getElementById('requiredCoursesList');
      
      if (courses.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: var(--text-secondary); padding: 20px;">太棒了!您已完成所有必修課程 🎉</p>';
        return;
      }

      container.innerHTML = courses.map(course => {
        const isExpired = course.isExpired;
        const daysLeft = course.daysLeft;
        
        return `
          <div class="course-card" onclick="viewCourse('${course.courseId}')">
            <div class="course-card-header required">
              <span class="course-badge">必修</span>
              <h3 class="course-title">${course.courseName}</h3>
              <p class="course-id">${course.courseId}</p>
            </div>
            <div class="course-card-body">
              <div class="course-deadline ${isExpired ? 'danger' : daysLeft <= 5 ? 'warning' : ''}">
                <i class="fas fa-calendar-alt"></i>
                截止日期: ${course.deadline}
                ${!isExpired ? ` (剩餘 ${daysLeft} 天)` : ' (已逾期)'}
              </div>
              <div class="course-actions">
                <button class="btn btn-primary" onclick="event.stopPropagation(); startLearning('${course.courseId}')">
                  <i class="fas fa-play"></i> 開始學習
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function displayInProgressCourses(courses) {
      const container = document.getElementById('inProgressCoursesList');
      
      if (courses.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: var(--text-secondary); padding: 20px;">目前沒有進行中的課程</p>';
        return;
      }

      container.innerHTML = courses.map(course => `
        <div class="course-card" onclick="viewCourse('${course.courseId}')">
          <div class="course-card-header">
            <span class="course-badge">進行中</span>
            <h3 class="course-title">${course.courseName}</h3>
            <p class="course-id">${course.courseId}</p>
          </div>
          <div class="course-card-body">
            <div class="course-meta">
              <span class="course-meta-item">
                <i class="fas fa-clock"></i>
                上次觀看: ${new Date(course.lastWatchTime).toLocaleDateString()}
              </span>
            </div>
            <div class="course-actions">
              <button class="btn btn-primary" onclick="event.stopPropagation(); continueLearning('${course.courseId}')">
                <i class="fas fa-play"></i> 繼續學習
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // ==================== 課程瀏覽 ==================== 
    async function loadCourses() {
      const result = await callAPI('getCourseList');

      if (result && result.success) {
        allCourses = result.data;
        displayCourses(allCourses);
        
        // 填充課門選項
        populateCourseCategoryFilter();
      }
    }

    function populateCourseCategoryFilter() {
      const categories = [...new Set(allCourses.map(c => c.courseCategory))];
      const select = document.getElementById('filterCourseCategory');
      
      select.innerHTML = '<option value="">全部</option>' + 
        categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
    }

    function applyCourseFilters() {
      const groupFilter = document.getElementById('filterCourseGroup').value;
      const categoryFilter = document.getElementById('filterCourseCategory').value;
      const typeFilter = document.getElementById('filterCourseType').value;
      const statusFilter = document.getElementById('filterStatus').value;

      let filtered = allCourses;

      if (groupFilter) {
        filtered = filtered.filter(c => c.courseGroup === groupFilter);
      }

      if (categoryFilter) {
        filtered = filtered.filter(c => c.courseCategory === categoryFilter);
      }

      if (typeFilter) {
        if (typeFilter === 'required') {
          filtered = filtered.filter(c => c.isRequired);
        } else if (typeFilter === 'optional') {
          filtered = filtered.filter(c => !c.isRequired);
        }
      }

      if (statusFilter) {
        filtered = filtered.filter(c => {
          if (statusFilter === 'completed') return c.isCompleted;
          if (statusFilter === 'inProgress') return c.hasStarted && !c.isCompleted;
          if (statusFilter === 'notStarted') return !c.hasStarted;
          return true;
        });
      }

      displayCourses(filtered);
    }

    function displayCourses(courses) {
      const container = document.getElementById('coursesList');
      
      if (courses.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: var(--text-secondary); grid-column: 1/-1;">找不到符合條件的課程</p>';
        return;
      }

      container.innerHTML = courses.map(course => {
        const headerClass = course.isCompleted ? 'completed' : course.isRequired ? 'required' : '';
        const badgeText = course.isCompleted ? '已完成' : course.isRequired ? '必修' : '選修';
        
        let deadlineHTML = '';
        if (course.deadline) {
          const daysLeft = calculateDaysLeft(course.deadline);
          const deadlineClass = course.isExpired ? 'danger' : daysLeft <= 5 ? 'warning' : '';
          deadlineHTML = `
            <div class="course-deadline ${deadlineClass}">
              <i class="fas fa-calendar-alt"></i>
              截止日期: ${course.deadline}
              ${!course.isExpired && daysLeft !== null ? ` (剩餘 ${daysLeft} 天)` : ''}
              ${course.isExpired ? ' (已逾期)' : ''}
            </div>
          `;
        }

        return `
          <div class="course-card" onclick="viewCourse('${course.courseId}')">
            <div class="course-card-header ${headerClass}">
              <span class="course-badge">${badgeText}</span>
              <h3 class="course-title">${course.courseName}</h3>
              <p class="course-id">${course.courseId}</p>
            </div>
            <div class="course-card-body">
              <p class="course-desc">${course.courseDesc || '暫無說明'}</p>
              <div class="course-meta">
                <span class="course-meta-item">
                  <i class="fas fa-folder"></i>
                  ${course.courseGroup} - ${course.courseCategory}
                </span>
                <span class="course-meta-item">
                  <i class="fas fa-star"></i>
                  ${course.points} 點
                </span>
              </div>
              ${deadlineHTML}
              <div class="course-actions">
                ${course.isCompleted 
                  ? '<button class="btn btn-success" disabled><i class="fas fa-check"></i> 已完成</button>'
                  : course.hasStarted
                    ? `<button class="btn btn-primary" onclick="event.stopPropagation(); continueLearning('${course.courseId}')"><i class="fas fa-play"></i> 繼續學習</button>`
                    : `<button class="btn btn-primary" onclick="event.stopPropagation(); startLearning('${course.courseId}')"><i class="fas fa-play"></i> 開始學習</button>`
                }
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function calculateDaysLeft(deadline) {
      if (!deadline) return null;
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      const deadlineDate = new Date(deadline);
      deadlineDate.setHours(23, 59, 59, 999);
      
      const diffTime = deadlineDate - now;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      return diffDays > 0 ? diffDays : 0;
    }

    async function viewCourse(courseId) {
      const result = await callAPI('getCourseDetail', { courseId });

      if (result && result.success) {
        currentCourse = result.data;
        
        // 檢查前置課程
        if (!currentCourse.prerequisiteCompleted) {
          showAlert(`請先完成前置課程: ${currentCourse.prerequisiteCourseId}`, 'warning');
          return;
        }

        // 如果已完成,直接顯示完成訊息
        if (currentCourse.isCompleted) {
          showAlert('您已完成此課程!', 'info');
          return;
        }

        // 導航到播放頁面
        navigateToPage('player');
        displayPlayer();
      }
    }

    async function startLearning(courseId) {
      const result = await callAPI('startLearning', { courseId });

      if (result && result.success) {
        currentRecordId = result.data.recordId;
        currentCourse = result.data.courseDetail;
        
        navigateToPage('player');
        displayPlayer();
      } else {
        showAlert(result?.message || '開始學習失敗', 'error');
      }
    }

    async function continueLearning(courseId) {
      await startLearning(courseId);
    }

    // ==================== 課程播放器 ==================== 
    function displayPlayer() {
      document.getElementById('playerCourseTitle').textContent = currentCourse.courseName;
      document.getElementById('playerCourseId').textContent = currentCourse.courseId;
      document.getElementById('playerCoursePoints').textContent = currentCourse.points;
      document.getElementById('playerDeadline').textContent = currentCourse.deadline || '無期限';
      document.getElementById('playerCourseDesc').textContent = currentCourse.courseDesc || '暫無說明';

      // 載入影片
      const videoUrl = convertDriveUrl(currentCourse.videoLink);
      document.getElementById('videoPlayer').src = videoUrl;

      // 開始追蹤觀看時間
      videoStartTime = new Date();
      watchedSeconds = 0;

      // 每10秒更新一次進度
      if (videoCheckInterval) clearInterval(videoCheckInterval);
      
      videoCheckInterval = setInterval(() => {
        watchedSeconds += 10;
        updateProgress();
      }, 10000);

      // 監聽影片結束事件(需要使用 YouTube API 或其他方式)
      // 這裡簡化處理,假設觀看一定時間後即可測驗
      setTimeout(() => {
        document.getElementById('btnStartExam').disabled = false;
        showAlert('影片已觀看完畢,可以開始測驗了!', 'success');
      }, 30000); // 假設30秒後可以測驗
    }

    function convertDriveUrl(url) {
      // 將 Google Drive 分享連結轉換為嵌入式連結
      if (url.includes('drive.google.com')) {
        const fileId = url.match(/[-\w]{25,}/);
        if (fileId) {
          return `https://drive.google.com/file/d/${fileId[0]}/preview`;
        }
      }
      return url;
    }

    async function updateProgress() {
      if (!currentRecordId) return;

      const progressPercent = Math.min(100, Math.round((watchedSeconds / 180) * 100)); // 假設影片3分鐘
      
      document.getElementById('progressFill').style.width = progressPercent + '%';
      document.getElementById('progressFill').textContent = progressPercent + '%';

      // 更新後端進度
      await callAPI('updateProgress', {
        recordId: currentRecordId,
        progressData: {
          watchedSeconds: watchedSeconds,
          progress: progressPercent,
          isComplete: progressPercent >= 100
        }
      });
    }

    function backToCourses() {
      if (videoCheckInterval) clearInterval(videoCheckInterval);
      navigateToPage('courses');
    }

    // ==================== 測驗 ==================== 
    async function startExam() {
      if (!currentCourse) return;

      const result = await callAPI('getRandomQuestions', {
        courseId: currentCourse.courseId
      });

      if (result && result.success) {
        currentExamQuestions = result.data;
        
        if (currentExamQuestions.length === 0) {
          showAlert('此課程尚無測驗題目', 'warning');
          return;
        }

        navigateToPage('exam');
        displayExam();
      }
    }

    function displayExam() {
      document.getElementById('examCourseTitle').textContent = currentCourse.courseName + ' - 測驗';
      
      const questionsHTML = currentExamQuestions.map((q, index) => `
        <div class="question-card">
          <span class="question-number">第 ${index + 1} 題</span>
          <div class="question-text">${q.questionText}</div>
          <div class="options-list">
            <div class="option-item">
              <input type="radio" name="question_${q.questionId}" value="A" id="q${index}_a">
              <label for="q${index}_a">${q.optionA}</label>
            </div>
            <div class="option-item">
              <input type="radio" name="question_${q.questionId}" value="B" id="q${index}_b">
              <label for="q${index}_b">${q.optionB}</label>
            </div>
            <div class="option-item">
              <input type="radio" name="question_${q.questionId}" value="C" id="q${index}_c">
              <label for="q${index}_c">${q.optionC}</label>
            </div>
            <div class="option-item">
              <input type="radio" name="question_${q.questionId}" value="D" id="q${index}_d">
              <label for="q${index}_d">${q.optionD}</label>
            </div>
          </div>
        </div>
      `).join('');

      document.getElementById('examQuestions').innerHTML = questionsHTML;
    }

    async function submitExam() {
      // 收集答案
      const answers = {};
      let allAnswered = true;

            currentExamQuestions.forEach(q => {
        const selected = document.querySelector(`input[name="question_${q.questionId}"]:checked`);
        if (selected) {
          answers[q.questionId] = selected.value;
        } else {
          allAnswered = false;
        }
      });

      if (!allAnswered) {
        showAlert('請回答所有題目', 'warning');
        return;
      }

      // 提交測驗
      const result = await callAPI('submitExam', {
        recordId: currentRecordId,
        answers: answers
      });

      if (result && result.success) {
        displayExamResult(result.data);
      } else {
        showAlert(result?.message || '提交失敗', 'error');
      }
    }

    function displayExamResult(resultData) {
      const modal = document.getElementById('examResultModal');
      const isPassed = resultData.isPassed;

      // 更新圖示和標題
      const icon = document.getElementById('resultIcon');
      const title = document.getElementById('resultTitle');
      
      if (isPassed) {
        icon.className = 'result-icon pass';
        icon.innerHTML = '<i class="fas fa-check-circle"></i>';
        title.textContent = '恭喜通過測驗!';
      } else {
        icon.className = 'result-icon fail';
        icon.innerHTML = '<i class="fas fa-times-circle"></i>';
        title.textContent = '測驗未通過';
      }

      // 更新分數
      document.getElementById('resultScore').textContent = resultData.score + ' 分';
      document.getElementById('resultCorrect').textContent = resultData.correctCount;
      document.getElementById('resultTotal').textContent = resultData.totalQuestions;
      document.getElementById('resultPassScore').textContent = resultData.passScore;

      // 顯示獲得點數
      const pointsRow = document.getElementById('resultPointsRow');
      if (isPassed) {
        pointsRow.style.display = 'flex';
        document.getElementById('resultPoints').textContent = resultData.earnedPoints;
      } else {
        pointsRow.style.display = 'none';
      }

      modal.classList.add('active');

      // 如果通過,更新當前課程狀態
      if (isPassed) {
        currentCourse.isCompleted = true;
      }
    }

    function closeExamResultModal() {
      document.getElementById('examResultModal').classList.remove('active');
      
      // 返回課程列表
      if (videoCheckInterval) clearInterval(videoCheckInterval);
      navigateToPage('courses');
      loadCourses();
    }

    function backToPlayer() {
      navigateToPage('player');
    }

    // ==================== 我的學習 ==================== 
    async function loadMyLearning() {
      // 載入學習紀錄
      const recordsResult = await callAPI('getLearningRecords');
      
      if (recordsResult && recordsResult.success) {
        displayMyLearningRecords(recordsResult.data);
      }

      // 載入點數紀錄
      const pointsResult = await callAPI('getPointRecords', {
        empId: currentUser.empId
      });

      if (pointsResult && pointsResult.success) {
        displayMyPointRecords(pointsResult.data);
      }
    }

    function displayMyLearningRecords(records) {
      const tbody = document.getElementById('myLearningRecords');
      
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">尚無學習紀錄</td></tr>';
        return;
      }

      tbody.innerHTML = records.map(record => `
        <tr>
          <td>${record.courseName}</td>
          <td>${record.startTime || '-'}</td>
          <td>${record.completeTime || '-'}</td>
          <td>${record.examScore !== null ? record.examScore + ' 分' : '-'}</td>
          <td>${record.earnedPoints || 0} 點</td>
          <td>
            ${record.isCompleted 
              ? '<span class="status-badge pass">已完成</span>' 
              : '<span class="status-badge active">進行中</span>'}
          </td>
        </tr>
      `).join('');
    }

    function displayMyPointRecords(records) {
      const tbody = document.getElementById('myPointRecords');
      
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center">尚無點數紀錄</td></tr>';
        return;
      }

      tbody.innerHTML = records.map(record => `
        <tr>
          <td>${record.courseName}</td>
          <td>${record.points} 點</td>
          <td>${record.earnedTime}</td>
        </tr>
      `).join('');
    }

    // ==================== 管理後台 ==================== 
    function switchAdminTab(tabName) {
      // 更新標籤樣式
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        }
      });

      // 切換面板
      document.querySelectorAll('.admin-panel').forEach(panel => {
        panel.classList.remove('active');
      });

      const targetPanel = document.getElementById('admin' + capitalize(tabName) + 'Panel');
      if (targetPanel) {
        targetPanel.classList.add('active');
      }

      // 載入對應資料
      switch(tabName) {
        case 'courses':
          loadAdminCourses();
          break;
        case 'questions':
          loadAdminQuestions();
          break;
        case 'accounts':
          loadAdminAccounts();
          break;
        case 'records':
          loadAdminRecords();
          break;
        case 'announcements':
          loadAdminAnnouncements();
          break;
        case 'settings':
          loadSystemSettings();
          break;
      }
    }

    function loadAdminData() {
      loadAdminCourses();
    }

    // ==================== 課程管理 ==================== 
    async function loadAdminCourses() {
      const result = await callAPI('getAllCourses');

      if (result && result.success) {
        displayAdminCourses(result.data);
      }
    }

    function displayAdminCourses(courses) {
      const tbody = document.getElementById('adminCoursesList');
      
      if (courses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">尚無課程</td></tr>';
        return;
      }

      tbody.innerHTML = courses.map(course => `
        <tr>
          <td>${course.courseId}</td>
          <td>${course.courseName}</td>
          <td>${course.courseGroup}</td>
          <td>${course.courseCategory}</td>
          <td>${course.points}</td>
          <td>${course.deadline || '-'}</td>
          <td>
            <span class="status-badge ${course.status === '啟用' ? 'active' : 'inactive'}">
              ${course.status}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-primary" onclick="editCourse('${course.courseId}')" title="編輯">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon btn-danger" onclick="deleteCourse('${course.courseId}')" title="刪除">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function showAddCourseModal() {
      document.getElementById('courseModalTitle').textContent = '新增課程';
      document.getElementById('courseForm').reset();
      document.getElementById('courseFormId').value = '';
      document.getElementById('courseModal').classList.add('active');
    }

    async function editCourse(courseId) {
      const result = await callAPI('getCourseDetail', { courseId });

      if (result && result.success) {
        const course = result.data;
        
        document.getElementById('courseModalTitle').textContent = '編輯課程';
        document.getElementById('courseFormId').value = course.courseId;
        document.getElementById('courseFormGroup').value = course.courseGroup;
        document.getElementById('courseFormCategory').value = course.courseCategory;
        document.getElementById('courseFormName').value = course.courseName;
        document.getElementById('courseFormDesc').value = course.courseDesc || '';
        document.getElementById('courseFormVideo').value = course.videoLink;
        document.getElementById('courseFormRequired').value = course.requiredDepts || '';
        document.getElementById('courseFormOptional').value = course.optionalDepts || '';
        document.getElementById('courseFormStart').value = course.startTime ? course.startTime.split(' ')[0] : '';
        document.getElementById('courseFormDeadline').value = course.deadline ? course.deadline.split(' ')[0] : '';
        document.getElementById('courseFormPoints').value = course.points;
        document.getElementById('courseFormPrerequisite').value = course.prerequisiteCourseId || '';
        
        document.getElementById('courseModal').classList.add('active');
      }
    }

    async function saveCourse() {
      const courseId = document.getElementById('courseFormId').value;
      const courseData = {
        courseGroup: document.getElementById('courseFormGroup').value,
        courseCategory: document.getElementById('courseFormCategory').value,
        courseName: document.getElementById('courseFormName').value,
        courseDesc: document.getElementById('courseFormDesc').value,
        videoLink: document.getElementById('courseFormVideo').value,
        requiredDepts: document.getElementById('courseFormRequired').value,
        optionalDepts: document.getElementById('courseFormOptional').value,
        startTime: document.getElementById('courseFormStart').value,
        deadline: document.getElementById('courseFormDeadline').value,
        points: parseInt(document.getElementById('courseFormPoints').value),
        prerequisiteCourseId: document.getElementById('courseFormPrerequisite').value
      };

      const action = courseId ? 'updateCourse' : 'createCourse';
      const data = courseId ? { courseId, courseData } : { courseData };

      const result = await callAPI(action, data);

      if (result && result.success) {
        showAlert(courseId ? '課程更新成功' : '課程新增成功', 'success');
        closeCourseModal();
        loadAdminCourses();
      } else {
        showAlert(result?.message || '操作失敗', 'error');
      }
    }

    async function deleteCourse(courseId) {
      if (!confirm('確定要刪除此課程嗎?此操作無法復原!')) return;

      const result = await callAPI('deleteCourse', { courseId });

      if (result && result.success) {
        showAlert('課程刪除成功', 'success');
        loadAdminCourses();
      } else {
        showAlert(result?.message || '刪除失敗', 'error');
      }
    }

    function closeCourseModal() {
      document.getElementById('courseModal').classList.remove('active');
    }

    // ==================== 題目管理 ==================== 
    async function loadAdminQuestions() {
      // 載入課程選項
      const coursesResult = await callAPI('getAllCourses');
      
      if (coursesResult && coursesResult.success) {
        const select1 = document.getElementById('adminQuestionCourseFilter');
        const select2 = document.getElementById('questionFormCourse');
        
        const options = coursesResult.data.map(c => 
          `<option value="${c.courseId}">${c.courseId} - ${c.courseName}</option>`
        ).join('');
        
        select1.innerHTML = '<option value="">選擇課程</option>' + options;
        select2.innerHTML = '<option value="">請選擇課程</option>' + options;
      }
    }

    async function loadAdminQuestionsByCourse() {
      const courseId = document.getElementById('adminQuestionCourseFilter').value;
      
      if (!courseId) {
        document.getElementById('adminQuestionsList').innerHTML = 
          '<tr><td colspan="4" class="text-center">請選擇課程</td></tr>';
        return;
      }

      const result = await callAPI('getQuestions', { courseId });

      if (result && result.success) {
        displayAdminQuestions(result.data);
      }
    }

    function displayAdminQuestions(questions) {
      const tbody = document.getElementById('adminQuestionsList');
      
      if (questions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">此課程尚無題目</td></tr>';
        return;
      }

      tbody.innerHTML = questions.map(q => `
        <tr>
          <td>${q.questionId}</td>
          <td>${q.questionText}</td>
          <td>${q.correctAnswer}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-primary" onclick="editQuestion('${q.questionId}')" title="編輯">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon btn-danger" onclick="deleteQuestion('${q.questionId}')" title="刪除">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function showAddQuestionModal() {
      const courseId = document.getElementById('adminQuestionCourseFilter').value;
      
      if (!courseId) {
        showAlert('請先選擇課程', 'warning');
        return;
      }

      document.getElementById('questionModalTitle').textContent = '新增題目';
      document.getElementById('questionForm').reset();
      document.getElementById('questionFormId').value = '';
      document.getElementById('questionFormCourse').value = courseId;
      document.getElementById('questionModal').classList.add('active');
    }

    async function editQuestion(questionId) {
      const result = await callAPI('getQuestionDetail', { questionId });

      if (result && result.success) {
        const q = result.data;
        
        document.getElementById('questionModalTitle').textContent = '編輯題目';
        document.getElementById('questionFormId').value = q.questionId;
        document.getElementById('questionFormCourse').value = q.courseId;
        document.getElementById('questionFormText').value = q.questionText;
        document.getElementById('questionFormOptionA').value = q.optionA;
        document.getElementById('questionFormOptionB').value = q.optionB;
        document.getElementById('questionFormOptionC').value = q.optionC;
        document.getElementById('questionFormOptionD').value = q.optionD;
        document.getElementById('questionFormAnswer').value = q.correctAnswer;
        
        document.getElementById('questionModal').classList.add('active');
      }
    }

    async function saveQuestion() {
      const questionId = document.getElementById('questionFormId').value;
      const questionData = {
        courseId: document.getElementById('questionFormCourse').value,
        questionText: document.getElementById('questionFormText').value,
        optionA: document.getElementById('questionFormOptionA').value,
        optionB: document.getElementById('questionFormOptionB').value,
        optionC: document.getElementById('questionFormOptionC').value,
        optionD: document.getElementById('questionFormOptionD').value,
        correctAnswer: document.getElementById('questionFormAnswer').value
      };

      const action = questionId ? 'updateQuestion' : 'createQuestion';
      const data = questionId ? { questionId, questionData } : { questionData };

      const result = await callAPI(action, data);

      if (result && result.success) {
        showAlert(questionId ? '題目更新成功' : '題目新增成功', 'success');
        closeQuestionModal();
        loadAdminQuestionsByCourse();
      } else {
        showAlert(result?.message || '操作失敗', 'error');
      }
    }

    async function deleteQuestion(questionId) {
      if (!confirm('確定要刪除此題目嗎?')) return;

      const result = await callAPI('deleteQuestion', { questionId });

      if (result && result.success) {
        showAlert('題目刪除成功', 'success');
        loadAdminQuestionsByCourse();
      } else {
        showAlert(result?.message || '刪除失敗', 'error');
      }
    }

    function closeQuestionModal() {
      document.getElementById('questionModal').classList.remove('active');
    }

    // ==================== 帳號管理 ==================== 
    async function loadAdminAccounts() {
      const result = await callAPI('getAllAccounts');

      if (result && result.success) {
        displayAdminAccounts(result.data);
      }
    }

    function displayAdminAccounts(accounts) {
      const tbody = document.getElementById('adminAccountsList');
      
      if (accounts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">尚無帳號</td></tr>';
        return;
      }

      tbody.innerHTML = accounts.map(acc => `
        <tr>
          <td>${acc.empId}</td>
          <td>${acc.name}</td>
          <td>${acc.department}</td>
          <td>${acc.email || '-'}</td>
          <td>${acc.permission}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-primary" onclick="editAccount('${acc.empId}')" title="編輯">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon btn-warning" onclick="resetPassword('${acc.empId}')" title="重設密碼">
                <i class="fas fa-key"></i>
              </button>
              <button class="btn-icon btn-danger" onclick="deleteAccount('${acc.empId}')" title="刪除">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function showAddAccountModal() {
      document.getElementById('accountModalTitle').textContent = '新增帳號';
      document.getElementById('accountForm').reset();
      document.getElementById('accountFormEmpId').readOnly = false;
      document.getElementById('accountModal').classList.add('active');
    }

    async function editAccount(empId) {
      const result = await callAPI('getAccountDetail', { empId });

      if (result && result.success) {
        const acc = result.data;
        
        document.getElementById('accountModalTitle').textContent = '編輯帳號';
        document.getElementById('accountFormEmpId').value = acc.empId;
        document.getElementById('accountFormEmpId').readOnly = true;
        document.getElementById('accountFormName').value = acc.name;
        document.getElementById('accountFormDept').value = acc.department;
        document.getElementById('accountFormPassword').value = '';
        document.getElementById('accountFormPassword').placeholder = '留空表示不修改';
        document.getElementById('accountFormEmail').value = acc.email || '';
        document.getElementById('accountFormPermission').value = acc.permission;
        
        document.getElementById('accountModal').classList.add('active');
      }
    }

    async function saveAccount() {
      const empId = document.getElementById('accountFormEmpId').value;
      const isEdit = document.getElementById('accountFormEmpId').readOnly;
      
      const accountData = {
        empId: empId,
        name: document.getElementById('accountFormName').value,
        department: document.getElementById('accountFormDept').value,
        password: document.getElementById('accountFormPassword').value,
        email: document.getElementById('accountFormEmail').value,
        permission: document.getElementById('accountFormPermission').value
      };

      const action = isEdit ? 'updateAccount' : 'createAccount';

      const result = await callAPI(action, accountData);

      if (result && result.success) {
        showAlert(isEdit ? '帳號更新成功' : '帳號新增成功', 'success');
        closeAccountModal();
        loadAdminAccounts();
      } else {
        showAlert(result?.message || '操作失敗', 'error');
      }
    }

    async function resetPassword(empId) {
      const newPassword = prompt('請輸入新密碼:');
      
      if (!newPassword) return;

      const result = await callAPI('resetPassword', { empId, newPassword });

      if (result && result.success) {
        showAlert('密碼重設成功', 'success');
      } else {
        showAlert(result?.message || '重設失敗', 'error');
      }
    }

    async function deleteAccount(empId) {
      if (!confirm('確定要刪除此帳號嗎?')) return;

      const result = await callAPI('deleteAccount', { empId });

      if (result && result.success) {
        showAlert('帳號刪除成功', 'success');
        loadAdminAccounts();
      } else {
        showAlert(result?.message || '刪除失敗', 'error');
      }
    }

    function closeAccountModal() {
      document.getElementById('accountModal').classList.remove('active');
    }

    // ==================== 學習紀錄管理 ==================== 
    async function loadAdminRecords() {
      const result = await callAPI('getAllLearningRecords');

      if (result && result.success) {
        displayAdminRecords(result.data);
      }
    }

    function displayAdminRecords(records) {
      const tbody = document.getElementById('adminRecordsList');
      
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">尚無學習紀錄</td></tr>';
        return;
      }

      tbody.innerHTML = records.map(record => `
        <tr>
          <td>${record.empId}</td>
          <td>${record.empName}</td>
          <td>${record.courseName}</td>
          <td>${record.startTime || '-'}</td>
          <td>${record.completeTime || '-'}</td>
          <td>${record.examScore !== null ? record.examScore + ' 分' : '-'}</td>
          <td>${record.earnedPoints || 0} 點</td>
        </tr>
      `).join('');
    }

    function exportRecords() {
      showAlert('匯出功能開發中...', 'info');
      // 可以實作匯出 CSV 或 Excel 功能
    }

    // ==================== 公告管理 ==================== 
    async function loadAdminAnnouncements() {
      const result = await callAPI('getAllAnnouncements');

      if (result && result.success) {
        displayAdminAnnouncements(result.data);
      }
    }

    function displayAdminAnnouncements(announcements) {
      const tbody = document.getElementById('adminAnnouncementsList');
      
      if (announcements.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">尚無公告</td></tr>';
        return;
      }

      tbody.innerHTML = announcements.map(ann => `
        <tr>
          <td>${ann.time}</td>
          <td>${ann.content}</td>
          <td>${ann.targetDepts || '全公司'}</td>
          <td>${ann.isPinned ? '是' : '否'}</td>
          <td>${ann.expiryDate || '無期限'}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-danger" onclick="deleteAnnouncement('${ann.time}')" title="刪除">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function showAddAnnouncementModal() {
      document.getElementById('announcementForm').reset();
      document.getElementById('announcementModal').classList.add('active');
    }

    async function saveAnnouncement() {
      const announcementData = {
        content: document.getElementById('announcementFormContent').value,
        targetDepts: document.getElementById('announcementFormTarget').value || '全公司',
        isPinned: document.getElementById('announcementFormPinned').checked,
        expiryDate: document.getElementById('announcementFormExpiry').value
      };

      const result = await callAPI('createAnnouncement', announcementData);

      if (result && result.success) {
        showAlert('公告發布成功', 'success');
        closeAnnouncementModal();
        loadAdminAnnouncements();
      } else {
        showAlert(result?.message || '發布失敗', 'error');
      }
    }

    async function deleteAnnouncement(announcementId) {
      if (!confirm('確定要刪除此公告嗎?')) return;

      const result = await callAPI('deleteAnnouncement', { announcementId });

      if (result && result.success) {
        showAlert('公告刪除成功', 'success');
        loadAdminAnnouncements();
      } else {
        showAlert(result?.message || '刪除失敗', 'error');
      }
    }

    function closeAnnouncementModal() {
      document.getElementById('announcementModal').classList.remove('active');
    }

    // ==================== 系統設定 ==================== 
    async function loadSystemSettings() {
      const result = await callAPI('getSystemSettings');

      if (result && result.success) {
        const settings = result.data;
        
        document.getElementById('settingQuestionCount').value = settings['測驗題數'] || 5;
        document.getElementById('settingPassScore').value = settings['測驗及格分數'] || 60;
        document.getElementById('settingReminderDays').value = settings['截止日提醒天數'] || 5;
        document.getElementById('settingSessionTimeout').value = settings['Session有效時間'] || 480;
      }
    }

    async function saveSystemSettings() {
      const settings = {
        '測驗題數': parseInt(document.getElementById('settingQuestionCount').value),
        '測驗及格分數': parseInt(document.getElementById('settingPassScore').value),
        '截止日提醒天數': parseInt(document.getElementById('settingReminderDays').value),
        'Session有效時間': parseInt(document.getElementById('settingSessionTimeout').value)
      };

      const result = await callAPI('updateSystemSettings', { settings });

      if (result && result.success) {
        showAlert('系統設定更新成功', 'success');
      } else {
        showAlert(result?.message || '更新失敗', 'error');
      }
    }

    // ==================== 工具函數 ==================== 
    function showLoading() {
      document.getElementById('loading').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('active');
    }

    function showAlert(message, type = 'info') {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert alert-${type} active`;
      
      setTimeout(() => {
        alert.classList.remove('active');
      }, 3000);
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // 關閉 Modal 的通用方法(點擊背景)
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
      }
    });
  </script>
</body>
</html>



