<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GAIæ˜¶é’å¤§å­¸</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- âœ… æ–°å¢ï¼šChart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    /* ğŸ¨ ç™»å…¥é é¢ç‰ˆæ¬Šæ–‡å­— */
.login-footer {
    text-align: center;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
    color: var(--text-secondary);
    font-size: 0.75rem;
    opacity: 0.7;
}

/* âœ… æ–°å¢ï¼šæ•™å¸«è³‡è¨Šæ¨£å¼ */
.course-teacher {
  font-size: 14px;
  color: #6366f1;
  margin: 8px 0;
  padding: 6px 12px;
  background: #eef2ff;
  border-radius: 6px;
  display: inline-block;
  font-weight: 500;
}

/* å¦‚æœæ²’æœ‰æ•™å¸«è³‡è¨Šï¼Œä¸é¡¯ç¤ºç©ºç™½å€åŸŸ */
.course-teacher:empty {
  display: none;
  margin: 0;
  padding: 0;
}

/* ==================== å…¨åŸŸæ¨£å¼ ==================== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  /* âœ… æ™‚å°šé…è‰²ç³»çµ± */
  --primary-color: #6366f1;      /* é›è— */
  --secondary-color: #8b5cf6;    /* ç´«è‰² */
  --accent-color: #ec4899;       /* ç²‰ç´… */
  --success-color: #10b981;      /* ç¿ ç¶  */
  --danger-color: #ef4444;       /* ç´…è‰² */
  --warning-color: #f59e0b;      /* æ©™è‰² */
  --info-color: #06b6d4;         /* é’è‰² */
  
  /* âœ… ä¸­æ€§è‰²ç³»çµ± */
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;
  
  /* âœ… æ–‡å­—é¡è‰² */
  --text-primary: #111827;
  --text-secondary: #6b7280;
  --text-tertiary: #9ca3af;
  
  /* âœ… æ¼¸å±¤è‰² */
  --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --gradient-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  --gradient-info: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
  --gradient-purple: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
  --gradient-orange: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
  --gradient-blue: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
  
  /* âœ… é™°å½±ç³»çµ± */
  --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
  --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  
  /* âœ… å½©è‰²é™°å½± */
  --shadow-primary: 0 10px 30px -5px rgba(99, 102, 241, 0.3);
  --shadow-secondary: 0 10px 30px -5px rgba(139, 92, 246, 0.3);
  --shadow-success: 0 10px 30px -5px rgba(16, 185, 129, 0.3);
  --shadow-danger: 0 10px 30px -5px rgba(239, 68, 68, 0.3);
  --shadow-warning: 0 10px 30px -5px rgba(245, 158, 11, 0.3);
}

/* âœ… æ™‚å°šæ¼¸å±¤èƒŒæ™¯ */
body {
  font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  min-height: 100vh;
  color: var(--text-primary);
  
  /* æŸ”å’Œæ¼¸å±¤èƒŒæ™¯ */
  background: 
    radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.05) 0%, transparent 70%),
    linear-gradient(135deg, #88d66f 0%, #2091f5 100%);
  background-attachment: fixed;
  
  /* æŸ”å’Œç´‹ç† */
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: 
    repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.03) 10px, rgba(255,255,255,.03) 20px);
  pointer-events: none;
  z-index: 0;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  position: relative;
  z-index: 1;
}

/* ==================== ç™»å…¥é é¢ ==================== */
.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
  position: relative;
  z-index: 1;
}

.login-box {
  background: rgba(255, 255, 255, 0.65);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-radius: 24px;
  padding: 50px;
  width: 100%;
  max-width: 450px;
  animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  
  /* ç»ç’ƒæ“¬æ…‹æ•ˆæœ */
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.08),
    0 0 0 1px rgba(255, 255, 255, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  
  border: 1px solid rgba(255, 255, 255, 0.3);
  position: relative;
  overflow: hidden;
}

/* æ¼¸å±¤é‚Šæ¡†æ•ˆæœ */
.login-box::before {
  content: '';
  position: absolute;
  inset: -2px;
  border-radius: 24px;
  padding: 2px;
  background: var(--gradient-primary);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  opacity: 0.6;
  animation: borderFlow 3s ease-in-out infinite;
  pointer-events: none; /* âœ… åŠ å…¥é€™è¡Œï¼è®“é»æ“Šç©¿é€ */
  z-index: -1; /* âœ… é¡å¤–ä¿éšªï¼šç¢ºä¿åœ¨å…§å®¹ä¸‹æ–¹ */
}

@keyframes borderFlow {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

.login-header {
  text-align: center;
  margin-bottom: 40px;
}

.login-header img {
  width: 80px;
  height: 80px;
  object-fit: contain;
  margin-bottom: 20px;
  display: inline-block;
  animation: iconFloat 3s ease-in-out infinite;
  filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.1));
}


@keyframes iconFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.login-header h1 {
  font-size: 42px;
  color: var(--text-primary);
  margin-bottom: 10px;
  font-weight: 800;
}

.login-header p {
  color: var(--text-secondary);
  font-size: 14px;
}

.form-group {
  margin-bottom: 25px;
}

.form-group label {
  display: block;
  margin-bottom: 10px;
  color: var(--text-primary);
  font-weight: 600;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.form-group label i {
  color: var(--primary-color);
}

.form-group input {
  width: 100%;
  padding: 14px 18px;
  background: rgba(255, 255, 255, 0.8);
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  font-size: 14px;
  color: var(--text-primary);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: inherit;
}

.form-group input:focus {
  outline: none;
  border-color: var(--primary-color);
  background: white;
  box-shadow: 
    0 0 0 4px rgba(99, 102, 241, 0.1),
    var(--shadow-md);
  transform: translateY(-2px);
}

.form-group input::placeholder {
  color: var(--text-tertiary);
}

/* âœ… æ™‚å°šæŒ‰éˆ• */
.btn {
  display: inline-block;
  padding: 14px 32px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
  text-decoration: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  font-family: inherit;
}

.btn-primary {
  background: var(--gradient-primary);
  color: white;
  width: 100%;
  box-shadow: var(--shadow-primary);
}

.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 15px 40px -10px rgba(99, 102, 241, 0.5),
    0 0 0 4px rgba(99, 102, 241, 0.1);
}

.btn-primary:active {
  transform: translateY(-1px);
}

/* æŒ‰éˆ•å…‰æ³¢æ•ˆæœ */
.btn::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.5);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn:active::after {
  width: 400px;
  height: 400px;
}

.btn-secondary {
  background: var(--gradient-secondary);
  color: white;
  box-shadow: var(--shadow-secondary);
}

.btn-secondary:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 15px 40px -10px rgba(139, 92, 246, 0.5),
    0 0 0 4px rgba(139, 92, 246, 0.1);
}

.btn-success {
  background: var(--gradient-success);
  color: white;
  box-shadow: var(--shadow-success);
}

.btn-success:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 15px 40px -10px rgba(16, 185, 129, 0.5),
    0 0 0 4px rgba(16, 185, 129, 0.1);
}

.btn-danger {
  background: var(--gradient-warning);
  color: white;
  box-shadow: var(--shadow-danger);
}

.btn-danger:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 15px 40px -10px rgba(239, 68, 68, 0.5),
    0 0 0 4px rgba(239, 68, 68, 0.1);
}

.btn-warning {
  background: var(--gradient-orange);
  color: white;
  box-shadow: var(--shadow-warning);
}

.btn-warning:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 15px 40px -10px rgba(245, 158, 11, 0.5),
    0 0 0 4px rgba(245, 158, 11, 0.1);
}

.btn-sm {
  padding: 10px 20px;
  font-size: 13px;
}
/* ä¿®æ”¹å¯†ç¢¼æŒ‰éˆ•æ¨£å¼ */
.btn-change-password {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.btn-change-password:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
}



    
/* ==================== ä¸»æ‡‰ç”¨ç¨‹å¼ ==================== */
.app-container {
  display: none;
  min-height: 100vh;
  position: relative;
  z-index: 1;
}

.app-container.active {
  display: block;
}

/* âœ… æ™‚å°šå°èˆªåˆ— */
.navbar {
  padding: 20px 0;
  position: sticky;
  top: 0;
  z-index: 1000;
  
  /* ç»ç’ƒæ“¬æ…‹æ•ˆæœ */
  background: linear-gradient(135deg, #f7f792 0%, #a9d126 100%);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  
  /* ç²¾ç·»é™°å½± */
  box-shadow: 
    0 10px 30px rgba(0, 0, 0, 0.05),
    0 0 0 1px rgba(255, 255, 255, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  
  border-bottom: 1px solid rgba(99, 102, 241, 0.1);
}

.navbar-content {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.navbar-brand {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 38px;
  font-weight: 800;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.navbar-brand i {
  font-size: 32px;
  animation: iconPulse 2s ease-in-out infinite;
}

@keyframes iconPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.navbar-menu {
  display: flex;
  gap: 10px;
  align-items: center;
}

.navbar-item {
  padding: 10px 20px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 500;
  position: relative;
}

.navbar-item:hover {
  background: var(--gray-100);
  color: var(--primary-color);
  transform: translateY(-2px);
}

.navbar-item.active {
  background: var(--gradient-primary);
  color: white;
  box-shadow: var(--shadow-primary);
  font-weight: 600;
}

.navbar-user {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 10px 20px;
  background: var(--gray-50);
  border-radius: 12px;
  border: 1px solid var(--gray-200);
  transition: all 0.3s;
}

.navbar-user:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.navbar-user-info {
  text-align: right;
}

.navbar-user-name {
  font-weight: 600;
  font-size: 14px;
  color: var(--text-primary);
}

.navbar-user-dept {
  font-size: 12px;
  color: var(--text-secondary);
}

.navbar-user-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--gradient-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  box-shadow: var(--shadow-primary);
  animation: avatarGlow 3s ease-in-out infinite;
}

@keyframes avatarGlow {
  0%, 100% { box-shadow: var(--shadow-primary); }
  50% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
}

.btn-logout {
  background: var(--gradient-warning);
  color: white;
  padding: 10px 20px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s;
  box-shadow: var(--shadow-danger);
}

.btn-logout:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 15px 40px -10px rgba(239, 68, 68, 0.5),
    0 0 0 4px rgba(239, 68, 68, 0.1);
}

/* ==================== ä¸»å…§å®¹å€ ==================== */
.main-content {
  max-width: 1400px;
  margin: 30px auto;
  padding: 0 20px;
  position: relative;
  z-index: 1;
}

.page-section {
  display: none;
}

.page-section.active {
  display: block;
  animation: fadeIn 0.4s ease;
}

/* âœ… ç»ç’ƒæ“¬æ…‹å¡ç‰‡ */
.dashboard-header,
.announcements-section,
.admin-card,
.course-filters,
.player-container,
.exam-container,
.charts-section {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-radius: 20px;
  padding: 30px;
  margin-bottom: 30px;
  
  /* ç²¾ç·»é™°å½± */
  box-shadow: 
    0 20px 50px rgba(0, 0, 0, 0.06),
    0 0 0 1px rgba(255, 255, 255, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  
  border: 1px solid rgba(255, 255, 255, 0.3);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.dashboard-header:hover,
.announcements-section:hover,
.admin-card:hover,
.charts-section:hover {
  transform: translateY(-5px);
  box-shadow: 
    0 30px 60px rgba(0, 0, 0, 0.08),
    0 0 0 1px rgba(255, 255, 255, 0.6),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
}

.dashboard-welcome {
  font-size: 32px;
  font-weight: 700;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 10px;
}

.dashboard-subtitle {
  color: var(--text-secondary);
  font-size: 16px;
}

/* âœ… æ™‚å°šçµ±è¨ˆå¡ç‰‡ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 25px;
  margin-bottom: 30px;
}

.stat-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-radius: 18px;
  padding: 28px;
  display: flex;
  align-items: center;
  gap: 20px;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  
  /* ç²¾ç·»é™°å½± */
  box-shadow: 
    0 10px 30px rgba(0, 0, 0, 0.05),
    0 0 0 1px rgba(255, 255, 255, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  
  border: 1px solid rgba(255, 255, 255, 0.3);
  position: relative;
  overflow: hidden;
}

/* å¡ç‰‡æ¼¸å±¤èƒŒæ™¯ */
.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gradient-primary);
  opacity: 0;
  transition: opacity 0.3s;
}

.stat-card:hover::before {
  opacity: 1;
}

.stat-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 
    0 20px 40px rgba(0, 0, 0, 0.08),
    0 0 0 1px rgba(255, 255, 255, 0.6),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
}

/* æ™‚å°šåœ–ç¤º */
.stat-icon {
  width: 70px;
  height: 70px;
  border-radius: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  color: white;
  position: relative;
  transition: all 0.3s;
}

.stat-card:hover .stat-icon {
  transform: scale(1.1) rotate(5deg);
}

.stat-icon.blue { 
  background: var(--gradient-primary);
  box-shadow: var(--shadow-primary);
}

.stat-icon.green { 
  background: var(--gradient-success);
  box-shadow: var(--shadow-success);
}

.stat-icon.orange { 
  background: var(--gradient-orange);
  box-shadow: var(--shadow-warning);
}

.stat-icon.red { 
  background: var(--gradient-warning);
  box-shadow: var(--shadow-danger);
}

.stat-info {
  flex: 1;
}

.stat-label {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 8px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-value {
  font-size: 36px;
  font-weight: 700;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* ==================== å‹•ç•«æ•ˆæœ ==================== */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(0);
  }
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}
    
    /* å…¬å‘Šå€å¡Š */
    .announcements-section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-title i {
      color: var(--primary-color);
    }
    
    .announcement-item {
      padding: 15px;
      border-left: 4px solid var(--primary-color);
      background: var(--light-color);
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .announcement-item.pinned {
      border-left-color: var(--danger-color);
      background: #fef2f2;
    }
    
    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .announcement-time {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .announcement-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      background: var(--danger-color);
      color: white;
    }
    
    .announcement-content {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.6;
    }
    
    /* èª²ç¨‹åˆ—è¡¨ */
    .course-filters {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    
    .filter-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .filter-group select,
    .filter-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
    }
    
    .courses-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
    }
    
.course-card {
  background: white;
  border-radius: 15px;
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  
  /* âœ… åŠ å¼·é™°å½± + é‚Šæ¡† */
  box-shadow: var(--shadow-md);
  border: 1px solid rgba(37, 99, 235, 0.1);
}

.course-card:hover {
  transform: translateY(-8px);
  box-shadow: var(--shadow-xl);
  border-color: rgba(37, 99, 235, 0.3);
}

/* âœ… èª²ç¨‹å¡ç‰‡ Header æ¼¸å±¤ */
.course-card-header {
  padding: 20px;
  background: var(--gradient-primary);
  color: white;
  position: relative;
  overflow: hidden;
}

/* âœ… æ–°å¢ï¼šHeader å‹•æ…‹å…‰æšˆ */
.course-card-header::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  animation: rotate 10s linear infinite;
}

@keyframes rotate {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.course-card-header.required {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.course-card-header.completed {
  background: var(--gradient-success);
}

    
    .course-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.3);
      margin-bottom: 10px;
    }
    
    .course-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .course-id {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .course-card-body {
      padding: 20px;
    }
    
    .course-desc {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 15px;
      line-height: 1.6;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .course-meta {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      font-size: 13px;
    }
    
    .course-meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--text-secondary);
    }
    
    .course-meta-item i {
      color: var(--primary-color);
    }
    
    .course-deadline {
      padding: 10px;
      background: var(--light-color);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 15px;
    }
    
    .course-deadline.warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .course-deadline.danger {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .course-actions {
      display: flex;
      gap: 10px;
    }
    
    .course-actions .btn {
      flex: 1;
    }
    
    /* ==================== èª²ç¨‹æ’­æ”¾å™¨ ==================== */
    .player-container {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    
    .player-header {
      padding: 25px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .player-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .player-meta {
      display: flex;
      gap: 20px;
      font-size: 14px;
      opacity: 0.9;
    }
    
    .player-body {
      padding: 30px;
    }
    
    .video-wrapper {
      position: relative;
      padding-bottom: 56.25%; /* 16:9 */
      height: 0;
      overflow: hidden;
      background: #000;
      border-radius: 10px;
      margin-bottom: 30px;
    }
    
    .video-wrapper iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .progress-bar {
      background: var(--light-color);
      border-radius: 10px;
      height: 30px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }
    
    .course-description {
      background: var(--light-color);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .course-description h3 {
      font-size: 16px;
      margin-bottom: 10px;
      color: var(--text-primary);
    }
    
    .course-description p {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    /* ==================== æ¸¬é©—é é¢ ==================== */
    .exam-container {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: var(--shadow);
      max-width: 800px;
      margin: 0 auto;
    }
    
    .exam-header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
    }
    
    .exam-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
    }
    
    .exam-info {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .question-card {
      background: var(--light-color);
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 25px;
    }
    
    .question-number {
      display: inline-block;
      background: var(--primary-color);
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .question-text {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .options-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .option-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .option-item:hover {
      border-color: var(--primary-color);
      background: #eff6ff;
    }
    
    .option-item input[type="radio"] {
      margin-right: 12px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .option-item label {
      flex: 1;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-primary);
    }
    
    .option-item.correct {
      border-color: var(--success-color);
      background: #f0fdf4;
    }
    
    .option-item.incorrect {
      border-color: var(--danger-color);
      background: #fef2f2;
    }
    
    .exam-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }
    
    /* æ¸¬é©—çµæœ */
    .exam-result {
      text-align: center;
      padding: 40px;
    }
    
    .result-icon {
      font-size: 80px;
      margin-bottom: 20px;
    }
    
    .result-icon.pass {
      color: var(--success-color);
    }
    
    .result-icon.fail {
      color: var(--danger-color);
    }
    
    .result-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .result-score {
      font-size: 48px;
      font-weight: 700;
      color: var(--primary-color);
      margin: 20px 0;
    }
    
    .result-details {
      background: var(--light-color);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }
    
    .result-detail-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .result-detail-item:last-child {
      border-bottom: none;
    }
    /* ==================== Sophiaå­¸ç¿’æ²™é¾æ¨£å¼ ==================== */

.sophia-header {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  border-radius: 20px;
  padding: 30px;
  margin-bottom: 30px;
  box-shadow: var(--shadow-lg);
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.sophia-filters {
  display: flex;
  gap: 15px;
  margin-top: 20px;
  flex-wrap: wrap;
  align-items: flex-end;
}

#customDateRange {
  display: flex;
  gap: 10px;
}

.sophia-dashboard {
  display: flex;
  flex-direction: column;
  gap: 30px;
}

.sophia-section {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  border-radius: 20px;
  padding: 30px;
  box-shadow: var(--shadow-lg);
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.sophia-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.sophia-card {
  background: white;
  border-radius: 15px;
  overflow: hidden;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--gray-200);
  transition: all 0.3s;
}

.sophia-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-xl);
}

.sophia-card .card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: var(--gradient-primary);
  color: white;
}

.sophia-card .card-header h3 {
  font-size: 16px;
  font-weight: 600;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sophia-card .card-badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  background: rgba(255, 255, 255, 0.3);
}

.sophia-card .card-body {
  padding: 20px;
}

/* åœç•™æ™‚é–“åˆ†æ */
.time-stats {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.time-stat-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  background: var(--gray-50);
  border-radius: 10px;
  transition: all 0.3s;
}

.time-stat-item:hover {
  background: var(--gray-100);
  transform: translateX(5px);
}

.time-stat-item .stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 20px;
}

.time-stat-item .stat-info {
  flex: 1;
}

.time-stat-item .stat-label {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 5px;
}

.time-stat-item .stat-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--text-primary);
}

/* æ’è¡Œæ¦œæ¨™ç±¤ */
.ranking-tabs {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  background: white;
  padding: 5px;
  border-radius: 10px;
  box-shadow: var(--shadow-sm);
}

.ranking-tab {
  flex: 1;
  padding: 10px 20px;
  border: none;
  background: transparent;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  transition: all 0.3s;
}

.ranking-tab:hover {
  background: var(--gray-100);
}

.ranking-tab.active {
  background: var(--gradient-primary);
  color: white;
}

/* æ’è¡Œæ¦œåˆ—è¡¨ */
.ranking-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.ranking-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 12px;
  background: var(--gray-50);
  border-radius: 8px;
  transition: all 0.3s;
}

.ranking-item:hover {
  background: var(--gray-100);
  transform: translateX(5px);
}

.ranking-item .rank {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 14px;
  color: white;
}

.ranking-item .rank.top1 {
  background: linear-gradient(135deg, #FFD700, #FFA500);
}

.ranking-item .rank.top2 {
  background: linear-gradient(135deg, #C0C0C0, #808080);
}

.ranking-item .rank.top3 {
  background: linear-gradient(135deg, #CD7F32, #8B4513);
}

.ranking-item .rank.other {
  background: var(--gray-400);
}

.ranking-item .course-name {
  flex: 1;
  font-size: 14px;
  color: var(--text-primary);
  font-weight: 500;
}

.ranking-item .value {
  font-size: 16px;
  font-weight: 700;
  color: var(--primary-color);
}

/* å­¸ç¿’æˆæ•ˆå ±è¡¨ */
.report-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
}

.report-stat-item {
  display: flex;
  flex-direction: column;
  gap: 5px;
  padding: 15px;
  background: var(--gray-50);
  border-radius: 8px;
}

.report-stat-item .stat-label {
  font-size: 12px;
  color: var(--text-secondary);
}

.report-stat-item .stat-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
}

.comparison-badge {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  background: rgba(255, 255, 255, 0.3);
}

.comparison-badge.positive {
  background: rgba(16, 185, 129, 0.2);
  color: #059669;
}

.comparison-badge.negative {
  background: rgba(239, 68, 68, 0.2);
  color: #dc2626;
}

/* å­¸ç¿’å»ºè­° */
.advice-container {
  padding: 20px;
  background: var(--gray-50);
  border-radius: 10px;
  min-height: 150px;
}

.loading-advice {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  color: var(--text-secondary);
  font-size: 14px;
}

.advice-content {
  line-height: 1.8;
  color: var(--text-primary);
}

.advice-content h4 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--primary-color);
}

.advice-content ul {
  margin-left: 20px;
  margin-top: 10px;
}

.advice-content li {
  margin-bottom: 8px;
}

/* æˆå°±ç³»çµ± */
.achievements-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.achievement-badge {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  padding: 20px;
  background: white;
  border-radius: 15px;
  box-shadow: var(--shadow-md);
  border: 2px solid transparent;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.achievement-badge.unlocked {
  border-color: var(--success-color);
}

.achievement-badge.locked {
  opacity: 0.5;
  filter: grayscale(100%);
}

.achievement-badge:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-xl);
}

.achievement-badge .badge-icon {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  color: white;
  background: var(--gradient-primary);
}

.achievement-badge .badge-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  text-align: center;
}

.achievement-badge .badge-desc {
  font-size: 12px;
  color: var(--text-secondary);
  text-align: center;
}

.achievement-badge .unlock-date {
  font-size: 11px;
  color: var(--success-color);
  margin-top: 5px;
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
  .sophia-grid {
    grid-template-columns: 1fr;
  }
  
  .sophia-filters {
    flex-direction: column;
    align-items: stretch;
  }
  
  #customDateRange {
    flex-direction: column;
  }
  
  .ranking-tabs {
    flex-direction: column;
  }
  
  .report-stats {
    grid-template-columns: 1fr;
  }
  
  .achievements-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  }
}

    /* ==================== ç®¡ç†å¾Œå° ==================== */
    .admin-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      background: white;
      padding: 10px;
      border-radius: 15px;
      box-shadow: var(--shadow);
    }
    
    .admin-tab {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: transparent;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.3s;
    }
    
    .admin-tab:hover {
      background: var(--light-color);
    }
    
    .admin-tab.active {
      background: var(--primary-color);
      color: white;
    }
    
    .admin-panel {
      display: none;
    }
    
    .admin-panel.active {
      display: block;
    }
    
    .admin-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }
    
    .admin-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
    }
    
    .admin-card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    /* è¡¨æ ¼ */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .data-table thead {
      background: var(--light-color);
    }
    
    .data-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
    }
    
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-secondary);
    }
    
    .data-table tbody tr:hover {
      background: var(--light-color);
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .status-badge.active {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-badge.inactive {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .status-badge.pass {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-badge.fail {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .btn-icon {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }
    
    .btn-icon i {
      pointer-events: none;
    }
    
    /* ==================== Modal ==================== */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  justify-content: center;
  align-items: center;
  padding: 20px;
  
  /* âœ… ç»ç’ƒæ“¬æ…‹èƒŒæ™¯ */
  background: rgba(37, 99, 235, 0.1);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

.modal-content {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.3s ease;
  
  /* âœ… åŠ å¼·é™°å½± */
  box-shadow: var(--shadow-xl);
  border: 1px solid rgba(37, 99, 235, 0.2);
}

    
    .modal.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
   
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }
    
    .modal-close:hover {
      background: var(--light-color);
      color: var(--text-primary);
    }
    
    .modal-body {
      margin-bottom: 20px;
    }
    
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
/* ==================== Loading & Alert ==================== */
.loading {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent; /* âœ… ç§»é™¤ç°è‰²é®ç½© */
  z-index: 99999;
  justify-content: center;
  align-items: center;
  pointer-events: none; /* âœ… å…è¨±é»æ“Šç©¿é€ */
}

.loading.active {
  display: flex;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  
  /* âœ… è—ç¶ æ¼¸å±¤é‚Šæ¡† */
  border: 5px solid transparent;
  border-top: 5px solid #2563eb;
  border-right: 5px solid #10b981;
  box-shadow: 
    0 0 20px rgba(37, 99, 235, 0.5),
    0 0 40px rgba(16, 185, 129, 0.3);
}


.alert {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 10px;
  box-shadow: var(--shadow-lg);
  z-index: 10000;
  display: none;
  animation: slideInRight 0.3s ease;
  max-width: 400px;
}

.alert.active {
  display: block;
}

.alert-success {
  background: var(--success-color);
  color: white;
}

.alert-error {
  background: var(--danger-color);
  color: white;
}

.alert-warning {
  background: var(--warning-color);
  color: white;
}

.alert-info {
  background: var(--info-color);
  color: white;
}

    
 
    
    /* ==================== Responsive ==================== */
    @media (max-width: 768px) {
      .navbar-menu {
        display: none;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .courses-grid {
        grid-template-columns: 1fr;
      }
      
      .filter-row {
        flex-direction: column;
      }
      
      .filter-group {
        width: 100%;
      }
      
      .admin-tabs {
        flex-direction: column;
      }
      
      .data-table {
        font-size: 12px;
      }
      
      .data-table th,
      .data-table td {
        padding: 8px;
      }
    }
    /* ==================== å­¸ç¿’ç´€éŒ„æ”¶æŠ˜æ¨£å¼ ==================== */

/* æ”¶æŠ˜æŒ‰éˆ•å®¹å™¨ */
#learningRecordToggleRow td {
  border-bottom: none !important;
}

/* æ”¶æŠ˜æŒ‰éˆ• */
#btnToggleLearningRecords {
  padding: 10px 25px;
  font-size: 14px;
  border-radius: 8px;
  transition: all 0.3s;
  cursor: pointer;
}

#btnToggleLearningRecords:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

/* éš±è—çš„ç´€éŒ„è¡Œå‹•ç•« */
.learning-record-hidden {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

    
    /* ==================== Utility Classes ==================== */
    .hidden {
      display: none !important;
    }
    
    .text-center {
      text-align: center;
    }
    
    .text-right {
      text-align: right;
    }
    
    .mt-10 { margin-top: 10px; }
    .mt-20 { margin-top: 20px; }
    .mt-30 { margin-top: 30px; }
    
    .mb-10 { margin-bottom: 10px; }
    .mb-20 { margin-bottom: 20px; }
    .mb-30 { margin-bottom: 30px; }
    
    .p-10 { padding: 10px; }
    .p-20 { padding: 20px; }
    .p-30 { padding: 30px; }

    /* ==================== éŒ¯èª¤é¡Œç›®æª¢è¨æ¨£å¼ ==================== */
.wrong-answer-item {
  background: #fff;
  border: 2px solid var(--border-color);
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  transition: all 0.3s;
}

.wrong-answer-item:hover {
  box-shadow: var(--shadow-lg);
  border-color: var(--danger-color);
}

.wrong-answer-item .question-number {
  display: inline-block;
  background: var(--danger-color);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 10px;
}

.wrong-answer-item .question-text {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 15px;
  line-height: 1.6;
}

.wrong-answer-item .answer-row {
  display: flex;
  align-items: center;
  padding: 10px 15px;
  border-radius: 8px;
  margin-bottom: 8px;
  font-size: 14px;
}

.wrong-answer-item .answer-row.your-answer {
  background: #fee2e2;
  border-left: 4px solid var(--danger-color);
}

.wrong-answer-item .answer-row.correct-answer {
  background: #d1fae5;
  border-left: 4px solid var(--success-color);
}

.wrong-answer-item .answer-label {
  font-weight: 600;
  margin-right: 10px;
  min-width: 100px;
}

.wrong-answer-item .answer-label.wrong {
  color: var(--danger-color);
}

.wrong-answer-item .answer-label.correct {
  color: var(--success-color);
}

.wrong-answer-item .answer-value {
  flex: 1;
  color: var(--text-primary);
}

.wrong-answer-item .answer-icon {
  font-size: 18px;
  margin-left: 10px;
}

.wrong-answer-item .answer-icon.wrong {
  color: var(--danger-color);
}

.wrong-answer-item .answer-icon.correct {
  color: var(--success-color);
}
    /* ==================== å­¸ç¿’é€²åº¦åœ–è¡¨æ¨£å¼ ==================== */
.charts-section {
  background: white;
  border-radius: 15px;
  padding: 25px;
  margin-bottom: 30px;
  box-shadow: var(--shadow);
}

.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 30px;
  margin-top: 20px;
}

.chart-container {
  background: var(--light-color);
  border-radius: 10px;
  padding: 20px;
  min-height: 300px;
}

.chart-container.full-width {
  grid-column: 1 / -1;
}

.chart-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.chart-title i {
  color: var(--primary-color);
}

.chart-canvas {
  position: relative;
  height: 250px;
}

.chart-canvas canvas {
  max-height: 250px;
}

.chart-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.chart-stat-item {
  background: white;
  border-radius: 8px;
  padding: 15px;
  text-align: center;
}

.chart-stat-label {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 5px;
}

.chart-stat-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--primary-color);
}

.chart-stat-value.success {
  color: var(--success-color);
}

.chart-stat-value.warning {
  color: var(--warning-color);
}

.chart-stat-value.danger {
  color: var(--danger-color);
}

/* ==================== éŸ¿æ‡‰å¼è¨­è¨ˆ ==================== */
@media (max-width: 768px) {
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  .chart-container.full-width {
    grid-column: 1;
  }
}

    /* ==================== æ‰‹æ©Ÿç‰ˆå„ªåŒ– ==================== */

/* å¹³æ¿ (768px - 1024px) */
@media (max-width: 1024px) {
  .navbar-menu {
    gap: 10px;
  }
  
  .navbar-item {
    padding: 6px 12px;
    font-size: 13px;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  .courses-grid {
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  }
}

/* æ‰‹æ©Ÿ (æœ€å¤§ 768px) */
@media (max-width: 768px) {
  /* å°èˆªåˆ— */
  .navbar-content {
    flex-direction: column;
    gap: 15px;
  }
  
  .navbar-brand {
    font-size: 26px;
  }
  
  .navbar-menu {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    width: 100%;
  }
  
  .navbar-item {
    flex: 1;
    min-width: 80px;
    text-align: center;
    padding: 8px 10px;
    font-size: 12px;
  }
  
  .navbar-user {
    width: 100%;
    justify-content: space-between;
    padding: 10px;
  }
  
  .navbar-user-info {
    text-align: left;
  }
/* æ‰‹æ©Ÿ (æœ€å¤§ 768px) */
@media (max-width: 768px) {
  /* èª¿æ•´æ­¡è¿åœ–ç‰‡å¤§å° */
  .dashboard-header img {
    max-height: 120px !important; /* ç¸®å°åˆ° 120px */
  }
  
  /* èª¿æ•´æ–‡å­—å€å¡Š */
  .dashboard-header {
    flex-direction: column !important;
    text-align: center; /* æ–‡å­—ç½®ä¸­ */
  }
}



  
  /* å„€éŒ¶æ¿ */
  .dashboard-header {
    padding: 20px;
  }
  
  .dashboard-welcome {
    font-size: 20px;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .stat-card {
    padding: 20px;
  }
  
  .stat-icon {
    width: 50px;
    height: 50px;
    font-size: 24px;
  }
  
  .stat-value {
    font-size: 24px;
  }
  
  /* åœ–è¡¨ */
  .charts-section {
    padding: 20px;
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .chart-container {
    padding: 15px;
  }
  
  .chart-canvas {
    height: 200px !important;
  }
  
  .chart-title {
    font-size: 14px;
  }
  
  .chart-stats {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  .chart-stat-item {
    padding: 12px;
  }
  
  .chart-stat-value {
    font-size: 20px;
  }
  
  /* èª²ç¨‹åˆ—è¡¨ */
  .courses-grid {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .course-card-header {
    padding: 15px;
  }
  
  .course-title {
    font-size: 16px;
  }
  
  .course-card-body {
    padding: 15px;
  }
  
  /* èª²ç¨‹ç¯©é¸ */
  .filter-row {
    flex-direction: column;
    gap: 10px;
  }
  
  .filter-group {
    width: 100%;
    min-width: auto;
  }
  
  /* æ’­æ”¾å™¨ */
  .player-header {
    padding: 20px;
  }
  
  .player-title {
    font-size: 20px;
  }
  
  .player-meta {
    flex-direction: column;
    gap: 10px;
    font-size: 13px;
  }
  
  .player-body {
    padding: 20px;
  }
  
  #videoTimeInfo {
    padding: 15px;
  }
  
  #videoTimeInfo > div {
    grid-template-columns: 1fr !important;
    gap: 10px;
  }
  
  /* æ¸¬é©— */
  .exam-container {
    padding: 20px;
  }
  
  .exam-title {
    font-size: 20px;
  }
  
  .question-card {
    padding: 20px;
  }
  
  .question-text {
    font-size: 15px;
  }
  
  .option-item {
    padding: 12px;
  }
  
  /* ç®¡ç†å¾Œå° */
  .admin-tabs {
    flex-direction: column;
    padding: 5px;
  }
  
  .admin-tab {
    padding: 10px;
    font-size: 13px;
  }
  
  .data-table {
    font-size: 12px;
    display: block;
    overflow-x: auto;
  }
  
  .data-table th,
  .data-table td {
    padding: 8px;
    white-space: nowrap;
  }
  
  /* Modal */
  .modal-content {
    padding: 20px;
    max-width: 95%;
  }
  
  .modal-title {
    font-size: 18px;
  }
  
  /* æŒ‰éˆ• */
  .btn {
    padding: 10px 20px;
    font-size: 13px;
  }
  
  .course-actions {
    flex-direction: column;
  }
  
  .course-actions .btn {
    width: 100%;
  }
  
  .exam-actions {
    flex-direction: column;
  }
  
  .exam-actions .btn {
    width: 100%;
  }
}

/* å°æ‰‹æ©Ÿ (æœ€å¤§ 480px) */
@media (max-width: 480px) {
  .navbar-brand {
    font-size: 22px;
  }
  
  .navbar-brand i {
    font-size: 24px;
  }
  
  .navbar-item {
    font-size: 11px;
    padding: 6px 8px;
  }
  
  .dashboard-welcome {
    font-size: 18px;
  }
  
  .stat-value {
    font-size: 20px;
  }
  
  .chart-canvas {
    height: 180px !important;
  }
  
  .course-title {
    font-size: 15px;
  }
  
  .player-title {
    font-size: 18px;
  }
  
  .exam-title {
    font-size: 18px;
  }
  
  .modal-content {
    padding: 15px;
  }
}

/* âœ… æ©«å‘æ¨¡å¼å„ªåŒ– */
@media (max-width: 768px) and (orientation: landscape) {
  .video-wrapper {
    padding-bottom: 45% !important;
  }
  
  .chart-canvas {
    height: 150px !important;
  }
}
/* âœ… æ–°å¢ï¼šå¹³æ»‘éæ¸¡å‹•ç•« */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(0);
  }
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* âœ… æ–°å¢ï¼šæ³¢æµªå‹•ç•« */
@keyframes wave {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-10px);
  }
}

/* âœ… æ–°å¢ï¼šè„ˆè¡å‹•ç•« */
@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

    /* ==================== ä½¿ç”¨è€…ä¸‹æ‹‰é¸å–®æ¨£å¼ ==================== */

/* é¸å–®å®¹å™¨ */
.user-menu-container {
  position: relative;
}

/* ä¸‹æ‹‰é¸å–® */
.user-dropdown-menu {
  position: absolute;
  top: calc(100% + 10px);
  right: 0;
  min-width: 200px;
  background: white;
  border-radius: 12px;
  box-shadow: 
    0 10px 30px rgba(0, 0, 0, 0.15),
    0 0 0 1px rgba(0, 0, 0, 0.05);
  padding: 8px;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 10000;
}

/* é¡¯ç¤ºç‹€æ…‹ */
.user-dropdown-menu.active {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

/* é¸å–®é …ç›® */
.dropdown-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--text-primary);
  font-size: 14px;
  font-weight: 500;
}

.dropdown-item:hover {
  background: var(--gray-100);
  color: var(--primary-color);
  transform: translateX(5px);
}

.dropdown-item i {
  font-size: 16px;
  width: 20px;
  text-align: center;
  color: var(--primary-color);
}

/* åˆ†éš”ç·š */
.dropdown-divider {
  height: 1px;
  background: var(--gray-200);
  margin: 8px 0;
}

/* ç™»å‡ºæŒ‰éˆ•èª¿æ•´ */
.btn-logout {
  display: flex;
  align-items: center;
  gap: 5px;
}

/* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
@media (max-width: 768px) {
  .user-dropdown-menu {
    min-width: 180px;
    right: -10px;
  }
  
  .dropdown-item {
    padding: 10px 14px;
    font-size: 13px;
  }
}


  </style>
</head>
<body>

  <!-- Loading å‹•ç•« -->
  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
  </div>

  <!-- Alert é€šçŸ¥ -->
  <div id="alert" class="alert"></div>

  <!-- ==================== ç™»å…¥é é¢ ==================== -->
  <div id="loginPage" class="login-container">
    <div class="login-box">
      <div class="login-header">
  <img src="R0.png" alt="Logo" style="width: 80px; height: 80px; object-fit: contain; margin-bottom: 20px;">
  <h1>GAIæ˜¶é’å¤§å­¸</h1>
  <p>è«‹ä½¿ç”¨æ‚¨çš„å·¥è™Ÿå’Œå¯†ç¢¼ç™»å…¥</p>
</div>

      
      <form id="loginForm">
        <div class="form-group">
          <label for="empId">
            <i class="fas fa-user"></i> å·¥è™Ÿ
          </label>
          <input type="text" id="empId" placeholder="è«‹è¼¸å…¥å·¥è™Ÿ" required>
        </div>
        
        <div class="form-group">
          <label for="password">
            <i class="fas fa-lock"></i> å¯†ç¢¼
          </label>
          <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
        </div>
        
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-sign-in-alt"></i> ç™»å…¥
        </button>
        <!-- ğŸ¨ æ–°å¢ç‰ˆæ¬Šæ–‡å­— -->
                <div class="login-footer">
                    Designed by TCC.ç®¡ç†æœ¬éƒ¨
                </div>
      </form>
    </div>
  </div>

  <!-- ==================== ä¸»æ‡‰ç”¨ç¨‹å¼ ==================== -->
  <div id="appContainer" class="app-container">
    
    <!-- é ‚éƒ¨å°èˆªåˆ— -->
    <nav class="navbar">
      <div class="navbar-content">
        <div class="navbar-brand">
  <img src="R0.png" alt="Logo" style="width: 80px; height: 80px; object-fit: contain; margin-right: 10px;">
  <span>GAIæ˜¶é’å¤§å­¸</span>
</div>

        
        <div class="navbar-menu">
          <div class="navbar-item active" data-page="dashboard">
            <i class="fas fa-home"></i> é¦–é 
          </div>
          <div class="navbar-item" data-page="courses">
            <i class="fas fa-book"></i> èª²ç¨‹
          </div>
          <div class="navbar-item" data-page="mylearning">
            <i class="fas fa-chart-line"></i> æˆ‘çš„å­¸ç¿’
          </div>
          <div class="navbar-item" data-page="sophia">
            <i class="fas fa-chart-pie"></i> Sophiaçš„è·å ´å­¸ç¿’æ²™é¾
          </div>

          <div class="navbar-item admin-only hidden" data-page="admin">
            <i class="fas fa-cog"></i> ç®¡ç†å¾Œå°
          </div>
        </div>
        
<div class="navbar-user">
  <div class="navbar-user-info">
    <div class="navbar-user-name" id="userName">ä½¿ç”¨è€…</div>
    <div class="navbar-user-dept" id="userDept">éƒ¨é–€</div>
  </div>
  <div class="navbar-user-avatar" id="userAvatar">U</div>
  
  <!-- âœ… æ–°å¢ï¼šä¸‹æ‹‰é¸å–®å®¹å™¨ -->
  <div class="user-menu-container">
    <button class="btn-logout" onclick="toggleUserMenu(event)">
      <i class="fas fa-sign-out-alt"></i> ç™»å‡º
      <i class="fas fa-chevron-down" style="margin-left: 5px; font-size: 12px;"></i>
    </button>
    
    <!-- âœ… ä¸‹æ‹‰é¸å–® -->
    <div id="userDropdownMenu" class="user-dropdown-menu">
      <div class="dropdown-item" onclick="showChangePasswordModal(); closeUserMenu();">
        <i class="fas fa-key"></i>
        <span>ä¿®æ”¹å¯†ç¢¼</span>
      </div>
      <div class="dropdown-divider"></div>
      <div class="dropdown-item" onclick="logout(); closeUserMenu();">
        <i class="fas fa-sign-out-alt"></i>
        <span>ç™»å‡º</span>
      </div>
    </div>
  </div>
</div>


      </div>
    </nav>

    <!-- ä¸»å…§å®¹å€ -->
    <div class="main-content">
      
      <!-- ==================== å„€éŒ¶æ¿é é¢ ==================== -->
 <div id="dashboardPage" class="page-section active">
  <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
    <!-- âœ… æ–‡å­—å€å¡Šï¼ˆåœ¨å·¦å´ç©ºé–“ä¸­ç½®ä¸­ï¼‰ -->
    <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;">
      <h1 class="dashboard-welcome">å—¨~æ­¡è¿å›ä¾†,<span id="welcomeName"></span>!</h1>
      <p class="dashboard-subtitle">ç¹¼çºŒæ‚¨çš„æ˜¶é’å­¸ç¿’æ—…ç¨‹</p>
    </div>
    
    <!-- âœ… åœ–ç‰‡ + æ–‡å­—å®¹å™¨ï¼ˆä¿æŒåœ¨å³å´ï¼‰ -->
    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; flex-shrink: 0;">
      <img src="R1.png" alt="Welcome" style="max-height: 200px; width: auto; object-fit: contain;">
      <div style="text-align: center; font-size: 14px; color: #6b7280; line-height: 1.5;">
        GAIæ˜¶é’å¤§å­¸-æ•¸ä½æ•™å‹™é•·<br>Sophia
      </div>
    </div>
  </div>




        <button class="btn btn-secondary btn-sm" onclick="refreshDashboard()" title="é‡æ–°æ•´ç†">
    <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
  </button>
        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon blue">
              <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">ç´¯ç©é»æ•¸</div>
              <div class="stat-value" id="totalPoints">0</div>
            </div>
          </div>
          
          
          <div class="stat-card">
            <div class="stat-icon green">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">å·²å®Œæˆèª²ç¨‹</div>
              <div class="stat-value" id="completedCount">0</div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon orange">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">é€²è¡Œä¸­èª²ç¨‹</div>
              <div class="stat-value" id="inProgressCount">0</div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon red">
              <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">å¾…å®Œæˆå¿…ä¿®</div>
              <div class="stat-value" id="requiredCount">0</div>
            </div>
          </div>
        </div>
        
        <!-- å…¬å‘Šå€å¡Š -->
        <div class="announcements-section">
          <h2 class="section-title">
            <i class="fas fa-bullhorn"></i>
            æœ€æ–°å…¬å‘Š
          </h2>
          <div id="announcementsList"></div>
        </div>
         <!-- âœ… æ–°å¢ï¼šå­¸ç¿’é€²åº¦åœ–è¡¨ -->
<div class="charts-section">
  <h2 class="section-title">
    <i class="fas fa-chart-line"></i>
    å­¸ç¿’é€²åº¦åˆ†æ
  </h2>
  
  <div class="charts-grid">
    <!-- æ¯æœˆå®Œæˆèª²ç¨‹æ•¸ -->
    <div class="chart-container">
      <div class="chart-title">
        <i class="fas fa-calendar-check"></i>
        æ¯æœˆå®Œæˆèª²ç¨‹æ•¸
      </div>
      <div class="chart-canvas">
        <canvas id="monthlyCoursesChart"></canvas>
      </div>
    </div>
    
    <!-- ç´¯ç©é»æ•¸è¶¨å‹¢ -->
    <div class="chart-container">
      <div class="chart-title">
        <i class="fas fa-trophy"></i>
        ç´¯ç©é»æ•¸è¶¨å‹¢
      </div>
      <div class="chart-canvas">
        <canvas id="pointsTrendChart"></canvas>
      </div>
    </div>
    
    <!-- éƒ¨é–€å®Œæˆç‡çµ±è¨ˆ -->
    <div class="chart-container full-width">
      <div class="chart-title">
        <i class="fas fa-building"></i>
        éƒ¨é–€å®Œæˆç‡çµ±è¨ˆ
      </div>
      <div class="chart-canvas" style="height: 300px;">
        <canvas id="departmentStatsChart"></canvas>
      </div>
      <div class="chart-stats">
        <div class="chart-stat-item">
          <div class="chart-stat-label">å¹³å‡å®Œæˆç‡</div>
          <div class="chart-stat-value" id="avgCompletionRate">0%</div>
        </div>
        <div class="chart-stat-item">
          <div class="chart-stat-label">æœ€é«˜å®Œæˆç‡</div>
          <div class="chart-stat-value success" id="maxCompletionRate">0%</div>
        </div>
        <div class="chart-stat-item">
          <div class="chart-stat-label">æœ€ä½å®Œæˆç‡</div>
          <div class="chart-stat-value danger" id="minCompletionRate">0%</div>
        </div>
      </div>
    </div>
  </div>
</div>
        
        <!-- å¾…å®Œæˆå¿…ä¿®èª²ç¨‹ -->
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">
              <i class="fas fa-exclamation-triangle"></i> å¾…å®Œæˆå¿…ä¿®èª²ç¨‹
            </h3>
          </div>
          <div id="requiredCoursesList"></div>
        </div>
        
        <!-- é€²è¡Œä¸­çš„èª²ç¨‹ -->
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">
              <i class="fas fa-play-circle"></i> é€²è¡Œä¸­çš„èª²ç¨‹
            </h3>
          </div>
          <div id="inProgressCoursesList"></div>
        </div>
        
      </div>

     

      <!-- ==================== èª²ç¨‹ç€è¦½é é¢ ==================== -->
      <div id="coursesPage" class="page-section">
        <!-- ç¯©é¸å™¨ -->
        <div class="course-filters">
          <div class="filter-row">
             <div class="form-group">
            <label>èª²ç¾¤ *</label>
            <select id="filterCourseGroup">
              <option value="">è«‹é¸æ“‡</option>
              <!-- å‹•æ…‹è¼‰å…¥é¸é … -->
            </select>
          </div>
            
            <div class="form-group">
            <label>èª²é–€ *</label>
             <select id="filterCourseCategory">
              <option value="">è«‹é¸æ“‡</option>
              <!-- å‹•æ…‹è¼‰å…¥é¸é … -->
            </select>
          </div>
            
            <div class="filter-group">
              <label>èª²ç¨‹é¡å‹</label>
              <select id="filterCourseType">
                <option value="">å…¨éƒ¨</option>
                <option value="required">å¿…ä¿®</option>
                <option value="optional">é¸ä¿®</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>ç‹€æ…‹</label>
              <select id="filterStatus">
                <option value="">å…¨éƒ¨</option>
                <option value="notStarted">æœªé–‹å§‹</option>
                <option value="inProgress">é€²è¡Œä¸­</option>
                <option value="completed">å·²å®Œæˆ</option>
              </select>
            </div>
            
            <div class="filter-group" style="display: flex; align-items: flex-end;">
              <button class="btn btn-primary" onclick="applyCourseFilters()">
                <i class="fas fa-search"></i> æœå°‹
              </button>
            </div>
          </div>
        </div>
        
        <!-- èª²ç¨‹åˆ—è¡¨ -->
        <div id="coursesList" class="courses-grid"></div>
      </div>

      <!-- ==================== èª²ç¨‹æ’­æ”¾é é¢ ==================== -->
      <div id="playerPage" class="page-section">
        <div class="player-container">
          <div class="player-header">
            <h1 class="player-title" id="playerCourseTitle">èª²ç¨‹åç¨±</h1>
            <div class="player-meta">
              <span><i class="fas fa-tag"></i> <span id="playerCourseId"></span></span>
              <span><i class="fas fa-star"></i> <span id="playerCoursePoints"></span> é»</span>
              <span><i class="fas fa-calendar"></i> æˆªæ­¢æ—¥æœŸ: <span id="playerDeadline"></span></span>
            </div>
          </div>
          
          <div class="player-body">
          <!-- å½±ç‰‡æ’­æ”¾å™¨ -->
          <div class="video-wrapper" id="videoWrapper">
            <iframe id="videoPlayer" 
                    src="" 
                    frameborder="0" 
                    allow="autoplay; encrypted-media" 
                    allowfullscreen>
            </iframe>
          </div>
          
          <!-- âœ… æ–°å¢ï¼šé–‹å§‹æ’­æ”¾æŒ‰éˆ• -->
<div id="videoControlPanel" style="margin-top: 15px; text-align: center;">
  <button id="btnStartWatching" class="btn btn-primary" style="padding: 10px 30px; font-size: 16px;">
    â–¶ï¸ é–‹å§‹æ’­æ”¾ä¸¦è¨ˆæ™‚
  </button>
  <div id="videoStatus" style="margin-top: 10px; color: #666; font-size: 14px;">
    è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹è§€çœ‹å½±ç‰‡
  </div>
</div>

<!-- âœ… æ–°å¢ï¼šæ™‚é–“è³‡è¨Šé¡¯ç¤ºå€å¡Š -->
<div id="videoTimeInfo" style="margin-top: 20px; background: #f8f9fa; border-radius: 10px; padding: 20px; display: none;">
  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
    <!-- å½±ç‰‡ç¸½é•·åº¦ -->
    <div style="text-align: center;">
      <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">
        <i class="fas fa-video"></i> å½±ç‰‡ç¸½é•·åº¦
      </div>
      <div id="totalDuration" style="font-size: 24px; font-weight: 700; color: #2563eb;">
        0:00
      </div>
    </div>
    
    <!-- å·²è§€çœ‹æ™‚é–“ -->
    <div style="text-align: center;">
      <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">
        <i class="fas fa-clock"></i> å·²è§€çœ‹æ™‚é–“
      </div>
      <div id="watchedTime" style="font-size: 24px; font-weight: 700; color: #10b981;">
        0:00
      </div>
    </div>
    
    <!-- å‰©é¤˜æ™‚é–“ -->
    <div style="text-align: center;">
      <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">
        <i class="fas fa-hourglass-half"></i> å‰©é¤˜æ™‚é–“
      </div>
      <div id="remainingTime" style="font-size: 24px; font-weight: 700; color: #f59e0b;">
        0:00
      </div>
    </div>
  </div>
  
  <!-- é€²åº¦ç™¾åˆ†æ¯” -->
  <div style="margin-top: 15px; text-align: center; font-size: 14px; color: #6b7280;">
    å·²å®Œæˆ <span id="progressPercent" style="font-weight: 700; color: #2563eb;">0%</span>
  </div>
</div>


            
            <!-- é€²åº¦æ¢ -->
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width: 0%">
                0%
              </div>
            </div>
            
            <!-- èª²ç¨‹èªªæ˜ -->
            <div class="course-description">
              <h3><i class="fas fa-info-circle"></i> èª²ç¨‹èªªæ˜</h3>
              <p id="playerCourseDesc"></p>
            </div>
            
            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="course-actions">
              <button class="btn btn-secondary" onclick="backToCourses()">
                <i class="fas fa-arrow-left"></i> è¿”å›èª²ç¨‹åˆ—è¡¨
              </button>
              <button class="btn btn-success" id="btnStartExam" onclick="startExam()" disabled>
                <i class="fas fa-pencil-alt"></i> é–‹å§‹æ¸¬é©—
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== æ¸¬é©—é é¢ ==================== -->
      <div id="examPage" class="page-section">
        <div class="exam-container">
          <div class="exam-header">
            <h1 class="exam-title" id="examCourseTitle">èª²ç¨‹æ¸¬é©—</h1>
            <p class="exam-info">
              è«‹ä»”ç´°é–±è®€æ¯å€‹é¡Œç›®,é¸æ“‡æ­£ç¢ºç­”æ¡ˆã€‚åŠæ ¼åˆ†æ•¸: <strong id="examPassScore">60</strong> åˆ†
            </p>
          </div>
          
          <div id="examQuestions"></div>
          
          <div class="exam-actions">
            <button class="btn btn-secondary" onclick="backToPlayer()">
              <i class="fas fa-arrow-left"></i> è¿”å›èª²ç¨‹
            </button>
            <button class="btn btn-primary" onclick="submitExam()">
              <i class="fas fa-check"></i> æäº¤æ¸¬é©—
            </button>
          </div>
        </div>
      </div>

      <!-- ==================== æˆ‘çš„å­¸ç¿’é é¢ ==================== -->
      <div id="mylearningPage" class="page-section">
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">
              <i class="fas fa-history"></i> å­¸ç¿’ç´€éŒ„
            </h3>
          </div>
          
          <table class="data-table">
            <thead>
              <tr>
                <th>èª²ç¨‹åç¨±</th>
                <th>é–‹å§‹æ™‚é–“</th>
                <th>å®Œæˆæ™‚é–“</th>
                <th>æ¸¬é©—åˆ†æ•¸</th>
                <th>ç²å¾—é»æ•¸</th>
                <th>ç‹€æ…‹</th>
              </tr>
            </thead>
            <tbody id="myLearningRecords">
              <tr>
                <td colspan="6" class="text-center">è¼‰å…¥ä¸­...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">
              <i class="fas fa-coins"></i> é»æ•¸ç´€éŒ„
            </h3>
          </div>
          
          <table class="data-table">
            <thead>
              <tr>
                <th>èª²ç¨‹åç¨±</th>
                <th>ç²å¾—é»æ•¸</th>
                <th>ç²å¾—æ™‚é–“</th>
              </tr>
            </thead>
            <tbody id="myPointRecords">
              <tr>
                <td colspan="3" class="text-center">è¼‰å…¥ä¸­...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ==================== Sophiaå­¸ç¿’æ²™é¾é é¢ ==================== -->
<div id="sophiaPage" class="page-section">
  
  <!-- é é¢æ¨™é¡Œ -->
  <div class="sophia-header">
    <div style="display: flex; align-items: center; gap: 20px;">
      <img src="R1.png" alt="Sophia" style="width: 80px; height: 80px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
      <div>
        <h1 style="font-size: 32px; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px;">
          Sophia è·å ´å­¸ç¿’æ²™é¾ ğŸ“Š
        </h1>
        <p style="color: var(--text-secondary); font-size: 16px;">
          æ·±å…¥åˆ†ææ‚¨çš„å­¸ç¿’æ•¸æ“šï¼Œç™¼ç¾æˆé•·è»Œè·¡
        </p>
      </div>
    </div>
    
    <!-- æ™‚é–“ç¯„åœç¯©é¸å™¨ -->
    <div class="sophia-filters">
      <div class="filter-group">
        <label><i class="fas fa-calendar-alt"></i> æ™‚é–“ç¯„åœ</label>
        <select id="sophiaTimeRange" onchange="loadSophiaData()">
          <option value="3months">æœ€è¿‘ 3 å€‹æœˆ</option>
          <option value="1month">æœ€è¿‘ 1 å€‹æœˆ</option>
          <option value="6months">æœ€è¿‘ 6 å€‹æœˆ</option>
          <option value="1year">æœ€è¿‘ 1 å¹´</option>
          <option value="custom">è‡ªè¨‚ç¯„åœ</option>
        </select>
      </div>
      
      <!-- è‡ªè¨‚æ™‚é–“ç¯„åœ -->
      <div id="customDateRange" style="display: none; gap: 10px;">
        <div class="filter-group">
          <label>é–‹å§‹æ—¥æœŸ</label>
          <input type="date" id="sophiaStartDate">
        </div>
        <div class="filter-group">
          <label>çµæŸæ—¥æœŸ</label>
          <input type="date" id="sophiaEndDate">
        </div>
        <button class="btn btn-primary btn-sm" onclick="loadSophiaData()">
          <i class="fas fa-search"></i> æŸ¥è©¢
        </button>
      </div>
      
      <button class="btn btn-secondary btn-sm" onclick="loadSophiaData()" title="æŒ‰æˆ‘æ›´æ–°">
        <i class="fas fa-sync-alt"></i> æŒ‰æˆ‘æ›´æ–°
      </button>
    </div>
  </div>
  
  <!-- å„€éŒ¶æ¿å®¹å™¨ -->
  <div class="sophia-dashboard">
    
   <!-- ç¬¬é›¶æ’ï¼šå­¸ç¿’å»ºè­° -->
    <div class="sophia-section">
      <h2 class="section-title">
        <i class="fas fa-lightbulb"></i> Sophia çš„è·è¨“å»ºè­°
      </h2>
      
      <div class="sophia-card">
        <div class="card-body">
          <div id="learningAdvice" class="advice-container">
            <div class="loading-advice">
              <i class="fas fa-spinner fa-spin"></i> Sophia æ­£åœ¨åˆ†ææ‚¨çš„å­¸ç¿’æ•¸æ“š...
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- ç¬¬ä¸€æ’ï¼šå€‹äººå­¸ç¿’è¡Œç‚ºåˆ†æ -->
    <div class="sophia-section">
      <h2 class="section-title">
        <i class="fas fa-user-chart"></i> å€‹äººå­¸ç¿’è¡Œç‚ºåˆ†æ
      </h2>
      
      <div class="sophia-grid">
        <!-- è§€çœ‹æ™‚æ®µåˆ†æ -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-clock"></i> è§€çœ‹æ™‚æ®µåˆ†æ</h3>
            <span class="card-badge">è¶¨å‹¢</span>
          </div>
          <div class="card-body">
            <canvas id="watchTimeChart"></canvas>
          </div>
        </div>
        
        <!-- åœç•™æ™‚é–“åˆ†æ -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-hourglass-half"></i> åœç•™æ™‚é–“åˆ†æ</h3>
            <span class="card-badge">çµ±è¨ˆ</span>
          </div>
          <div class="card-body">
            <div class="time-stats">
              <div class="time-stat-item">
                <div class="stat-icon" style="background: var(--gradient-primary);">
                  <i class="fas fa-play"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-label">ç¸½åœç•™æ™‚é–“</div>
                  <div class="stat-value" id="totalStayTime">0 å°æ™‚</div>
                </div>
              </div>
              
              <div class="time-stat-item">
                <div class="stat-icon" style="background: var(--gradient-success);">
                  <i class="fas fa-check"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-label">æœ‰æ•ˆå­¸ç¿’æ™‚é–“</div>
                  <div class="stat-value" id="effectiveTime">0 å°æ™‚</div>
                </div>
              </div>
              
              <div class="time-stat-item">
                <div class="stat-icon" style="background: var(--gradient-warning);">
                  <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-label">å¹³å‡æ¯æ¬¡å­¸ç¿’æ™‚é•·</div>
                  <div class="stat-value" id="avgSessionTime">0 åˆ†é˜</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- å­¸ç¿’ç¿’æ…£åˆ†æ -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-calendar-week"></i> å­¸ç¿’ç¿’æ…£åˆ†æ</h3>
            <span class="card-badge">ç¿’æ…£</span>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div>
                <canvas id="weekdayChart"></canvas>
                <p style="text-align: center; margin-top: 10px; color: var(--text-secondary); font-size: 13px;">
                  æœ€å¸¸å­¸ç¿’çš„æ˜ŸæœŸå¹¾
                </p>
              </div>
              <div>
                <canvas id="courseTypeChart"></canvas>
                <p style="text-align: center; margin-top: 10px; color: var(--text-secondary); font-size: 13px;">
                  æœ€å¸¸å­¸ç¿’çš„èª²ç¨‹é¡å‹
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ç¬¬äºŒæ’ï¼šèª²ç¨‹ç†±é–€åº¦æ’è¡Œ -->
    <div class="sophia-section">
      <h2 class="section-title">
        <i class="fas fa-fire"></i> èª²ç¨‹ç†±é–€åº¦æ’è¡Œ
      </h2>
      
      <!-- æ™‚é–“ç¯„åœåˆ‡æ› -->
      <div class="ranking-tabs">
        <button class="ranking-tab active" data-period="week" onclick="switchRankingPeriod('week')">
          æœ¬é€±
        </button>
        <button class="ranking-tab" data-period="month" onclick="switchRankingPeriod('month')">
          æœ¬æœˆ
        </button>
        <button class="ranking-tab" data-period="quarter" onclick="switchRankingPeriod('quarter')">
          æœ¬å­£
        </button>
        <button class="ranking-tab" data-period="year" onclick="switchRankingPeriod('year')">
          æœ¬å¹´
        </button>
      </div>
      
      <div class="sophia-grid">
        <!-- è§€çœ‹æ¬¡æ•¸æ’è¡Œ -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-eye"></i> è§€çœ‹æ¬¡æ•¸æ’è¡Œ</h3>
            <span class="card-badge">TOP 10</span>
          </div>
          <div class="card-body">
            <div id="viewCountRanking" class="ranking-list"></div>
          </div>
        </div>
        
        <!-- å®Œæˆç‡æ’è¡Œ -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-check-circle"></i> å®Œæˆç‡æ’è¡Œ</h3>
            <span class="card-badge">TOP 10</span>
          </div>
          <div class="card-body">
            <div id="completionRateRanking" class="ranking-list"></div>
          </div>
        </div>
        
        <!-- å¹³å‡åˆ†æ•¸æ’è¡Œ -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-star"></i> å¹³å‡åˆ†æ•¸æ’è¡Œ</h3>
            <span class="card-badge">TOP 10</span>
          </div>
          <div class="card-body">
            <div id="avgScoreRanking" class="ranking-list"></div>
          </div>
        </div>
        
        <!-- å­¸ç¿’æ™‚é•·æ’è¡Œ -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-clock"></i> å­¸ç¿’æ™‚é•·æ’è¡Œ</h3>
            <span class="card-badge">TOP 10</span>
          </div>
          <div class="card-body">
            <div id="studyTimeRanking" class="ranking-list"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ç¬¬ä¸‰æ’ï¼šå­¸ç¿’æˆæ•ˆå ±è¡¨ -->
    <div class="sophia-section">
      <h2 class="section-title">
        <i class="fas fa-chart-bar"></i> å­¸ç¿’æˆæ•ˆå ±è¡¨
      </h2>
      
      <div class="sophia-grid">
        <!-- å­¸ç¿’æ™‚æ•¸çµ±è¨ˆ -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-clock"></i> å­¸ç¿’æ™‚æ•¸çµ±è¨ˆ</h3>
            <div class="comparison-badge" id="timeComparison">
              <i class="fas fa-arrow-up"></i> +0%
            </div>
          </div>
          <div class="card-body">
            <div class="report-stats">
              <div class="report-stat-item">
                <span class="stat-label">ç¸½æ™‚æ•¸</span>
                <span class="stat-value" id="reportTotalHours">0 å°æ™‚</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">å¹³å‡æ¯æ—¥æ™‚æ•¸</span>
                <span class="stat-value" id="reportAvgDailyHours">0 å°æ™‚</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">èˆ‡ä¸Šæœˆæ¯”è¼ƒ</span>
                <span class="stat-value" id="reportMonthComparison">-</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">èˆ‡éƒ¨é–€å¹³å‡æ¯”è¼ƒ</span>
                <span class="stat-value" id="reportDeptComparison">-</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- èª²ç¨‹å®Œæˆæ•¸ -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-check-double"></i> èª²ç¨‹å®Œæˆæ•¸</h3>
            <div class="comparison-badge" id="courseComparison">
              <i class="fas fa-arrow-up"></i> +0%
            </div>
          </div>
          <div class="card-body">
            <div class="report-stats">
              <div class="report-stat-item">
                <span class="stat-label">å·²å®Œæˆ</span>
                <span class="stat-value" id="reportCompleted">0 é–€</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">é€²è¡Œä¸­</span>
                <span class="stat-value" id="reportInProgress">0 é–€</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">æœªé–‹å§‹</span>
                <span class="stat-value" id="reportNotStarted">0 é–€</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">å¿…ä¿®å®Œæˆç‡</span>
                <span class="stat-value" id="reportRequiredRate">0%</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- æ¸¬é©—æˆç¸¾çµ±è¨ˆ -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-graduation-cap"></i> æ¸¬é©—æˆç¸¾çµ±è¨ˆ</h3>
          </div>
          <div class="card-body">
            <div class="report-stats">
              <div class="report-stat-item">
                <span class="stat-label">å¹³å‡åˆ†æ•¸</span>
                <span class="stat-value" id="reportAvgScore">0 åˆ†</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">åŠæ ¼ç‡</span>
                <span class="stat-value" id="reportPassRate">0%</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">æœ€é«˜åˆ†</span>
                <span class="stat-value" id="reportMaxScore">0 åˆ†</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">æœ€ä½åˆ†</span>
                <span class="stat-value" id="reportMinScore">0 åˆ†</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- é»æ•¸ç´¯ç© -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-trophy"></i> é»æ•¸ç´¯ç©</h3>
            <div class="comparison-badge" id="pointsComparison">
              <i class="fas fa-arrow-up"></i> +0%
            </div>
          </div>
          <div class="card-body">
            <div class="report-stats">
              <div class="report-stat-item">
                <span class="stat-label">æœ¬æœˆç²å¾—é»æ•¸</span>
                <span class="stat-value" id="reportMonthPoints">0 é»</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">ç´¯ç©ç¸½é»æ•¸</span>
                <span class="stat-value" id="reportTotalPoints">0 é»</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">å…¬å¸æ’å</span>
                <span class="stat-value" id="reportRanking">-</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">éƒ¨é–€æ’å</span>
                <span class="stat-value" id="reportDeptRanking">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    
    
    <!-- ç¬¬äº”æ’ï¼šæˆå°±ç³»çµ± -->
    <div class="sophia-section">
      <h2 class="section-title">
        <i class="fas fa-medal"></i> å­¸ç¿’æˆå°±
      </h2>
      
      <div class="achievements-grid" id="achievementsGrid">
        <!-- æˆå°±å¾½ç« å°‡å‹•æ…‹è¼‰å…¥ -->
      </div>
    </div>
    
    <!-- ç¬¬å…­æ’ï¼šæœˆå ±/å­£å ±ç”Ÿæˆ -->
    <div class="sophia-section">
      <h2 class="section-title">
        <i class="fas fa-file-alt"></i> å ±è¡¨ç”Ÿæˆ
      </h2>
      
      <div class="sophia-grid">
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-user"></i> å€‹äººæœˆå ±</h3>
          </div>
          <div class="card-body">
            <p style="color: var(--text-secondary); margin-bottom: 15px;">
              ç”Ÿæˆæ‚¨çš„å€‹äººå­¸ç¿’æœˆå ±ï¼Œä¸¦å¯„é€åˆ°æ‚¨çš„ Email
            </p>
            <button class="btn btn-primary" onclick="generatePersonalMonthlyReport()">
              <i class="fas fa-file-pdf"></i> ç”Ÿæˆå€‹äººæœˆå ±
            </button>
          </div>
        </div>
        
        <div class="sophia-card dept-only">
          <div class="card-header">
            <h3><i class="fas fa-users"></i> éƒ¨é–€æœˆå ±</h3>
            <span class="card-badge">s2+</span>
          </div>
          <div class="card-body">
            <p style="color: var(--text-secondary); margin-bottom: 15px;">
              ç”Ÿæˆéƒ¨é–€æ•´é«”å­¸ç¿’æœˆå ±ï¼ˆéœ€è¦ s2 ä»¥ä¸Šæ¬Šé™ï¼‰
            </p>
            <button class="btn btn-secondary" onclick="generateDepartmentMonthlyReport()">
              <i class="fas fa-file-pdf"></i> ç”Ÿæˆéƒ¨é–€æœˆå ±
            </button>
          </div>
        </div>
        
        <div class="sophia-card admin-only">
          <div class="card-header">
            <h3><i class="fas fa-building"></i> å…¬å¸å­£å ±</h3>
            <span class="card-badge">s4</span>
          </div>
          <div class="card-body">
            <p style="color: var(--text-secondary); margin-bottom: 15px;">
              ç”Ÿæˆå…¨å…¬å¸å­¸ç¿’å­£å ±ï¼ˆéœ€è¦ s4 æ¬Šé™ï¼‰
            </p>
            <button class="btn btn-warning" onclick="generateCompanyQuarterlyReport()">
              <i class="fas fa-file-pdf"></i> ç”Ÿæˆå…¬å¸å­£å ±
            </button>
          </div>
        </div>
      </div>
    </div>
    
  </div>
  
</div>


      <!-- ==================== ç®¡ç†å¾Œå°é é¢ ==================== -->
      <div id="adminPage" class="page-section">
        <!-- ç®¡ç†æ¨™ç±¤ -->
        <div class="admin-tabs">
          <button class="admin-tab active" data-tab="courses">
            <i class="fas fa-book"></i> èª²ç¨‹ç®¡ç†
          </button>
          <button class="admin-tab" data-tab="questions">
            <i class="fas fa-question-circle"></i> é¡Œç›®ç®¡ç†
          </button>
          <button class="admin-tab" data-tab="accounts">
            <i class="fas fa-users"></i> å¸³è™Ÿç®¡ç†
          </button>
          <button class="admin-tab" data-tab="records">
            <i class="fas fa-chart-bar"></i> å­¸ç¿’ç´€éŒ„
          </button>
          <button class="admin-tab" data-tab="announcements">
            <i class="fas fa-bullhorn"></i> å…¬å‘Šç®¡ç†
          </button>
          <button class="admin-tab" data-tab="settings">
            <i class="fas fa-cog"></i> ç³»çµ±è¨­å®š
          </button>
        </div>

<!-- èª²ç¨‹ç®¡ç†é¢æ¿ -->
<div id="adminCoursesPanel" class="admin-panel active">
  <div class="admin-card">
    <div class="admin-card-header">
      <h3 class="admin-card-title">èª²ç¨‹åˆ—è¡¨</h3>
      <button class="btn btn-primary btn-sm" onclick="showAddCourseModal()">
        <i class="fas fa-plus"></i> æ–°å¢èª²ç¨‹
      </button>
    </div>
    
    <table class="data-table">
      <thead>
        <tr>
          <th>èª²ç¨‹ID</th>
          <th>èª²ç¾¤</th>           <!-- âœ… ä¿®æ­£: ç¬¬2æ¬„ -->
          <th>èª²é–€</th>           <!-- âœ… ä¿®æ­£: ç¬¬3æ¬„ -->
          <th>èª²ç¨‹åç¨±</th>       <!-- âœ… ä¿®æ­£: ç¬¬4æ¬„ -->
          <th>é»æ•¸</th>
          <th>æˆªæ­¢æ—¥æœŸ</th>
          <th>ç‹€æ…‹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="adminCoursesList">
        <tr>
          <td colspan="8" class="text-center">è¼‰å…¥ä¸­...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


<!-- é¡Œç›®ç®¡ç†é¢æ¿ -->
<div id="adminQuestionsPanel" class="admin-panel">
  <div class="admin-card">
    <div class="admin-card-header">
      <h3 class="admin-card-title">é¡Œç›®åˆ—è¡¨</h3>
      <div>
        <!-- âœ… ä¿®æ­£: onchange äº‹ä»¶å‘¼å« loadAdminQuestionsByCourse() -->
        <select id="adminQuestionCourseFilter" onchange="loadAdminQuestionsByCourse()">
          <option value="">é¸æ“‡èª²ç¨‹</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="showAddQuestionModal()">
          <i class="fas fa-plus"></i> æ–°å¢é¡Œç›®
        </button>
      </div>
    </div>
    
    <table class="data-table">
      <thead>
        <tr>
          <th>é¡Œç›®ID</th>
          <th>é¡Œç›®å…§å®¹</th>
          <th>æ­£ç¢ºç­”æ¡ˆ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="adminQuestionsList">
        <tr>
          <td colspan="4" class="text-center">è«‹é¸æ“‡èª²ç¨‹</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


        <!-- å¸³è™Ÿç®¡ç†é¢æ¿ -->
        <div id="adminAccountsPanel" class="admin-panel">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">å¸³è™Ÿåˆ—è¡¨</h3>
              <button class="btn btn-primary btn-sm" onclick="showAddAccountModal()">
                <i class="fas fa-plus"></i> æ–°å¢å¸³è™Ÿ
              </button>
            </div>
            
            <table class="data-table">
              <thead>
                <tr>
                  <th>å·¥è™Ÿ</th>
                  <th>å§“å</th>
                  <th>éƒ¨é–€</th>
                  <th>Email</th>
                  <th>æ¬Šé™</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="adminAccountsList">
                <tr>
                  <td colspan="6" class="text-center">è¼‰å…¥ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- å­¸ç¿’ç´€éŒ„é¢æ¿ -->
        <div id="adminRecordsPanel" class="admin-panel">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">å­¸ç¿’ç´€éŒ„</h3>
              <button class="btn btn-success btn-sm" onclick="exportRecords()">
                <i class="fas fa-download"></i> åŒ¯å‡ºå ±è¡¨
              </button>
            </div>
            
            <table class="data-table">
              <thead>
                <tr>
                  <th>å·¥è™Ÿ</th>
                  <th>å§“å</th>
                  <th>èª²ç¨‹åç¨±</th>
                  <th>é–‹å§‹æ™‚é–“</th>
                  <th>å®Œæˆæ™‚é–“</th>
                  <th>æ¸¬é©—åˆ†æ•¸</th>
                  <th>ç²å¾—é»æ•¸</th>
                </tr>
              </thead>
              <tbody id="adminRecordsList">
                <tr>
                  <td colspan="7" class="text-center">è¼‰å…¥ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- å…¬å‘Šç®¡ç†é¢æ¿ -->
        <div id="adminAnnouncementsPanel" class="admin-panel">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">å…¬å‘Šåˆ—è¡¨</h3>
              <button class="btn btn-primary btn-sm" onclick="showAddAnnouncementModal()">
                <i class="fas fa-plus"></i> æ–°å¢å…¬å‘Š
              </button>
            </div>
            
            <table class="data-table">
              <thead>
                <tr>
                  <th>æ™‚é–“</th>
                  <th>å…¬å‘Šå…§å®¹</th>
                  <th>ç™¼å¸ƒå°è±¡</th>
                  <th>æ˜¯å¦ç½®é ‚</th>
                  <th>æœ‰æ•ˆæœŸé™</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="adminAnnouncementsList">
                <tr>
                  <td colspan="6" class="text-center">è¼‰å…¥ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ç³»çµ±è¨­å®šé¢æ¿ -->
        <div id="adminSettingsPanel" class="admin-panel">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">ç³»çµ±è¨­å®š</h3>
            </div>
            
            <form id="systemSettingsForm">
              <div class="form-group">
                <label>æ¸¬é©—é¡Œæ•¸</label>
                <input type="number" id="settingQuestionCount" min="1" max="20" value="5">
              </div>
              
              <div class="form-group">
                <label>æ¸¬é©—åŠæ ¼åˆ†æ•¸</label>
                <input type="number" id="settingPassScore" min="0" max="100" value="60">
              </div>
              
              <div class="form-group">
                <label>æˆªæ­¢æ—¥æé†’å¤©æ•¸</label>
                <input type="number" id="settingReminderDays" min="1" max="30" value="5">
              </div>
              
              <div class="form-group">
                <label>Session æœ‰æ•ˆæ™‚é–“(åˆ†é˜)</label>
                <input type="number" id="settingSessionTimeout" min="30" max="1440" value="480">
              </div>
              
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> å„²å­˜è¨­å®š
              </button>
            </form>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ==================== Modals ==================== -->
  
<!-- æ–°å¢/ç·¨è¼¯èª²ç¨‹ Modal -->
<div id="courseModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="courseModalTitle">æ–°å¢èª²ç¨‹</h3>
      <button class="modal-close" onclick="closeCourseModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="courseForm">
        <input type="hidden" id="courseFormId">
        
        <div class="form-group">
          <label>èª²ç¾¤ *</label>
          <select id="courseFormCategory" required>
            <option value="">è«‹é¸æ“‡</option>
            <!-- å‹•æ…‹è¼‰å…¥é¸é … -->
          </select>
        </div>

        <div class="form-group">
          <label>èª²é–€ *</label>
          <select id="courseFormSubject" required>
            <option value="">è«‹é¸æ“‡</option>
            <!-- å‹•æ…‹è¼‰å…¥é¸é … -->
          </select>
        </div>
        
        <div class="form-group">
          <label>èª²ç¨‹åç¨± *</label>
          <input type="text" id="courseFormName" placeholder="ä¾‹å¦‚: è³‡è¨Šå®‰å…¨åŸºç¤è¨“ç·´" required>
        </div>
        
        <div class="form-group">
          <label>èª²ç¨‹èªªæ˜</label>
          <textarea id="courseFormDesc" rows="3" placeholder="èª²ç¨‹èªªæ˜"></textarea>
        </div>
        
        <div class="form-group">
          <label>å½±ç‰‡é€£çµ(Google Drive) *</label>
          <input type="url" id="courseFormVideo" placeholder="https://drive.google.com/..." required>
        </div>
        
        <!-- âœ… æ–°å¢ï¼šå¿…ä¿®å°è±¡ï¼ˆéƒ¨é–€+å€‹äººï¼‰-->
        <div class="form-group">
          <label>å¿…ä¿®å°è±¡</label>
          
          <!-- éƒ¨é–€è¼¸å…¥ -->
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <select style="width: 100px;">
              <option>éƒ¨é–€</option>
            </select>
            <input type="text" id="courseFormRequiredDepts" placeholder="ä¾‹å¦‚: IT,HR,Finance" style="flex: 1;">
          </div>
          
          <!-- å€‹äººè¼¸å…¥ -->
          <div style="display: flex; gap: 10px;">
            <select style="width: 100px;">
              <option>å€‹äºº</option>
            </select>
            <input type="text" id="courseFormRequiredIndividuals" placeholder="ä¾‹å¦‚: E001,E002,E003" style="flex: 1;">
          </div>
          
          <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 5px;">
            ğŸ’¡ æç¤ºï¼šéƒ¨é–€å’Œå€‹äººå¯ä»¥åŒæ™‚è¨­å®šï¼Œç³»çµ±æœƒè‡ªå‹•åˆä½µï¼ˆè¯é›†ï¼‰
          </small>
        </div>
        
        <!-- âœ… æ–°å¢ï¼šé¸ä¿®å°è±¡ï¼ˆéƒ¨é–€+å€‹äººï¼‰-->
        <div class="form-group">
          <label>é¸ä¿®å°è±¡</label>
          
          <!-- éƒ¨é–€è¼¸å…¥ -->
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <select style="width: 100px;">
              <option>éƒ¨é–€</option>
            </select>
            <input type="text" id="courseFormOptionalDepts" placeholder="ä¾‹å¦‚: Sales,Marketing" style="flex: 1;">
          </div>
          
          <!-- å€‹äººè¼¸å…¥ -->
          <div style="display: flex; gap: 10px;">
            <select style="width: 100px;">
              <option>å€‹äºº</option>
            </select>
            <input type="text" id="courseFormOptionalIndividuals" placeholder="ä¾‹å¦‚: E004,E005" style="flex: 1;">
          </div>
          
          <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 5px;">
            ğŸ’¡ æç¤ºï¼šéƒ¨é–€å’Œå€‹äººå¯ä»¥åŒæ™‚è¨­å®šï¼Œç³»çµ±æœƒè‡ªå‹•åˆä½µï¼ˆè¯é›†ï¼‰
          </small>
        </div>
        
        <div class="form-group">
          <label>é–‹å§‹æ™‚é–“ *</label>
          <input type="date" id="courseFormStart" required>
        </div>
        
        <div class="form-group">
          <label>æˆªæ­¢æ™‚é–“ *</label>
          <input type="date" id="courseFormDeadline" required>
        </div>
        
        <div class="form-group">
          <label>é»æ•¸ *</label>
          <input type="number" id="courseFormPoints" min="0" value="10" required>
        </div>
        
        <div class="form-group">
          <label>å‰ç½®èª²ç¨‹ID</label>
          <input type="text" id="courseFormPrerequisite" placeholder="é¸å¡«">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeCourseModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveCourse()">å„²å­˜</button>
    </div>
  </div>
</div>


  <!-- æ–°å¢/ç·¨è¼¯é¡Œç›® Modal -->
  <div id="questionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="questionModalTitle">æ–°å¢é¡Œç›®</h3>
        <button class="modal-close" onclick="closeQuestionModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="questionForm">
          <input type="hidden" id="questionFormId">
          
          <div class="form-group">
            <label>èª²ç¨‹ *</label>
                        <select id="questionFormCourse" required>
              <option value="">è«‹é¸æ“‡èª²ç¨‹</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>é¡Œç›®å…§å®¹ *</label>
            <textarea id="questionFormText" rows="3" placeholder="è«‹è¼¸å…¥é¡Œç›®å…§å®¹" required></textarea>
          </div>
          
          <div class="form-group">
            <label>é¸é …A *</label>
            <input type="text" id="questionFormOptionA" placeholder="é¸é …A" required>
          </div>
          
          <div class="form-group">
            <label>é¸é …B *</label>
            <input type="text" id="questionFormOptionB" placeholder="é¸é …B" required>
          </div>
          
          <div class="form-group">
            <label>é¸é …C *</label>
            <input type="text" id="questionFormOptionC" placeholder="é¸é …C" required>
          </div>
          
          <div class="form-group">
            <label>é¸é …D *</label>
            <input type="text" id="questionFormOptionD" placeholder="é¸é …D" required>
          </div>
          
          <div class="form-group">
            <label>æ­£ç¢ºç­”æ¡ˆ *</label>
            <select id="questionFormAnswer" required>
              <option value="">è«‹é¸æ“‡</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeQuestionModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveQuestion()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢/ç·¨è¼¯å¸³è™Ÿ Modal -->
  <div id="accountModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="accountModalTitle">æ–°å¢å¸³è™Ÿ</h3>
        <button class="modal-close" onclick="closeAccountModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="accountForm">
          <div class="form-group">
            <label>å·¥è™Ÿ *</label>
            <input type="text" id="accountFormEmpId" placeholder="ä¾‹å¦‚: E001" required>
          </div>
          
          <div class="form-group">
            <label>å§“å *</label>
            <input type="text" id="accountFormName" placeholder="ä¾‹å¦‚: ç‹å°æ˜" required>
          </div>
          
          <div class="form-group">
            <label>éƒ¨é–€ *</label>
            <input type="text" id="accountFormDept" placeholder="ä¾‹å¦‚: IT" required>
          </div>
          
          <div class="form-group">
            <label>å¯†ç¢¼ *</label>
            <input type="password" id="accountFormPassword" placeholder="é è¨­å¯†ç¢¼" required>
          </div>
          
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="accountFormEmail" placeholder="example@company.com">
          </div>
          
          <div class="form-group">
            <label>æ¬Šé™ *</label>
            <select id="accountFormPermission" required>
              <option value="s1">s1 - ä¸€èˆ¬å“¡å·¥</option>
              <option value="s2">s2 - éƒ¨é–€ä¸»ç®¡</option>
              <option value="s3">s3 - é«˜éšä¸»ç®¡</option>
              <option value="s4">s4 - ç³»çµ±ç®¡ç†å“¡</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAccountModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveAccount()">å„²å­˜</button>
      </div>
    </div>
  </div>

<!-- æ–°å¢å…¬å‘Š Modal -->
<div id="announcementModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">æ–°å¢å…¬å‘Š</h3>
      <button class="modal-close" onclick="closeAnnouncementModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="announcementForm">
        <div class="form-group">
          <label>å…¬å‘Šå…§å®¹ *</label>
          <textarea id="announcementFormContent" rows="4" placeholder="è«‹è¼¸å…¥å…¬å‘Šå…§å®¹" required></textarea>
        </div>
        
        <!-- âœ… æ–°å¢ï¼šç™¼å¸ƒå°è±¡ï¼ˆéƒ¨é–€+å€‹äººï¼‰-->
        <div class="form-group">
          <label>ç™¼å¸ƒå°è±¡</label>
          
          <!-- éƒ¨é–€è¼¸å…¥ -->
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <select style="width: 100px;">
              <option>éƒ¨é–€</option>
            </select>
            <input type="text" id="announcementFormTargetDepts" placeholder="ç•™ç©ºè¡¨ç¤ºå…¨å…¬å¸ï¼Œä¾‹å¦‚: IT,HR">
          </div>
          
          <!-- å€‹äººè¼¸å…¥ -->
          <div style="display: flex; gap: 10px;">
            <select style="width: 100px;">
              <option>å€‹äºº</option>
            </select>
            <input type="text" id="announcementFormTargetIndividuals" placeholder="ä¾‹å¦‚: E001,E002,E003">
          </div>
          
          <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 5px;">
            ğŸ’¡ æç¤ºï¼šç•™ç©ºè¡¨ç¤ºç™¼é€çµ¦å…¨å…¬å¸ï¼Œéƒ¨é–€å’Œå€‹äººå¯ä»¥åŒæ™‚è¨­å®š
          </small>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="announcementFormPinned">
            æ˜¯å¦ç½®é ‚
          </label>
        </div>
        
        <div class="form-group">
          <label>æœ‰æ•ˆæœŸé™</label>
          <input type="date" id="announcementFormExpiry">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeAnnouncementModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveAnnouncement()">ç™¼å¸ƒ</button>
    </div>
  </div>
</div>


<!-- æ¸¬é©—çµæœ Modal -->
<div id="examResultModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h3 class="modal-title">æ¸¬é©—çµæœ</h3>
      <button class="modal-close" onclick="closeExamResultModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="exam-result">
        <!-- çµæœåœ–ç¤ºå’Œæ¨™é¡Œ -->
        <div class="result-icon" id="resultIcon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h2 class="result-title" id="resultTitle">æ¸¬é©—é€šé!</h2>
        <div class="result-score" id="resultScore">0</div>
        
        <!-- çµ±è¨ˆè³‡è¨Š -->
        <div class="result-details">
          <div class="result-detail-item">
            <span>æ­£ç¢ºé¡Œæ•¸</span>
            <strong id="resultCorrect">0</strong>
          </div>
          <div class="result-detail-item">
            <span>ç¸½é¡Œæ•¸</span>
            <strong id="resultTotal">0</strong>
          </div>
          <div class="result-detail-item">
            <span>åŠæ ¼åˆ†æ•¸</span>
            <strong id="resultPassScore">60</strong>
          </div>
          <div class="result-detail-item" id="resultPointsRow">
            <span>ç²å¾—é»æ•¸</span>
            <strong id="resultPoints">0</strong>
          </div>
        </div>
        
        <!-- âœ… æ–°å¢ï¼šéŒ¯èª¤é¡Œç›®æª¢è¨å€å¡Š -->
        <div id="wrongAnswersSection" style="display: none; margin-top: 30px; text-align: left;">
          <h3 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
            <i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i>
            éŒ¯èª¤é¡Œç›®æª¢è¨
          </h3>
          <div id="wrongAnswersList"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer" style="display: flex; gap: 10px; justify-content: center;">
      <button class="btn btn-secondary" onclick="closeExamResultModal()">
        <i class="fas fa-times"></i> é—œé–‰
      </button>
      <!-- âœ… æ–°å¢ï¼šé‡æ–°æ¸¬é©—æŒ‰éˆ•ï¼ˆåªåœ¨æœªé€šéæ™‚é¡¯ç¤ºï¼‰-->
      <button id="btnRetakeExam" class="btn btn-warning" onclick="retakeExam()" style="display: none;">
        <i class="fas fa-redo"></i> é‡æ–°æ¸¬é©—
      </button>
      <!-- âœ… æ–°å¢ï¼šè¿”å›èª²ç¨‹åˆ—è¡¨æŒ‰éˆ•ï¼ˆé€šéæ™‚é¡¯ç¤ºï¼‰-->
      <button id="btnBackToCourses" class="btn btn-primary" onclick="closeExamResultAndBackToCourses()" style="display: none;">
        <i class="fas fa-check"></i> è¿”å›èª²ç¨‹åˆ—è¡¨
      </button>
    </div>
  </div>
</div>

  <!-- âœ… ä¿®æ”¹å¯†ç¢¼ Modal -->
<div id="changePasswordModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h3 class="modal-title">ä¿®æ”¹å¯†ç¢¼</h3>
      <button class="modal-close" onclick="closeChangePasswordModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="changePasswordForm" onsubmit="submitChangePassword(event)">
        <div class="form-group">
          <label>
            <i class="fas fa-lock"></i> ç›®å‰å¯†ç¢¼ *
          </label>
          <input type="password" id="currentPassword" placeholder="è«‹è¼¸å…¥ç›®å‰å¯†ç¢¼" required autocomplete="current-password">
        </div>
        
        <div class="form-group">
          <label>
            <i class="fas fa-key"></i> æ–°å¯†ç¢¼ *
          </label>
          <input type="password" id="newPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘6å€‹å­—å…ƒï¼‰" required minlength="6" autocomplete="new-password">
          <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 5px;">
            ğŸ’¡ æç¤ºï¼šå¯†ç¢¼é•·åº¦è‡³å°‘ 6 å€‹å­—å…ƒ
          </small>
        </div>
        
        <div class="form-group">
          <label>
            <i class="fas fa-check-circle"></i> ç¢ºèªæ–°å¯†ç¢¼ *
          </label>
          <input type="password" id="confirmPassword" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" required minlength="6" autocomplete="new-password">
        </div>
        
        <!-- âœ… å¯†ç¢¼å¼·åº¦æŒ‡ç¤ºå™¨ -->
        <div id="passwordStrength" style="display: none; margin-top: 10px; padding: 10px; border-radius: 8px; font-size: 13px;">
          <strong>å¯†ç¢¼å¼·åº¦ï¼š</strong>
          <span id="strengthText"></span>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeChangePasswordModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="submitChangePassword(event)">
        <i class="fas fa-save"></i> ç¢ºèªä¿®æ”¹
      </button>
    </div>
  </div>
</div>

  <script>
    /**
 * æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
 */
function formatDate(date) {
  if (!date) return '';
  if (typeof date === 'string') date = new Date(date);
  
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  
  return `${year}-${month}-${day}`;
}

/**
 * æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“ç‚º YYYY-MM-DD HH:MM:SS
 */
function formatDateTime(date) {
  if (!date) return '';
  if (typeof date === 'string') date = new Date(date);
  
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  
  return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

    // ==================== éæ¿¾ Chrome æ“´å……åŠŸèƒ½éŒ¯èª¤ ====================
(function() {
  const originalError = console.error;
  console.error = function(...args) {
    const errorMessage = args[0];
    
    // âœ… éæ¿¾æ‰ Chrome æ“´å……åŠŸèƒ½çš„éŒ¯èª¤
    if (typeof errorMessage === 'string') {
      if (errorMessage.includes('message channel closed') ||
          errorMessage.includes('listener indicated an asynchronous response')) {
        return; // ä¸é¡¯ç¤ºæ­¤éŒ¯èª¤
      }
    }
    
    // âœ… å…¶ä»–éŒ¯èª¤æ­£å¸¸é¡¯ç¤º
    originalError.apply(console, args);
  };
})();

    // ==================== å…¨åŸŸè®Šæ•¸ ==================== 
    let API_URL = 'https://script.google.com/macros/s/AKfycbwvL98-795KzZwcQGfpmOnL8gBHDa6Ljx-YrCZ56Sb0nDbqrFTWcDE88uS81ClQv0SP/exec';
    let sessionToken = null;
    let currentUser = null;
    let currentCourse = null;
    let currentRecordId = null;
    let videoStartTime = null;
    let watchedSeconds = 0;
    let currentVideoDuration = 180;  // âœ… åŠ å…¥é€™è¡Œ!
    let videoCheckInterval = null;
    let allCourses = [];
    let currentExamQuestions = [];
    let isPageVisible = true;  // âœ… æ–°å¢é€™è¡Œ!ç”¨ä¾†è¨˜éŒ„é é¢æ˜¯å¦å¯è¦‹
    // ==================== é è¼‰å…¥ç®¡ç†å™¨ ====================
const PreloadManager = {
  // é è¼‰å…¥ç‹€æ…‹
  status: {
    dashboard: false,
    courses: false,
    myLearning: false,
    charts: false
  },

  // é è¼‰å…¥çš„è³‡æ–™
  data: {
    dashboard: null,
    courses: null,
    myLearning: null,
    charts: null
  },

  // éšæ®µä¸€ï¼šç™»å…¥å¾Œç«‹å³è¼‰å…¥ï¼ˆ2ç§’å…§ï¼‰
  async stage1() {
    console.log('ğŸš€ é è¼‰å…¥éšæ®µä¸€ï¼šå„€éŒ¶æ¿ + èª²ç¨‹åˆ—è¡¨');
    
    try {
      // ä¸¦è¡Œè¼‰å…¥å„€éŒ¶æ¿å’Œèª²ç¨‹åˆ—è¡¨
      const [dashboardData, coursesData] = await Promise.all([
        this.preloadDashboard(),
        this.preloadCourses()
      ]);

      console.log('âœ… éšæ®µä¸€è¼‰å…¥å®Œæˆ');
      return true;
    } catch (error) {
      console.error('âŒ éšæ®µä¸€è¼‰å…¥å¤±æ•—:', error);
      return false;
    }
  },

  // éšæ®µäºŒï¼šèƒŒæ™¯å»¶é²è¼‰å…¥ï¼ˆ3-5ç§’å¾Œï¼‰
  async stage2() {
    console.log('ğŸš€ é è¼‰å…¥éšæ®µäºŒï¼šæˆ‘çš„å­¸ç¿’ + åœ–è¡¨');
    
    // å»¶é²3ç§’å¾Œé–‹å§‹è¼‰å…¥
    await new Promise(resolve => setTimeout(resolve, 3000));

    try {
      // ä¸¦è¡Œè¼‰å…¥æˆ‘çš„å­¸ç¿’å’Œåœ–è¡¨
      await Promise.all([
        this.preloadMyLearning(),
        this.preloadCharts()
      ]);

      console.log('âœ… éšæ®µäºŒè¼‰å…¥å®Œæˆ');
      return true;
    } catch (error) {
      console.error('âŒ éšæ®µäºŒè¼‰å…¥å¤±æ•—:', error);
      return false;
    }
  },

  // é è¼‰å…¥å„€éŒ¶æ¿è³‡æ–™
  async preloadDashboard() {
    if (this.status.dashboard) {
      console.log('â­ï¸ å„€éŒ¶æ¿å·²é è¼‰å…¥ï¼Œè·³é');
      return this.data.dashboard;
    }

    try {
      console.log('â³ é è¼‰å…¥å„€éŒ¶æ¿...');
      
      const result = await callAPI('getPersonalDashboard', {});

      if (result && result.success) {
        this.data.dashboard = result.data;
        this.status.dashboard = true;
        console.log('âœ… å„€éŒ¶æ¿é è¼‰å…¥å®Œæˆ');
        return this.data.dashboard;
      } else {
        throw new Error(result?.message || 'è¼‰å…¥å¤±æ•—');
      }
    } catch (error) {
      console.error('âŒ å„€éŒ¶æ¿é è¼‰å…¥å¤±æ•—:', error);
      throw error;
    }
  },

  // é è¼‰å…¥èª²ç¨‹åˆ—è¡¨
  async preloadCourses() {
    if (this.status.courses) {
      console.log('â­ï¸ èª²ç¨‹åˆ—è¡¨å·²é è¼‰å…¥ï¼Œè·³é');
      return this.data.courses;
    }

    try {
      console.log('â³ é è¼‰å…¥èª²ç¨‹åˆ—è¡¨...');
      
      const result = await callAPI('getCourseList', {});

      if (result && result.success) {
        this.data.courses = result.data;
        this.status.courses = true;
        console.log('âœ… èª²ç¨‹åˆ—è¡¨é è¼‰å…¥å®Œæˆ');
        return this.data.courses;
      } else {
        throw new Error(result?.message || 'è¼‰å…¥å¤±æ•—');
      }
    } catch (error) {
      console.error('âŒ èª²ç¨‹åˆ—è¡¨é è¼‰å…¥å¤±æ•—:', error);
      throw error;
    }
  },

  // é è¼‰å…¥æˆ‘çš„å­¸ç¿’ç´€éŒ„
  async preloadMyLearning() {
    if (this.status.myLearning) {
      console.log('â­ï¸ æˆ‘çš„å­¸ç¿’å·²é è¼‰å…¥ï¼Œè·³é');
      return this.data.myLearning;
    }

    try {
      console.log('â³ é è¼‰å…¥æˆ‘çš„å­¸ç¿’...');
      
      const [learningResult, pointsResult] = await Promise.all([
        callAPI('getLearningRecords', {}),
        callAPI('getPointRecords', { empId: currentUser.empId })
      ]);

      if (learningResult && learningResult.success && pointsResult && pointsResult.success) {
        this.data.myLearning = {
          learningRecords: learningResult.data,
          pointRecords: pointsResult.data
        };
        this.status.myLearning = true;
        console.log('âœ… æˆ‘çš„å­¸ç¿’é è¼‰å…¥å®Œæˆ');
        return this.data.myLearning;
      } else {
        throw new Error('è¼‰å…¥å¤±æ•—');
      }
    } catch (error) {
      console.error('âŒ æˆ‘çš„å­¸ç¿’é è¼‰å…¥å¤±æ•—:', error);
      throw error;
    }
  },

  // é è¼‰å…¥åœ–è¡¨è³‡æ–™
  async preloadCharts() {
    if (this.status.charts) {
      console.log('â­ï¸ åœ–è¡¨å·²é è¼‰å…¥ï¼Œè·³é');
      return this.data.charts;
    }

    try {
      console.log('â³ é è¼‰å…¥åœ–è¡¨...');
      
      const result = await callAPI('getChartData', {});

      if (result && result.success) {
        this.data.charts = result.data;
        this.status.charts = true;
        console.log('âœ… åœ–è¡¨é è¼‰å…¥å®Œæˆ');
        return this.data.charts;
      } else {
        throw new Error(result?.message || 'è¼‰å…¥å¤±æ•—');
      }
    } catch (error) {
      console.error('âŒ åœ–è¡¨é è¼‰å…¥å¤±æ•—:', error);
      throw error;
    }
  },

  // é–‹å§‹é è¼‰å…¥æµç¨‹
  async start() {
    console.log('ğŸ¯ é–‹å§‹é è¼‰å…¥æµç¨‹...');
    
    // éšæ®µä¸€ï¼šç«‹å³è¼‰å…¥
    await this.stage1();

    // éšæ®µäºŒï¼šèƒŒæ™¯å»¶é²è¼‰å…¥ï¼ˆä¸ç­‰å¾…å®Œæˆï¼‰
    this.stage2().catch(error => {
      console.error('éšæ®µäºŒèƒŒæ™¯è¼‰å…¥å¤±æ•—:', error);
    });
  },

  // é‡ç½®é è¼‰å…¥ç‹€æ…‹ï¼ˆç™»å‡ºæ™‚ä½¿ç”¨ï¼‰
  reset() {
    console.log('ğŸ”„ é‡ç½®é è¼‰å…¥ç‹€æ…‹');
    this.status = {
      dashboard: false,
      courses: false,
      myLearning: false,
      charts: false
    };
    this.data = {
      dashboard: null,
      courses: null,
      myLearning: null,
      charts: null
    };
  }
};


    // ==================== åˆå§‹åŒ– ==================== 
    document.addEventListener('DOMContentLoaded', function() {
      // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
      const savedToken = localStorage.getItem('sessionToken');
      if (savedToken) {
        sessionToken = savedToken;
        validateSession();
      }

      // ç™»å…¥è¡¨å–®æäº¤
      document.getElementById('loginForm').addEventListener('submit', handleLogin);

      // å°èˆªé¸å–®é»æ“Š
      document.querySelectorAll('.navbar-item').forEach(item => {
        item.addEventListener('click', function() {
          const page = this.dataset.page;
          navigateToPage(page);
        });
      });

      // ç®¡ç†å¾Œå°æ¨™ç±¤åˆ‡æ›
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.dataset.tab;
          switchAdminTab(tabName);
        });
      });

      // ç³»çµ±è¨­å®šè¡¨å–®æäº¤
      document.getElementById('systemSettingsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveSystemSettings();
      });
          // âœ… æ–°å¢é€™æ®µ!ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–
      document.addEventListener('visibilitychange', handleVisibilityChange);
      
      console.log('âœ… é é¢å¯è¦‹æ€§ç›£è½å™¨å·²å•Ÿå‹•');
    
    });
/**
 * è™•ç†é é¢å¯è¦‹æ€§è®ŠåŒ–
 */
function handleVisibilityChange() {
  console.log('=== handleVisibilityChange ===');
  console.log('document.hidden:', document.hidden);
  
  if (document.hidden) {
    // âœ… é é¢ä¸å¯è¦‹ (åˆ‡æ›åˆ†é ã€æœ€å°åŒ–è¦–çª—ç­‰)
    console.log('âš ï¸ é é¢ä¸å¯è¦‹,æš«åœè¨ˆæ™‚å™¨');
    isPageVisible = false;
    
  } else {
    // âœ… é é¢å¯è¦‹
    console.log('âœ… é é¢å¯è¦‹,æª¢æŸ¥æ˜¯å¦éœ€è¦æ¢å¾©è¨ˆæ™‚å™¨');
    isPageVisible = true;
    
    // âœ… æª¢æŸ¥æ˜¯å¦åœ¨æ’­æ”¾é é¢
    const playerPage = document.getElementById('playerPage');
    const isPlayerActive = playerPage && playerPage.classList.contains('active');
    
    console.log('æ’­æ”¾é é¢æ˜¯å¦å•Ÿç”¨:', isPlayerActive);
    console.log('æ˜¯å¦æœ‰å­¸ç¿’ç´€éŒ„:', !!currentRecordId);
    console.log('å·²è§€çœ‹ç§’æ•¸:', watchedSeconds);
    console.log('å½±ç‰‡ç¸½é•·åº¦:', currentVideoDuration);
    
    // âœ… æª¢æŸ¥æ˜¯å¦å·²ç¶“çœ‹å®Œ
    if (watchedSeconds >= currentVideoDuration) {
      console.log('âš ï¸ å½±ç‰‡å·²çœ‹å®Œ,ä¸éœ€è¦æ¢å¾©è¨ˆæ™‚å™¨');
      return;
    }
    
    // âœ… å¦‚æœåœ¨æ’­æ”¾é é¢ã€æœ‰å­¸ç¿’ç´€éŒ„ã€ä¸”è¨ˆæ™‚å™¨æœªå•Ÿå‹•,å‰‡æ¢å¾©è¨ˆæ™‚å™¨
    if (isPlayerActive && currentRecordId && !videoCheckInterval) {
      console.log('âœ… æ¢å¾©è¨ˆæ™‚å™¨');
      startVideoTimer();
    } else {
      console.log('âš ï¸ ä¸éœ€è¦æ¢å¾©è¨ˆæ™‚å™¨');
    }
  }
}


/**
 * å•Ÿå‹•å½±ç‰‡è¨ˆæ™‚å™¨
 */
function startVideoTimer() {
  console.log('=== startVideoTimer ===');
  console.log('ç•¶å‰è§€çœ‹ç§’æ•¸:', watchedSeconds);
  console.log('å½±ç‰‡ç¸½é•·åº¦:', currentVideoDuration);
  
  // âœ… æª¢æŸ¥æ˜¯å¦å·²ç¶“çœ‹å®Œ
if (watchedSeconds >= currentVideoDuration) {
  console.log('âœ… å½±ç‰‡æ’­æ”¾å®Œç•¢');
  stopVideoTimer();
  
  // âœ… å•Ÿç”¨æ¸¬é©—æŒ‰éˆ•
  const btnStartExam = document.getElementById('btnStartExam');
  if (btnStartExam) {
    btnStartExam.disabled = false;
    btnStartExam.textContent = 'é–‹å§‹æ¸¬é©—';
  }
  
  // âœ… æ›´æ–°ã€Œé–‹å§‹æ’­æ”¾ã€æŒ‰éˆ•ç‹€æ…‹
  const btnStartWatching = document.getElementById('btnStartWatching');
  const videoStatus = document.getElementById('videoStatus');
  
  if (btnStartWatching) {
    btnStartWatching.disabled = true;
    btnStartWatching.textContent = 'âœ… å·²è§€çœ‹å®Œç•¢';
    btnStartWatching.style.backgroundColor = '#28a745';
  }
  
  if (videoStatus) {
    videoStatus.textContent = 'å½±ç‰‡å·²è§€çœ‹å®Œç•¢ï¼Œå¯ä»¥é–‹å§‹æ¸¬é©—äº†ï¼';
    videoStatus.style.color = '#28a745';
  }
  
  showAlert('å½±ç‰‡å·²è§€çœ‹å®Œç•¢,å¯ä»¥é–‹å§‹æ¸¬é©—äº†!', 'success');
  
  return;
}

  
  // âœ… å¦‚æœè¨ˆæ™‚å™¨å·²ç¶“å•Ÿå‹•,ä¸è¦é‡è¤‡å•Ÿå‹•
  if (videoCheckInterval) {
    console.log('âš ï¸ è¨ˆæ™‚å™¨å·²ç¶“å•Ÿå‹•,è·³é');
    return;
  }
  
  console.log('âœ… å•Ÿå‹•è¨ˆæ™‚å™¨');
  
  videoCheckInterval = setInterval(() => {
    // âœ… æª¢æŸ¥é é¢æ˜¯å¦å¯è¦‹
    if (!isPageVisible) {
      console.log('âš ï¸ é é¢ä¸å¯è¦‹,è·³éæœ¬æ¬¡è¨ˆæ™‚');
      return;
    }
    
    // âœ… æª¢æŸ¥æ˜¯å¦æ’­æ”¾å®Œç•¢
    if (watchedSeconds >= currentVideoDuration) {
      console.log('âœ… å½±ç‰‡æ’­æ”¾å®Œç•¢');
      stopVideoTimer();
      
      // âœ… å•Ÿç”¨æ¸¬é©—æŒ‰éˆ•
      const btnStartExam = document.getElementById('btnStartExam');
      if (btnStartExam) {
        btnStartExam.disabled = false;
        btnStartExam.textContent = 'é–‹å§‹æ¸¬é©—';
        showAlert('å½±ç‰‡å·²è§€çœ‹å®Œç•¢,å¯ä»¥é–‹å§‹æ¸¬é©—äº†!', 'success');
      }
      
      return;
    }
    
    // âœ… æ­£å¸¸è¨ˆæ™‚
    watchedSeconds += 1;
    updateProgressBar();
    updateTimeInfo();  // âœ… æ–°å¢ï¼šæ›´æ–°æ™‚é–“è³‡è¨Š
    
    // âœ… æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡é€²åº¦åˆ°å¾Œç«¯
    if (watchedSeconds % 30 === 0) {
      updateProgressToServer(false);
    }

  }, 1000);
  
  console.log('âœ… startVideoTimer å®Œæˆ');
}


/**
 * åœæ­¢å½±ç‰‡è¨ˆæ™‚å™¨
 */
function stopVideoTimer() {
  console.log('=== stopVideoTimer ===');
  console.log('ç•¶å‰è§€çœ‹ç§’æ•¸:', watchedSeconds);
  
  // åœæ­¢è¨ˆæ™‚å™¨
  if (videoCheckInterval) {
    clearInterval(videoCheckInterval);
    videoCheckInterval = null;
    console.log('âœ… è¨ˆæ™‚å™¨å·²åœæ­¢');
  }
  
// æœ€å¾Œä¸€æ¬¡æ›´æ–°é€²åº¦åˆ°å¾Œç«¯
if (currentRecordId && watchedSeconds > 0) {
  console.log('âœ… æ›´æ–°æœ€å¾Œé€²åº¦åˆ°å¾Œç«¯');
  const isComplete = watchedSeconds >= currentVideoDuration;
  updateProgressToServer(isComplete);
}

// âœ… æœ€å¾Œä¸€æ¬¡æ›´æ–°æ™‚é–“è³‡è¨Š
updateTimeInfo();

console.log('âœ… stopVideoTimer å®Œæˆ');

}

    // ==================== API å‘¼å«å‡½æ•¸ ==================== 
/**
 * å‘¼å«å¾Œç«¯ API (ä½¿ç”¨ JSONP)
 */
async function callAPI(action, data = {}) {
  console.log('=== callAPI é–‹å§‹ ===');
  console.log('action:', action);
  console.log('data:', data);
  
  showLoading();
  
  try {
    // âœ… å»ºç«‹å”¯ä¸€çš„ callback åç¨±
    const callbackName = 'apiCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    console.log('âœ… Callback åç¨±:', callbackName);
    
    // âœ… å»ºç«‹åƒæ•¸
    const params = new URLSearchParams({
      action: action,
      callback: callbackName
    });
    
    if (sessionToken) {
      params.append('sessionToken', sessionToken);
    }
    
    // âœ… åŠ å…¥å…¶ä»–åƒæ•¸
    for (const key in data) {
      if (data.hasOwnProperty(key)) {
        params.append(key, data[key]);
      }
    }
    
    const url = `${API_URL}?${params.toString()}`;
    
    console.log('âœ… å®Œæ•´ URL:', url);
    
    return new Promise((resolve, reject) => {
      // âœ… è¨­å®šè¶…æ™‚è¨ˆæ™‚å™¨ (30ç§’)
      const timeoutId = setTimeout(() => {
        console.error('âŒ API è«‹æ±‚è¶…æ™‚');
        cleanup();
        hideLoading();
        showAlert('è«‹æ±‚è¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        reject(new Error('Request timeout'));
      }, 30000);
      
      // âœ… å»ºç«‹ callback å‡½æ•¸
      window[callbackName] = function(response) {
        console.log('âœ… æ”¶åˆ° API å›æ‡‰:', response);
        
        clearTimeout(timeoutId);
        cleanup();
        hideLoading();
        
        // âœ… æª¢æŸ¥ Session æ˜¯å¦ç„¡æ•ˆ
        if (!response.success && response.message === 'Session ç„¡æ•ˆ') {
          console.log('âŒ Session ç„¡æ•ˆï¼Œç™»å‡º');
          logout();
          resolve(null);
        } else {
          resolve(response);
        }
      };
      
      // âœ… å»ºç«‹ script æ¨™ç±¤
      const script = document.createElement('script');
      script.src = url;
      script.id = callbackName;
      
      // âœ… éŒ¯èª¤è™•ç† (ä¿®æ­£ç‰ˆ)
      script.onerror = function(error) {
        console.error('âŒ Script è¼‰å…¥å¤±æ•—:', error);
        console.error('URL:', url);
        
        clearTimeout(timeoutId);
        cleanup();
        hideLoading();
        
        // âœ… ä¸è¦ç«‹å³ rejectï¼Œå› ç‚ºå¯èƒ½æ˜¯ CORS å•é¡Œ
        // çµ¦ callback ä¸€é»æ™‚é–“åŸ·è¡Œ
        setTimeout(() => {
          if (window[callbackName]) {
            console.error('âŒ Callback æœªè¢«å‘¼å«ï¼Œç¢ºèªç‚ºè¼‰å…¥å¤±æ•—');
            showAlert('ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            reject(new Error('Failed to load script'));
          }
        }, 1000);
      };
      
      // âœ… è¼‰å…¥æˆåŠŸè™•ç†
      script.onload = function() {
        console.log('âœ… Script è¼‰å…¥æˆåŠŸ');
      };
      
      // âœ… æ¸…ç†å‡½æ•¸
      function cleanup() {
        try {
          if (window[callbackName]) {
            delete window[callbackName];
          }
          
          const scriptElement = document.getElementById(callbackName);
          if (scriptElement && scriptElement.parentNode) {
            scriptElement.parentNode.removeChild(scriptElement);
          }
        } catch(e) {
          console.error('æ¸…ç†å¤±æ•—:', e);
        }
      }
      
      // âœ… åŠ å…¥ script æ¨™ç±¤åˆ° DOM
      document.body.appendChild(script);
      
      console.log('âœ… Script æ¨™ç±¤å·²åŠ å…¥ DOM');
    });
    
  } catch (error) {
    console.error('âŒ callAPI éŒ¯èª¤:', error);
    hideLoading();
    showAlert('ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
    return null;
  }
}




    // ==================== ç™»å…¥ç›¸é—œ ==================== 
async function handleLogin(e) {
  e.preventDefault();

  const empId = document.getElementById('empId').value.trim();
  const password = document.getElementById('password').value;

  if (!empId || !password) {
    showAlert('è«‹è¼¸å…¥å·¥è™Ÿå’Œå¯†ç¢¼', 'warning');
    return;
  }

  showLoading();

  try {
    const result = await callAPI('login', { empId, password });

    if (result && result.success) {
      sessionToken = result.data.sessionToken;
      currentUser = result.data.user;
      
      localStorage.setItem('sessionToken', sessionToken);
      
      showAlert('ç™»å…¥æˆåŠŸ!', 'success');

      // âœ… æ–°å¢ï¼šé–‹å§‹é è¼‰å…¥æµç¨‹
      console.log('ğŸ¯ é–‹å§‹é è¼‰å…¥è³‡æ–™...');
      PreloadManager.start().catch(error => {
        console.error('é è¼‰å…¥å¤±æ•—:', error);
      });

      showApp();
    } else {
      showAlert(result?.message || 'ç™»å…¥å¤±æ•—', 'error');
    }
  } catch (error) {
    console.error('Login error:', error);
    showAlert('ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
  } finally {
    hideLoading();
  }
}


async function validateSession() {
  const result = await callAPI('validateSession');
  
  console.log('âœ… validateSession çµæœ:', result);
  
  if (result && result.success) {
    // âœ… ä¿®æ­£: ç›´æ¥ä½¿ç”¨ result.data
    currentUser = result.data;
    
    console.log('âœ… currentUser å·²è¨­å®š:', currentUser);
    
    showApp();
  } else {
    console.log('âŒ Session é©—è­‰å¤±æ•—');
    logout();
  }
}


function logout() {
  // âœ… æ–°å¢ï¼šé‡ç½®é è¼‰å…¥ç‹€æ…‹
  PreloadManager.reset();
  
  // æ¸…é™¤å¿«å–
  CacheManager.clear();
  
  sessionToken = null;
  currentUser = null;
  localStorage.removeItem('sessionToken');

  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('appContainer').classList.remove('active');
  
  showAlert('å·²ç™»å‡º', 'info');
}


function showApp() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('appContainer').classList.add('active');
  
  // âœ… åŠ å…¥é˜²å‘†æª¢æŸ¥
  if (!currentUser) {
    console.error('âŒ currentUser æœªå®šç¾©');
    logout();
    return;
  }
  
  if (!currentUser.name) {
    console.error('âŒ currentUser.name æœªå®šç¾©');
    console.log('currentUser:', currentUser);
    logout();
    return;
  }
  
  // æ›´æ–°ä½¿ç”¨è€…è³‡è¨Š
  document.getElementById('userName').textContent = currentUser.name;
  document.getElementById('userDept').textContent = currentUser.department || 'æœªçŸ¥éƒ¨é–€';
  document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
  document.getElementById('welcomeName').textContent = currentUser.name;

  // âœ… ä¿®æ­£: åªæœ‰ s4 æ‰èƒ½çœ‹åˆ°ç®¡ç†å¾Œå°
  console.log('ä½¿ç”¨è€…æ¬Šé™: ' + currentUser.permission);
  
  if (currentUser.permission === 's4') {
    console.log('âœ… é¡¯ç¤ºç®¡ç†å¾Œå°é¸å–® (s4)');
    document.querySelectorAll('.admin-only').forEach(el => {
      el.classList.remove('hidden');
    });
  } else {
    console.log('âš ï¸ éš±è—ç®¡ç†å¾Œå°é¸å–® (é s4)');
    document.querySelectorAll('.admin-only').forEach(el => {
      el.classList.add('hidden');
    });
  }

  // è¼‰å…¥å„€éŒ¶æ¿
  loadDashboard();
}



    // ==================== é é¢å°èˆª ==================== 
/**
 * é é¢å°èˆª
 */
function navigateToPage(pageName) {
  console.log('=== navigateToPage ===');
  console.log('ç›®æ¨™é é¢:', pageName);
  console.log('ä½¿ç”¨è€…æ¬Šé™:', currentUser ? currentUser.permission : 'æœªç™»å…¥');
  
  // âœ… æª¢æŸ¥ç•¶å‰é é¢
  const currentPage = document.querySelector('.page-section.active')?.id.replace('Page', '');
  console.log('ç•¶å‰é é¢:', currentPage);
  
  // âœ… å¦‚æœå¾æ’­æ”¾é é¢é›¢é–‹,åœæ­¢è¨ˆæ™‚å™¨
  if (currentPage === 'player' && pageName !== 'player') {
    console.log('âœ… é›¢é–‹æ’­æ”¾é é¢,åœæ­¢è¨ˆæ™‚å™¨');
    stopVideoTimer();
    watchedSeconds = 0;  // âœ… é‡ç½®è§€çœ‹ç§’æ•¸
  }
  
  // âœ… æ¬Šé™æª¢æŸ¥: åªæœ‰ s4 æ‰èƒ½é€²å…¥ç®¡ç†å¾Œå°
  if (pageName === 'admin') {
    if (!currentUser || currentUser.permission !== 's4') {
      console.log('âŒ æ¬Šé™ä¸è¶³,ç„¡æ³•é€²å…¥ç®¡ç†å¾Œå°');
      showAlert('æ‚¨æ²’æœ‰æ¬Šé™é€²å…¥ç®¡ç†å¾Œå°', 'error');
      return;
    }
    console.log('âœ… æ¬Šé™æª¢æŸ¥é€šé (s4)');
  }
  
  // âœ… æ›´æ–°å°èˆªé¸å–®
  document.querySelectorAll('.navbar-item').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.page === pageName) {
      item.classList.add('active');
    }
  });

  // âœ… åˆ‡æ›é é¢
  document.querySelectorAll('.page-section').forEach(section => {
    section.classList.remove('active');
  });

  const targetPage = document.getElementById(pageName + 'Page');
  if (targetPage) {
    targetPage.classList.add('active');
  }

  // âœ… è¼‰å…¥å°æ‡‰é é¢è³‡æ–™
  switch(pageName) {
    case 'dashboard':
      loadDashboard();
      break;
    case 'courses':
      loadCourses();
      break;
    case 'mylearning':
      loadMyLearning();
      break;
    case 'admin':
      loadAdminData();
      break;
  }
  
  console.log('âœ… é é¢åˆ‡æ›å®Œæˆ:', pageName);
}



async function loadDashboard(forceRefresh = false) {
  try {
    console.log('=== loadDashboard ===');
    console.log('forceRefresh:', forceRefresh);
    
    // âœ… æª¢æŸ¥æ˜¯å¦å·²é è¼‰å…¥
    if (!forceRefresh && PreloadManager.status.dashboard && PreloadManager.data.dashboard) {
      console.log('âš¡ ä½¿ç”¨é è¼‰å…¥çš„å„€éŒ¶æ¿è³‡æ–™');
      const data = PreloadManager.data.dashboard;

      // ç›´æ¥æ¸²æŸ“è³‡æ–™
      document.getElementById('totalPoints').textContent = data.user.totalPoints;
      document.getElementById('completedCount').textContent = data.completedCourses.length;
      document.getElementById('inProgressCount').textContent = data.inProgressCourses.length;
      document.getElementById('requiredCount').textContent = data.requiredCourses.length;

      displayAnnouncements(data.announcements);
      displayRequiredCourses(data.requiredCourses);
      displayInProgressCourses(data.inProgressCourses);
      
      // å»¶é²è¼‰å…¥åœ–è¡¨
      setTimeout(() => {
        loadCharts(forceRefresh);
      }, 500);
      
      return;
    }

    // âœ… åŸæœ‰çš„è¼‰å…¥é‚è¼¯...
    if (forceRefresh) {
      CacheManager.clear('getPersonalDashboard_{}');
    }
    
    const result = await callAPIWithCache('getPersonalDashboard', {}, !forceRefresh);

    if (result && result.success) {
      const data = result.data;

      document.getElementById('totalPoints').textContent = data.user.totalPoints;
      document.getElementById('completedCount').textContent = data.completedCourses.length;
      document.getElementById('inProgressCount').textContent = data.inProgressCourses.length;
      document.getElementById('requiredCount').textContent = data.requiredCourses.length;

      displayAnnouncements(data.announcements);
      displayRequiredCourses(data.requiredCourses);
      displayInProgressCourses(data.inProgressCourses);
      
      setTimeout(() => {
        loadCharts(forceRefresh);
      }, 500);
    }
  } catch(error) {
    console.error('âŒ loadDashboard å¤±æ•—:', error);
    showAlert('è¼‰å…¥å„€éŒ¶æ¿å¤±æ•—', 'error');
  }
}


/**
 * è¼‰å…¥åœ–è¡¨ï¼ˆä½¿ç”¨å¿«å–ï¼‰
 */
async function loadCharts(forceRefresh = false) {
  console.log('=== loadCharts é–‹å§‹ ===');
  console.log('forceRefresh:', forceRefresh);
  
  try {
    // âœ… æª¢æŸ¥æ˜¯å¦å·²é è¼‰å…¥
    if (!forceRefresh && PreloadManager.status.charts && PreloadManager.data.charts) {
      console.log('âš¡ ä½¿ç”¨é è¼‰å…¥çš„åœ–è¡¨è³‡æ–™');
      const chartData = PreloadManager.data.charts;
      
      drawMonthlyCoursesChart(chartData.monthlyCourses);
      drawPointsTrendChart(chartData.pointsTrend);
      drawDepartmentStatsChart(chartData.departmentStats);
      
      console.log('âœ… åœ–è¡¨ç¹ªè£½å®Œæˆï¼ˆä½¿ç”¨é è¼‰å…¥ï¼‰');
      return;
    }

    // âœ… åŸæœ‰çš„è¼‰å…¥é‚è¼¯...
    if (forceRefresh) {
      CacheManager.clear('getChartData_{}');
    }
    
    const result = await callAPIWithCache('getChartData', {}, !forceRefresh);
    
    if (result && result.success) {
      const chartData = result.data;
      
      console.log('âœ… åœ–è¡¨è³‡æ–™:', chartData);
      
      drawMonthlyCoursesChart(chartData.monthlyCourses);
      drawPointsTrendChart(chartData.pointsTrend);
      drawDepartmentStatsChart(chartData.departmentStats);
      
      console.log('âœ… åœ–è¡¨ç¹ªè£½å®Œæˆ');
    } else {
      console.error('âŒ å–å¾—åœ–è¡¨è³‡æ–™å¤±æ•—:', result?.message);
    }
  } catch(error) {
    console.error('âŒ loadCharts å¤±æ•—:', error);
  }
}



    // ==================== å­¸ç¿’é€²åº¦åœ–è¡¨ï¼ˆäº’å‹•ç‰ˆï¼‰====================

let monthlyCoursesChart = null;
let pointsTrendChart = null;
let departmentStatsChart = null;

/**
 * ç¹ªè£½æ¯æœˆå®Œæˆèª²ç¨‹æ•¸åœ–è¡¨ï¼ˆæŠ˜ç·šåœ– + äº’å‹•ï¼‰
 */
function drawMonthlyCoursesChart(data) {
  console.log('=== drawMonthlyCoursesChart ===');
  console.log('data:', data);
  
  const ctx = document.getElementById('monthlyCoursesChart');
  if (!ctx) {
    console.error('âŒ æ‰¾ä¸åˆ° canvas å…ƒç´ ');
    return;
  }
  
  // éŠ·æ¯€èˆŠåœ–è¡¨
  if (monthlyCoursesChart) {
    monthlyCoursesChart.destroy();
  }
  
  monthlyCoursesChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: 'å®Œæˆèª²ç¨‹æ•¸',
        data: data.values,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37, 99, 235, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 10,
        pointBackgroundColor: '#2563eb',
        pointBorderColor: '#fff',
        pointBorderWidth: 3,
        pointHoverBackgroundColor: '#1d4ed8',
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 16,
          titleFont: {
            size: 16,
            weight: 'bold'
          },
          bodyFont: {
            size: 14
          },
          borderColor: '#2563eb',
          borderWidth: 2,
          displayColors: false,
          callbacks: {
            title: function(context) {
              return context[0].label;
            },
            label: function(context) {
              return 'å®Œæˆèª²ç¨‹æ•¸: ' + context.parsed.y + ' é–€';
            },
            afterLabel: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed.y / total) * 100).toFixed(1);
              return 'ä½”æ¯”: ' + percentage + '%';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            font: {
              size: 12
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          ticks: {
            font: {
              size: 12
            }
          },
          grid: {
            display: false
          }
        }
      },
      // âœ… æ–°å¢ï¼šé»æ“Šäº‹ä»¶
      onClick: (event, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const month = data.labels[index];
          const count = data.values[index];
          
          showAlert(`ğŸ“Š ${month}å®Œæˆäº† ${count} é–€èª²ç¨‹`, 'info');
        }
      },
      // âœ… æ–°å¢ï¼šæ»‘é¼ ç§»å‹•æ•ˆæœ
      onHover: (event, elements) => {
        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
      }
    }
  });
  
  console.log('âœ… æ¯æœˆå®Œæˆèª²ç¨‹æ•¸åœ–è¡¨ç¹ªè£½å®Œæˆ');
}

/**
 * ç¹ªè£½ç´¯ç©é»æ•¸è¶¨å‹¢åœ–è¡¨ï¼ˆé¢ç©åœ– + äº’å‹•ï¼‰
 */
function drawPointsTrendChart(data) {
  console.log('=== drawPointsTrendChart ===');
  console.log('data:', data);
  
  const ctx = document.getElementById('pointsTrendChart');
  if (!ctx) {
    console.error('âŒ æ‰¾ä¸åˆ° canvas å…ƒç´ ');
    return;
  }
  
  // éŠ·æ¯€èˆŠåœ–è¡¨
  if (pointsTrendChart) {
    pointsTrendChart.destroy();
  }
  
  pointsTrendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: 'ç´¯ç©é»æ•¸',
        data: data.values,
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.2)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 10,
        pointBackgroundColor: '#10b981',
        pointBorderColor: '#fff',
        pointBorderWidth: 3,
        pointHoverBackgroundColor: '#059669',
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 16,
          titleFont: {
            size: 16,
            weight: 'bold'
          },
          bodyFont: {
            size: 14
          },
          borderColor: '#10b981',
          borderWidth: 2,
          displayColors: false,
          callbacks: {
            title: function(context) {
              return context[0].label;
            },
            label: function(context) {
              return 'ç´¯ç©é»æ•¸: ' + context.parsed.y + ' é»';
            },
            afterLabel: function(context) {
              const index = context.dataIndex;
              if (index > 0) {
                const prevValue = context.dataset.data[index - 1];
                const currentValue = context.parsed.y;
                const increase = currentValue - prevValue;
                return increase > 0 ? 'â–² +' + increase + ' é»' : 'æŒå¹³';
              }
              return '';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            font: {
              size: 12
            },
            callback: function(value) {
              return value + ' é»';
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          ticks: {
            font: {
              size: 12
            }
          },
          grid: {
            display: false
          }
        }
      },
      // âœ… æ–°å¢ï¼šé»æ“Šäº‹ä»¶
      onClick: (event, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const month = data.labels[index];
          const points = data.values[index];
          
          showAlert(`ğŸ† ${month}ç´¯ç©é»æ•¸: ${points} é»`, 'success');
        }
      },
      // âœ… æ–°å¢ï¼šæ»‘é¼ ç§»å‹•æ•ˆæœ
      onHover: (event, elements) => {
        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
      }
    }
  });
  
  console.log('âœ… ç´¯ç©é»æ•¸è¶¨å‹¢åœ–è¡¨ç¹ªè£½å®Œæˆ');
}

/**
 * ç¹ªè£½éƒ¨é–€å®Œæˆç‡çµ±è¨ˆåœ–è¡¨ï¼ˆé•·æ¢åœ– + äº’å‹•ï¼‰
 */
function drawDepartmentStatsChart(data) {
  console.log('=== drawDepartmentStatsChart ===');
  console.log('data:', data);
  
  const ctx = document.getElementById('departmentStatsChart');
  if (!ctx) {
    console.error('âŒ æ‰¾ä¸åˆ° canvas å…ƒç´ ');
    return;
  }
  
  // éŠ·æ¯€èˆŠåœ–è¡¨
  if (departmentStatsChart) {
    departmentStatsChart.destroy();
  }
  
  // è¨ˆç®—å¹³å‡ã€æœ€é«˜ã€æœ€ä½å®Œæˆç‡
  const rates = data.completionRates;
  const avgRate = rates.length > 0 ? Math.round(rates.reduce((a, b) => a + b, 0) / rates.length) : 0;
  const maxRate = rates.length > 0 ? Math.max(...rates) : 0;
  const minRate = rates.length > 0 ? Math.min(...rates) : 0;
  
  // æ›´æ–°çµ±è¨ˆè³‡è¨Š
  document.getElementById('avgCompletionRate').textContent = avgRate + '%';
  document.getElementById('maxCompletionRate').textContent = maxRate + '%';
  document.getElementById('minCompletionRate').textContent = minRate + '%';
  
  departmentStatsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.departments,
      datasets: [{
        label: 'å®Œæˆç‡',
        data: data.completionRates,
        backgroundColor: data.completionRates.map(rate => {
          if (rate >= 80) return 'rgba(16, 185, 129, 0.8)';
          if (rate >= 60) return 'rgba(245, 158, 11, 0.8)';
          return 'rgba(239, 68, 68, 0.8)';
        }),
        borderColor: data.completionRates.map(rate => {
          if (rate >= 80) return '#10b981';
          if (rate >= 60) return '#f59e0b';
          return '#ef4444';
        }),
        borderWidth: 2,
        borderRadius: 8,
        hoverBackgroundColor: data.completionRates.map(rate => {
          if (rate >= 80) return 'rgba(16, 185, 129, 1)';
          if (rate >= 60) return 'rgba(245, 158, 11, 1)';
          return 'rgba(239, 68, 68, 1)';
        })
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 16,
          titleFont: {
            size: 16,
            weight: 'bold'
          },
          bodyFont: {
            size: 14
          },
          borderColor: '#2563eb',
          borderWidth: 2,
          displayColors: false,
          callbacks: {
            title: function(context) {
              return context[0].label + ' éƒ¨é–€';
            },
            label: function(context) {
              return 'å®Œæˆç‡: ' + context.parsed.y + '%';
            },
            afterLabel: function(context) {
              const rate = context.parsed.y;
              if (rate >= 80) return 'âœ… è¡¨ç¾å„ªç•°';
              if (rate >= 60) return 'âš ï¸ éœ€è¦åŠ æ²¹';
              return 'âŒ éœ€è¦æ”¹é€²';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            font: {
              size: 12
            },
            callback: function(value) {
              return value + '%';
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          ticks: {
            font: {
              size: 12
            }
          },
          grid: {
            display: false
          }
        }
      },
      // âœ… æ–°å¢ï¼šé»æ“Šäº‹ä»¶
      onClick: (event, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const dept = data.departments[index];
          const rate = data.completionRates[index];
          
          let emoji = 'âœ…';
          let message = 'è¡¨ç¾å„ªç•°';
          
          if (rate < 80) {
            emoji = 'âš ï¸';
            message = 'éœ€è¦åŠ æ²¹';
          }
          if (rate < 60) {
            emoji = 'âŒ';
            message = 'éœ€è¦æ”¹é€²';
          }
          
          showAlert(`${emoji} ${dept} éƒ¨é–€å®Œæˆç‡: ${rate}% (${message})`, 'info');
        }
      },
      // âœ… æ–°å¢ï¼šæ»‘é¼ ç§»å‹•æ•ˆæœ
      onHover: (event, elements) => {
        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
      }
    }
  });
  
  console.log('âœ… éƒ¨é–€å®Œæˆç‡çµ±è¨ˆåœ–è¡¨ç¹ªè£½å®Œæˆ');
}



    function displayAnnouncements(announcements) {
      const container = document.getElementById('announcementsList');
      
      if (announcements.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">ç›®å‰æ²’æœ‰å…¬å‘Š</p>';
        return;
      }

      container.innerHTML = announcements.map(ann => `
        <div class="announcement-item ${ann.isPinned ? 'pinned' : ''}">
          <div class="announcement-header">
            <span class="announcement-time">${ann.time}</span>
            ${ann.isPinned ? '<span class="announcement-badge">ç½®é ‚</span>' : ''}
          </div>
          <div class="announcement-content">${ann.content}</div>
        </div>
      `).join('');
    }

function displayRequiredCourses(courses) {
  const container = document.getElementById('requiredCoursesList');
  
  if (courses.length === 0) {
    container.innerHTML = '<p class="text-center" style="color: var(--text-secondary); padding: 20px;">å¤ªæ£’äº†!æ‚¨å·²å®Œæˆæ‰€æœ‰å¿…ä¿®èª²ç¨‹ ğŸ‰</p>';
    return;
  }

  container.innerHTML = courses.map(course => {
    const isExpired = course.isExpired;
    const daysLeft = course.daysLeft;
    
    return `
      <div class="course-card">
        <div class="course-card-header required">
          <span class="course-badge">å¿…ä¿®</span>
          <h3 class="course-title">${course.courseName}</h3>
          <p class="course-id">${course.courseId}</p>
        </div>
        <div class="course-card-body">
          <div class="course-deadline ${isExpired ? 'danger' : daysLeft <= 5 ? 'warning' : ''}">
            <i class="fas fa-calendar-alt"></i>
            æˆªæ­¢æ—¥æœŸ: ${course.deadline}
            ${!isExpired ? ` (å‰©é¤˜ ${daysLeft} å¤©)` : ' (å·²é€¾æœŸ)'}
          </div>
          <div class="course-actions">
            <button class="btn btn-primary" onclick="startLearning('${course.courseId}')">
              <i class="fas fa-play"></i> é–‹å§‹å­¸ç¿’
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function displayInProgressCourses(courses) {
  const container = document.getElementById('inProgressCoursesList');
  
  if (courses.length === 0) {
    container.innerHTML = '<p class="text-center" style="color: var(--text-secondary); padding: 20px;">ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„èª²ç¨‹</p>';
    return;
  }

  container.innerHTML = courses.map(course => `
    <div class="course-card">
      <div class="course-card-header">
        <span class="course-badge">é€²è¡Œä¸­</span>
        <h3 class="course-title">${course.courseName}</h3>
        <p class="course-id">${course.courseId}</p>
      </div>
      <div class="course-card-body">
        <div class="course-meta">
          <span class="course-meta-item">
            <i class="fas fa-clock"></i>
            ä¸Šæ¬¡è§€çœ‹: ${new Date(course.lastWatchTime).toLocaleDateString()}
          </span>
        </div>
        <div class="course-actions">
          <button class="btn btn-primary" onclick="continueLearning('${course.courseId}')">
            <i class="fas fa-play"></i> ç¹¼çºŒå­¸ç¿’
          </button>
        </div>
      </div>
    </div>
  `).join('');
}


    function displayInProgressCourses(courses) {
      const container = document.getElementById('inProgressCoursesList');
      
      if (courses.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: var(--text-secondary); padding: 20px;">ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„èª²ç¨‹</p>';
        return;
      }

      container.innerHTML = courses.map(course => `
        <div class="course-card" onclick="viewCourse('${course.courseId}')">
          <div class="course-card-header">
            <span class="course-badge">é€²è¡Œä¸­</span>
            <h3 class="course-title">${course.courseName}</h3>
            <p class="course-id">${course.courseId}</p>
          </div>
          <div class="course-card-body">
            <div class="course-meta">
              <span class="course-meta-item">
                <i class="fas fa-clock"></i>
                ä¸Šæ¬¡è§€çœ‹: ${new Date(course.lastWatchTime).toLocaleDateString()}
              </span>
            </div>
            <div class="course-actions">
              <button class="btn btn-primary" onclick="event.stopPropagation(); continueLearning('${course.courseId}')">
                <i class="fas fa-play"></i> ç¹¼çºŒå­¸ç¿’
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

// ==================== ä½¿ç”¨å¿«å–çš„å‡½æ•¸ ====================

/**
 * è¼‰å…¥èª²ç¨‹åˆ—è¡¨ï¼ˆä½¿ç”¨å¿«å–ï¼‰
 */
async function loadCourses(forceRefresh = false) {
  try {
    console.log('=== loadCourses ===');
    console.log('forceRefresh:', forceRefresh);
    
    // âœ… æª¢æŸ¥æ˜¯å¦å·²é è¼‰å…¥
    if (!forceRefresh && PreloadManager.status.courses && PreloadManager.data.courses) {
      console.log('âš¡ ä½¿ç”¨é è¼‰å…¥çš„èª²ç¨‹åˆ—è¡¨');
      allCourses = PreloadManager.data.courses;
      displayCourses(allCourses);
      populateCourseCategoryFilter();
      populateCourseGroupFilter();
      return;
    }

    // âœ… åŸæœ‰çš„è¼‰å…¥é‚è¼¯...
    if (forceRefresh) {
      CacheManager.clear('getCourseList_{}');
    }
    
    const result = await callAPIWithCache('getCourseList', {}, !forceRefresh);

    if (result && result.success) {
      allCourses = result.data;
      displayCourses(allCourses);
      populateCourseCategoryFilter();
      populateCourseGroupFilter();
    }
  } catch(error) {
    console.error('âŒ loadCourses å¤±æ•—:', error);
    showAlert('è¼‰å…¥èª²ç¨‹å¤±æ•—', 'error');
  }
}



    /**
 * å¡«å……èª²ç¨‹ç€è¦½é é¢çš„èª²ç¾¤é¸é …
 */
function populateCourseGroupFilter() {
  const groups = [...new Set(allCourses.map(c => c.courseGroup))];
  const select = document.getElementById('filterCourseGroup');
  
  if (select) {
    select.innerHTML = '<option value="">å…¨éƒ¨</option>' + 
      groups.map(group => `<option value="${group}">${group}</option>`).join('');
  }
}

/**
 * å¡«å……èª²ç¨‹ç€è¦½é é¢çš„èª²é–€é¸é …
 */
function populateCourseCategoryFilter() {
  const categories = [...new Set(allCourses.map(c => c.courseCategory))];
  const select = document.getElementById('filterCourseCategory');
  
  if (select) {
    select.innerHTML = '<option value="">å…¨éƒ¨</option>' + 
      categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
  }
}
    function applyCourseFilters() {
      const groupFilter = document.getElementById('filterCourseGroup').value;
      const categoryFilter = document.getElementById('filterCourseCategory').value;
      const typeFilter = document.getElementById('filterCourseType').value;
      const statusFilter = document.getElementById('filterStatus').value;

      let filtered = allCourses;

      if (groupFilter) {
        filtered = filtered.filter(c => c.courseGroup === groupFilter);
      }

      if (categoryFilter) {
        filtered = filtered.filter(c => c.courseCategory === categoryFilter);
      }

      if (typeFilter) {
        if (typeFilter === 'required') {
          filtered = filtered.filter(c => c.isRequired);
        } else if (typeFilter === 'optional') {
          filtered = filtered.filter(c => !c.isRequired);
        }
      }

      if (statusFilter) {
        filtered = filtered.filter(c => {
          if (statusFilter === 'completed') return c.isCompleted;
          if (statusFilter === 'inProgress') return c.hasStarted && !c.isCompleted;
          if (statusFilter === 'notStarted') return !c.hasStarted;
          return true;
        });
      }

      displayCourses(filtered);
    }

function displayCourses(courses) {
  const container = document.getElementById('coursesList');
  
  if (courses.length === 0) {
    container.innerHTML = '<p class="text-center" style="color: var(--text-secondary); grid-column: 1/-1;">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„èª²ç¨‹</p>';
    return;
  }

  container.innerHTML = courses.map(course => {
    const headerClass = course.isCompleted ? 'completed' : course.isRequired ? 'required' : '';
    const badgeText = course.isCompleted ? 'å·²å®Œæˆ' : course.isRequired ? 'å¿…ä¿®' : 'é¸ä¿®';
    
    // âœ… æ–°å¢ï¼šæ•™å¸«è³‡è¨Šï¼ˆå¦‚æœæœ‰çš„è©±æ‰é¡¯ç¤ºï¼‰
    const teacherInfo = course.teacher 
      ? `<p class="course-teacher">ğŸ‘¨â€ğŸ« æˆèª²æ•™å¸«ï¼š${course.teacher}</p>` 
      : '';
    
    let deadlineHTML = '';
    if (course.deadline) {
      const daysLeft = calculateDaysLeft(course.deadline);
      const deadlineClass = course.isExpired ? 'danger' : daysLeft <= 5 ? 'warning' : '';
      deadlineHTML = `
        <div class="course-deadline ${deadlineClass}">
          <i class="fas fa-calendar-alt"></i>
          æˆªæ­¢æ—¥æœŸ: ${course.deadline}
          ${!course.isExpired && daysLeft !== null ? ` (å‰©é¤˜ ${daysLeft} å¤©)` : ''}
          ${course.isExpired ? ' (å·²é€¾æœŸ)' : ''}
        </div>
      `;
    }

    return `
      <div class="course-card">
        <div class="course-card-header ${headerClass}">
          <span class="course-badge">${badgeText}</span>
          <h3 class="course-title">${course.courseName}</h3>
          <p class="course-id">${course.courseId}</p>
        </div>
        <div class="course-card-body">
          ${teacherInfo}
          <p class="course-desc">${course.courseDesc || 'æš«ç„¡èªªæ˜'}</p>
          <div class="course-meta">
            <span class="course-meta-item">
              <i class="fas fa-folder"></i>
              ${course.courseGroup} - ${course.courseCategory}
            </span>
            <span class="course-meta-item">
              <i class="fas fa-star"></i>
              ${course.points} é»
            </span>
          </div>
          ${deadlineHTML}
          <div class="course-actions">
            ${course.isCompleted 
              ? '<button class="btn btn-success" disabled><i class="fas fa-check"></i> å·²å®Œæˆ</button>'
              : course.hasStarted
                ? `<button class="btn btn-primary" onclick="startLearning('${course.courseId}')"><i class="fas fa-play"></i> ç¹¼çºŒå­¸ç¿’</button>`
                : `<button class="btn btn-primary" onclick="startLearning('${course.courseId}')"><i class="fas fa-play"></i> é–‹å§‹å­¸ç¿’</button>`
            }
          </div>
        </div>
      </div>
    `;
  }).join('');
}




    function calculateDaysLeft(deadline) {
      if (!deadline) return null;
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      const deadlineDate = new Date(deadline);
      deadlineDate.setHours(23, 59, 59, 999);
      
      const diffTime = deadlineDate - now;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      return diffDays > 0 ? diffDays : 0;
    }

/**
 * æŸ¥çœ‹èª²ç¨‹è©³ç´°è³‡æ–™ (å¾èª²ç¨‹å¡ç‰‡é»é¸é€²å…¥)
 */
async function viewCourse(courseId) {
  console.log('=== viewCourse é–‹å§‹ ===');
  console.log('courseId:', courseId);
  
  const result = await callAPI('getCourseDetail', { courseId });

  if (result && result.success) {
    currentCourse = result.data;
    
    console.log('âœ… èª²ç¨‹è³‡æ–™:', currentCourse);
    
    // âœ… æª¢æŸ¥å‰ç½®èª²ç¨‹
    if (!currentCourse.prerequisiteCompleted) {
      showAlert(`è«‹å…ˆå®Œæˆå‰ç½®èª²ç¨‹: ${currentCourse.prerequisiteCourseId}`, 'warning');
      return;
    }

    // âœ… å¦‚æœå·²å®Œæˆ,ç›´æ¥é¡¯ç¤ºå®Œæˆè¨Šæ¯
    if (currentCourse.isCompleted) {
      showAlert('æ‚¨å·²å®Œæˆæ­¤èª²ç¨‹!', 'info');
      return;
    }

    // âš ï¸ æ³¨æ„: viewCourse() ä¸æœƒå»ºç«‹å­¸ç¿’ç´€éŒ„
    // ä½¿ç”¨è€…éœ€è¦é»é¸ã€é–‹å§‹å­¸ç¿’ã€‘æŒ‰éˆ•
    console.log('âš ï¸ å°šæœªå»ºç«‹å­¸ç¿’ç´€éŒ„,è«‹é»é¸ã€é–‹å§‹å­¸ç¿’ã€‘');
    
    // âœ… å°èˆªåˆ°æ’­æ”¾é é¢
    navigateToPage('player');
    displayPlayer();
  }
}

/**
 * é–‹å§‹å­¸ç¿’ (å»ºç«‹å­¸ç¿’ç´€éŒ„)
 */
async function startLearning(courseId) {
  console.log('=== startLearning é–‹å§‹ ===');
  console.log('courseId:', courseId);
  
  showLoading();
  
  const result = await callAPI('startLearning', { courseId });

  console.log('âœ… API å®Œæ•´å›æ‡‰:', result);
  // âœ… åŠ å…¥è©³ç´°æª¢æŸ¥
  if (result && result.data && result.data.courseDetail) {
    console.log('=== courseDetail å…§å®¹ ===');
    console.log('å®Œæ•´ courseDetail:', result.data.courseDetail);
    console.log('videoDuration å€¼:', result.data.courseDetail.videoDuration);
    console.log('videoDuration å‹åˆ¥:', typeof result.data.courseDetail.videoDuration);
    console.log('videoDuration æ˜¯å¦å­˜åœ¨:', 'videoDuration' in result.data.courseDetail);
  }

  hideLoading();

  if (result && result.success) {
    // âœ… æª¢æŸ¥ data çµæ§‹
    if (!result.data) {
      console.error('âŒ result.data ä¸å­˜åœ¨');
      showAlert('ç³»çµ±éŒ¯èª¤: ç„¡æ³•å–å¾—èª²ç¨‹è³‡æ–™', 'error');
      return;
    }
    
    if (!result.data.recordId) {
      console.error('âŒ result.data.recordId ä¸å­˜åœ¨');
      showAlert('ç³»çµ±éŒ¯èª¤: ç„¡æ³•å–å¾—ç´€éŒ„ID', 'error');
      return;
    }
    
    if (!result.data.courseDetail) {
      console.error('âŒ result.data.courseDetail ä¸å­˜åœ¨');
      showAlert('ç³»çµ±éŒ¯èª¤: ç„¡æ³•å–å¾—èª²ç¨‹è©³ç´°è³‡æ–™', 'error');
      return;
    }
    
    // âœ… è¨­å®šå…¨åŸŸè®Šæ•¸
    currentRecordId = result.data.recordId;
    currentCourse = result.data.courseDetail;
    
    console.log('âœ… currentRecordId:', currentRecordId);
    console.log('âœ… currentCourse:', currentCourse);
    
    // âœ… å°èˆªåˆ°æ’­æ”¾é é¢
    navigateToPage('player');
    displayPlayer();
  } else {
    console.error('âŒ é–‹å§‹å­¸ç¿’å¤±æ•—');
    showAlert(result?.message || 'é–‹å§‹å­¸ç¿’å¤±æ•—', 'error');
  }
}

/**
 * ç¹¼çºŒå­¸ç¿’ (é‡æ–°é–‹å§‹å­¸ç¿’)
 */
async function continueLearning(courseId) {
  console.log('=== continueLearning é–‹å§‹ ===');
  console.log('courseId:', courseId);
  
  // âœ… ç›´æ¥å‘¼å« startLearning()
  await startLearning(courseId);
}


function displayPlayer() {
  console.log('=== displayPlayer é–‹å§‹ ===');
  console.log('currentCourse:', currentCourse);
  console.log('currentRecordId:', currentRecordId);
  
  // âœ… é˜²å‘†æª¢æŸ¥
  if (!currentCourse) {
    console.error('âŒ currentCourse æœªå®šç¾©');
    showAlert('èª²ç¨‹è³‡æ–™è¼‰å…¥å¤±æ•—,è«‹é‡æ–°é–‹å§‹å­¸ç¿’', 'error');
    backToCourses();
    return;
  }
  
  const requiredFields = ['courseName', 'courseId', 'videoUrl'];
  for (const field of requiredFields) {
    if (!currentCourse[field]) {
      console.error(`âŒ currentCourse.${field} æœªå®šç¾©`);
      showAlert(`èª²ç¨‹è³‡æ–™ä¸å®Œæ•´: ç¼ºå°‘ ${field}`, 'error');
      backToCourses();
      return;
    }
  }
  
  // âœ… é¡¯ç¤ºèª²ç¨‹è³‡è¨Š
  document.getElementById('playerCourseTitle').textContent = currentCourse.courseName;
  document.getElementById('playerCourseId').textContent = currentCourse.courseId;
  document.getElementById('playerCoursePoints').textContent = currentCourse.points || 0;
  document.getElementById('playerDeadline').textContent = currentCourse.deadline || 'ç„¡æœŸé™';
  document.getElementById('playerCourseDesc').textContent = currentCourse.courseDesc || 'æš«ç„¡èªªæ˜';

  // âœ… æ ¹æ“šèª²ç¨‹é¡å‹è¼‰å…¥ä¸åŒçš„æ’­æ”¾å™¨
  const courseType = currentCourse.courseType || 'google_drive';
  
  console.log('âœ… èª²ç¨‹é¡å‹: ' + courseType);
  
  if (courseType === 'google_drive') {
    // Google Drive å½±ç‰‡
    loadGoogleDrivePlayer();
  } else if (courseType === 'external_webpage') {
    // å¤–éƒ¨ç¶²é 
    loadExternalWebpagePlayer();
  } else {
    console.error('âŒ æœªçŸ¥çš„èª²ç¨‹é¡å‹: ' + courseType);
    showAlert('æœªçŸ¥çš„èª²ç¨‹é¡å‹', 'error');
    return;
  }
  
  // âœ… æª¢æŸ¥æ˜¯å¦æœ‰å­¸ç¿’ç´€éŒ„
  const btnStartExam = document.getElementById('btnStartExam');
  
  if (!currentRecordId) {
    console.log('âš ï¸ å°šæœªå»ºç«‹å­¸ç¿’ç´€éŒ„');
    btnStartExam.disabled = true;
    btnStartExam.textContent = 'è«‹å…ˆé»é¸ã€é–‹å§‹å­¸ç¿’ã€‘';
    showAlert('è«‹å…ˆé»é¸ã€é–‹å§‹å­¸ç¿’ã€‘æŒ‰éˆ•ä»¥å»ºç«‹å­¸ç¿’ç´€éŒ„', 'info');
    return;
  }
  
  console.log('âœ… å­¸ç¿’ç´€éŒ„ID: ' + currentRecordId);
  
  videoStartTime = new Date();
  watchedSeconds = 0;

  // âœ… åœæ­¢èˆŠçš„è¨ˆæ™‚å™¨ (å¦‚æœæœ‰çš„è©±)
  if (videoCheckInterval) {
    clearInterval(videoCheckInterval);
    videoCheckInterval = null;
  }
  
  // âœ… å–å¾—å½±ç‰‡é•·åº¦
  let videoDuration = 180;
  
  console.log('=== æª¢æŸ¥ videoDuration ===');
  console.log('currentCourse.videoDuration:', currentCourse.videoDuration);
  console.log('å‹åˆ¥:', typeof currentCourse.videoDuration);
  
  if (currentCourse.videoDuration !== undefined && 
      currentCourse.videoDuration !== null && 
      currentCourse.videoDuration !== '') {
    
    const parsed = parseInt(currentCourse.videoDuration);
    
    if (!isNaN(parsed) && parsed > 0) {
      videoDuration = parsed;
      console.log('âœ… ä½¿ç”¨èª²ç¨‹è¨­å®šçš„å½±ç‰‡é•·åº¦:', videoDuration, 'ç§’');
    } else {
      console.log('âš ï¸ è§£æå¤±æ•—,ä½¿ç”¨é è¨­å€¼:', videoDuration, 'ç§’');
    }
  } else {
    console.log('âš ï¸ videoDuration ä¸å­˜åœ¨,ä½¿ç”¨é è¨­å€¼:', videoDuration, 'ç§’');
  }
  
  // âœ… è¨­å®šå…¨åŸŸè®Šæ•¸
  currentVideoDuration = videoDuration;

  console.log('âœ… æœ€çµ‚å½±ç‰‡é•·åº¦:', currentVideoDuration, 'ç§’ (' + Math.floor(currentVideoDuration / 60) + ' åˆ†é˜)');

  // âœ… è¨­å®šã€Œé–‹å§‹æ’­æ”¾ã€æŒ‰éˆ•
  setupStartWatchingButton();

  // âœ… åˆå§‹åŒ–æ™‚é–“è³‡è¨Šé¡¯ç¤º
  updateTimeInfo();

  console.log('âœ… displayPlayer å®Œæˆ');
}

/**
 * âœ… æ–°å¢ï¼šè¼‰å…¥ Google Drive æ’­æ”¾å™¨
 */
function loadGoogleDrivePlayer() {
  console.log('=== loadGoogleDrivePlayer ===');
  
  const videoUrl = convertDriveUrl(currentCourse.videoUrl);
  
  if (!videoUrl) {
    console.error('âŒ å½±ç‰‡é€£çµè½‰æ›å¤±æ•—');
    showAlert('å½±ç‰‡é€£çµç„¡æ•ˆ', 'error');
    return;
  }
  
  const videoIframe = document.getElementById('videoPlayer');
  videoIframe.src = videoUrl;
  
  console.log('âœ… Google Drive æ’­æ”¾å™¨è¼‰å…¥å®Œæˆ');
}

/**
 * âœ… æ–°å¢ï¼šè¼‰å…¥å¤–éƒ¨ç¶²é æ’­æ”¾å™¨
 */
function loadExternalWebpagePlayer() {
  console.log('=== loadExternalWebpagePlayer ===');
  
  const videoUrl = currentCourse.videoUrl;
  
  if (!videoUrl) {
    console.error('âŒ ç¶²é é€£çµç‚ºç©º');
    showAlert('ç¶²é é€£çµç„¡æ•ˆ', 'error');
    return;
  }
  
  const videoIframe = document.getElementById('videoPlayer');
  
  // âœ… å˜—è©¦åµŒå…¥ iframe
  videoIframe.src = videoUrl;
  
  // âœ… ç›£è½ iframe è¼‰å…¥éŒ¯èª¤
  videoIframe.onerror = function() {
    console.error('âŒ iframe è¼‰å…¥å¤±æ•—ï¼ˆå¯èƒ½è¢« X-Frame-Options é˜»æ“‹ï¼‰');
    
    // âœ… æ”¹ç”¨æ–°è¦–çª—é–‹å•Ÿ
    const confirmOpen = confirm('æ­¤ç¶²é ç„¡æ³•åµŒå…¥é¡¯ç¤ºï¼Œæ˜¯å¦è¦åœ¨æ–°è¦–çª—é–‹å•Ÿï¼Ÿ');
    
    if (confirmOpen) {
      window.open(videoUrl, '_blank');
      
      // âœ… æç¤ºä½¿ç”¨è€…æ‰‹å‹•å®Œæˆ
      showAlert('è«‹åœ¨æ–°è¦–çª—ä¸­å®Œæˆå­¸ç¿’ï¼Œå®Œæˆå¾Œé»æ“Šã€é–‹å§‹æ¸¬é©—ã€‘', 'info');
      
      // âœ… å•Ÿç”¨æ¸¬é©—æŒ‰éˆ•ï¼ˆæ‰‹å‹•å®Œæˆæ¨¡å¼ï¼‰
      const btnStartExam = document.getElementById('btnStartExam');
      btnStartExam.disabled = false;
      btnStartExam.textContent = 'é–‹å§‹æ¸¬é©—';
    } else {
      backToCourses();
    }
  };
  
  console.log('âœ… å¤–éƒ¨ç¶²é æ’­æ”¾å™¨è¼‰å…¥å®Œæˆ');
}


/**
 * è¨­å®šã€Œé–‹å§‹æ’­æ”¾ã€æŒ‰éˆ•
 */
function setupStartWatchingButton() {
  console.log('=== setupStartWatchingButton ===');
  
  const btnStartWatching = document.getElementById('btnStartWatching');
  const videoStatus = document.getElementById('videoStatus');
  
  if (!btnStartWatching) {
    console.error('âŒ æ‰¾ä¸åˆ°ã€Œé–‹å§‹æ’­æ”¾ã€æŒ‰éˆ•');
    return;
  }
  
  // âœ… æª¢æŸ¥æ˜¯å¦å·²ç¶“çœ‹å®Œ
  if (watchedSeconds >= currentVideoDuration) {
    console.log('âš ï¸ å½±ç‰‡å·²çœ‹å®Œ');
    btnStartWatching.disabled = true;
    btnStartWatching.textContent = 'âœ… å·²è§€çœ‹å®Œç•¢';
    btnStartWatching.style.backgroundColor = '#28a745';
    
    if (videoStatus) {
      videoStatus.textContent = 'å½±ç‰‡å·²è§€çœ‹å®Œç•¢ï¼Œå¯ä»¥é–‹å§‹æ¸¬é©—äº†ï¼';
      videoStatus.style.color = '#28a745';
    }
    
    return;
  }
  
  // âœ… æª¢æŸ¥è¨ˆæ™‚å™¨æ˜¯å¦å·²ç¶“å•Ÿå‹•
  if (videoCheckInterval) {
    console.log('âš ï¸ è¨ˆæ™‚å™¨å·²å•Ÿå‹•');
    btnStartWatching.disabled = true;
    btnStartWatching.textContent = 'â±ï¸ è§€çœ‹ä¸­...';
    btnStartWatching.style.backgroundColor = '#ffc107';
    
    if (videoStatus) {
      videoStatus.textContent = 'æ­£åœ¨è¨ˆæ™‚ä¸­ï¼Œè«‹ç¹¼çºŒè§€çœ‹å½±ç‰‡';
      videoStatus.style.color = '#ffc107';
    }
    
    return;
  }
  
  // âœ… è¨­å®šæŒ‰éˆ•é»æ“Šäº‹ä»¶
  btnStartWatching.onclick = function() {
    console.log('âœ… ä½¿ç”¨è€…é»æ“Šã€Œé–‹å§‹æ’­æ”¾ã€æŒ‰éˆ•');
    
    // âœ… å†æ¬¡æª¢æŸ¥æ˜¯å¦å·²ç¶“çœ‹å®Œ
    if (watchedSeconds >= currentVideoDuration) {
      console.log('âš ï¸ å½±ç‰‡å·²çœ‹å®Œ');
      showAlert('å½±ç‰‡å·²è§€çœ‹å®Œç•¢', 'info');
      return;
    }
    
    // âœ… å†æ¬¡æª¢æŸ¥è¨ˆæ™‚å™¨æ˜¯å¦å·²ç¶“å•Ÿå‹•
    if (videoCheckInterval) {
      console.log('âš ï¸ è¨ˆæ™‚å™¨å·²ç¶“å•Ÿå‹•');
      showAlert('è¨ˆæ™‚å™¨å·²ç¶“å•Ÿå‹•', 'info');
      return;
    }
    
// âœ… å•Ÿå‹•è¨ˆæ™‚å™¨
startVideoTimer();

// âœ… æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
btnStartWatching.disabled = true;
btnStartWatching.textContent = 'â±ï¸ è§€çœ‹ä¸­...';
btnStartWatching.style.backgroundColor = '#ffc107';

if (videoStatus) {
  videoStatus.textContent = 'æ­£åœ¨è¨ˆæ™‚ä¸­ï¼Œè«‹ç¹¼çºŒè§€çœ‹å½±ç‰‡';
  videoStatus.style.color = '#ffc107';
}

// âœ… é¡¯ç¤ºæ™‚é–“è³‡è¨Šå€å¡Š
const videoTimeInfo = document.getElementById('videoTimeInfo');
if (videoTimeInfo) {
  videoTimeInfo.style.display = 'block';
}

// âœ… æ›´æ–°æ™‚é–“è³‡è¨Š
updateTimeInfo();

showAlert('å·²é–‹å§‹è¨ˆæ™‚ï¼Œè«‹è§€çœ‹å½±ç‰‡', 'success');

  };
  
  console.log('âœ… setupStartWatchingButton å®Œæˆ');
}

/**
 * é–‹å§‹å½±ç‰‡è¿½è¹¤
 */
function startVideoTracking(videoDuration) {
  console.log('=== startVideoTracking ===');
  console.log('å½±ç‰‡é•·åº¦:', videoDuration, 'ç§’');
  
  // âœ… æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡å‰ç«¯é€²åº¦æ¢
  videoCheckInterval = setInterval(() => {
    watchedSeconds += 30;
    updateProgressBar(videoDuration);
  }, 30000);

  // âœ… å½±ç‰‡æ’­æ”¾å®Œç•¢å¾Œ,æ›´æ–°å¾Œç«¯ä¸¦å•Ÿç”¨æ¸¬é©—æŒ‰éˆ•
  setTimeout(() => {
    if (videoCheckInterval) {
      clearInterval(videoCheckInterval);
    }
    
    // âœ… æœ€å¾Œä¸€æ¬¡æ›´æ–°é€²åº¦ (æ¨™è¨˜ç‚ºå®Œæˆ)
    watchedSeconds = videoDuration;
    updateProgressBar(videoDuration);
    updateProgressToServer(videoDuration, true);
    
    const btnStartExam = document.getElementById('btnStartExam');
    btnStartExam.disabled = false;
    btnStartExam.textContent = 'é–‹å§‹æ¸¬é©—';
    showAlert('å½±ç‰‡å·²è§€çœ‹å®Œç•¢,å¯ä»¥é–‹å§‹æ¸¬é©—äº†!', 'success');
  }, videoDuration * 1000);
}


/**
 * æ›´æ–°é€²åº¦åˆ°ä¼ºæœå™¨
 */
async function updateProgressToServer(videoDuration, isComplete = false) {
  if (!currentRecordId) return;

  const progressPercent = Math.min(100, Math.round((watchedSeconds / videoDuration) * 100));
  
  const progressData = {
    watchedSeconds: watchedSeconds,
    videoDuration: videoDuration,  // âœ… åŠ å…¥å½±ç‰‡é•·åº¦
    progress: progressPercent,
    isComplete: isComplete || progressPercent >= 100
  };

  console.log('æ›´æ–°é€²åº¦åˆ°ä¼ºæœå™¨:', progressData);

  try {
    const result = await callAPI('updateProgress', {
      recordId: currentRecordId,
      progressData: JSON.stringify(progressData)
    });

    if (result && result.success) {
      console.log('âœ… é€²åº¦æ›´æ–°æˆåŠŸ');
    } else {
      console.error('âŒ é€²åº¦æ›´æ–°å¤±æ•—:', result?.message);
    }
  } catch (error) {
    console.error('âŒ æ›´æ–°é€²åº¦å¤±æ•—:', error);
  }
}


/**
 * æ›´æ–°å‰ç«¯é€²åº¦æ¢
 */
function updateProgressBar() {
  if (!currentRecordId) return;

  // âœ… é˜²å‘†æª¢æŸ¥: å¦‚æœ currentVideoDuration ç„¡æ•ˆ,ä½¿ç”¨é è¨­å€¼
  const videoDuration = (currentVideoDuration && currentVideoDuration > 0) 
    ? currentVideoDuration 
    : 180;
  
  const progressPercent = Math.min(100, Math.round((watchedSeconds / videoDuration) * 100));
  
  const progressFill = document.getElementById('progressFill');
  if (progressFill) {
    progressFill.style.width = progressPercent + '%';
    progressFill.textContent = progressPercent + '%';
  }
  
  console.log(`é€²åº¦æ›´æ–°: ${watchedSeconds}/${videoDuration} ç§’ (${progressPercent}%)`);
}

/**
 * å°‡ç§’æ•¸è½‰æ›ç‚º mm:ss æ ¼å¼
 * @param {number} seconds - ç§’æ•¸
 * @returns {string} - æ ¼å¼åŒ–å¾Œçš„æ™‚é–“ï¼ˆä¾‹å¦‚ï¼š3:45ï¼‰
 */
function formatTime(seconds) {
  if (!seconds || seconds < 0) return '0:00';
  
  const minutes = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  
  return `${minutes}:${secs.toString().padStart(2, '0')}`;
}

/**
 * æ›´æ–°æ™‚é–“è³‡è¨Šé¡¯ç¤º
 */
function updateTimeInfo() {
  // âœ… é˜²å‘†æª¢æŸ¥
  if (!currentRecordId || !currentVideoDuration) {
    return;
  }
  
  // âœ… è¨ˆç®—å‰©é¤˜æ™‚é–“
  const remainingSeconds = Math.max(0, currentVideoDuration - watchedSeconds);
  
  // âœ… è¨ˆç®—é€²åº¦ç™¾åˆ†æ¯”
  const progressPercent = Math.min(100, Math.round((watchedSeconds / currentVideoDuration) * 100));
  
  // âœ… æ›´æ–° DOM
  const totalDurationEl = document.getElementById('totalDuration');
  const watchedTimeEl = document.getElementById('watchedTime');
  const remainingTimeEl = document.getElementById('remainingTime');
  const progressPercentEl = document.getElementById('progressPercent');
  
  if (totalDurationEl) {
    totalDurationEl.textContent = formatTime(currentVideoDuration);
  }
  
  if (watchedTimeEl) {
    watchedTimeEl.textContent = formatTime(watchedSeconds);
  }
  
  if (remainingTimeEl) {
    remainingTimeEl.textContent = formatTime(remainingSeconds);
  }
  
  if (progressPercentEl) {
    progressPercentEl.textContent = progressPercent + '%';
  }
  
  // âœ… æ ¹æ“šå‰©é¤˜æ™‚é–“æ”¹è®Šé¡è‰²
  if (remainingTimeEl) {
    if (remainingSeconds <= 30) {
      remainingTimeEl.style.color = '#ef4444'; // ç´…è‰²ï¼ˆå¿«çµæŸäº†ï¼‰
    } else if (remainingSeconds <= 60) {
      remainingTimeEl.style.color = '#f59e0b'; // æ©™è‰²ï¼ˆå³å°‡çµæŸï¼‰
    } else {
      remainingTimeEl.style.color = '#f59e0b'; // æ©™è‰²ï¼ˆæ­£å¸¸ï¼‰
    }
  }
}



/**
 * æ›´æ–°é€²åº¦åˆ°ä¼ºæœå™¨ (ä½¿ç”¨å…¨åŸŸè®Šæ•¸ currentVideoDuration)
 */
async function updateProgressToServer(isComplete = false) {
  if (!currentRecordId) return;

  const progressPercent = Math.min(100, Math.round((watchedSeconds / currentVideoDuration) * 100));
  
  const progressData = {
    watchedSeconds: watchedSeconds,
    videoDuration: currentVideoDuration,  // âœ… ä½¿ç”¨å…¨åŸŸè®Šæ•¸
    progress: progressPercent,
    isComplete: isComplete || progressPercent >= 100
  };

  console.log('æ›´æ–°é€²åº¦åˆ°ä¼ºæœå™¨:', progressData);

  try {
    const result = await callAPI('updateProgress', {
      recordId: currentRecordId,
      progressData: JSON.stringify(progressData)
    });

    if (result && result.success) {
      console.log('âœ… é€²åº¦æ›´æ–°æˆåŠŸ');
    } else {
      console.error('âŒ é€²åº¦æ›´æ–°å¤±æ•—:', result?.message);
    }
  } catch (error) {
    console.error('âŒ æ›´æ–°é€²åº¦å¤±æ•—:', error);
  }
}


/**
 * è¿”å›èª²ç¨‹åˆ—è¡¨
 */
function backToCourses() {
  console.log('=== backToCourses ===');
  console.log('ç•¶å‰è§€çœ‹ç§’æ•¸:', watchedSeconds);
  console.log('å½±ç‰‡ç¸½é•·åº¦:', currentVideoDuration);
  
  // âœ… ä½¿ç”¨æ–°çš„åœæ­¢å‡½æ•¸
  stopVideoTimer();
  
  // âœ… é‡ç½®è§€çœ‹ç§’æ•¸
  watchedSeconds = 0;
  
  // âœ… éš±è—æ™‚é–“è³‡è¨Šå€å¡Š
  const videoTimeInfo = document.getElementById('videoTimeInfo');
  if (videoTimeInfo) {
    videoTimeInfo.style.display = 'none';
  }
  
  console.log('âœ… è¿”å›èª²ç¨‹åˆ—è¡¨');
  navigateToPage('courses');
}



function convertDriveUrl(url) {
  console.log('=== convertDriveUrl ===');
  console.log('è¼¸å…¥ URL:', url);
  
  if (!url) {
    console.error('âŒ URL ç‚ºç©º');
    return '';
  }
  
  // âœ… ç§»é™¤ç©ºç™½å’Œæ›è¡Œ
  url = String(url).trim();
  
  // âœ… æ–¹æ³• 1: å¾åˆ†äº«é€£çµæå– File ID
  if (url.includes('drive.google.com/file/d/')) {
    const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
    if (match && match[1]) {
      const fileId = match[1];
      const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
      console.log('âœ… è½‰æ›æˆåŠŸ (æ–¹æ³•1):', embedUrl);
      return embedUrl;
    }
  }
  
  // âœ… æ–¹æ³• 2: å¾ open?id= æ ¼å¼æå–
  if (url.includes('drive.google.com/open?id=')) {
    const match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    if (match && match[1]) {
      const fileId = match[1];
      const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
      console.log('âœ… è½‰æ›æˆåŠŸ (æ–¹æ³•2):', embedUrl);
      return embedUrl;
    }
  }
  
  // âœ… æ–¹æ³• 3: å¾ä»»ä½• Drive é€£çµæå– File ID
  const fileIdMatch = url.match(/[-\w]{25,}/);
  if (fileIdMatch) {
    const fileId = fileIdMatch[0];
    const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
    console.log('âœ… è½‰æ›æˆåŠŸ (æ–¹æ³•3):', embedUrl);
    return embedUrl;
  }
  
  // âœ… æ–¹æ³• 4: å¦‚æœå·²ç¶“æ˜¯åµŒå…¥å¼é€£çµ
  if (url.includes('/preview')) {
    console.log('âœ… å·²æ˜¯åµŒå…¥å¼é€£çµ');
    return url;
  }
  
  console.error('âŒ ç„¡æ³•è½‰æ› URL');
  return '';
}



/**
 * æ›´æ–°å‰ç«¯é€²åº¦æ¢
 */
function updateProgressBar() {
  if (!currentRecordId) return;

  // âœ… é˜²å‘†æª¢æŸ¥: å¦‚æœ currentVideoDuration ç„¡æ•ˆ,ä½¿ç”¨é è¨­å€¼
  const videoDuration = (currentVideoDuration && currentVideoDuration > 0) 
    ? currentVideoDuration 
    : 180;
  
  const progressPercent = Math.min(100, Math.round((watchedSeconds / videoDuration) * 100));
  
  const progressFill = document.getElementById('progressFill');
  if (progressFill) {
    progressFill.style.width = progressPercent + '%';
    progressFill.textContent = progressPercent + '%';
  }
  
  console.log(`é€²åº¦æ›´æ–°: ${watchedSeconds}/${videoDuration} ç§’ (${progressPercent}%)`);
}


/**
 * æ›´æ–°é€²åº¦åˆ°ä¼ºæœå™¨ (åªåœ¨å¿…è¦æ™‚å‘¼å«)
 */
async function updateProgressToServer(isComplete = false) {
  if (!currentRecordId) return;

  const videoDuration = 180;
  const progressPercent = Math.min(100, Math.round((watchedSeconds / videoDuration) * 100));
  
  const progressData = {
    watchedSeconds: watchedSeconds,
    progress: progressPercent,
    isComplete: isComplete || progressPercent >= 100
  };

  console.log('æ›´æ–°é€²åº¦åˆ°ä¼ºæœå™¨:', progressData);

  try {
    const result = await callAPI('updateProgress', {
      recordId: currentRecordId,
      progressData: JSON.stringify(progressData)
    });

    if (result && result.success) {
      console.log('âœ… é€²åº¦æ›´æ–°æˆåŠŸ');
    } else {
      console.error('âŒ é€²åº¦æ›´æ–°å¤±æ•—:', result?.message);
    }
  } catch (error) {
    console.error('âŒ æ›´æ–°é€²åº¦å¤±æ•—:', error);
  }
}

/**
 * æ›´æ–°é€²åº¦åˆ°ä¼ºæœå™¨ (åªåœ¨å¿…è¦æ™‚å‘¼å«)
 */
async function updateProgressToServer(isComplete = false) {
  if (!currentRecordId) return;

  const videoDuration = 180;
  const progressPercent = Math.min(100, Math.round((watchedSeconds / videoDuration) * 100));
  
  const progressData = {
    watchedSeconds: watchedSeconds,
    progress: progressPercent,
    isComplete: isComplete || progressPercent >= 100
  };

  console.log('æ›´æ–°é€²åº¦åˆ°ä¼ºæœå™¨:', progressData);

  try {
    const result = await callAPI('updateProgress', {
      recordId: currentRecordId,
      progressData: JSON.stringify(progressData)  // âœ… è½‰æ›æˆ JSON å­—ä¸²
    });

    if (result && result.success) {
      console.log('âœ… é€²åº¦æ›´æ–°æˆåŠŸ');
    } else {
      console.error('âŒ é€²åº¦æ›´æ–°å¤±æ•—:', result?.message);
    }
  } catch (error) {
    console.error('âŒ æ›´æ–°é€²åº¦å¤±æ•—:', error);
  }
}



    function backToCourses() {
      if (videoCheckInterval) clearInterval(videoCheckInterval);
      navigateToPage('courses');
    }
/**
 * ç”Ÿæˆå­¸ç¿’å»ºè­° UI
 */
async function generateLearningAdviceUI(reportData) {
  try {
    const adviceContainer = document.getElementById('learningAdvice');
    adviceContainer.innerHTML = '<div class="loading-advice"><i class="fas fa-spinner fa-spin"></i> Sophia æ­£åœ¨åˆ†ææ‚¨çš„å­¸ç¿’æ•¸æ“š...</div>';
    
    // âœ… å‘¼å«å¾Œç«¯ API ç”Ÿæˆå»ºè­°
    const result = await callAPI('generateLearningAdvice', {
      reportData: JSON.stringify(reportData)
    });
    
    if (result && result.success) {
      adviceContainer.innerHTML = '<div class="advice-content">' + result.data.advice + '</div>';
    } else {
      adviceContainer.innerHTML = '<div class="advice-content"><p>âš ï¸ ç„¡æ³•ç”Ÿæˆå­¸ç¿’å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p></div>';
    }
    
  } catch(error) {
    console.error('âŒ generateLearningAdviceUI å¤±æ•—:', error);
    document.getElementById('learningAdvice').innerHTML = '<div class="advice-content"><p>âš ï¸ ç„¡æ³•ç”Ÿæˆå­¸ç¿’å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p></div>';
  }
}

// ==================== æ¸¬é©— ==================== 

/**
 * é–‹å§‹æ¸¬é©—
 */
async function startExam() {
  console.log('=== startExam é–‹å§‹ ===');
  console.log('currentCourse:', currentCourse);
  console.log('currentRecordId:', currentRecordId);
  
  // âœ… é˜²å‘†æª¢æŸ¥ 1: currentCourse æ˜¯å¦å­˜åœ¨
  if (!currentCourse) {
    console.error('âŒ currentCourse æœªå®šç¾©');
    showAlert('èª²ç¨‹è³‡æ–™éºå¤±,è«‹é‡æ–°é–‹å§‹å­¸ç¿’', 'error');
    backToCourses();
    return;
  }
  
  // âœ… é˜²å‘†æª¢æŸ¥ 2: currentRecordId æ˜¯å¦å­˜åœ¨
  if (!currentRecordId) {
    console.error('âŒ currentRecordId æœªå®šç¾©');
    showAlert('å­¸ç¿’ç´€éŒ„éºå¤±,è«‹é‡æ–°é–‹å§‹å­¸ç¿’', 'error');
    backToCourses();
    return;
  }
  
  console.log('âœ… æª¢æŸ¥é€šé,é–‹å§‹å–å¾—æ¸¬é©—é¡Œç›®');
  
  showLoading();
  
  try {
    // âœ… å‘¼å« API å–å¾—éš¨æ©Ÿé¡Œç›®
    const result = await callAPI('getRandomQuestions', {
      courseId: currentCourse.courseId
    });
    
    console.log('API å›æ‡‰:', result);
    
    hideLoading();
    
    if (result && result.success) {
      currentExamQuestions = result.data;
      
      console.log('âœ… æˆåŠŸå–å¾— ' + currentExamQuestions.length + ' ç­†é¡Œç›®');
      
      if (currentExamQuestions.length === 0) {
        showAlert('æ­¤èª²ç¨‹å°šç„¡æ¸¬é©—é¡Œç›®', 'warning');
        return;
      }
      
      // âœ… å°èˆªåˆ°æ¸¬é©—é é¢
      navigateToPage('exam');
      displayExam();
    } else {
      console.error('âŒ API å›æ‡‰å¤±æ•—:', result?.message);
      showAlert(result?.message || 'å–å¾—æ¸¬é©—é¡Œç›®å¤±æ•—', 'error');
    }
  } catch (error) {
    console.error('âŒ startExam å¤±æ•—:', error);
    hideLoading();
    showAlert('å–å¾—æ¸¬é©—é¡Œç›®å¤±æ•—', 'error');
  }
}

/**
 * é¡¯ç¤ºæ¸¬é©—é¡Œç›®
 */
function displayExam() {
  console.log('=== displayExam é–‹å§‹ ===');
  console.log('currentExamQuestions:', currentExamQuestions);
  
  document.getElementById('examCourseTitle').textContent = currentCourse.courseName + ' - æ¸¬é©—';
  
  const questionsHTML = currentExamQuestions.map((q, index) => `
    <div class="question-card">
      <span class="question-number">ç¬¬ ${index + 1} é¡Œ</span>
      <div class="question-text">${q.questionText}</div>
      <div class="options-list">
        <div class="option-item">
          <input type="radio" name="question_${q.questionId}" value="A" id="q${index}_a">
          <label for="q${index}_a">${q.optionA}</label>
        </div>
        <div class="option-item">
          <input type="radio" name="question_${q.questionId}" value="B" id="q${index}_b">
          <label for="q${index}_b">${q.optionB}</label>
        </div>
        <div class="option-item">
          <input type="radio" name="question_${q.questionId}" value="C" id="q${index}_c">
          <label for="q${index}_c">${q.optionC}</label>
        </div>
        <div class="option-item">
          <input type="radio" name="question_${q.questionId}" value="D" id="q${index}_d">
          <label for="q${index}_d">${q.optionD}</label>
        </div>
      </div>
    </div>
  `).join('');

  document.getElementById('examQuestions').innerHTML = questionsHTML;
  
  console.log('âœ… æ¸¬é©—é¡Œç›®é¡¯ç¤ºå®Œæˆ');
}

/**
 * æäº¤æ¸¬é©—
 */
async function submitExam() {
  console.log('=== submitExam é–‹å§‹ ===');
  console.log('currentRecordId:', currentRecordId);
  console.log('currentExamQuestions:', currentExamQuestions);
  
  // âœ… æ”¶é›†ç­”æ¡ˆ
  const answers = {};
  let allAnswered = true;

  currentExamQuestions.forEach(q => {
    const selected = document.querySelector(`input[name="question_${q.questionId}"]:checked`);
    if (selected) {
      answers[q.questionId] = selected.value;
      console.log(`é¡Œç›® ${q.questionId}: é¸æ“‡ ${selected.value}`);
    } else {
      allAnswered = false;
      console.log(`é¡Œç›® ${q.questionId}: æœªä½œç­”`);
    }
  });

  if (!allAnswered) {
    showAlert('è«‹å›ç­”æ‰€æœ‰é¡Œç›®', 'warning');
    return;
  }
  
  console.log('âœ… æ‰€æœ‰é¡Œç›®å·²ä½œç­”');
  console.log('ç­”æ¡ˆ:', answers);
  
  showLoading();
  
  try {
    // âœ… æäº¤æ¸¬é©—
    const result = await callAPI('submitExam', {
      courseId: currentCourse.courseId,
      recordId: currentRecordId,
      answers: JSON.stringify(answers)
    });
    
    console.log('API å›æ‡‰:', result);
    
    hideLoading();

    if (result && result.success) {
      console.log('âœ… æ¸¬é©—æäº¤æˆåŠŸ');
      displayExamResult(result.data);
    } else {
      console.error('âŒ æ¸¬é©—æäº¤å¤±æ•—:', result?.message);
      showAlert(result?.message || 'æäº¤å¤±æ•—', 'error');
    }
  } catch (error) {
    console.error('âŒ submitExam å¤±æ•—:', error);
    hideLoading();
    showAlert('æäº¤å¤±æ•—', 'error');
  }
}

/**
 * é¡¯ç¤ºæ¸¬é©—çµæœ
 */
function displayExamResult(resultData) {
  console.log('=== displayExamResult ===');
  console.log('resultData:', resultData);
  
  const modal = document.getElementById('examResultModal');
  const isPassed = resultData.isPassed;

  // æ›´æ–°åœ–ç¤ºå’Œæ¨™é¡Œ
  const icon = document.getElementById('resultIcon');
  const title = document.getElementById('resultTitle');
  
  if (isPassed) {
    icon.className = 'result-icon pass';
    icon.innerHTML = '<i class="fas fa-check-circle"></i>';
    title.textContent = 'æ­å–œé€šéæ¸¬é©—!';
  } else {
    icon.className = 'result-icon fail';
    icon.innerHTML = '<i class="fas fa-times-circle"></i>';
    title.textContent = 'æ¸¬é©—æœªé€šé';
  }

  // æ›´æ–°åˆ†æ•¸
  document.getElementById('resultScore').textContent = resultData.score + ' åˆ†';
  document.getElementById('resultCorrect').textContent = resultData.correctCount;
  document.getElementById('resultTotal').textContent = resultData.totalQuestions;
  document.getElementById('resultPassScore').textContent = resultData.passScore;

  // é¡¯ç¤ºç²å¾—é»æ•¸
  const pointsRow = document.getElementById('resultPointsRow');
  if (isPassed) {
    pointsRow.style.display = 'flex';
    document.getElementById('resultPoints').textContent = resultData.earnedPoints || 0;
  } else {
    pointsRow.style.display = 'none';
  }

  // âœ… æ–°å¢ï¼šé¡¯ç¤ºéŒ¯èª¤é¡Œç›®æª¢è¨
  displayWrongAnswers(resultData.answerDetails);

  // âœ… æ–°å¢ï¼šæ§åˆ¶æŒ‰éˆ•é¡¯ç¤º
  const btnRetakeExam = document.getElementById('btnRetakeExam');
  const btnBackToCourses = document.getElementById('btnBackToCourses');
  
  if (isPassed) {
    // é€šéï¼šé¡¯ç¤ºã€è¿”å›èª²ç¨‹åˆ—è¡¨ã€‘æŒ‰éˆ•
    btnRetakeExam.style.display = 'none';
    btnBackToCourses.style.display = 'inline-block';
    currentCourse.isCompleted = true;
  } else {
    // æœªé€šéï¼šé¡¯ç¤ºã€é‡æ–°æ¸¬é©—ã€‘æŒ‰éˆ•
    btnRetakeExam.style.display = 'inline-block';
    btnBackToCourses.style.display = 'none';
  }

  modal.classList.add('active');
  
  console.log('âœ… æ¸¬é©—çµæœé¡¯ç¤ºå®Œæˆ');
}

/**
 * é¡¯ç¤ºéŒ¯èª¤é¡Œç›®æª¢è¨
 */
function displayWrongAnswers(answerDetails) {
  console.log('=== displayWrongAnswers ===');
  console.log('answerDetails:', answerDetails);
  
  if (!answerDetails || answerDetails.length === 0) {
    console.log('âš ï¸ æ²’æœ‰ç­”æ¡ˆè©³æƒ…');
    return;
  }
  
  // ç¯©é¸å‡ºéŒ¯èª¤çš„é¡Œç›®
  const wrongAnswers = answerDetails.filter(detail => !detail.isCorrect);
  
  console.log('éŒ¯èª¤é¡Œç›®æ•¸é‡:', wrongAnswers.length);
  
  const wrongAnswersSection = document.getElementById('wrongAnswersSection');
  const wrongAnswersList = document.getElementById('wrongAnswersList');
  
  if (wrongAnswers.length === 0) {
    // å…¨éƒ¨ç­”å°ï¼Œéš±è—æª¢è¨å€å¡Š
    wrongAnswersSection.style.display = 'none';
    return;
  }
  
  // é¡¯ç¤ºæª¢è¨å€å¡Š
  wrongAnswersSection.style.display = 'block';
  
  // å»ºç«‹éŒ¯èª¤é¡Œç›®åˆ—è¡¨
  wrongAnswersList.innerHTML = wrongAnswers.map((detail, index) => {
    // å¾ currentExamQuestions æ‰¾åˆ°å®Œæ•´é¡Œç›®è³‡è¨Š
    const question = currentExamQuestions.find(q => q.questionId === detail.questionId);
    
    if (!question) {
      console.log('âš ï¸ æ‰¾ä¸åˆ°é¡Œç›®:', detail.questionId);
      return '';
    }
    
    // å–å¾—é¸é …æ–‡å­—
    const yourAnswerText = question['option' + detail.userAnswer] || detail.userAnswer;
    const correctAnswerText = question['option' + detail.correctAnswer] || detail.correctAnswer;
    
    return `
      <div class="wrong-answer-item">
        <span class="question-number">ç¬¬ ${index + 1} é¡Œ</span>
        <div class="question-text">${question.questionText}</div>
        
        <div class="answer-row your-answer">
          <span class="answer-label wrong">
            <i class="fas fa-times-circle"></i> æ‚¨çš„ç­”æ¡ˆ
          </span>
          <span class="answer-value">
            <strong>${detail.userAnswer}.</strong> ${yourAnswerText}
          </span>
          <span class="answer-icon wrong">
            <i class="fas fa-times"></i>
          </span>
        </div>
        
        <div class="answer-row correct-answer">
          <span class="answer-label correct">
            <i class="fas fa-check-circle"></i> æ­£ç¢ºç­”æ¡ˆ
          </span>
          <span class="answer-value">
            <strong>${detail.correctAnswer}.</strong> ${correctAnswerText}
          </span>
          <span class="answer-icon correct">
            <i class="fas fa-check"></i>
          </span>
        </div>
      </div>
    `;
  }).join('');
  
  console.log('âœ… éŒ¯èª¤é¡Œç›®æª¢è¨é¡¯ç¤ºå®Œæˆ');
}

/**
 * é‡æ–°æ¸¬é©—
 */
function retakeExam() {
  console.log('=== retakeExam ===');
  
  // é—œé–‰æ¸¬é©—çµæœ Modal
  document.getElementById('examResultModal').classList.remove('active');
  
  // é‡æ–°é–‹å§‹æ¸¬é©—
  startExam();
}

/**
 * é—œé–‰æ¸¬é©—çµæœä¸¦è¿”å›èª²ç¨‹åˆ—è¡¨
 */
function closeExamResultAndBackToCourses() {
  console.log('=== closeExamResultAndBackToCourses ===');
  
  // é—œé–‰æ¸¬é©—çµæœ Modal
  document.getElementById('examResultModal').classList.remove('active');
  
  // åœæ­¢è¨ˆæ™‚å™¨
  if (videoCheckInterval) {
    clearInterval(videoCheckInterval);
    videoCheckInterval = null;
  }
  
  // é‡ç½®è§€çœ‹ç§’æ•¸
  watchedSeconds = 0;
  
  // éš±è—æ™‚é–“è³‡è¨Šå€å¡Š
  const videoTimeInfo = document.getElementById('videoTimeInfo');
  if (videoTimeInfo) {
    videoTimeInfo.style.display = 'none';
  }
  
  // è¿”å›èª²ç¨‹åˆ—è¡¨
  navigateToPage('courses');
  loadCourses();
}


/**
 * é—œé–‰æ¸¬é©—çµæœ Modalï¼ˆåªé—œé–‰ï¼Œä¸è¿”å›èª²ç¨‹åˆ—è¡¨ï¼‰
 */
function closeExamResultModal() {
  console.log('=== closeExamResultModal ===');
  
  document.getElementById('examResultModal').classList.remove('active');
  
  // âœ… å¦‚æœæ¸¬é©—é€šéï¼Œæ‰è¿”å›èª²ç¨‹åˆ—è¡¨
  if (currentCourse && currentCourse.isCompleted) {
    console.log('âœ… æ¸¬é©—é€šéï¼Œè¿”å›èª²ç¨‹åˆ—è¡¨');
    
    // åœæ­¢è¨ˆæ™‚å™¨
    if (videoCheckInterval) {
      clearInterval(videoCheckInterval);
      videoCheckInterval = null;
    }
    
    // é‡ç½®è§€çœ‹ç§’æ•¸
    watchedSeconds = 0;
    
    // éš±è—æ™‚é–“è³‡è¨Šå€å¡Š
    const videoTimeInfo = document.getElementById('videoTimeInfo');
    if (videoTimeInfo) {
      videoTimeInfo.style.display = 'none';
    }
    
    navigateToPage('courses');
    loadCourses();
  } else {
    console.log('âš ï¸ æ¸¬é©—æœªé€šéï¼Œç•™åœ¨æ¸¬é©—é é¢');
    // ç•™åœ¨æ¸¬é©—é é¢ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥é‡æ–°æ¸¬é©—
  }
}


/**
 * è¿”å›èª²ç¨‹æ’­æ”¾é é¢
 */
function backToPlayer() {
  navigateToPage('player');
}


    function closeExamResultModal() {
      document.getElementById('examResultModal').classList.remove('active');
      
      // è¿”å›èª²ç¨‹åˆ—è¡¨
      if (videoCheckInterval) clearInterval(videoCheckInterval);
      navigateToPage('courses');
      loadCourses();
    }

    function backToPlayer() {
      navigateToPage('player');
    }

    // ==================== æˆ‘çš„å­¸ç¿’ ==================== 
/**
 * è¼‰å…¥æˆ‘çš„å­¸ç¿’ï¼ˆä½¿ç”¨å¿«å–ï¼‰
 */
async function loadMyLearning(forceRefresh = false) {
  try {
    console.log('=== loadMyLearning ===');
    console.log('forceRefresh:', forceRefresh);
    
    // âœ… æª¢æŸ¥æ˜¯å¦å·²é è¼‰å…¥
    if (!forceRefresh && PreloadManager.status.myLearning && PreloadManager.data.myLearning) {
      console.log('âš¡ ä½¿ç”¨é è¼‰å…¥çš„æˆ‘çš„å­¸ç¿’è³‡æ–™');
      const { learningRecords, pointRecords } = PreloadManager.data.myLearning;
      displayMyLearningRecords(learningRecords);
      displayMyPointRecords(pointRecords);
      return;
    }

    // âœ… åŸæœ‰çš„è¼‰å…¥é‚è¼¯...
    if (forceRefresh) {
      CacheManager.clear('getLearningRecords_{}');
      CacheManager.clear('getPointRecords_{"empId":"' + currentUser.empId + '"}');
    }
    
    const recordsResult = await callAPIWithCache('getLearningRecords', {}, !forceRefresh);
    
    if (recordsResult && recordsResult.success) {
      displayMyLearningRecords(recordsResult.data);
    }

    const pointsResult = await callAPIWithCache('getPointRecords', {
      empId: currentUser.empId
    }, !forceRefresh);

    if (pointsResult && pointsResult.success) {
      displayMyPointRecords(pointsResult.data);
    }
  } catch(error) {
    console.error('âŒ loadMyLearning å¤±æ•—:', error);
    showAlert('è¼‰å…¥å­¸ç¿’ç´€éŒ„å¤±æ•—', 'error');
  }
}


function displayMyLearningRecords(records) {
  const tbody = document.getElementById('myLearningRecords');
  
  if (records.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">å°šç„¡å­¸ç¿’ç´€éŒ„</td></tr>';
    return;
  }

  // âœ… æ ¹æ“šé–‹å§‹æ™‚é–“é™åºæ’åˆ—
  const sortedRecords = records.sort((a, b) => {
    const timeA = new Date(a.startTime || 0).getTime();
    const timeB = new Date(b.startTime || 0).getTime();
    return timeB - timeA;
  });

  // âœ… åˆ†å‰²ç‚ºå‰5ç­†å’Œå…¶é¤˜
  const visibleRecords = sortedRecords.slice(0, 5);
  const hiddenRecords = sortedRecords.slice(5);

  // âœ… å»ºç«‹è¡¨æ ¼å…§å®¹
  const visibleHTML = visibleRecords.map(record => `
    <tr class="learning-record-row">
      <td>${record.courseName}</td>
      <td>${record.startTime || '-'}</td>
      <td>${record.completeTime || '-'}</td>
      <td>${record.examScore !== null ? record.examScore + ' åˆ†' : '-'}</td>
      <td>${record.earnedPoints || 0} é»</td>
      <td>
        ${record.isCompleted 
          ? '<span class="status-badge pass">å·²å®Œæˆ</span>' 
          : '<span class="status-badge active">é€²è¡Œä¸­</span>'}
      </td>
    </tr>
  `).join('');

  const hiddenHTML = hiddenRecords.map(record => `
    <tr class="learning-record-row learning-record-hidden" style="display: none;">
      <td>${record.courseName}</td>
      <td>${record.startTime || '-'}</td>
      <td>${record.completeTime || '-'}</td>
      <td>${record.examScore !== null ? record.examScore + ' åˆ†' : '-'}</td>
      <td>${record.earnedPoints || 0} é»</td>
      <td>
        ${record.isCompleted 
          ? '<span class="status-badge pass">å·²å®Œæˆ</span>' 
          : '<span class="status-badge active">é€²è¡Œä¸­</span>'}
      </td>
    </tr>
  `).join('');

  // âœ… å»ºç«‹æ”¶æŠ˜æŒ‰éˆ•
  const toggleButtonHTML = hiddenRecords.length > 0 ? `
    <tr id="learningRecordToggleRow">
      <td colspan="6" style="text-align: center; padding: 15px; background: var(--light-color);">
        <button id="btnToggleLearningRecords" class="btn btn-secondary btn-sm" onclick="toggleLearningRecords()">
          <i class="fas fa-chevron-down"></i> é¡¯ç¤ºæ›´å¤š (é‚„æœ‰ ${hiddenRecords.length} ç­†)
        </button>
      </td>
    </tr>
  ` : '';

  // âœ… çµ„åˆæ‰€æœ‰å…§å®¹
  tbody.innerHTML = visibleHTML + hiddenHTML + toggleButtonHTML;
  
  // âŒ ç§»é™¤å‰ç«¯è‡ªè¡ŒåŠ ç¸½çš„ä»£ç¢¼
  // const totalPoints = records.reduce((sum, r) => sum + (r.earnedPoints || 0), 0);
  // document.getElementById('totalPoints').textContent = totalPoints;
}


/**
 * åˆ‡æ›å­¸ç¿’ç´€éŒ„é¡¯ç¤º/éš±è—
 */
function toggleLearningRecords() {
  console.log('=== toggleLearningRecords ===');
  
  const hiddenRows = document.querySelectorAll('.learning-record-hidden');
  const button = document.getElementById('btnToggleLearningRecords');
  
  if (!button || hiddenRows.length === 0) {
    console.log('âš ï¸ æ‰¾ä¸åˆ°éš±è—çš„ç´€éŒ„æˆ–æŒ‰éˆ•');
    return;
  }
  
  // âœ… æª¢æŸ¥ç•¶å‰ç‹€æ…‹
  const isHidden = hiddenRows[0].style.display === 'none';
  
  if (isHidden) {
    // âœ… å±•é–‹ï¼šé¡¯ç¤ºæ‰€æœ‰éš±è—çš„ç´€éŒ„
    hiddenRows.forEach((row, index) => {
      setTimeout(() => {
        row.style.display = 'table-row';
        row.style.animation = 'fadeIn 0.3s ease';
      }, index * 50); // é€è¡Œå±•é–‹å‹•ç•«
    });
    
    // âœ… æ›´æ–°æŒ‰éˆ•æ–‡å­—
    button.innerHTML = '<i class="fas fa-chevron-up"></i> æ”¶èµ·';
    
    console.log('âœ… å·²å±•é–‹ ' + hiddenRows.length + ' ç­†ç´€éŒ„');
  } else {
    // âœ… æ”¶èµ·ï¼šéš±è—æ‰€æœ‰é¡å¤–çš„ç´€éŒ„
    hiddenRows.forEach(row => {
      row.style.display = 'none';
    });
    
    // âœ… æ›´æ–°æŒ‰éˆ•æ–‡å­—
    button.innerHTML = '<i class="fas fa-chevron-down"></i> é¡¯ç¤ºæ›´å¤š (é‚„æœ‰ ' + hiddenRows.length + ' ç­†)';
    
    // âœ… æ²å‹•åˆ°è¡¨æ ¼é ‚éƒ¨
    const table = document.querySelector('.data-table');
    if (table) {
      table.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    console.log('âœ… å·²æ”¶èµ· ' + hiddenRows.length + ' ç­†ç´€éŒ„');
  }
}


    function displayMyPointRecords(records) {
      const tbody = document.getElementById('myPointRecords');
      
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center">å°šç„¡é»æ•¸ç´€éŒ„</td></tr>';
        return;
      }

      tbody.innerHTML = records.map(record => `
        <tr>
          <td>${record.courseName}</td>
          <td>${record.points} é»</td>
          <td>${record.earnedTime}</td>
        </tr>
      `).join('');
    }
    // ==================== è¼‰å…¥ä¸‹æ‹‰é¸å–®é¸é … ====================

    /**
     * è¼‰å…¥èª²ç¾¤é¸é …
     */
    async function loadCategoryOptions() {
      try {
        console.log('=== loadCategoryOptions ===');
        
        const result = await callAPI('getCategoryOptions', {});
        
        if (result && result.success) {
          const select = document.getElementById('courseFormCategory');
          
          // æ¸…ç©ºç¾æœ‰é¸é … (ä¿ç•™ç¬¬ä¸€å€‹ "è«‹é¸æ“‡")
          select.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
          
          // æ–°å¢é¸é …
          result.data.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option.value;        // ä»£è™Ÿ (ä¾‹å¦‚: RR)
            opt.textContent = option.label;  // é¡¯ç¤ºåç¨± (ä¾‹å¦‚: ã€æ–°äººè¨“ç·´ã€‘)
            select.appendChild(opt);
          });
          
          console.log('âœ… èª²ç¾¤é¸é …è¼‰å…¥æˆåŠŸ,å…± ' + result.data.length + ' å€‹');
        } else {
          showAlert(result?.message || 'è¼‰å…¥èª²ç¾¤é¸é …å¤±æ•—', 'error');
        }
      } catch (error) {
        console.error('âŒ è¼‰å…¥èª²ç¾¤é¸é …å¤±æ•—:', error);
        showAlert('è¼‰å…¥èª²ç¾¤é¸é …å¤±æ•—', 'error');
      }
    }

    /**
     * è¼‰å…¥èª²é–€é¸é …
     */
    async function loadSubjectOptions() {
      try {
        console.log('=== loadSubjectOptions ===');
        
        const result = await callAPI('getSubjectOptions', {});
        
        if (result && result.success) {
          const select = document.getElementById('courseFormSubject');
          
          // æ¸…ç©ºç¾æœ‰é¸é … (ä¿ç•™ç¬¬ä¸€å€‹ "è«‹é¸æ“‡")
          select.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
          
          // æ–°å¢é¸é …
          result.data.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option.value;        // ä»£è™Ÿ (ä¾‹å¦‚: doc)
            opt.textContent = option.label;  // é¡¯ç¤ºåç¨± (ä¾‹å¦‚: æ–‡æ›¸å·¥å…·)
            select.appendChild(opt);
          });
          
          console.log('âœ… èª²é–€é¸é …è¼‰å…¥æˆåŠŸ,å…± ' + result.data.length + ' å€‹');
        } else {
          showAlert(result?.message || 'è¼‰å…¥èª²é–€é¸é …å¤±æ•—', 'error');
        }
      } catch (error) {
        console.error('âŒ è¼‰å…¥èª²é–€é¸é …å¤±æ•—:', error);
        showAlert('è¼‰å…¥èª²é–€é¸é …å¤±æ•—', 'error');
      }
    }

    // ==========================================
// Sophiaå­¸ç¿’æ²™é¾ - JavaScript å‡½æ•¸
// ==========================================

/**
 * ç•¶å‰é¸æ“‡çš„æ’è¡Œæ¦œæ™‚é–“ç¯„åœ
 */
let currentRankingPeriod = 'week';

/**
 * å°èˆªåˆ° Sophia é é¢
 */
function navigateToSophia() {
  navigateToPage('sophia');
  loadSophiaData();
}

/**
 * è¼‰å…¥ Sophia é é¢è³‡æ–™
 */
async function loadSophiaData() {
  try {
    console.log('=== loadSophiaData ===');
    
    showLoading();
    
    // âœ… å–å¾—æ™‚é–“ç¯„åœ
    const timeRange = getTimeRange();
    
    if (!timeRange) {
      hideLoading();
      return;
    }
    
    console.log('æ™‚é–“ç¯„åœ:', timeRange);
    
    // âœ… ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰è³‡æ–™
    const [
      behaviorData,
      rankingData,
      reportData,
      achievementsData
    ] = await Promise.all([
      callAPI('getSophiaBehaviorData', {
        startDate: timeRange.startDate,
        endDate: timeRange.endDate
      }),
      callAPI('getSophiaRankingData', { 
        period: currentRankingPeriod 
      }),
      callAPI('getSophiaReportData', {
        startDate: timeRange.startDate,
        endDate: timeRange.endDate
      }),
      callAPI('getSophiaAchievements', {})
    ]);
    
    hideLoading();
    
    // âœ… æ¸²æŸ“å„å€‹å€å¡Š
    if (behaviorData && behaviorData.success) {
      renderBehaviorAnalysis(behaviorData.data);
    }
    
    if (rankingData && rankingData.success) {
      renderRankings(rankingData.data);
    }
    
    if (reportData && reportData.success) {
      renderReport(reportData.data);
    }
    
    if (achievementsData && achievementsData.success) {
      renderAchievements(achievementsData.data);
    }
    
    // âœ… ç”Ÿæˆå­¸ç¿’å»ºè­°
    if (reportData && reportData.success) {
      generateLearningAdviceUI(reportData.data);
    }
    
  } catch(error) {
    console.error('âŒ loadSophiaData å¤±æ•—:', error);
    hideLoading();
    showAlert('è¼‰å…¥è³‡æ–™å¤±æ•—', 'error');
  }
}


/**
 * å–å¾—æ™‚é–“ç¯„åœ
 */
function getTimeRange() {
  const timeRangeSelect = document.getElementById('sophiaTimeRange');
  const selectedRange = timeRangeSelect.value;
  
  const now = new Date();
  let startDate, endDate;
  
  switch(selectedRange) {
    case '1month':
      startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
      endDate = now;
      break;
      
    case '3months':
      startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
      endDate = now;
      break;
      
    case '6months':
      startDate = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
      endDate = now;
      break;
      
    case '1year':
      startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
      endDate = now;
      break;
      
    case 'custom':
      const startInput = document.getElementById('sophiaStartDate').value;
      const endInput = document.getElementById('sophiaEndDate').value;
      
      if (!startInput || !endInput) {
        showAlert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ', 'warning');
        return null;
      }
      
      startDate = new Date(startInput);
      endDate = new Date(endInput);
      break;
      
    default:
      startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
      endDate = now;
  }
  
  return {
    startDate: formatDate(startDate),
    endDate: formatDate(endDate)
  };
}

/**
 * æ¸²æŸ“å€‹äººå­¸ç¿’è¡Œç‚ºåˆ†æ
 */
function renderBehaviorAnalysis(data) {
  console.log('=== renderBehaviorAnalysis ===');
  console.log('data:', data);
  
  // 1. è§€çœ‹æ™‚æ®µåˆ†æï¼ˆæŠ˜ç·šåœ–ï¼‰
  renderWatchTimeChart(data.watchTimeData);
  
  // 2. åœç•™æ™‚é–“åˆ†æ
  document.getElementById('totalStayTime').textContent = formatHours(data.totalStayTime);
  document.getElementById('effectiveTime').textContent = formatHours(data.effectiveTime);
  document.getElementById('avgSessionTime').textContent = formatMinutes(data.avgSessionTime);
  
  // 3. å­¸ç¿’ç¿’æ…£åˆ†æ
  renderWeekdayChart(data.weekdayData);
  renderCourseTypeChart(data.courseTypeData);
}

/**
 * ç¹ªè£½è§€çœ‹æ™‚æ®µåˆ†æåœ–è¡¨
 */
function renderWatchTimeChart(data) {
  const ctx = document.getElementById('watchTimeChart');
  
  if (window.watchTimeChartInstance) {
    window.watchTimeChartInstance.destroy();
  }
  
  window.watchTimeChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: 'æ¯æ—¥è§€çœ‹æ™‚æ•¸ï¼ˆå°æ™‚ï¼‰',
        data: data.values,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37, 99, 235, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 5,
        pointHoverRadius: 8,
        pointBackgroundColor: '#2563eb',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13 },
          callbacks: {
            label: function(context) {
              return 'è§€çœ‹æ™‚æ•¸: ' + context.parsed.y.toFixed(1) + ' å°æ™‚';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value + ' å°æ™‚';
            }
          }
        }
      }
    }
  });
}

/**
 * ç¹ªè£½æ˜ŸæœŸå¹¾åˆ†æåœ–è¡¨
 */
function renderWeekdayChart(data) {
  const ctx = document.getElementById('weekdayChart');
  
  if (window.weekdayChartInstance) {
    window.weekdayChartInstance.destroy();
  }
  
  window.weekdayChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: data.labels,
      datasets: [{
        data: data.values,
        backgroundColor: [
          '#ef4444',
          '#f59e0b',
          '#10b981',
          '#06b6d4',
          '#6366f1',
          '#8b5cf6',
          '#ec4899'
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 10,
            font: { size: 11 }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed / total) * 100).toFixed(1);
              return context.label + ': ' + context.parsed + ' æ¬¡ (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
}

/**
 * ç¹ªè£½èª²ç¨‹é¡å‹åˆ†æåœ–è¡¨
 */
function renderCourseTypeChart(data) {
  const ctx = document.getElementById('courseTypeChart');
  
  if (window.courseTypeChartInstance) {
    window.courseTypeChartInstance.destroy();
  }
  
  window.courseTypeChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: data.labels,
      datasets: [{
        data: data.values,
        backgroundColor: [
          '#2563eb',
          '#10b981',
          '#f59e0b',
          '#ef4444',
          '#8b5cf6',
          '#06b6d4'
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 10,
            font: { size: 11 }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed / total) * 100).toFixed(1);
              return context.label + ': ' + context.parsed + ' æ¬¡ (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
}

/**
 * åˆ‡æ›æ’è¡Œæ¦œæ™‚é–“ç¯„åœ
 */
function switchRankingPeriod(period) {
  currentRankingPeriod = period;
  
  // æ›´æ–°æ¨™ç±¤æ¨£å¼
  document.querySelectorAll('.ranking-tab').forEach(tab => {
    tab.classList.remove('active');
    if (tab.dataset.period === period) {
      tab.classList.add('active');
    }
  });
  
  // é‡æ–°è¼‰å…¥æ’è¡Œæ¦œ
  loadRankingData();
}

/**
 * è¼‰å…¥æ’è¡Œæ¦œè³‡æ–™
 */
async function loadRankingData() {
  try {
    showLoading();
    
    const result = await callAPI('getSophiaRankingData', { 
      period: currentRankingPeriod 
    });
    
    hideLoading();
    
    if (result && result.success) {
      renderRankings(result.data);
    }
  } catch(error) {
    console.error('âŒ loadRankingData å¤±æ•—:', error);
    hideLoading();
  }
}

/**
 * æ¸²æŸ“æ’è¡Œæ¦œ
 */
function renderRankings(data) {
  console.log('=== renderRankings ===');
  console.log('data:', data);
  
  // 1. è§€çœ‹æ¬¡æ•¸æ’è¡Œ
  renderRankingList('viewCountRanking', data.viewCount, (item) => item.count + ' æ¬¡');
  
  // 2. å®Œæˆç‡æ’è¡Œ
  renderRankingList('completionRateRanking', data.completionRate, (item) => item.rate + '%');
  
  // 3. å¹³å‡åˆ†æ•¸æ’è¡Œ
  renderRankingList('avgScoreRanking', data.avgScore, (item) => item.score + ' åˆ†');
  
  // 4. å­¸ç¿’æ™‚é•·æ’è¡Œ
  renderRankingList('studyTimeRanking', data.studyTime, (item) => formatHours(item.hours));
}

/**
 * æ¸²æŸ“å–®å€‹æ’è¡Œæ¦œåˆ—è¡¨
 */
function renderRankingList(containerId, data, valueFormatter) {
  const container = document.getElementById(containerId);
  
  if (!data || data.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">æš«ç„¡è³‡æ–™</p>';
    return;
  }
  
  container.innerHTML = data.map((item, index) => {
    const rank = index + 1;
    let rankClass = 'other';
    
    if (rank === 1) rankClass = 'top1';
    else if (rank === 2) rankClass = 'top2';
    else if (rank === 3) rankClass = 'top3';
    
    return `
      <div class="ranking-item">
        <div class="rank ${rankClass}">${rank}</div>
        <div class="course-name">${item.courseName}</div>
        <div class="value">${valueFormatter(item)}</div>
      </div>
    `;
  }).join('');
}

/**
 * æ¸²æŸ“å­¸ç¿’æˆæ•ˆå ±è¡¨
 */
function renderReport(data) {
  console.log('=== renderReport ===');
  console.log('data:', data);
  
  // 1. å­¸ç¿’æ™‚æ•¸çµ±è¨ˆ
  document.getElementById('reportTotalHours').textContent = formatHours(data.totalHours);
  document.getElementById('reportAvgDailyHours').textContent = formatHours(data.avgDailyHours);
  document.getElementById('reportMonthComparison').textContent = formatComparison(data.monthComparison);
  document.getElementById('reportDeptComparison').textContent = formatComparison(data.deptComparison);
  
  // æ›´æ–°æ¯”è¼ƒå¾½ç« 
  updateComparisonBadge('timeComparison', data.monthComparison);
  
  // 2. èª²ç¨‹å®Œæˆæ•¸
  document.getElementById('reportCompleted').textContent = data.completed + ' é–€';
  document.getElementById('reportInProgress').textContent = data.inProgress + ' é–€';
  document.getElementById('reportNotStarted').textContent = data.notStarted + ' é–€';
  document.getElementById('reportRequiredRate').textContent = data.requiredRate + '%';
  
  updateComparisonBadge('courseComparison', data.courseComparison);
  
  // 3. æ¸¬é©—æˆç¸¾çµ±è¨ˆ
  document.getElementById('reportAvgScore').textContent = data.avgScore + ' åˆ†';
  document.getElementById('reportPassRate').textContent = data.passRate + '%';
  document.getElementById('reportMaxScore').textContent = data.maxScore + ' åˆ†';
  document.getElementById('reportMinScore').textContent = data.minScore + ' åˆ†';
  
  // 4. é»æ•¸ç´¯ç©
  document.getElementById('reportMonthPoints').textContent = data.monthPoints + ' é»';
  document.getElementById('reportTotalPoints').textContent = data.totalPoints + ' é»';
  document.getElementById('reportRanking').textContent = data.ranking ? 'ç¬¬ ' + data.ranking + ' å' : '-';
  document.getElementById('reportDeptRanking').textContent = data.deptRanking ? 'ç¬¬ ' + data.deptRanking + ' å' : '-';
  
  updateComparisonBadge('pointsComparison', data.pointsComparison);
}

/**
 * æ›´æ–°æ¯”è¼ƒå¾½ç« 
 */
function updateComparisonBadge(badgeId, value) {
  const badge = document.getElementById(badgeId);
  
  if (value > 0) {
    badge.className = 'comparison-badge positive';
    badge.innerHTML = '<i class="fas fa-arrow-up"></i> +' + value + '%';
  } else if (value < 0) {
    badge.className = 'comparison-badge negative';
    badge.innerHTML = '<i class="fas fa-arrow-down"></i> ' + value + '%';
  } else {
    badge.className = 'comparison-badge';
    badge.innerHTML = '<i class="fas fa-minus"></i> 0%';
  }
}

/**
 * ç”Ÿæˆå­¸ç¿’å»ºè­°ï¼ˆä½¿ç”¨ ChatGPT APIï¼‰
 */
async function generateLearningAdvice(reportData) {
  try {
    console.log('=== generateLearningAdvice ===');
    
    const adviceContainer = document.getElementById('learningAdvice');
    adviceContainer.innerHTML = '<div class="loading-advice"><i class="fas fa-spinner fa-spin"></i> Sophia æ­£åœ¨åˆ†ææ‚¨çš„å­¸ç¿’æ•¸æ“š...</div>';
    
    // å‘¼å«å¾Œç«¯ API ç”Ÿæˆå»ºè­°
    const result = await callAPI('generateLearningAdvice', {
      reportData: JSON.stringify(reportData)
    });
    
    if (result && result.success) {
      adviceContainer.innerHTML = '<div class="advice-content">' + result.data.advice + '</div>';
    } else {
      adviceContainer.innerHTML = '<div class="advice-content"><p>âš ï¸ ç„¡æ³•ç”Ÿæˆå­¸ç¿’å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p></div>';
    }
    
  } catch(error) {
    console.error('âŒ generateLearningAdvice å¤±æ•—:', error);
    document.getElementById('learningAdvice').innerHTML = '<div class="advice-content"><p>âš ï¸ ç„¡æ³•ç”Ÿæˆå­¸ç¿’å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p></div>';
  }
}

/**
 * æ¸²æŸ“æˆå°±ç³»çµ±
 */
function renderAchievements(data) {
  console.log('=== renderAchievements ===');
  console.log('data:', data);
  
  const container = document.getElementById('achievementsGrid');
  
  if (!data || data.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px; grid-column: 1/-1;">æš«ç„¡æˆå°±</p>';
    return;
  }
  
  container.innerHTML = data.map(achievement => {
    const isUnlocked = achievement.unlocked;
    const badgeClass = isUnlocked ? 'unlocked' : 'locked';
    
    return `
      <div class="achievement-badge ${badgeClass}">
        <div class="badge-icon" style="background: ${achievement.color};">
          <i class="${achievement.icon}"></i>
        </div>
        <div class="badge-name">${achievement.name}</div>
        <div class="badge-desc">${achievement.description}</div>
        ${isUnlocked ? '<div class="unlock-date">âœ… ' + achievement.unlockDate + '</div>' : '<div class="unlock-date">ğŸ”’ å°šæœªè§£é–</div>'}
      </div>
    `;
  }).join('');
}

/**
 * ç”Ÿæˆå€‹äººæœˆå ±
 */
async function generatePersonalMonthlyReport() {
  try {
    if (!confirm('ç¢ºå®šè¦ç”Ÿæˆå€‹äººæœˆå ±ä¸¦å¯„é€åˆ°æ‚¨çš„ Email å—ï¼Ÿ')) {
      return;
    }
    
    showLoading();
    
    const result = await callAPI('generatePersonalMonthlyReport', {});
    
    hideLoading();
    
    if (result && result.success) {
      showAlert('å€‹äººæœˆå ±å·²ç”Ÿæˆä¸¦å¯„é€åˆ°æ‚¨çš„ Emailï¼', 'success');
    } else {
      showAlert(result?.message || 'ç”Ÿæˆå¤±æ•—', 'error');
    }
    
  } catch(error) {
    console.error('âŒ generatePersonalMonthlyReport å¤±æ•—:', error); 
    hideLoading();
    showAlert('ç”Ÿæˆå¤±æ•—', 'error');
  }
}

/**
 * ç”Ÿæˆéƒ¨é–€æœˆå ±
 */
async function generateDepartmentMonthlyReport() {
  try {
    if (!checkPermission(sessionToken, PERMISSION_LEVELS.DEPT_MANAGER)) {
      showAlert('æ‚¨æ²’æœ‰æ¬Šé™ç”Ÿæˆéƒ¨é–€æœˆå ±ï¼ˆéœ€è¦ s2 ä»¥ä¸Šæ¬Šé™ï¼‰', 'error');
      return;
    }
    
    if (!confirm('ç¢ºå®šè¦ç”Ÿæˆéƒ¨é–€æœˆå ±ä¸¦å¯„é€åˆ°æ‚¨çš„ Email å—ï¼Ÿ')) {
      return;
    }
    
    showLoading();
    
    const result = await callAPI('generateDepartmentMonthlyReport', {});
    
    hideLoading();
    
    if (result && result.success) {
      showAlert('éƒ¨é–€æœˆå ±å·²ç”Ÿæˆä¸¦å¯„é€åˆ°æ‚¨çš„ Emailï¼', 'success');
    } else {
      showAlert(result?.message || 'ç”Ÿæˆå¤±æ•—', 'error');
    }
    
  } catch(error) {
    console.error('âŒ generateDepartmentMonthlyReport å¤±æ•—:', error);
    hideLoading();
    showAlert('ç”Ÿæˆå¤±æ•—', 'error');
  }
}

/**
 * ç”Ÿæˆå…¬å¸å­£å ±
 */
async function generateCompanyQuarterlyReport() {
  try {
    if (!checkPermission(sessionToken, PERMISSION_LEVELS.ADMIN)) {
      showAlert('æ‚¨æ²’æœ‰æ¬Šé™ç”Ÿæˆå…¬å¸å­£å ±ï¼ˆéœ€è¦ s4 æ¬Šé™ï¼‰', 'error');
      return;
    }
    
    if (!confirm('ç¢ºå®šè¦ç”Ÿæˆå…¬å¸å­£å ±ä¸¦å¯„é€åˆ°æ‚¨çš„ Email å—ï¼Ÿ')) {
      return;
    }
    
    showLoading();
    
    const result = await callAPI('generateCompanyQuarterlyReport', {});
    
    hideLoading();
    
    if (result && result.success) {
      showAlert('å…¬å¸å­£å ±å·²ç”Ÿæˆä¸¦å¯„é€åˆ°æ‚¨çš„ Emailï¼', 'success');
    } else {
      showAlert(result?.message || 'ç”Ÿæˆå¤±æ•—', 'error');
    }
    
  } catch(error) {
    console.error('âŒ generateCompanyQuarterlyReport å¤±æ•—:', error);
    hideLoading();
    showAlert('ç”Ÿæˆå¤±æ•—', 'error');
  }
}

/**
 * æ ¼å¼åŒ–å°æ™‚æ•¸
 */
function formatHours(hours) {
  if (!hours || hours === 0) return '0 å°æ™‚';
  
  if (hours < 1) {
    return Math.round(hours * 60) + ' åˆ†é˜';
  }
  
  return hours.toFixed(1) + ' å°æ™‚';
}

/**
 * æ ¼å¼åŒ–åˆ†é˜æ•¸
 */
function formatMinutes(minutes) {
  if (!minutes || minutes === 0) return '0 åˆ†é˜';
  
  if (minutes >= 60) {
    const hours = Math.floor(minutes / 60);
    const mins = Math.round(minutes % 60);
    return hours + ' å°æ™‚ ' + mins + ' åˆ†é˜';
  }
  
  return Math.round(minutes) + ' åˆ†é˜';
}

/**
 * æ ¼å¼åŒ–æ¯”è¼ƒç™¾åˆ†æ¯”
 */
function formatComparison(value) {
  if (value > 0) {
    return 'â†‘ +' + value + '%';
  } else if (value < 0) {
    return 'â†“ ' + value + '%';
  } else {
    return 'â†’ 0%';
  }
}

/**
 * ç›£è½æ™‚é–“ç¯„åœé¸æ“‡å™¨
 */
document.addEventListener('DOMContentLoaded', function() {
  const timeRangeSelect = document.getElementById('sophiaTimeRange');
  
  if (timeRangeSelect) {
    timeRangeSelect.addEventListener('change', function() {
      const customDateRange = document.getElementById('customDateRange');
      
      if (this.value === 'custom') {
        customDateRange.style.display = 'flex';
      } else {
        customDateRange.style.display = 'none';
        loadSophiaData();
      }
    });
  }
});

    // ==================== ç®¡ç†å¾Œå° ==================== 
    function switchAdminTab(tabName) {
      // æ›´æ–°æ¨™ç±¤æ¨£å¼
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        }
      });

      // åˆ‡æ›é¢æ¿
      document.querySelectorAll('.admin-panel').forEach(panel => {
        panel.classList.remove('active');
      });

      const targetPanel = document.getElementById('admin' + capitalize(tabName) + 'Panel');
      if (targetPanel) {
        targetPanel.classList.add('active');
      }

      // è¼‰å…¥å°æ‡‰è³‡æ–™
      switch(tabName) {
        case 'courses':
          loadAdminCourses();
          break;
        case 'questions':
          loadAdminQuestions();
          break;
        case 'accounts':
          loadAdminAccounts();
          break;
        case 'records':
          loadAdminRecords();
          break;
        case 'announcements':
          loadAdminAnnouncements();
          break;
        case 'settings':
          loadSystemSettings();
          break;
      }
    }

    function loadAdminData() {
      loadAdminCourses();
    }

    // ==================== èª²ç¨‹ç®¡ç† ==================== 
    async function loadAdminCourses() {
      const result = await callAPI('getAllCourses');

      if (result && result.success) {
        displayAdminCourses(result.data);
      }
    }

function displayAdminCourses(courses) {
  const tbody = document.getElementById('adminCoursesList');
  
  if (courses.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center">å°šç„¡èª²ç¨‹</td></tr>';
    return;
  }

  tbody.innerHTML = courses.map(course => `
    <tr>
      <td>${course.courseId}</td>
      <td>${course.courseGroup}</td>        <!-- âœ… å·²ä¿®æ­£ -->
      <td>${course.courseCategory}</td>     <!-- âœ… å·²ä¿®æ­£ -->
      <td>${course.courseName}</td>         <!-- âœ… å·²ä¿®æ­£ -->
      <td>${course.points}</td>
      <td>${course.deadline || '-'}</td>
      <td>
        <span class="status-badge ${course.status === 'å•Ÿç”¨' ? 'active' : 'inactive'}">
          ${course.status}
        </span>
      </td>
      <td>
        <div class="action-buttons">
          <button class="btn-icon btn-primary" onclick="editCourse('${course.courseId}')" title="ç·¨è¼¯">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn-icon btn-danger" onclick="deleteCourse('${course.courseId}')" title="åˆªé™¤">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}


async function showAddCourseModal() {
  document.getElementById('courseModalTitle').textContent = 'æ–°å¢èª²ç¨‹';
  document.getElementById('courseForm').reset();
  document.getElementById('courseFormId').value = '';
  
  // âœ… æ¸…ç©ºéƒ¨é–€+å€‹äººè¼¸å…¥æ¡†
  document.getElementById('courseFormRequiredDepts').value = '';
  document.getElementById('courseFormRequiredIndividuals').value = '';
  document.getElementById('courseFormOptionalDepts').value = '';
  document.getElementById('courseFormOptionalIndividuals').value = '';
  
  // âœ… è¼‰å…¥ä¸‹æ‹‰é¸å–®é¸é …
  await loadCategoryOptions();
  await loadSubjectOptions();
  
  document.getElementById('courseModal').classList.add('active');
}



async function editCourse(courseId) {
  // âœ… å…ˆè¼‰å…¥ä¸‹æ‹‰é¸å–®é¸é …
  await loadCategoryOptions();
  await loadSubjectOptions();
  
  const result = await callAPI('getCourseDetail', { courseId });

  if (result && result.success) {
    const course = result.data;
    
    document.getElementById('courseModalTitle').textContent = 'ç·¨è¼¯èª²ç¨‹';
    document.getElementById('courseFormId').value = course.courseId;
    document.getElementById('courseFormCategory').value = course.courseGroup;
    document.getElementById('courseFormSubject').value = course.courseCategory;
    document.getElementById('courseFormName').value = course.courseName;
    document.getElementById('courseFormDesc').value = course.courseDesc || '';
    document.getElementById('courseFormVideo').value = course.videoUrl;
    
    // âœ… è§£æå¿…ä¿®å°è±¡ï¼ˆæ”¯æ´æ–°èˆŠæ ¼å¼ï¼‰
    const required = parseTargetAudienceFrontend(course.requiredDepts);
    document.getElementById('courseFormRequiredDepts').value = required.departments.join(',');
    document.getElementById('courseFormRequiredIndividuals').value = required.individuals.join(',');
    
    // âœ… è§£æé¸ä¿®å°è±¡ï¼ˆæ”¯æ´æ–°èˆŠæ ¼å¼ï¼‰
    const optional = parseTargetAudienceFrontend(course.optionalDepts);
    document.getElementById('courseFormOptionalDepts').value = optional.departments.join(',');
    document.getElementById('courseFormOptionalIndividuals').value = optional.individuals.join(',');
    
    document.getElementById('courseFormStart').value = course.startDate ? course.startDate.split(' ')[0] : '';
    document.getElementById('courseFormDeadline').value = course.deadline ? course.deadline.split(' ')[0] : '';
    document.getElementById('courseFormPoints').value = course.points;
    document.getElementById('courseFormPrerequisite').value = course.prerequisiteCourseID || '';
    
    document.getElementById('courseModal').classList.add('active');
  }
}



async function saveCourse() {
  const courseId = document.getElementById('courseFormId').value;
  
  // âœ… è§£æéƒ¨é–€å’Œå€‹äººè¼¸å…¥
  const requiredDeptsInput = document.getElementById('courseFormRequiredDepts').value.trim();
  const requiredIndividualsInput = document.getElementById('courseFormRequiredIndividuals').value.trim();
  const optionalDeptsInput = document.getElementById('courseFormOptionalDepts').value.trim();
  const optionalIndividualsInput = document.getElementById('courseFormOptionalIndividuals').value.trim();
  
  // âœ… è½‰æ›ç‚ºé™£åˆ—
  const requiredDepts = requiredDeptsInput ? requiredDeptsInput.split(',').map(d => d.trim()).filter(d => d) : [];
  const requiredIndividuals = requiredIndividualsInput ? requiredIndividualsInput.split(',').map(i => i.trim()).filter(i => i) : [];
  const optionalDepts = optionalDeptsInput ? optionalDeptsInput.split(',').map(d => d.trim()).filter(d => d) : [];
  const optionalIndividuals = optionalIndividualsInput ? optionalIndividualsInput.split(',').map(i => i.trim()).filter(i => i) : [];
  
  const courseData = {
    categoryCode: document.getElementById('courseFormCategory').value,
    subjectCode: document.getElementById('courseFormSubject').value,
    courseName: document.getElementById('courseFormName').value,
    courseDesc: document.getElementById('courseFormDesc').value,
    videoUrl: document.getElementById('courseFormVideo').value,
    requiredDepts: requiredDepts,              // âœ… æ–°å¢
    requiredIndividuals: requiredIndividuals,  // âœ… æ–°å¢
    optionalDepts: optionalDepts,              // âœ… æ–°å¢
    optionalIndividuals: optionalIndividuals,  // âœ… æ–°å¢
    startDate: document.getElementById('courseFormStart').value,
    deadline: document.getElementById('courseFormDeadline').value,
    points: parseInt(document.getElementById('courseFormPoints').value),
    prerequisiteCourseId: document.getElementById('courseFormPrerequisite').value
  };

  const action = courseId ? 'updateCourse' : 'createCourse';
  const data = courseId ? { courseId, courseData: JSON.stringify(courseData) } : { courseData: JSON.stringify(courseData) };

  const result = await callAPI(action, data);

  if (result && result.success) {
    showAlert(courseId ? 'èª²ç¨‹æ›´æ–°æˆåŠŸ' : 'èª²ç¨‹æ–°å¢æˆåŠŸ', 'success');
    closeCourseModal();
    loadAdminCourses();
  } else {
    showAlert(result?.message || 'æ“ä½œå¤±æ•—', 'error');
  }
}



    async function deleteCourse(courseId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤èª²ç¨‹å—?æ­¤æ“ä½œç„¡æ³•å¾©åŸ!')) return;

      const result = await callAPI('deleteCourse', { courseId });

      if (result && result.success) {
        showAlert('èª²ç¨‹åˆªé™¤æˆåŠŸ', 'success');
        loadAdminCourses();
      } else {
        showAlert(result?.message || 'åˆªé™¤å¤±æ•—', 'error');
      }
    }

    function closeCourseModal() {
      document.getElementById('courseModal').classList.remove('active');
    }

    // ==================== é¡Œç›®ç®¡ç† ==================== 
// ==================== é¡Œç›®ç®¡ç† ==================== 

/**
 * è¼‰å…¥é¡Œç›®ç®¡ç†çš„èª²ç¨‹é¸å–®
 */
async function loadAdminQuestions() {
  console.log('=== loadAdminQuestions ===');
  
  // âœ… è¼‰å…¥èª²ç¨‹é¸é …
  const coursesResult = await callAPI('getAllCourses', {});
  
  if (coursesResult && coursesResult.success) {
    const select1 = document.getElementById('adminQuestionCourseFilter');
    const select2 = document.getElementById('questionFormCourse');
    
    const options = coursesResult.data.map(c => 
      `<option value="${c.courseId}">${c.courseId} - ${c.courseName}</option>`
    ).join('');
    
    select1.innerHTML = '<option value="">é¸æ“‡èª²ç¨‹</option>' + options;
    select2.innerHTML = '<option value="">è«‹é¸æ“‡èª²ç¨‹</option>' + options;
    
    console.log('âœ… èª²ç¨‹é¸å–®è¼‰å…¥å®Œæˆ,å…± ' + coursesResult.data.length + ' ç­†èª²ç¨‹');
  } else {
    console.error('âŒ è¼‰å…¥èª²ç¨‹å¤±æ•—');
  }
  
  // âœ… æ¸…ç©ºé¡Œç›®åˆ—è¡¨
  displayAdminQuestions([]);
}

/**
 * ç•¶é¸æ“‡èª²ç¨‹æ™‚,è¼‰å…¥è©²èª²ç¨‹çš„é¡Œç›®
 */
async function loadAdminQuestionsByCourse() {
  const courseSelect = document.getElementById('adminQuestionCourseFilter');
  const selectedCourseId = courseSelect.value;
  
  console.log('=== loadAdminQuestionsByCourse ===');
  console.log('é¸æ“‡çš„èª²ç¨‹ID:', selectedCourseId);
  
  if (!selectedCourseId) {
    console.log('âš ï¸ æœªé¸æ“‡èª²ç¨‹');
    displayAdminQuestions([]);
    return;
  }
  
  showLoading();
  
  try {
    // âœ… å‘¼å« getQuestionList API
    const result = await callAPI('getQuestionList', { 
      courseId: selectedCourseId 
    });
    
    console.log('API å›æ‡‰:', result);
    
    hideLoading();
    
    if (result && result.success) {
      console.log('âœ… æˆåŠŸå–å¾— ' + result.data.length + ' ç­†é¡Œç›®');
      displayAdminQuestions(result.data);
      
      if (result.data.length === 0) {
        showAlert('æ­¤èª²ç¨‹å°šç„¡é¡Œç›®', 'info');
      }
    } else {
      console.error('âŒ API å›æ‡‰å¤±æ•—:', result?.message);
      showAlert(result?.message || 'è¼‰å…¥é¡Œç›®å¤±æ•—', 'error');
      displayAdminQuestions([]);
    }
  } catch (error) {
    console.error('âŒ è¼‰å…¥é¡Œç›®å¤±æ•—:', error);
    hideLoading();
    showAlert('è¼‰å…¥é¡Œç›®å¤±æ•—', 'error');
    displayAdminQuestions([]);
  }
}

/**
 * é¡¯ç¤ºé¡Œç›®åˆ—è¡¨
 */
function displayAdminQuestions(questions) {
  const tbody = document.getElementById('adminQuestionsList');
  
  if (questions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-center">è«‹é¸æ“‡èª²ç¨‹</td></tr>';
    return;
  }

  tbody.innerHTML = questions.map(q => `
    <tr>
      <td>${q.questionId}</td>
      <td>${q.questionText}</td>
      <td>${q.correctAnswer}</td>
      <td>
        <div class="action-buttons">
          <button class="btn-icon btn-primary" onclick="editQuestion('${q.questionId}')" title="ç·¨è¼¯">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn-icon btn-danger" onclick="deleteQuestion('${q.questionId}')" title="åˆªé™¤">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}

/**
 * é¡¯ç¤ºæ–°å¢é¡Œç›® Modal
 */
function showAddQuestionModal() {
  const courseId = document.getElementById('adminQuestionCourseFilter').value;
  
  if (!courseId) {
    showAlert('è«‹å…ˆé¸æ“‡èª²ç¨‹', 'warning');
    return;
  }

  document.getElementById('questionModalTitle').textContent = 'æ–°å¢é¡Œç›®';
  document.getElementById('questionForm').reset();
  document.getElementById('questionFormId').value = '';
  document.getElementById('questionFormCourse').value = courseId;
  document.getElementById('questionModal').classList.add('active');
}

/**
 * ç·¨è¼¯é¡Œç›®
 */
async function editQuestion(questionId) {
  showLoading();
  
  try {
    const result = await callAPI('getQuestionDetail', { questionId });

    hideLoading();

    if (result && result.success) {
      const q = result.data;
      
      document.getElementById('questionModalTitle').textContent = 'ç·¨è¼¯é¡Œç›®';
      document.getElementById('questionFormId').value = q.questionId;
      document.getElementById('questionFormCourse').value = q.courseId;
      document.getElementById('questionFormText').value = q.questionText;
      document.getElementById('questionFormOptionA').value = q.optionA;
      document.getElementById('questionFormOptionB').value = q.optionB;
      document.getElementById('questionFormOptionC').value = q.optionC;
      document.getElementById('questionFormOptionD').value = q.optionD;
      document.getElementById('questionFormAnswer').value = q.correctAnswer;
      
      document.getElementById('questionModal').classList.add('active');
    } else {
      showAlert(result?.message || 'è¼‰å…¥é¡Œç›®å¤±æ•—', 'error');
    }
  } catch (error) {
    console.error('ç·¨è¼¯é¡Œç›®å¤±æ•—:', error);
    hideLoading();
    showAlert('è¼‰å…¥é¡Œç›®å¤±æ•—', 'error');
  }
}

/**
 * å„²å­˜é¡Œç›®
 */
async function saveQuestion() {
  const questionId = document.getElementById('questionFormId').value;
  const questionData = {
    courseId: document.getElementById('questionFormCourse').value,
    questionText: document.getElementById('questionFormText').value,
    optionA: document.getElementById('questionFormOptionA').value,
    optionB: document.getElementById('questionFormOptionB').value,
    optionC: document.getElementById('questionFormOptionC').value,
    optionD: document.getElementById('questionFormOptionD').value,
    correctAnswer: document.getElementById('questionFormAnswer').value
  };

  // âœ… é©—è­‰å¿…å¡«æ¬„ä½
  if (!questionData.courseId || !questionData.questionText || 
      !questionData.optionA || !questionData.optionB || 
      !questionData.optionC || !questionData.optionD || 
      !questionData.correctAnswer) {
    showAlert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'warning');
    return;
  }

  showLoading();

  try {
    const action = questionId ? 'updateQuestion' : 'createQuestion';
    const data = questionId 
      ? { questionId, questionData: JSON.stringify(questionData) } 
      : { questionData: JSON.stringify(questionData) };

    const result = await callAPI(action, data);

    hideLoading();

    if (result && result.success) {
      showAlert(questionId ? 'é¡Œç›®æ›´æ–°æˆåŠŸ' : 'é¡Œç›®æ–°å¢æˆåŠŸ', 'success');
      closeQuestionModal();
      loadAdminQuestionsByCourse(); // âœ… é‡æ–°è¼‰å…¥é¡Œç›®åˆ—è¡¨
    } else {
      showAlert(result?.message || 'æ“ä½œå¤±æ•—', 'error');
    }
  } catch (error) {
    console.error('å„²å­˜é¡Œç›®å¤±æ•—:', error);
    hideLoading();
    showAlert('æ“ä½œå¤±æ•—', 'error');
  }
}

/**
 * åˆªé™¤é¡Œç›®
 */
async function deleteQuestion(questionId) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é¡Œç›®å—?')) return;

  showLoading();

  try {
    const result = await callAPI('deleteQuestion', { questionId });

    hideLoading();

    if (result && result.success) {
      showAlert('é¡Œç›®åˆªé™¤æˆåŠŸ', 'success');
      loadAdminQuestionsByCourse(); // âœ… é‡æ–°è¼‰å…¥é¡Œç›®åˆ—è¡¨
    } else {
      showAlert(result?.message || 'åˆªé™¤å¤±æ•—', 'error');
    }
  } catch (error) {
    console.error('åˆªé™¤é¡Œç›®å¤±æ•—:', error);
    hideLoading();
    showAlert('åˆªé™¤å¤±æ•—', 'error');
  }
}

/**
 * é—œé–‰é¡Œç›® Modal
 */
function closeQuestionModal() {
  document.getElementById('questionModal').classList.remove('active');
}


    async function loadAdminQuestionsByCourse() {
      const courseId = document.getElementById('adminQuestionCourseFilter').value;
      
      if (!courseId) {
        document.getElementById('adminQuestionsList').innerHTML = 
          '<tr><td colspan="4" class="text-center">è«‹é¸æ“‡èª²ç¨‹</td></tr>';
        return;
      }

      const result = await callAPI('getQuestions', { courseId });

      if (result && result.success) {
        displayAdminQuestions(result.data);
      }
    }

    function displayAdminQuestions(questions) {
      const tbody = document.getElementById('adminQuestionsList');
      
      if (questions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">æ­¤èª²ç¨‹å°šç„¡é¡Œç›®</td></tr>';
        return;
      }

      tbody.innerHTML = questions.map(q => `
        <tr>
          <td>${q.questionId}</td>
          <td>${q.questionText}</td>
          <td>${q.correctAnswer}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-primary" onclick="editQuestion('${q.questionId}')" title="ç·¨è¼¯">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon btn-danger" onclick="deleteQuestion('${q.questionId}')" title="åˆªé™¤">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function showAddQuestionModal() {
      const courseId = document.getElementById('adminQuestionCourseFilter').value;
      
      if (!courseId) {
        showAlert('è«‹å…ˆé¸æ“‡èª²ç¨‹', 'warning');
        return;
      }

      document.getElementById('questionModalTitle').textContent = 'æ–°å¢é¡Œç›®';
      document.getElementById('questionForm').reset();
      document.getElementById('questionFormId').value = '';
      document.getElementById('questionFormCourse').value = courseId;
      document.getElementById('questionModal').classList.add('active');
    }

    async function editQuestion(questionId) {
      const result = await callAPI('getQuestionDetail', { questionId });

      if (result && result.success) {
        const q = result.data;
        
        document.getElementById('questionModalTitle').textContent = 'ç·¨è¼¯é¡Œç›®';
        document.getElementById('questionFormId').value = q.questionId;
        document.getElementById('questionFormCourse').value = q.courseId;
        document.getElementById('questionFormText').value = q.questionText;
        document.getElementById('questionFormOptionA').value = q.optionA;
        document.getElementById('questionFormOptionB').value = q.optionB;
        document.getElementById('questionFormOptionC').value = q.optionC;
        document.getElementById('questionFormOptionD').value = q.optionD;
        document.getElementById('questionFormAnswer').value = q.correctAnswer;
        
        document.getElementById('questionModal').classList.add('active');
      }
    }

    async function saveQuestion() {
      const questionId = document.getElementById('questionFormId').value;
      const questionData = {
        courseId: document.getElementById('questionFormCourse').value,
        questionText: document.getElementById('questionFormText').value,
        optionA: document.getElementById('questionFormOptionA').value,
        optionB: document.getElementById('questionFormOptionB').value,
        optionC: document.getElementById('questionFormOptionC').value,
        optionD: document.getElementById('questionFormOptionD').value,
        correctAnswer: document.getElementById('questionFormAnswer').value
      };

      const action = questionId ? 'updateQuestion' : 'createQuestion';
      const data = questionId ? { questionId, questionData } : { questionData };

      const result = await callAPI(action, data);

      if (result && result.success) {
        showAlert(questionId ? 'é¡Œç›®æ›´æ–°æˆåŠŸ' : 'é¡Œç›®æ–°å¢æˆåŠŸ', 'success');
        closeQuestionModal();
        loadAdminQuestionsByCourse();
      } else {
        showAlert(result?.message || 'æ“ä½œå¤±æ•—', 'error');
      }
    }

    async function deleteQuestion(questionId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é¡Œç›®å—?')) return;

      const result = await callAPI('deleteQuestion', { questionId });

      if (result && result.success) {
        showAlert('é¡Œç›®åˆªé™¤æˆåŠŸ', 'success');
        loadAdminQuestionsByCourse();
      } else {
        showAlert(result?.message || 'åˆªé™¤å¤±æ•—', 'error');
      }
    }

    function closeQuestionModal() {
      document.getElementById('questionModal').classList.remove('active');
    }

    // ==================== å¸³è™Ÿç®¡ç† ==================== 
    async function loadAdminAccounts() {
      const result = await callAPI('getAllAccounts');

      if (result && result.success) {
        displayAdminAccounts(result.data);
      }
    }

    function displayAdminAccounts(accounts) {
      const tbody = document.getElementById('adminAccountsList');
      
      if (accounts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">å°šç„¡å¸³è™Ÿ</td></tr>';
        return;
      }

      tbody.innerHTML = accounts.map(acc => `
        <tr>
          <td>${acc.empId}</td>
          <td>${acc.name}</td>
          <td>${acc.department}</td>
          <td>${acc.email || '-'}</td>
          <td>${acc.permission}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-primary" onclick="editAccount('${acc.empId}')" title="ç·¨è¼¯">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon btn-warning" onclick="resetPassword('${acc.empId}')" title="é‡è¨­å¯†ç¢¼">
                <i class="fas fa-key"></i>
              </button>
              <button class="btn-icon btn-danger" onclick="deleteAccount('${acc.empId}')" title="åˆªé™¤">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function showAddAccountModal() {
      document.getElementById('accountModalTitle').textContent = 'æ–°å¢å¸³è™Ÿ';
      document.getElementById('accountForm').reset();
      document.getElementById('accountFormEmpId').readOnly = false;
      document.getElementById('accountModal').classList.add('active');
    }

    async function editAccount(empId) {
      const result = await callAPI('getAccountDetail', { empId });

      if (result && result.success) {
        const acc = result.data;
        
        document.getElementById('accountModalTitle').textContent = 'ç·¨è¼¯å¸³è™Ÿ';
        document.getElementById('accountFormEmpId').value = acc.empId;
        document.getElementById('accountFormEmpId').readOnly = true;
        document.getElementById('accountFormName').value = acc.name;
        document.getElementById('accountFormDept').value = acc.department;
        document.getElementById('accountFormPassword').value = '';
        document.getElementById('accountFormPassword').placeholder = 'ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹';
        document.getElementById('accountFormEmail').value = acc.email || '';
        document.getElementById('accountFormPermission').value = acc.permission;
        
        document.getElementById('accountModal').classList.add('active');
      }
    }

    async function saveAccount() {
      const empId = document.getElementById('accountFormEmpId').value;
      const isEdit = document.getElementById('accountFormEmpId').readOnly;
      
      const accountData = {
        empId: empId,
        name: document.getElementById('accountFormName').value,
        department: document.getElementById('accountFormDept').value,
        password: document.getElementById('accountFormPassword').value,
        email: document.getElementById('accountFormEmail').value,
        permission: document.getElementById('accountFormPermission').value
      };

      const action = isEdit ? 'updateAccount' : 'createAccount';

      const result = await callAPI(action, accountData);

      if (result && result.success) {
        showAlert(isEdit ? 'å¸³è™Ÿæ›´æ–°æˆåŠŸ' : 'å¸³è™Ÿæ–°å¢æˆåŠŸ', 'success');
        closeAccountModal();
        loadAdminAccounts();
      } else {
        showAlert(result?.message || 'æ“ä½œå¤±æ•—', 'error');
      }
    }

    async function resetPassword(empId) {
      const newPassword = prompt('è«‹è¼¸å…¥æ–°å¯†ç¢¼:');
      
      if (!newPassword) return;

      const result = await callAPI('resetPassword', { empId, newPassword });

      if (result && result.success) {
        showAlert('å¯†ç¢¼é‡è¨­æˆåŠŸ', 'success');
      } else {
        showAlert(result?.message || 'é‡è¨­å¤±æ•—', 'error');
      }
    }

    async function deleteAccount(empId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¸³è™Ÿå—?')) return;

      const result = await callAPI('deleteAccount', { empId });

      if (result && result.success) {
        showAlert('å¸³è™Ÿåˆªé™¤æˆåŠŸ', 'success');
        loadAdminAccounts();
      } else {
        showAlert(result?.message || 'åˆªé™¤å¤±æ•—', 'error');
      }
    }

    function closeAccountModal() {
      document.getElementById('accountModal').classList.remove('active');
    }

    // ==================== å­¸ç¿’ç´€éŒ„ç®¡ç† ==================== 
    async function loadAdminRecords() {
      const result = await callAPI('getAllLearningRecords');

      if (result && result.success) {
        displayAdminRecords(result.data);
      }
    }

    function displayAdminRecords(records) {
      const tbody = document.getElementById('adminRecordsList');
      
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">å°šç„¡å­¸ç¿’ç´€éŒ„</td></tr>';
        return;
      }

      tbody.innerHTML = records.map(record => `
        <tr>
          <td>${record.empId}</td>
          <td>${record.empName}</td>
          <td>${record.courseName}</td>
          <td>${record.startTime || '-'}</td>
          <td>${record.completeTime || '-'}</td>
          <td>${record.examScore !== null ? record.examScore + ' åˆ†' : '-'}</td>
          <td>${record.earnedPoints || 0} é»</td>
        </tr>
      `).join('');
    }

    function exportRecords() {
      showAlert('åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
      // å¯ä»¥å¯¦ä½œåŒ¯å‡º CSV æˆ– Excel åŠŸèƒ½
    }

    // ==================== å…¬å‘Šç®¡ç† ==================== 
    async function loadAdminAnnouncements() {
      const result = await callAPI('getAllAnnouncements');

      if (result && result.success) {
        displayAdminAnnouncements(result.data);
      }
    }

function displayAdminAnnouncements(announcements) {
  const tbody = document.getElementById('adminAnnouncementsList');
  
  if (announcements.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">å°šç„¡å…¬å‘Š</td></tr>';
    return;
  }

  tbody.innerHTML = announcements.map(ann => {
    // âœ… é¡¯ç¤ºæ ¼å¼åŒ–çš„å°è±¡ï¼ˆæ”¯æ´æ–°æ ¼å¼ï¼‰
    let targetDisplay = ann.targetDepts || 'å…¨å…¬å¸';
    
    // å¦‚æœæ˜¯æ–°æ ¼å¼ï¼Œè§£æå¾Œé¡¯ç¤º
    if (targetDisplay.includes('éƒ¨é–€:') || targetDisplay.includes('å€‹äºº:')) {
      const parsed = parseTargetAudienceFrontend(targetDisplay);
      const parts = [];
      
      if (parsed.departments.length > 0) {
        parts.push('éƒ¨é–€: ' + parsed.departments.join(', '));
      }
      if (parsed.individuals.length > 0) {
        parts.push('å€‹äºº: ' + parsed.individuals.join(', '));
      }
      
      targetDisplay = parts.join(' | ') || 'å…¨å…¬å¸';
    }
    
    return `
      <tr>
        <td>${ann.time}</td>
        <td>${ann.content}</td>
        <td>${targetDisplay}</td>
        <td>${ann.isPinned ? 'æ˜¯' : 'å¦'}</td>
        <td>${ann.expiryDate || 'ç„¡æœŸé™'}</td>
        <td>
          <div class="action-buttons">
            <button class="btn-icon btn-danger" onclick="deleteAnnouncement('${ann.time}')" title="åˆªé™¤">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}


    function showAddAnnouncementModal() {
      document.getElementById('announcementForm').reset();
      document.getElementById('announcementModal').classList.add('active');
    }

async function saveAnnouncement() {
  // âœ… è§£æéƒ¨é–€å’Œå€‹äººè¼¸å…¥
  const targetDeptsInput = document.getElementById('announcementFormTargetDepts').value.trim();
  const targetIndividualsInput = document.getElementById('announcementFormTargetIndividuals').value.trim();
  
  // âœ… è½‰æ›ç‚ºé™£åˆ—
  const targetDepts = targetDeptsInput ? targetDeptsInput.split(',').map(d => d.trim()).filter(d => d) : [];
  const targetIndividuals = targetIndividualsInput ? targetIndividualsInput.split(',').map(i => i.trim()).filter(i => i) : [];
  
  const announcementData = {
    content: document.getElementById('announcementFormContent').value,
    targetDepts: targetDepts,              // âœ… æ–°å¢
    targetIndividuals: targetIndividuals,  // âœ… æ–°å¢
    isPinned: document.getElementById('announcementFormPinned').checked,
    expiryDate: document.getElementById('announcementFormExpiry').value
  };

  const result = await callAPI('createAnnouncement', announcementData);

  if (result && result.success) {
    showAlert('å…¬å‘Šç™¼å¸ƒæˆåŠŸ', 'success');
    closeAnnouncementModal();
    loadAdminAnnouncements();
  } else {
    showAlert(result?.message || 'ç™¼å¸ƒå¤±æ•—', 'error');
  }
}


    async function deleteAnnouncement(announcementId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å…¬å‘Šå—?')) return;

      const result = await callAPI('deleteAnnouncement', { announcementId });

      if (result && result.success) {
        showAlert('å…¬å‘Šåˆªé™¤æˆåŠŸ', 'success');
        loadAdminAnnouncements();
      } else {
        showAlert(result?.message || 'åˆªé™¤å¤±æ•—', 'error');
      }
    }

    function closeAnnouncementModal() {
      document.getElementById('announcementModal').classList.remove('active');
    }
    // ==================== è³‡æ–™å¿«å–ç³»çµ± ====================

/**
 * å¿«å–ç®¡ç†å™¨
 */
const CacheManager = {
  // å¿«å–å„²å­˜
  cache: {},
  
  // å¿«å–æœ‰æ•ˆæœŸï¼ˆæ¯«ç§’ï¼‰
  expiry: {
    courses: 5 * 60 * 1000,      // èª²ç¨‹åˆ—è¡¨: 5 åˆ†é˜
    dashboard: 2 * 60 * 1000,    // å„€éŒ¶æ¿: 2 åˆ†é˜
    charts: 5 * 60 * 1000,       // åœ–è¡¨: 5 åˆ†é˜
    mylearning: 3 * 60 * 1000,   // æˆ‘çš„å­¸ç¿’: 3 åˆ†é˜
    announcements: 10 * 60 * 1000 // å…¬å‘Š: 10 åˆ†é˜
  },
  
  /**
   * è¨­å®šå¿«å–
   */
  set: function(key, data) {
    console.log('ğŸ’¾ è¨­å®šå¿«å–:', key);
    this.cache[key] = {
      data: data,
      timestamp: Date.now()
    };
  },
  
  /**
   * å–å¾—å¿«å–
   */
  get: function(key, expiryTime) {
    const cached = this.cache[key];
    
    if (!cached) {
      console.log('âš ï¸ å¿«å–ä¸å­˜åœ¨:', key);
      return null;
    }
    
    const now = Date.now();
    const age = now - cached.timestamp;
    
    if (age > expiryTime) {
      console.log('âš ï¸ å¿«å–å·²éæœŸ:', key, '(', Math.round(age / 1000), 'ç§’)');
      delete this.cache[key];
      return null;
    }
    
    console.log('âœ… ä½¿ç”¨å¿«å–:', key, '(å‰©é¤˜', Math.round((expiryTime - age) / 1000), 'ç§’)');
    return cached.data;
  },
  
  /**
   * æ¸…é™¤ç‰¹å®šå¿«å–
   */
  clear: function(key) {
    console.log('ğŸ—‘ï¸ æ¸…é™¤å¿«å–:', key);
    delete this.cache[key];
  },
  
  /**
   * æ¸…é™¤æ‰€æœ‰å¿«å–
   */
  clearAll: function() {
    console.log('ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰å¿«å–');
    this.cache = {};
  },
  
  /**
   * å–å¾—å¿«å–ç‹€æ…‹
   */
  getStatus: function() {
    const status = {};
    for (const key in this.cache) {
      const age = Date.now() - this.cache[key].timestamp;
      status[key] = {
        age: Math.round(age / 1000) + ' ç§’',
        size: JSON.stringify(this.cache[key].data).length + ' bytes'
      };
    }
    return status;
  }
};

/**
 * å¸¶å¿«å–çš„ API å‘¼å«
 */
async function callAPIWithCache(action, data = {}, useCache = true) {
  console.log('=== callAPIWithCache ===');
  console.log('action:', action);
  console.log('useCache:', useCache);
  
  // ç”Ÿæˆå¿«å–éµ
  const cacheKey = action + '_' + JSON.stringify(data);
  
  // æª¢æŸ¥å¿«å–
  if (useCache) {
    const expiryTime = CacheManager.expiry[action] || 5 * 60 * 1000;
    const cached = CacheManager.get(cacheKey, expiryTime);
    
    if (cached) {
      console.log('âœ… è¿”å›å¿«å–è³‡æ–™');
      return cached;
    }
  }
  
  // å‘¼å« API
  console.log('ğŸ“¡ å‘¼å« API');
  const result = await callAPI(action, data);
  
  // å„²å­˜å¿«å–
  if (result && result.success && useCache) {
    CacheManager.set(cacheKey, result);
  }
  
  return result;
}


    // ==================== ç³»çµ±è¨­å®š ==================== 
    async function loadSystemSettings() {
      const result = await callAPI('getSystemSettings');

      if (result && result.success) {
        const settings = result.data;
        
        document.getElementById('settingQuestionCount').value = settings['æ¸¬é©—é¡Œæ•¸'] || 5;
        document.getElementById('settingPassScore').value = settings['æ¸¬é©—åŠæ ¼åˆ†æ•¸'] || 60;
        document.getElementById('settingReminderDays').value = settings['æˆªæ­¢æ—¥æé†’å¤©æ•¸'] || 5;
        document.getElementById('settingSessionTimeout').value = settings['Sessionæœ‰æ•ˆæ™‚é–“'] || 480;
      }
    }

    async function saveSystemSettings() {
      const settings = {
        'æ¸¬é©—é¡Œæ•¸': parseInt(document.getElementById('settingQuestionCount').value),
        'æ¸¬é©—åŠæ ¼åˆ†æ•¸': parseInt(document.getElementById('settingPassScore').value),
        'æˆªæ­¢æ—¥æé†’å¤©æ•¸': parseInt(document.getElementById('settingReminderDays').value),
        'Sessionæœ‰æ•ˆæ™‚é–“': parseInt(document.getElementById('settingSessionTimeout').value)
      };

      const result = await callAPI('updateSystemSettings', { settings });

      if (result && result.success) {
        showAlert('ç³»çµ±è¨­å®šæ›´æ–°æˆåŠŸ', 'success');
      } else {
        showAlert(result?.message || 'æ›´æ–°å¤±æ•—', 'error');
      }
    }
  // ==================== ä¿®æ”¹å¯†ç¢¼åŠŸèƒ½ ====================

/**
 * é¡¯ç¤ºä¿®æ”¹å¯†ç¢¼ Modal
 */
function showChangePasswordModal() {
  console.log('=== showChangePasswordModal ===');
  
  // é‡ç½®è¡¨å–®
  document.getElementById('changePasswordForm').reset();
  
  // éš±è—å¯†ç¢¼å¼·åº¦æŒ‡ç¤ºå™¨
  document.getElementById('passwordStrength').style.display = 'none';
  
  // é¡¯ç¤º Modal
  document.getElementById('changePasswordModal').classList.add('active');
  
  // ç›£è½æ–°å¯†ç¢¼è¼¸å…¥ï¼ˆé¡¯ç¤ºå¼·åº¦ï¼‰
  const newPasswordInput = document.getElementById('newPassword');
  newPasswordInput.addEventListener('input', checkPasswordStrength);
}

/**
 * é—œé–‰ä¿®æ”¹å¯†ç¢¼ Modal
 */
function closeChangePasswordModal() {
  console.log('=== closeChangePasswordModal ===');
  
  // ç§»é™¤äº‹ä»¶ç›£è½å™¨
  const newPasswordInput = document.getElementById('newPassword');
  newPasswordInput.removeEventListener('input', checkPasswordStrength);
  
  // é—œé–‰ Modal
  document.getElementById('changePasswordModal').classList.remove('active');
}

/**
 * æª¢æŸ¥å¯†ç¢¼å¼·åº¦
 */
function checkPasswordStrength() {
  const password = document.getElementById('newPassword').value;
  const strengthDiv = document.getElementById('passwordStrength');
  const strengthText = document.getElementById('strengthText');
  
  if (password.length === 0) {
    strengthDiv.style.display = 'none';
    return;
  }
  
  let strength = 0;
  let text = '';
  let color = '';
  
  // é•·åº¦æª¢æŸ¥
  if (password.length >= 6) strength++;
  if (password.length >= 8) strength++;
  if (password.length >= 12) strength++;
  
  // è¤‡é›œåº¦æª¢æŸ¥
  if (/[a-z]/.test(password)) strength++; // å°å¯«å­—æ¯
  if (/[A-Z]/.test(password)) strength++; // å¤§å¯«å­—æ¯
  if (/[0-9]/.test(password)) strength++; // æ•¸å­—
  if (/[^a-zA-Z0-9]/.test(password)) strength++; // ç‰¹æ®Šå­—å…ƒ
  
  // åˆ¤æ–·å¼·åº¦
  if (strength <= 2) {
    text = 'å¼± âš ï¸';
    color = '#ef4444';
  } else if (strength <= 4) {
    text = 'ä¸­ç­‰ âš¡';
    color = '#f59e0b';
  } else if (strength <= 6) {
    text = 'å¼· âœ…';
    color = '#10b981';
  } else {
    text = 'éå¸¸å¼· ğŸ”’';
    color = '#059669';
  }
  
  strengthDiv.style.display = 'block';
  strengthDiv.style.backgroundColor = color + '20';
  strengthDiv.style.borderLeft = '4px solid ' + color;
  strengthText.textContent = text;
  strengthText.style.color = color;
}

/**
 * æäº¤ä¿®æ”¹å¯†ç¢¼
 */
async function submitChangePassword(event) {
  if (event) event.preventDefault();
  
  console.log('=== submitChangePassword ===');
  
  // å–å¾—è¼¸å…¥å€¼
  const currentPassword = document.getElementById('currentPassword').value.trim();
  const newPassword = document.getElementById('newPassword').value.trim();
  const confirmPassword = document.getElementById('confirmPassword').value.trim();
  
  // âœ… å‰ç«¯é©—è­‰
  if (!currentPassword || !newPassword || !confirmPassword) {
    showAlert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'warning');
    return;
  }
  
  if (newPassword.length < 6) {
    showAlert('æ–°å¯†ç¢¼é•·åº¦è‡³å°‘ 6 å€‹å­—å…ƒ', 'warning');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    showAlert('æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´', 'warning');
    return;
  }
  
  if (currentPassword === newPassword) {
    showAlert('æ–°å¯†ç¢¼ä¸èƒ½èˆ‡ç›®å‰å¯†ç¢¼ç›¸åŒ', 'warning');
    return;
  }
  
  console.log('âœ… å‰ç«¯é©—è­‰é€šé');
  
  showLoading();
  
  try {
    // âœ… å‘¼å«å¾Œç«¯ API
    const result = await callAPI('changePassword', {
      currentPassword: currentPassword,
      newPassword: newPassword
    });
    
    console.log('API å›æ‡‰:', result);
    
    hideLoading();
    
    if (result && result.success) {
      console.log('âœ… å¯†ç¢¼ä¿®æ”¹æˆåŠŸ');
      showAlert('å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼è«‹é‡æ–°ç™»å…¥', 'success');
      
      // é—œé–‰ Modal
      closeChangePasswordModal();
      
      // å»¶é² 2 ç§’å¾Œç™»å‡º
      setTimeout(() => {
        logout();
      }, 2000);
    } else {
      console.error('âŒ å¯†ç¢¼ä¿®æ”¹å¤±æ•—:', result?.message);
      showAlert(result?.message || 'å¯†ç¢¼ä¿®æ”¹å¤±æ•—', 'error');
    }
  } catch (error) {
    console.error('âŒ submitChangePassword å¤±æ•—:', error);
    hideLoading();
    showAlert('ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
  }
}


    // ==================== å·¥å…·å‡½æ•¸ ==================== 
    function showLoading() {
      document.getElementById('loading').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('active');
    }

    function showAlert(message, type = 'info') {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert alert-${type} active`;
      
      setTimeout(() => {
        alert.classList.remove('active');
      }, 3000);
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // é—œé–‰ Modal çš„é€šç”¨æ–¹æ³•(é»æ“ŠèƒŒæ™¯)
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
      }
    });

    /**
 * é‡æ–°æ•´ç†å„€éŒ¶æ¿
 */
function refreshDashboard() {
  console.log('ğŸ”„ é‡æ–°æ•´ç†å„€éŒ¶æ¿');
  
  // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
  showLoading();
  
  // æ¸…é™¤æ‰€æœ‰å¿«å–
  CacheManager.clearAll();
  
  // é‡æ–°è¼‰å…¥
  loadDashboard(true);
  
  // éš±è—è¼‰å…¥å‹•ç•«
  setTimeout(() => {
    hideLoading();
    showAlert('è³‡æ–™å·²æ›´æ–°', 'success');
  }, 1000);
}
    /**
 * å‰ç«¯è§£æå°è±¡å­—ä¸²ï¼ˆæ”¯æ´æ–°èˆŠæ ¼å¼ï¼‰
 * @param {string} targetString - å°è±¡å­—ä¸²
 * @return {Object} - { departments: [], individuals: [] }
 */
function parseTargetAudienceFrontend(targetString) {
  if (!targetString || targetString.trim() === '') {
    return { departments: [], individuals: [] };
  }
  
  const result = { departments: [], individuals: [] };
  
  // âœ… æª¢æŸ¥æ˜¯å¦ç‚ºæ–°æ ¼å¼
  if (targetString.includes('éƒ¨é–€:') || targetString.includes('å€‹äºº:')) {
    // æ–°æ ¼å¼: "éƒ¨é–€:IT,HR;å€‹äºº:E001,E002"
    const parts = targetString.split(';');
    
    parts.forEach(part => {
      part = part.trim();
      
      if (part.startsWith('éƒ¨é–€:')) {
        const depts = part.substring(3).split(',').map(d => d.trim()).filter(d => d);
        result.departments = depts;
      } else if (part.startsWith('å€‹äºº:')) {
        const individuals = part.substring(3).split(',').map(i => i.trim()).filter(i => i);
        result.individuals = individuals;
      }
    });
  } else {
    // èˆŠæ ¼å¼: "IT,HR,Finance" (è¦–ç‚ºéƒ¨é–€)
    result.departments = targetString.split(',').map(d => d.trim()).filter(d => d);
  }
  
  return result;
}

    // ==================== ä½¿ç”¨è€…ä¸‹æ‹‰é¸å–®åŠŸèƒ½ ====================

/**
 * åˆ‡æ›ä¸‹æ‹‰é¸å–®é¡¯ç¤º/éš±è—
 */
function toggleUserMenu(event) {
  event.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
  
  const menu = document.getElementById('userDropdownMenu');
  
  if (menu.classList.contains('active')) {
    menu.classList.remove('active');
  } else {
    menu.classList.add('active');
  }
}

/**
 * é—œé–‰ä¸‹æ‹‰é¸å–®
 */
function closeUserMenu() {
  const menu = document.getElementById('userDropdownMenu');
  menu.classList.remove('active');
}

/**
 * é»æ“Šé é¢å…¶ä»–åœ°æ–¹æ™‚é—œé–‰é¸å–®
 */
document.addEventListener('click', function(event) {
  const menu = document.getElementById('userDropdownMenu');
  const container = document.querySelector('.user-menu-container');
  
  // å¦‚æœé»æ“Šçš„ä¸æ˜¯é¸å–®æˆ–æŒ‰éˆ•ï¼Œå‰‡é—œé–‰é¸å–®
  if (menu && container && !container.contains(event.target)) {
    menu.classList.remove('active');
  }
});


  </script>
</body>
</html>
