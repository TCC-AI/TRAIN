

<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>昶青集團<br>GAI智能職訓中心</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- ✅ 新增：Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
/* ==================== 全域樣式 ==================== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  /* ✅ 時尚配色系統 */
  --primary-color: #6366f1;      /* 靛藍 */
  --secondary-color: #8b5cf6;    /* 紫色 */
  --accent-color: #ec4899;       /* 粉紅 */
  --success-color: #10b981;      /* 翠綠 */
  --danger-color: #ef4444;       /* 紅色 */
  --warning-color: #f59e0b;      /* 橙色 */
  --info-color: #06b6d4;         /* 青色 */
  
  /* ✅ 中性色系統 */
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;
  
  /* ✅ 文字顏色 */
  --text-primary: #111827;
  --text-secondary: #6b7280;
  --text-tertiary: #9ca3af;
  
  /* ✅ 漸層色 */
  --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --gradient-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  --gradient-info: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
  --gradient-purple: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
  --gradient-orange: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
  --gradient-blue: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
  
  /* ✅ 陰影系統 */
  --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
  --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  
  /* ✅ 彩色陰影 */
  --shadow-primary: 0 10px 30px -5px rgba(99, 102, 241, 0.3);
  --shadow-secondary: 0 10px 30px -5px rgba(139, 92, 246, 0.3);
  --shadow-success: 0 10px 30px -5px rgba(16, 185, 129, 0.3);
  --shadow-danger: 0 10px 30px -5px rgba(239, 68, 68, 0.3);
  --shadow-warning: 0 10px 30px -5px rgba(245, 158, 11, 0.3);
}

/* ✅ 時尚漸層背景 */
body {
  font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  min-height: 100vh;
  color: var(--text-primary);
  
  /* 柔和漸層背景 */
  background: 
    radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.05) 0%, transparent 70%),
    linear-gradient(135deg, #88d66f 0%, #2091f5 100%);
  background-attachment: fixed;
  
  /* 柔和紋理 */
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: 
    repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.03) 10px, rgba(255,255,255,.03) 20px);
  pointer-events: none;
  z-index: 0;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  position: relative;
  z-index: 1;
}

/* ==================== 登入頁面 ==================== */
.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
  position: relative;
  z-index: 1;
}

.login-box {
  background: rgba(255, 255, 255, 0.65);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-radius: 24px;
  padding: 50px;
  width: 100%;
  max-width: 450px;
  animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  
  /* 玻璃擬態效果 */
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.08),
    0 0 0 1px rgba(255, 255, 255, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  
  border: 1px solid rgba(255, 255, 255, 0.3);
  position: relative;
  overflow: hidden;
}

/* 漸層邊框效果 */
.login-box::before {
  content: '';
  position: absolute;
  inset: -2px;
  border-radius: 24px;
  padding: 2px;
  background: var(--gradient-primary);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  opacity: 0.6;
  animation: borderFlow 3s ease-in-out infinite;
  pointer-events: none; /* ✅ 加入這行！讓點擊穿透 */
  z-index: -1; /* ✅ 額外保險：確保在內容下方 */
}

@keyframes borderFlow {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

.login-header {
  text-align: center;
  margin-bottom: 40px;
}

.login-header img {
  width: 80px;
  height: 80px;
  object-fit: contain;
  margin-bottom: 20px;
  display: inline-block;
  animation: iconFloat 3s ease-in-out infinite;
  filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.1));
}


@keyframes iconFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.login-header h1 {
  font-size: 28px;
  color: var(--text-primary);
  margin-bottom: 10px;
  font-weight: 700;
}

.login-header p {
  color: var(--text-secondary);
  font-size: 14px;
}

.form-group {
  margin-bottom: 25px;
}

.form-group label {
  display: block;
  margin-bottom: 10px;
  color: var(--text-primary);
  font-weight: 600;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.form-group label i {
  color: var(--primary-color);
}

.form-group input {
  width: 100%;
  padding: 14px 18px;
  background: rgba(255, 255, 255, 0.8);
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  font-size: 14px;
  color: var(--text-primary);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: inherit;
}

.form-group input:focus {
  outline: none;
  border-color: var(--primary-color);
  background: white;
  box-shadow: 
    0 0 0 4px rgba(99, 102, 241, 0.1),
    var(--shadow-md);
  transform: translateY(-2px);
}

.form-group input::placeholder {
  color: var(--text-tertiary);
}

/* ✅ 時尚按鈕 */
.btn {
  display: inline-block;
  padding: 14px 32px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
  text-decoration: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  font-family: inherit;
}

.btn-primary {
  background: var(--gradient-primary);
  color: white;
  width: 100%;
  box-shadow: var(--shadow-primary);
}

.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 15px 40px -10px rgba(99, 102, 241, 0.5),
    0 0 0 4px rgba(99, 102, 241, 0.1);
}

.btn-primary:active {
  transform: translateY(-1px);
}

/* 按鈕光波效果 */
.btn::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.5);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn:active::after {
  width: 400px;
  height: 400px;
}

.btn-secondary {
  background: var(--gradient-secondary);
  color: white;
  box-shadow: var(--shadow-secondary);
}

.btn-secondary:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 15px 40px -10px rgba(139, 92, 246, 0.5),
    0 0 0 4px rgba(139, 92, 246, 0.1);
}

.btn-success {
  background: var(--gradient-success);
  color: white;
  box-shadow: var(--shadow-success);
}

.btn-success:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 15px 40px -10px rgba(16, 185, 129, 0.5),
    0 0 0 4px rgba(16, 185, 129, 0.1);
}

.btn-danger {
  background: var(--gradient-warning);
  color: white;
  box-shadow: var(--shadow-danger);
}

.btn-danger:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 15px 40px -10px rgba(239, 68, 68, 0.5),
    0 0 0 4px rgba(239, 68, 68, 0.1);
}

.btn-warning {
  background: var(--gradient-orange);
  color: white;
  box-shadow: var(--shadow-warning);
}

.btn-warning:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 15px 40px -10px rgba(245, 158, 11, 0.5),
    0 0 0 4px rgba(245, 158, 11, 0.1);
}

.btn-sm {
  padding: 10px 20px;
  font-size: 13px;
}
/* 修改密碼按鈕樣式 */
.btn-change-password {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.btn-change-password:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
}

/* ==================== 主應用程式 ==================== */
.app-container {
  display: none;
  min-height: 100vh;
  position: relative;
  z-index: 1;
}

.app-container.active {
  display: block;
}

/* ✅ 時尚導航列 */
.navbar {
  padding: 20px 0;
  position: sticky;
  top: 0;
  z-index: 1000;
  
  /* 玻璃擬態效果 */
  background: linear-gradient(135deg, #f7f792 0%, #a9d126 100%);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  
  /* 精緻陰影 */
  box-shadow: 
    0 10px 30px rgba(0, 0, 0, 0.05),
    0 0 0 1px rgba(255, 255, 255, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  
  border-bottom: 1px solid rgba(99, 102, 241, 0.1);
}

.navbar-content {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.navbar-brand {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 30px;
  font-weight: 800;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.navbar-brand i {
  font-size: 32px;
  animation: iconPulse 2s ease-in-out infinite;
}

@keyframes iconPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.navbar-menu {
  display: flex;
  gap: 10px;
  align-items: center;
}

.navbar-item {
  padding: 10px 20px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 500;
  position: relative;
}

.navbar-item:hover {
  background: var(--gray-100);
  color: var(--primary-color);
  transform: translateY(-2px);
}

.navbar-item.active {
  background: var(--gradient-primary);
  color: white;
  box-shadow: var(--shadow-primary);
  font-weight: 600;
}

.navbar-user {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 10px 20px;
  background: var(--gray-50);
  border-radius: 12px;
  border: 1px solid var(--gray-200);
  transition: all 0.3s;
}

.navbar-user:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.navbar-user-info {
  text-align: right;
}

.navbar-user-name {
  font-weight: 600;
  font-size: 14px;
  color: var(--text-primary);
}

.navbar-user-dept {
  font-size: 12px;
  color: var(--text-secondary);
}

.navbar-user-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--gradient-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  box-shadow: var(--shadow-primary);
  animation: avatarGlow 3s ease-in-out infinite;
}

@keyframes avatarGlow {
  0%, 100% { box-shadow: var(--shadow-primary); }
  50% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
}

.btn-logout {
  background: var(--gradient-warning);
  color: white;
  padding: 10px 20px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s;
  box-shadow: var(--shadow-danger);
}

.btn-logout:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 15px 40px -10px rgba(239, 68, 68, 0.5),
    0 0 0 4px rgba(239, 68, 68, 0.1);
}

/* ==================== 主內容區 ==================== */
.main-content {
  max-width: 1400px;
  margin: 30px auto;
  padding: 0 20px;
  position: relative;
  z-index: 1;
}

.page-section {
  display: none;
}

.page-section.active {
  display: block;
  animation: fadeIn 0.4s ease;
}

/* ✅ 玻璃擬態卡片 */
.dashboard-header,
.announcements-section,
.admin-card,
.course-filters,
.player-container,
.exam-container,
.charts-section {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-radius: 20px;
  padding: 30px;
  margin-bottom: 30px;
  
  /* 精緻陰影 */
  box-shadow: 
    0 20px 50px rgba(0, 0, 0, 0.06),
    0 0 0 1px rgba(255, 255, 255, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  
  border: 1px solid rgba(255, 255, 255, 0.3);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.dashboard-header:hover,
.announcements-section:hover,
.admin-card:hover,
.charts-section:hover {
  transform: translateY(-5px);
  box-shadow: 
    0 30px 60px rgba(0, 0, 0, 0.08),
    0 0 0 1px rgba(255, 255, 255, 0.6),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
}

.dashboard-welcome {
  font-size: 32px;
  font-weight: 700;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 10px;
}

.dashboard-subtitle {
  color: var(--text-secondary);
  font-size: 16px;
}

/* ✅ 時尚統計卡片 */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 25px;
  margin-bottom: 30px;
}

.stat-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-radius: 18px;
  padding: 28px;
  display: flex;
  align-items: center;
  gap: 20px;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  
  /* 精緻陰影 */
  box-shadow: 
    0 10px 30px rgba(0, 0, 0, 0.05),
    0 0 0 1px rgba(255, 255, 255, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  
  border: 1px solid rgba(255, 255, 255, 0.3);
  position: relative;
  overflow: hidden;
}

/* 卡片漸層背景 */
.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gradient-primary);
  opacity: 0;
  transition: opacity 0.3s;
}

.stat-card:hover::before {
  opacity: 1;
}

.stat-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 
    0 20px 40px rgba(0, 0, 0, 0.08),
    0 0 0 1px rgba(255, 255, 255, 0.6),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
}

/* 時尚圖示 */
.stat-icon {
  width: 70px;
  height: 70px;
  border-radius: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  color: white;
  position: relative;
  transition: all 0.3s;
}

.stat-card:hover .stat-icon {
  transform: scale(1.1) rotate(5deg);
}

.stat-icon.blue { 
  background: var(--gradient-primary);
  box-shadow: var(--shadow-primary);
}

.stat-icon.green { 
  background: var(--gradient-success);
  box-shadow: var(--shadow-success);
}

.stat-icon.orange { 
  background: var(--gradient-orange);
  box-shadow: var(--shadow-warning);
}

.stat-icon.red { 
  background: var(--gradient-warning);
  box-shadow: var(--shadow-danger);
}

.stat-info {
  flex: 1;
}

.stat-label {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 8px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-value {
  font-size: 36px;
  font-weight: 700;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* ==================== 動畫效果 ==================== */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(0);
  }
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}
    
    /* 公告區塊 */
    .announcements-section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-title i {
      color: var(--primary-color);
    }
    
    .announcement-item {
      padding: 15px;
      border-left: 4px solid var(--primary-color);
      background: var(--light-color);
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .announcement-item.pinned {
      border-left-color: var(--danger-color);
      background: #fef2f2;
    }
    
    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .announcement-time {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .announcement-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      background: var(--danger-color);
      color: white;
    }
    
    .announcement-content {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.6;
    }
    
    /* 課程列表 */
    .course-filters {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    
    .filter-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .filter-group select,
    .filter-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
    }
    
    .courses-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
    }
    
.course-card {
  background: white;
  border-radius: 15px;
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  
  /* ✅ 加強陰影 + 邊框 */
  box-shadow: var(--shadow-md);
  border: 1px solid rgba(37, 99, 235, 0.1);
}

.course-card:hover {
  transform: translateY(-8px);
  box-shadow: var(--shadow-xl);
  border-color: rgba(37, 99, 235, 0.3);
}

/* ✅ 課程卡片 Header 漸層 */
.course-card-header {
  padding: 20px;
  background: var(--gradient-primary);
  color: white;
  position: relative;
  overflow: hidden;
}

/* ✅ 新增：Header 動態光暈 */
.course-card-header::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  animation: rotate 10s linear infinite;
}

@keyframes rotate {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.course-card-header.required {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.course-card-header.completed {
  background: var(--gradient-success);
}

    
    .course-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.3);
      margin-bottom: 10px;
    }
    
    .course-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .course-id {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .course-card-body {
      padding: 20px;
    }
    
    .course-desc {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 15px;
      line-height: 1.6;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .course-meta {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      font-size: 13px;
    }
    
    .course-meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--text-secondary);
    }
    
    .course-meta-item i {
      color: var(--primary-color);
    }
    
    .course-deadline {
      padding: 10px;
      background: var(--light-color);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 15px;
    }
    
    .course-deadline.warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .course-deadline.danger {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .course-actions {
      display: flex;
      gap: 10px;
    }
    
    .course-actions .btn {
      flex: 1;
    }
    
    /* ==================== 課程播放器 ==================== */
    .player-container {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    
    .player-header {
      padding: 25px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .player-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .player-meta {
      display: flex;
      gap: 20px;
      font-size: 14px;
      opacity: 0.9;
    }
    
    .player-body {
      padding: 30px;
    }
    
    .video-wrapper {
      position: relative;
      padding-bottom: 56.25%; /* 16:9 */
      height: 0;
      overflow: hidden;
      background: #000;
      border-radius: 10px;
      margin-bottom: 30px;
    }
    
    .video-wrapper iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .progress-bar {
      background: var(--light-color);
      border-radius: 10px;
      height: 30px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }
    
    .course-description {
      background: var(--light-color);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .course-description h3 {
      font-size: 16px;
      margin-bottom: 10px;
      color: var(--text-primary);
    }
    
    .course-description p {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    /* ==================== 測驗頁面 ==================== */
    .exam-container {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: var(--shadow);
      max-width: 800px;
      margin: 0 auto;
    }
    
    .exam-header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
    }
    
    .exam-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
    }
    
    .exam-info {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .question-card {
      background: var(--light-color);
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 25px;
    }
    
    .question-number {
      display: inline-block;
      background: var(--primary-color);
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .question-text {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .options-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .option-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .option-item:hover {
      border-color: var(--primary-color);
      background: #eff6ff;
    }
    
    .option-item input[type="radio"] {
      margin-right: 12px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .option-item label {
      flex: 1;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-primary);
    }
    
    .option-item.correct {
      border-color: var(--success-color);
      background: #f0fdf4;
    }
    
    .option-item.incorrect {
      border-color: var(--danger-color);
      background: #fef2f2;
    }
    
    .exam-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }
    
    /* 測驗結果 */
    .exam-result {
      text-align: center;
      padding: 40px;
    }
    
    .result-icon {
      font-size: 80px;
      margin-bottom: 20px;
    }
    
    .result-icon.pass {
      color: var(--success-color);
    }
    
    .result-icon.fail {
      color: var(--danger-color);
    }
    
    .result-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .result-score {
      font-size: 48px;
      font-weight: 700;
      color: var(--primary-color);
      margin: 20px 0;
    }
    
    .result-details {
      background: var(--light-color);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }
    
    .result-detail-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .result-detail-item:last-child {
      border-bottom: none;
    }
    /* ==================== Sophia學習沙龍樣式 ==================== */

.sophia-header {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  border-radius: 20px;
  padding: 30px;
  margin-bottom: 30px;
  box-shadow: var(--shadow-lg);
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.sophia-filters {
  display: flex;
  gap: 15px;
  margin-top: 20px;
  flex-wrap: wrap;
  align-items: flex-end;
}

#customDateRange {
  display: flex;
  gap: 10px;
}

.sophia-dashboard {
  display: flex;
  flex-direction: column;
  gap: 30px;
}

.sophia-section {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  border-radius: 20px;
  padding: 30px;
  box-shadow: var(--shadow-lg);
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.sophia-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.sophia-card {
  background: white;
  border-radius: 15px;
  overflow: hidden;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--gray-200);
  transition: all 0.3s;
}

.sophia-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-xl);
}

.sophia-card .card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: var(--gradient-primary);
  color: white;
}

.sophia-card .card-header h3 {
  font-size: 16px;
  font-weight: 600;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sophia-card .card-badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  background: rgba(255, 255, 255, 0.3);
}

.sophia-card .card-body {
  padding: 20px;
}

/* 停留時間分析 */
.time-stats {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.time-stat-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  background: var(--gray-50);
  border-radius: 10px;
  transition: all 0.3s;
}

.time-stat-item:hover {
  background: var(--gray-100);
  transform: translateX(5px);
}

.time-stat-item .stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 20px;
}

.time-stat-item .stat-info {
  flex: 1;
}

.time-stat-item .stat-label {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 5px;
}

.time-stat-item .stat-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--text-primary);
}

/* 排行榜標籤 */
.ranking-tabs {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  background: white;
  padding: 5px;
  border-radius: 10px;
  box-shadow: var(--shadow-sm);
}

.ranking-tab {
  flex: 1;
  padding: 10px 20px;
  border: none;
  background: transparent;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  transition: all 0.3s;
}

.ranking-tab:hover {
  background: var(--gray-100);
}

.ranking-tab.active {
  background: var(--gradient-primary);
  color: white;
}

/* 排行榜列表 */
.ranking-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.ranking-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 12px;
  background: var(--gray-50);
  border-radius: 8px;
  transition: all 0.3s;
}

.ranking-item:hover {
  background: var(--gray-100);
  transform: translateX(5px);
}

.ranking-item .rank {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 14px;
  color: white;
}

.ranking-item .rank.top1 {
  background: linear-gradient(135deg, #FFD700, #FFA500);
}

.ranking-item .rank.top2 {
  background: linear-gradient(135deg, #C0C0C0, #808080);
}

.ranking-item .rank.top3 {
  background: linear-gradient(135deg, #CD7F32, #8B4513);
}

.ranking-item .rank.other {
  background: var(--gray-400);
}

.ranking-item .course-name {
  flex: 1;
  font-size: 14px;
  color: var(--text-primary);
  font-weight: 500;
}

.ranking-item .value {
  font-size: 16px;
  font-weight: 700;
  color: var(--primary-color);
}

/* 學習成效報表 */
.report-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
}

.report-stat-item {
  display: flex;
  flex-direction: column;
  gap: 5px;
  padding: 15px;
  background: var(--gray-50);
  border-radius: 8px;
}

.report-stat-item .stat-label {
  font-size: 12px;
  color: var(--text-secondary);
}

.report-stat-item .stat-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
}

.comparison-badge {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  background: rgba(255, 255, 255, 0.3);
}

.comparison-badge.positive {
  background: rgba(16, 185, 129, 0.2);
  color: #059669;
}

.comparison-badge.negative {
  background: rgba(239, 68, 68, 0.2);
  color: #dc2626;
}

/* 學習建議 */
.advice-container {
  padding: 20px;
  background: var(--gray-50);
  border-radius: 10px;
  min-height: 150px;
}

.loading-advice {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  color: var(--text-secondary);
  font-size: 14px;
}

.advice-content {
  line-height: 1.8;
  color: var(--text-primary);
}

.advice-content h4 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--primary-color);
}

.advice-content ul {
  margin-left: 20px;
  margin-top: 10px;
}

.advice-content li {
  margin-bottom: 8px;
}

/* 成就系統 */
.achievements-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.achievement-badge {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  padding: 20px;
  background: white;
  border-radius: 15px;
  box-shadow: var(--shadow-md);
  border: 2px solid transparent;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.achievement-badge.unlocked {
  border-color: var(--success-color);
}

.achievement-badge.locked {
  opacity: 0.5;
  filter: grayscale(100%);
}

.achievement-badge:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-xl);
}

.achievement-badge .badge-icon {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  color: white;
  background: var(--gradient-primary);
}

.achievement-badge .badge-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  text-align: center;
}

.achievement-badge .badge-desc {
  font-size: 12px;
  color: var(--text-secondary);
  text-align: center;
}

.achievement-badge .unlock-date {
  font-size: 11px;
  color: var(--success-color);
  margin-top: 5px;
}

/* 響應式設計 */
@media (max-width: 768px) {
  .sophia-grid {
    grid-template-columns: 1fr;
  }
  
  .sophia-filters {
    flex-direction: column;
    align-items: stretch;
  }
  
  #customDateRange {
    flex-direction: column;
  }
  
  .ranking-tabs {
    flex-direction: column;
  }
  
  .report-stats {
    grid-template-columns: 1fr;
  }
  
  .achievements-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  }
}

    /* ==================== 管理後台 ==================== */
    .admin-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      background: white;
      padding: 10px;
      border-radius: 15px;
      box-shadow: var(--shadow);
    }
    
    .admin-tab {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: transparent;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.3s;
    }
    
    .admin-tab:hover {
      background: var(--light-color);
    }
    
    .admin-tab.active {
      background: var(--primary-color);
      color: white;
    }
    
    .admin-panel {
      display: none;
    }
    
    .admin-panel.active {
      display: block;
    }
    
    .admin-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }
    
    .admin-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
    }
    
    .admin-card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    /* 表格 */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .data-table thead {
      background: var(--light-color);
    }
    
    .data-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
    }
    
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-secondary);
    }
    
    .data-table tbody tr:hover {
      background: var(--light-color);
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .status-badge.active {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-badge.inactive {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .status-badge.pass {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-badge.fail {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .btn-icon {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }
    
    .btn-icon i {
      pointer-events: none;
    }
    
    /* ==================== Modal ==================== */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  justify-content: center;
  align-items: center;
  padding: 20px;
  
  /* ✅ 玻璃擬態背景 */
  background: rgba(37, 99, 235, 0.1);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

.modal-content {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.3s ease;
  
  /* ✅ 加強陰影 */
  box-shadow: var(--shadow-xl);
  border: 1px solid rgba(37, 99, 235, 0.2);
}

    
    .modal.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
   
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }
    
    .modal-close:hover {
      background: var(--light-color);
      color: var(--text-primary);
    }
    
    .modal-body {
      margin-bottom: 20px;
    }
    
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
/* ==================== Loading & Alert ==================== */
.loading {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent; /* ✅ 移除灰色遮罩 */
  z-index: 99999;
  justify-content: center;
  align-items: center;
  pointer-events: none; /* ✅ 允許點擊穿透 */
}

.loading.active {
  display: flex;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  
  /* ✅ 藍綠漸層邊框 */
  border: 5px solid transparent;
  border-top: 5px solid #2563eb;
  border-right: 5px solid #10b981;
  box-shadow: 
    0 0 20px rgba(37, 99, 235, 0.5),
    0 0 40px rgba(16, 185, 129, 0.3);
}


.alert {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 10px;
  box-shadow: var(--shadow-lg);
  z-index: 10000;
  display: none;
  animation: slideInRight 0.3s ease;
  max-width: 400px;
}

.alert.active {
  display: block;
}

.alert-success {
  background: var(--success-color);
  color: white;
}

.alert-error {
  background: var(--danger-color);
  color: white;
}

.alert-warning {
  background: var(--warning-color);
  color: white;
}

.alert-info {
  background: var(--info-color);
  color: white;
}

    
 
    
    /* ==================== Responsive ==================== */
    @media (max-width: 768px) {
      .navbar-menu {
        display: none;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .courses-grid {
        grid-template-columns: 1fr;
      }
      
      .filter-row {
        flex-direction: column;
      }
      
      .filter-group {
        width: 100%;
      }
      
      .admin-tabs {
        flex-direction: column;
      }
      
      .data-table {
        font-size: 12px;
      }
      
      .data-table th,
      .data-table td {
        padding: 8px;
      }
    }
    /* ==================== 學習紀錄收折樣式 ==================== */

/* 收折按鈕容器 */
#learningRecordToggleRow td {
  border-bottom: none !important;
}

/* 收折按鈕 */
#btnToggleLearningRecords {
  padding: 10px 25px;
  font-size: 14px;
  border-radius: 8px;
  transition: all 0.3s;
  cursor: pointer;
}

#btnToggleLearningRecords:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

/* 隱藏的紀錄行動畫 */
.learning-record-hidden {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

    
    /* ==================== Utility Classes ==================== */
    .hidden {
      display: none !important;
    }
    
    .text-center {
      text-align: center;
    }
    
    .text-right {
      text-align: right;
    }
    
    .mt-10 { margin-top: 10px; }
    .mt-20 { margin-top: 20px; }
    .mt-30 { margin-top: 30px; }
    
    .mb-10 { margin-bottom: 10px; }
    .mb-20 { margin-bottom: 20px; }
    .mb-30 { margin-bottom: 30px; }
    
    .p-10 { padding: 10px; }
    .p-20 { padding: 20px; }
    .p-30 { padding: 30px; }

    /* ==================== 錯誤題目檢討樣式 ==================== */
.wrong-answer-item {
  background: #fff;
  border: 2px solid var(--border-color);
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  transition: all 0.3s;
}

.wrong-answer-item:hover {
  box-shadow: var(--shadow-lg);
  border-color: var(--danger-color);
}

.wrong-answer-item .question-number {
  display: inline-block;
  background: var(--danger-color);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 10px;
}

.wrong-answer-item .question-text {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 15px;
  line-height: 1.6;
}

.wrong-answer-item .answer-row {
  display: flex;
  align-items: center;
  padding: 10px 15px;
  border-radius: 8px;
  margin-bottom: 8px;
  font-size: 14px;
}

.wrong-answer-item .answer-row.your-answer {
  background: #fee2e2;
  border-left: 4px solid var(--danger-color);
}

.wrong-answer-item .answer-row.correct-answer {
  background: #d1fae5;
  border-left: 4px solid var(--success-color);
}

.wrong-answer-item .answer-label {
  font-weight: 600;
  margin-right: 10px;
  min-width: 100px;
}

.wrong-answer-item .answer-label.wrong {
  color: var(--danger-color);
}

.wrong-answer-item .answer-label.correct {
  color: var(--success-color);
}

.wrong-answer-item .answer-value {
  flex: 1;
  color: var(--text-primary);
}

.wrong-answer-item .answer-icon {
  font-size: 18px;
  margin-left: 10px;
}

.wrong-answer-item .answer-icon.wrong {
  color: var(--danger-color);
}

.wrong-answer-item .answer-icon.correct {
  color: var(--success-color);
}
    /* ==================== 學習進度圖表樣式 ==================== */
.charts-section {
  background: white;
  border-radius: 15px;
  padding: 25px;
  margin-bottom: 30px;
  box-shadow: var(--shadow);
}

.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 30px;
  margin-top: 20px;
}

.chart-container {
  background: var(--light-color);
  border-radius: 10px;
  padding: 20px;
  min-height: 300px;
}

.chart-container.full-width {
  grid-column: 1 / -1;
}

.chart-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.chart-title i {
  color: var(--primary-color);
}

.chart-canvas {
  position: relative;
  height: 250px;
}

.chart-canvas canvas {
  max-height: 250px;
}

.chart-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.chart-stat-item {
  background: white;
  border-radius: 8px;
  padding: 15px;
  text-align: center;
}

.chart-stat-label {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 5px;
}

.chart-stat-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--primary-color);
}

.chart-stat-value.success {
  color: var(--success-color);
}

.chart-stat-value.warning {
  color: var(--warning-color);
}

.chart-stat-value.danger {
  color: var(--danger-color);
}

/* ==================== 響應式設計 ==================== */
@media (max-width: 768px) {
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  .chart-container.full-width {
    grid-column: 1;
  }
}

    /* ==================== 手機版優化 ==================== */

/* 平板 (768px - 1024px) */
@media (max-width: 1024px) {
  .navbar-menu {
    gap: 10px;
  }
  
  .navbar-item {
    padding: 6px 12px;
    font-size: 13px;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  .courses-grid {
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  }
}

/* 手機 (最大 768px) */
@media (max-width: 768px) {
  /* 導航列 */
  .navbar-content {
    flex-direction: column;
    gap: 15px;
  }
  
  .navbar-brand {
    font-size: 22px;
  }
  
  .navbar-menu {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    width: 100%;
  }
  
  .navbar-item {
    flex: 1;
    min-width: 80px;
    text-align: center;
    padding: 8px 10px;
    font-size: 12px;
  }
  
  .navbar-user {
    width: 100%;
    justify-content: space-between;
    padding: 10px;
  }
  
  .navbar-user-info {
    text-align: left;
  }
/* 手機 (最大 768px) */
@media (max-width: 768px) {
  /* 調整歡迎圖片大小 */
  .dashboard-header img {
    max-height: 120px !important; /* 縮小到 120px */
  }
  
  /* 調整文字區塊 */
  .dashboard-header {
    flex-direction: column !important;
    text-align: center; /* 文字置中 */
  }
}



  
  /* 儀錶板 */
  .dashboard-header {
    padding: 20px;
  }
  
  .dashboard-welcome {
    font-size: 20px;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .stat-card {
    padding: 20px;
  }
  
  .stat-icon {
    width: 50px;
    height: 50px;
    font-size: 24px;
  }
  
  .stat-value {
    font-size: 24px;
  }
  
  /* 圖表 */
  .charts-section {
    padding: 20px;
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .chart-container {
    padding: 15px;
  }
  
  .chart-canvas {
    height: 200px !important;
  }
  
  .chart-title {
    font-size: 14px;
  }
  
  .chart-stats {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  .chart-stat-item {
    padding: 12px;
  }
  
  .chart-stat-value {
    font-size: 20px;
  }
  
  /* 課程列表 */
  .courses-grid {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .course-card-header {
    padding: 15px;
  }
  
  .course-title {
    font-size: 16px;
  }
  
  .course-card-body {
    padding: 15px;
  }
  
  /* 課程篩選 */
  .filter-row {
    flex-direction: column;
    gap: 10px;
  }
  
  .filter-group {
    width: 100%;
    min-width: auto;
  }
  
  /* 播放器 */
  .player-header {
    padding: 20px;
  }
  
  .player-title {
    font-size: 20px;
  }
  
  .player-meta {
    flex-direction: column;
    gap: 10px;
    font-size: 13px;
  }
  
  .player-body {
    padding: 20px;
  }
  
  #videoTimeInfo {
    padding: 15px;
  }
  
  #videoTimeInfo > div {
    grid-template-columns: 1fr !important;
    gap: 10px;
  }
  
  /* 測驗 */
  .exam-container {
    padding: 20px;
  }
  
  .exam-title {
    font-size: 20px;
  }
  
  .question-card {
    padding: 20px;
  }
  
  .question-text {
    font-size: 15px;
  }
  
  .option-item {
    padding: 12px;
  }
  
  /* 管理後台 */
  .admin-tabs {
    flex-direction: column;
    padding: 5px;
  }
  
  .admin-tab {
    padding: 10px;
    font-size: 13px;
  }
  
  .data-table {
    font-size: 12px;
    display: block;
    overflow-x: auto;
  }
  
  .data-table th,
  .data-table td {
    padding: 8px;
    white-space: nowrap;
  }
  
  /* Modal */
  .modal-content {
    padding: 20px;
    max-width: 95%;
  }
  
  .modal-title {
    font-size: 18px;
  }
  
  /* 按鈕 */
  .btn {
    padding: 10px 20px;
    font-size: 13px;
  }
  
  .course-actions {
    flex-direction: column;
  }
  
  .course-actions .btn {
    width: 100%;
  }
  
  .exam-actions {
    flex-direction: column;
  }
  
  .exam-actions .btn {
    width: 100%;
  }
}

/* 小手機 (最大 480px) */
@media (max-width: 480px) {
  .navbar-brand {
    font-size: 16px;
  }
  
  .navbar-brand i {
    font-size: 24px;
  }
  
  .navbar-item {
    font-size: 11px;
    padding: 6px 8px;
  }
  
  .dashboard-welcome {
    font-size: 18px;
  }
  
  .stat-value {
    font-size: 20px;
  }
  
  .chart-canvas {
    height: 180px !important;
  }
  
  .course-title {
    font-size: 15px;
  }
  
  .player-title {
    font-size: 18px;
  }
  
  .exam-title {
    font-size: 18px;
  }
  
  .modal-content {
    padding: 15px;
  }
}

/* ✅ 橫向模式優化 */
@media (max-width: 768px) and (orientation: landscape) {
  .video-wrapper {
    padding-bottom: 45% !important;
  }
  
  .chart-canvas {
    height: 150px !important;
  }
}
/* ✅ 新增：平滑過渡動畫 */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(0);
  }
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* ✅ 新增：波浪動畫 */
@keyframes wave {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-10px);
  }
}

/* ✅ 新增：脈衝動畫 */
@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

    /* ==================== 使用者下拉選單樣式 ==================== */

/* 選單容器 */
.user-menu-container {
  position: relative;
}

/* 下拉選單 */
.user-dropdown-menu {
  position: absolute;
  top: calc(100% + 10px);
  right: 0;
  min-width: 200px;
  background: white;
  border-radius: 12px;
  box-shadow: 
    0 10px 30px rgba(0, 0, 0, 0.15),
    0 0 0 1px rgba(0, 0, 0, 0.05);
  padding: 8px;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 10000;
}

/* 顯示狀態 */
.user-dropdown-menu.active {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

/* 選單項目 */
.dropdown-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--text-primary);
  font-size: 14px;
  font-weight: 500;
}

.dropdown-item:hover {
  background: var(--gray-100);
  color: var(--primary-color);
  transform: translateX(5px);
}

.dropdown-item i {
  font-size: 16px;
  width: 20px;
  text-align: center;
  color: var(--primary-color);
}

/* 分隔線 */
.dropdown-divider {
  height: 1px;
  background: var(--gray-200);
  margin: 8px 0;
}

/* 登出按鈕調整 */
.btn-logout {
  display: flex;
  align-items: center;
  gap: 5px;
}

/* 手機版優化 */
@media (max-width: 768px) {
  .user-dropdown-menu {
    min-width: 180px;
    right: -10px;
  }
  
  .dropdown-item {
    padding: 10px 14px;
    font-size: 13px;
  }
}


  </style>
</head>
<body>

  <!-- Loading 動畫 -->
  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
  </div>

  <!-- Alert 通知 -->
  <div id="alert" class="alert"></div>

  <!-- ==================== 登入頁面 ==================== -->
  <div id="loginPage" class="login-container">
    <div class="login-box">
      <div class="login-header">
  <img src="R0.png" alt="Logo" style="width: 80px; height: 80px; object-fit: contain; margin-bottom: 20px;">
  <h1>昶青集團<br>GAI智能職訓中心</h1>
  <p>請使用您的工號和密碼登入</p>
</div>

      
      <form id="loginForm">
        <div class="form-group">
          <label for="empId">
            <i class="fas fa-user"></i> 工號
          </label>
          <input type="text" id="empId" placeholder="請輸入工號" required>
        </div>
        
        <div class="form-group">
          <label for="password">
            <i class="fas fa-lock"></i> 密碼
          </label>
          <input type="password" id="password" placeholder="請輸入密碼" required>
        </div>
        
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-sign-in-alt"></i> 登入
        </button>
      </form>
    </div>
  </div>

  <!-- ==================== 主應用程式 ==================== -->
  <div id="appContainer" class="app-container">
    
    <!-- 頂部導航列 -->
    <nav class="navbar">
      <div class="navbar-content">
        <div class="navbar-brand">
  <img src="R0.png" alt="Logo" style="width: 80px; height: 80px; object-fit: contain; margin-right: 10px;">
  <span>昶青集團<br>GAI智能職訓中心</span>
</div>

        
        <div class="navbar-menu">
          <div class="navbar-item active" data-page="dashboard">
            <i class="fas fa-home"></i> 首頁
          </div>
          <div class="navbar-item" data-page="courses">
            <i class="fas fa-book"></i> 課程
          </div>
          <div class="navbar-item" data-page="mylearning">
            <i class="fas fa-chart-line"></i> 我的學習
          </div>
          <div class="navbar-item" data-page="sophia">
            <i class="fas fa-chart-pie"></i> Sophia的AI學習沙龍
          </div>

          <div class="navbar-item admin-only hidden" data-page="admin">
            <i class="fas fa-cog"></i> 管理後台
          </div>
        </div>
        
<div class="navbar-user">
  <div class="navbar-user-info">
    <div class="navbar-user-name" id="userName">使用者</div>
    <div class="navbar-user-dept" id="userDept">部門</div>
  </div>
  <div class="navbar-user-avatar" id="userAvatar">U</div>
  
  <!-- ✅ 新增：下拉選單容器 -->
  <div class="user-menu-container">
    <button class="btn-logout" onclick="toggleUserMenu(event)">
      <i class="fas fa-sign-out-alt"></i> 登出
      <i class="fas fa-chevron-down" style="margin-left: 5px; font-size: 12px;"></i>
    </button>
    
    <!-- ✅ 下拉選單 -->
    <div id="userDropdownMenu" class="user-dropdown-menu">
      <div class="dropdown-item" onclick="showChangePasswordModal(); closeUserMenu();">
        <i class="fas fa-key"></i>
        <span>修改密碼</span>
      </div>
      <div class="dropdown-divider"></div>
      <div class="dropdown-item" onclick="logout(); closeUserMenu();">
        <i class="fas fa-sign-out-alt"></i>
        <span>登出</span>
      </div>
    </div>
  </div>
</div>


      </div>
    </nav>

    <!-- 主內容區 -->
    <div class="main-content">
      
      <!-- ==================== 儀錶板頁面 ==================== -->
 <div id="dashboardPage" class="page-section active">
  <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
    <!-- ✅ 文字區塊（在左側空間中置中） -->
    <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;">
      <h1 class="dashboard-welcome">嗨~歡迎回來,<span id="welcomeName"></span>!</h1>
      <p class="dashboard-subtitle">繼續您的昶青學習旅程</p>
    </div>
    
    <!-- ✅ 圖片 + 文字容器（保持在右側） -->
    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; flex-shrink: 0;">
      <img src="R1.png" alt="Welcome" style="max-height: 200px; width: auto; object-fit: contain;">
      <div style="text-align: center; font-size: 14px; color: #6b7280; line-height: 1.5;">
        昶青集團<br>GAI智能職訓中心-數位主任<br>Sophia
      </div>
    </div>
  </div>




        <button class="btn btn-secondary btn-sm" onclick="refreshDashboard()" title="重新整理">
    <i class="fas fa-sync-alt"></i> 重新整理
  </button>
        <!-- 統計卡片 -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon blue">
              <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">累積點數</div>
              <div class="stat-value" id="totalPoints">0</div>
            </div>
          </div>
          
          
          <div class="stat-card">
            <div class="stat-icon green">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">已完成課程</div>
              <div class="stat-value" id="completedCount">0</div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon orange">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">進行中課程</div>
              <div class="stat-value" id="inProgressCount">0</div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon red">
              <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">待完成必修</div>
              <div class="stat-value" id="requiredCount">0</div>
            </div>
          </div>
        </div>
        
        <!-- 公告區塊 -->
        <div class="announcements-section">
          <h2 class="section-title">
            <i class="fas fa-bullhorn"></i>
            最新公告
          </h2>
          <div id="announcementsList"></div>
        </div>
         <!-- ✅ 新增：學習進度圖表 -->
<div class="charts-section">
  <h2 class="section-title">
    <i class="fas fa-chart-line"></i>
    學習進度分析
  </h2>
  
  <div class="charts-grid">
    <!-- 每月完成課程數 -->
    <div class="chart-container">
      <div class="chart-title">
        <i class="fas fa-calendar-check"></i>
        每月完成課程數
      </div>
      <div class="chart-canvas">
        <canvas id="monthlyCoursesChart"></canvas>
      </div>
    </div>
    
    <!-- 累積點數趨勢 -->
    <div class="chart-container">
      <div class="chart-title">
        <i class="fas fa-trophy"></i>
        累積點數趨勢
      </div>
      <div class="chart-canvas">
        <canvas id="pointsTrendChart"></canvas>
      </div>
    </div>
    
    <!-- 部門完成率統計 -->
    <div class="chart-container full-width">
      <div class="chart-title">
        <i class="fas fa-building"></i>
        部門完成率統計
      </div>
      <div class="chart-canvas" style="height: 300px;">
        <canvas id="departmentStatsChart"></canvas>
      </div>
      <div class="chart-stats">
        <div class="chart-stat-item">
          <div class="chart-stat-label">平均完成率</div>
          <div class="chart-stat-value" id="avgCompletionRate">0%</div>
        </div>
        <div class="chart-stat-item">
          <div class="chart-stat-label">最高完成率</div>
          <div class="chart-stat-value success" id="maxCompletionRate">0%</div>
        </div>
        <div class="chart-stat-item">
          <div class="chart-stat-label">最低完成率</div>
          <div class="chart-stat-value danger" id="minCompletionRate">0%</div>
        </div>
      </div>
    </div>
  </div>
</div>
        
        <!-- 待完成必修課程 -->
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">
              <i class="fas fa-exclamation-triangle"></i> 待完成必修課程
            </h3>
          </div>
          <div id="requiredCoursesList"></div>
        </div>
        
        <!-- 進行中的課程 -->
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">
              <i class="fas fa-play-circle"></i> 進行中的課程
            </h3>
          </div>
          <div id="inProgressCoursesList"></div>
        </div>
        
      </div>

     

      <!-- ==================== 課程瀏覽頁面 ==================== -->
      <div id="coursesPage" class="page-section">
        <!-- 篩選器 -->
        <div class="course-filters">
          <div class="filter-row">
             <div class="form-group">
            <label>課群 *</label>
            <select id="filterCourseGroup">
              <option value="">請選擇</option>
              <!-- 動態載入選項 -->
            </select>
          </div>
            
            <div class="form-group">
            <label>課門 *</label>
             <select id="filterCourseCategory">
              <option value="">請選擇</option>
              <!-- 動態載入選項 -->
            </select>
          </div>
            
            <div class="filter-group">
              <label>課程類型</label>
              <select id="filterCourseType">
                <option value="">全部</option>
                <option value="required">必修</option>
                <option value="optional">選修</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>狀態</label>
              <select id="filterStatus">
                <option value="">全部</option>
                <option value="notStarted">未開始</option>
                <option value="inProgress">進行中</option>
                <option value="completed">已完成</option>
              </select>
            </div>
            
            <div class="filter-group" style="display: flex; align-items: flex-end;">
              <button class="btn btn-primary" onclick="applyCourseFilters()">
                <i class="fas fa-search"></i> 搜尋
              </button>
            </div>
          </div>
        </div>
        
        <!-- 課程列表 -->
        <div id="coursesList" class="courses-grid"></div>
      </div>

      <!-- ==================== 課程播放頁面 ==================== -->
      <div id="playerPage" class="page-section">
        <div class="player-container">
          <div class="player-header">
            <h1 class="player-title" id="playerCourseTitle">課程名稱</h1>
            <div class="player-meta">
              <span><i class="fas fa-tag"></i> <span id="playerCourseId"></span></span>
              <span><i class="fas fa-star"></i> <span id="playerCoursePoints"></span> 點</span>
              <span><i class="fas fa-calendar"></i> 截止日期: <span id="playerDeadline"></span></span>
            </div>
          </div>
          
          <div class="player-body">
          <!-- 影片播放器 -->
          <div class="video-wrapper" id="videoWrapper">
            <iframe id="videoPlayer" 
                    src="" 
                    frameborder="0" 
                    allow="autoplay; encrypted-media" 
                    allowfullscreen>
            </iframe>
          </div>
          
          <!-- ✅ 新增：開始播放按鈕 -->
<div id="videoControlPanel" style="margin-top: 15px; text-align: center;">
  <button id="btnStartWatching" class="btn btn-primary" style="padding: 10px 30px; font-size: 16px;">
    ▶️ 開始播放並計時
  </button>
  <div id="videoStatus" style="margin-top: 10px; color: #666; font-size: 14px;">
    請點擊上方按鈕開始觀看影片
  </div>
</div>

<!-- ✅ 新增：時間資訊顯示區塊 -->
<div id="videoTimeInfo" style="margin-top: 20px; background: #f8f9fa; border-radius: 10px; padding: 20px; display: none;">
  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
    <!-- 影片總長度 -->
    <div style="text-align: center;">
      <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">
        <i class="fas fa-video"></i> 影片總長度
      </div>
      <div id="totalDuration" style="font-size: 24px; font-weight: 700; color: #2563eb;">
        0:00
      </div>
    </div>
    
    <!-- 已觀看時間 -->
    <div style="text-align: center;">
      <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">
        <i class="fas fa-clock"></i> 已觀看時間
      </div>
      <div id="watchedTime" style="font-size: 24px; font-weight: 700; color: #10b981;">
        0:00
      </div>
    </div>
    
    <!-- 剩餘時間 -->
    <div style="text-align: center;">
      <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">
        <i class="fas fa-hourglass-half"></i> 剩餘時間
      </div>
      <div id="remainingTime" style="font-size: 24px; font-weight: 700; color: #f59e0b;">
        0:00
      </div>
    </div>
  </div>
  
  <!-- 進度百分比 -->
  <div style="margin-top: 15px; text-align: center; font-size: 14px; color: #6b7280;">
    已完成 <span id="progressPercent" style="font-weight: 700; color: #2563eb;">0%</span>
  </div>
</div>


            
            <!-- 進度條 -->
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width: 0%">
                0%
              </div>
            </div>
            
            <!-- 課程說明 -->
            <div class="course-description">
              <h3><i class="fas fa-info-circle"></i> 課程說明</h3>
              <p id="playerCourseDesc"></p>
            </div>
            
            <!-- 操作按鈕 -->
            <div class="course-actions">
              <button class="btn btn-secondary" onclick="backToCourses()">
                <i class="fas fa-arrow-left"></i> 返回課程列表
              </button>
              <button class="btn btn-success" id="btnStartExam" onclick="startExam()" disabled>
                <i class="fas fa-pencil-alt"></i> 開始測驗
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== 測驗頁面 ==================== -->
      <div id="examPage" class="page-section">
        <div class="exam-container">
          <div class="exam-header">
            <h1 class="exam-title" id="examCourseTitle">課程測驗</h1>
            <p class="exam-info">
              請仔細閱讀每個題目,選擇正確答案。及格分數: <strong id="examPassScore">60</strong> 分
            </p>
          </div>
          
          <div id="examQuestions"></div>
          
          <div class="exam-actions">
            <button class="btn btn-secondary" onclick="backToPlayer()">
              <i class="fas fa-arrow-left"></i> 返回課程
            </button>
            <button class="btn btn-primary" onclick="submitExam()">
              <i class="fas fa-check"></i> 提交測驗
            </button>
          </div>
        </div>
      </div>

      <!-- ==================== 我的學習頁面 ==================== -->
      <div id="mylearningPage" class="page-section">
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">
              <i class="fas fa-history"></i> 學習紀錄
            </h3>
          </div>
          
          <table class="data-table">
            <thead>
              <tr>
                <th>課程名稱</th>
                <th>開始時間</th>
                <th>完成時間</th>
                <th>測驗分數</th>
                <th>獲得點數</th>
                <th>狀態</th>
              </tr>
            </thead>
            <tbody id="myLearningRecords">
              <tr>
                <td colspan="6" class="text-center">載入中...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">
              <i class="fas fa-coins"></i> 點數紀錄
            </h3>
          </div>
          
          <table class="data-table">
            <thead>
              <tr>
                <th>課程名稱</th>
                <th>獲得點數</th>
                <th>獲得時間</th>
              </tr>
            </thead>
            <tbody id="myPointRecords">
              <tr>
                <td colspan="3" class="text-center">載入中...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ==================== Sophia學習沙龍頁面 ==================== -->
<div id="sophiaPage" class="page-section">
  
  <!-- 頁面標題 -->
  <div class="sophia-header">
    <div style="display: flex; align-items: center; gap: 20px;">
      <img src="R1.png" alt="Sophia" style="width: 80px; height: 80px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
      <div>
        <h1 style="font-size: 32px; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px;">
          Sophia 學習沙龍 📊
        </h1>
        <p style="color: var(--text-secondary); font-size: 16px;">
          深入分析您的學習數據，發現成長軌跡
        </p>
      </div>
    </div>
    
    <!-- 時間範圍篩選器 -->
    <div class="sophia-filters">
      <div class="filter-group">
        <label><i class="fas fa-calendar-alt"></i> 時間範圍</label>
        <select id="sophiaTimeRange" onchange="loadSophiaData()">
          <option value="3months">最近 3 個月</option>
          <option value="1month">最近 1 個月</option>
          <option value="6months">最近 6 個月</option>
          <option value="1year">最近 1 年</option>
          <option value="custom">自訂範圍</option>
        </select>
      </div>
      
      <!-- 自訂時間範圍 -->
      <div id="customDateRange" style="display: none; gap: 10px;">
        <div class="filter-group">
          <label>開始日期</label>
          <input type="date" id="sophiaStartDate">
        </div>
        <div class="filter-group">
          <label>結束日期</label>
          <input type="date" id="sophiaEndDate">
        </div>
        <button class="btn btn-primary btn-sm" onclick="loadSophiaData()">
          <i class="fas fa-search"></i> 查詢
        </button>
      </div>
      
      <button class="btn btn-secondary btn-sm" onclick="loadSophiaData()" title="重新整理">
        <i class="fas fa-sync-alt"></i> 重新整理
      </button>
    </div>
  </div>
  
  <!-- 儀錶板容器 -->
  <div class="sophia-dashboard">
    
   <!-- 第零排：學習建議 -->
    <div class="sophia-section">
      <h2 class="section-title">
        <i class="fas fa-lightbulb"></i> Sophia 的職訓建議
      </h2>
      
      <div class="sophia-card">
        <div class="card-body">
          <div id="learningAdvice" class="advice-container">
            <div class="loading-advice">
              <i class="fas fa-spinner fa-spin"></i> Sophia 正在分析您的學習數據...
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 第一排：個人學習行為分析 -->
    <div class="sophia-section">
      <h2 class="section-title">
        <i class="fas fa-user-chart"></i> 個人學習行為分析
      </h2>
      
      <div class="sophia-grid">
        <!-- 觀看時段分析 -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-clock"></i> 觀看時段分析</h3>
            <span class="card-badge">趨勢</span>
          </div>
          <div class="card-body">
            <canvas id="watchTimeChart"></canvas>
          </div>
        </div>
        
        <!-- 停留時間分析 -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-hourglass-half"></i> 停留時間分析</h3>
            <span class="card-badge">統計</span>
          </div>
          <div class="card-body">
            <div class="time-stats">
              <div class="time-stat-item">
                <div class="stat-icon" style="background: var(--gradient-primary);">
                  <i class="fas fa-play"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-label">總停留時間</div>
                  <div class="stat-value" id="totalStayTime">0 小時</div>
                </div>
              </div>
              
              <div class="time-stat-item">
                <div class="stat-icon" style="background: var(--gradient-success);">
                  <i class="fas fa-check"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-label">有效學習時間</div>
                  <div class="stat-value" id="effectiveTime">0 小時</div>
                </div>
              </div>
              
              <div class="time-stat-item">
                <div class="stat-icon" style="background: var(--gradient-warning);">
                  <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-label">平均每次學習時長</div>
                  <div class="stat-value" id="avgSessionTime">0 分鐘</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 學習習慣分析 -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-calendar-week"></i> 學習習慣分析</h3>
            <span class="card-badge">習慣</span>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div>
                <canvas id="weekdayChart"></canvas>
                <p style="text-align: center; margin-top: 10px; color: var(--text-secondary); font-size: 13px;">
                  最常學習的星期幾
                </p>
              </div>
              <div>
                <canvas id="courseTypeChart"></canvas>
                <p style="text-align: center; margin-top: 10px; color: var(--text-secondary); font-size: 13px;">
                  最常學習的課程類型
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 第二排：課程熱門度排行 -->
    <div class="sophia-section">
      <h2 class="section-title">
        <i class="fas fa-fire"></i> 課程熱門度排行
      </h2>
      
      <!-- 時間範圍切換 -->
      <div class="ranking-tabs">
        <button class="ranking-tab active" data-period="week" onclick="switchRankingPeriod('week')">
          本週
        </button>
        <button class="ranking-tab" data-period="month" onclick="switchRankingPeriod('month')">
          本月
        </button>
        <button class="ranking-tab" data-period="quarter" onclick="switchRankingPeriod('quarter')">
          本季
        </button>
        <button class="ranking-tab" data-period="year" onclick="switchRankingPeriod('year')">
          本年
        </button>
      </div>
      
      <div class="sophia-grid">
        <!-- 觀看次數排行 -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-eye"></i> 觀看次數排行</h3>
            <span class="card-badge">TOP 10</span>
          </div>
          <div class="card-body">
            <div id="viewCountRanking" class="ranking-list"></div>
          </div>
        </div>
        
        <!-- 完成率排行 -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-check-circle"></i> 完成率排行</h3>
            <span class="card-badge">TOP 10</span>
          </div>
          <div class="card-body">
            <div id="completionRateRanking" class="ranking-list"></div>
          </div>
        </div>
        
        <!-- 平均分數排行 -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-star"></i> 平均分數排行</h3>
            <span class="card-badge">TOP 10</span>
          </div>
          <div class="card-body">
            <div id="avgScoreRanking" class="ranking-list"></div>
          </div>
        </div>
        
        <!-- 學習時長排行 -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-clock"></i> 學習時長排行</h3>
            <span class="card-badge">TOP 10</span>
          </div>
          <div class="card-body">
            <div id="studyTimeRanking" class="ranking-list"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 第三排：學習成效報表 -->
    <div class="sophia-section">
      <h2 class="section-title">
        <i class="fas fa-chart-bar"></i> 學習成效報表
      </h2>
      
      <div class="sophia-grid">
        <!-- 學習時數統計 -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-clock"></i> 學習時數統計</h3>
            <div class="comparison-badge" id="timeComparison">
              <i class="fas fa-arrow-up"></i> +0%
            </div>
          </div>
          <div class="card-body">
            <div class="report-stats">
              <div class="report-stat-item">
                <span class="stat-label">總時數</span>
                <span class="stat-value" id="reportTotalHours">0 小時</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">平均每日時數</span>
                <span class="stat-value" id="reportAvgDailyHours">0 小時</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">與上月比較</span>
                <span class="stat-value" id="reportMonthComparison">-</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">與部門平均比較</span>
                <span class="stat-value" id="reportDeptComparison">-</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 課程完成數 -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-check-double"></i> 課程完成數</h3>
            <div class="comparison-badge" id="courseComparison">
              <i class="fas fa-arrow-up"></i> +0%
            </div>
          </div>
          <div class="card-body">
            <div class="report-stats">
              <div class="report-stat-item">
                <span class="stat-label">已完成</span>
                <span class="stat-value" id="reportCompleted">0 門</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">進行中</span>
                <span class="stat-value" id="reportInProgress">0 門</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">未開始</span>
                <span class="stat-value" id="reportNotStarted">0 門</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">必修完成率</span>
                <span class="stat-value" id="reportRequiredRate">0%</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 測驗成績統計 -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-graduation-cap"></i> 測驗成績統計</h3>
          </div>
          <div class="card-body">
            <div class="report-stats">
              <div class="report-stat-item">
                <span class="stat-label">平均分數</span>
                <span class="stat-value" id="reportAvgScore">0 分</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">及格率</span>
                <span class="stat-value" id="reportPassRate">0%</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">最高分</span>
                <span class="stat-value" id="reportMaxScore">0 分</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">最低分</span>
                <span class="stat-value" id="reportMinScore">0 分</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 點數累積 -->
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-trophy"></i> 點數累積</h3>
            <div class="comparison-badge" id="pointsComparison">
              <i class="fas fa-arrow-up"></i> +0%
            </div>
          </div>
          <div class="card-body">
            <div class="report-stats">
              <div class="report-stat-item">
                <span class="stat-label">本月獲得點數</span>
                <span class="stat-value" id="reportMonthPoints">0 點</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">累積總點數</span>
                <span class="stat-value" id="reportTotalPoints">0 點</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">公司排名</span>
                <span class="stat-value" id="reportRanking">-</span>
              </div>
              <div class="report-stat-item">
                <span class="stat-label">部門排名</span>
                <span class="stat-value" id="reportDeptRanking">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    
    
    <!-- 第五排：成就系統 -->
    <div class="sophia-section">
      <h2 class="section-title">
        <i class="fas fa-medal"></i> 學習成就
      </h2>
      
      <div class="achievements-grid" id="achievementsGrid">
        <!-- 成就徽章將動態載入 -->
      </div>
    </div>
    
    <!-- 第六排：月報/季報生成 -->
    <div class="sophia-section">
      <h2 class="section-title">
        <i class="fas fa-file-alt"></i> 報表生成
      </h2>
      
      <div class="sophia-grid">
        <div class="sophia-card">
          <div class="card-header">
            <h3><i class="fas fa-user"></i> 個人月報</h3>
          </div>
          <div class="card-body">
            <p style="color: var(--text-secondary); margin-bottom: 15px;">
              生成您的個人學習月報，並寄送到您的 Email
            </p>
            <button class="btn btn-primary" onclick="generatePersonalMonthlyReport()">
              <i class="fas fa-file-pdf"></i> 生成個人月報
            </button>
          </div>
        </div>
        
        <div class="sophia-card dept-only">
          <div class="card-header">
            <h3><i class="fas fa-users"></i> 部門月報</h3>
            <span class="card-badge">s2+</span>
          </div>
          <div class="card-body">
            <p style="color: var(--text-secondary); margin-bottom: 15px;">
              生成部門整體學習月報（需要 s2 以上權限）
            </p>
            <button class="btn btn-secondary" onclick="generateDepartmentMonthlyReport()">
              <i class="fas fa-file-pdf"></i> 生成部門月報
            </button>
          </div>
        </div>
        
        <div class="sophia-card admin-only">
          <div class="card-header">
            <h3><i class="fas fa-building"></i> 公司季報</h3>
            <span class="card-badge">s4</span>
          </div>
          <div class="card-body">
            <p style="color: var(--text-secondary); margin-bottom: 15px;">
              生成全公司學習季報（需要 s4 權限）
            </p>
            <button class="btn btn-warning" onclick="generateCompanyQuarterlyReport()">
              <i class="fas fa-file-pdf"></i> 生成公司季報
            </button>
          </div>
        </div>
      </div>
    </div>
    
  </div>
  
</div>


      <!-- ==================== 管理後台頁面 ==================== -->
      <div id="adminPage" class="page-section">
        <!-- 管理標籤 -->
        <div class="admin-tabs">
          <button class="admin-tab active" data-tab="courses">
            <i class="fas fa-book"></i> 課程管理
          </button>
          <button class="admin-tab" data-tab="questions">
            <i class="fas fa-question-circle"></i> 題目管理
          </button>
          <button class="admin-tab" data-tab="accounts">
            <i class="fas fa-users"></i> 帳號管理
          </button>
          <button class="admin-tab" data-tab="records">
            <i class="fas fa-chart-bar"></i> 學習紀錄
          </button>
          <button class="admin-tab" data-tab="announcements">
            <i class="fas fa-bullhorn"></i> 公告管理
          </button>
          <button class="admin-tab" data-tab="settings">
            <i class="fas fa-cog"></i> 系統設定
          </button>
        </div>

<!-- 課程管理面板 -->
<div id="adminCoursesPanel" class="admin-panel active">
  <div class="admin-card">
    <div class="admin-card-header">
      <h3 class="admin-card-title">課程列表</h3>
      <button class="btn btn-primary btn-sm" onclick="showAddCourseModal()">
        <i class="fas fa-plus"></i> 新增課程
      </button>
    </div>
    
    <table class="data-table">
      <thead>
        <tr>
          <th>課程ID</th>
          <th>課群</th>           <!-- ✅ 修正: 第2欄 -->
          <th>課門</th>           <!-- ✅ 修正: 第3欄 -->
          <th>課程名稱</th>       <!-- ✅ 修正: 第4欄 -->
          <th>點數</th>
          <th>截止日期</th>
          <th>狀態</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="adminCoursesList">
        <tr>
          <td colspan="8" class="text-center">載入中...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


<!-- 題目管理面板 -->
<div id="adminQuestionsPanel" class="admin-panel">
  <div class="admin-card">
    <div class="admin-card-header">
      <h3 class="admin-card-title">題目列表</h3>
      <div>
        <!-- ✅ 修正: onchange 事件呼叫 loadAdminQuestionsByCourse() -->
        <select id="adminQuestionCourseFilter" onchange="loadAdminQuestionsByCourse()">
          <option value="">選擇課程</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="showAddQuestionModal()">
          <i class="fas fa-plus"></i> 新增題目
        </button>
      </div>
    </div>
    
    <table class="data-table">
      <thead>
        <tr>
          <th>題目ID</th>
          <th>題目內容</th>
          <th>正確答案</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="adminQuestionsList">
        <tr>
          <td colspan="4" class="text-center">請選擇課程</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


        <!-- 帳號管理面板 -->
        <div id="adminAccountsPanel" class="admin-panel">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">帳號列表</h3>
              <button class="btn btn-primary btn-sm" onclick="showAddAccountModal()">
                <i class="fas fa-plus"></i> 新增帳號
              </button>
            </div>
            
            <table class="data-table">
              <thead>
                <tr>
                  <th>工號</th>
                  <th>姓名</th>
                  <th>部門</th>
                  <th>Email</th>
                  <th>權限</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="adminAccountsList">
                <tr>
                  <td colspan="6" class="text-center">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 學習紀錄面板 -->
        <div id="adminRecordsPanel" class="admin-panel">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">學習紀錄</h3>
              <button class="btn btn-success btn-sm" onclick="exportRecords()">
                <i class="fas fa-download"></i> 匯出報表
              </button>
            </div>
            
            <table class="data-table">
              <thead>
                <tr>
                  <th>工號</th>
                  <th>姓名</th>
                  <th>課程名稱</th>
                  <th>開始時間</th>
                  <th>完成時間</th>
                  <th>測驗分數</th>
                  <th>獲得點數</th>
                </tr>
              </thead>
              <tbody id="adminRecordsList">
                <tr>
                  <td colspan="7" class="text-center">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 公告管理面板 -->
        <div id="adminAnnouncementsPanel" class="admin-panel">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">公告列表</h3>
              <button class="btn btn-primary btn-sm" onclick="showAddAnnouncementModal()">
                <i class="fas fa-plus"></i> 新增公告
              </button>
            </div>
            
            <table class="data-table">
              <thead>
                <tr>
                  <th>時間</th>
                  <th>公告內容</th>
                  <th>發布對象</th>
                  <th>是否置頂</th>
                  <th>有效期限</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="adminAnnouncementsList">
                <tr>
                  <td colspan="6" class="text-center">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 系統設定面板 -->
        <div id="adminSettingsPanel" class="admin-panel">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">系統設定</h3>
            </div>
            
            <form id="systemSettingsForm">
              <div class="form-group">
                <label>測驗題數</label>
                <input type="number" id="settingQuestionCount" min="1" max="20" value="5">
              </div>
              
              <div class="form-group">
                <label>測驗及格分數</label>
                <input type="number" id="settingPassScore" min="0" max="100" value="60">
              </div>
              
              <div class="form-group">
                <label>截止日提醒天數</label>
                <input type="number" id="settingReminderDays" min="1" max="30" value="5">
              </div>
              
              <div class="form-group">
                <label>Session 有效時間(分鐘)</label>
                <input type="number" id="settingSessionTimeout" min="30" max="1440" value="480">
              </div>
              
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> 儲存設定
              </button>
            </form>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ==================== Modals ==================== -->
  
<!-- 新增/編輯課程 Modal -->
<div id="courseModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="courseModalTitle">新增課程</h3>
      <button class="modal-close" onclick="closeCourseModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="courseForm">
        <input type="hidden" id="courseFormId">
        
        <div class="form-group">
          <label>課群 *</label>
          <select id="courseFormCategory" required>
            <option value="">請選擇</option>
            <!-- 動態載入選項 -->
          </select>
        </div>

        <div class="form-group">
          <label>課門 *</label>
          <select id="courseFormSubject" required>
            <option value="">請選擇</option>
            <!-- 動態載入選項 -->
          </select>
        </div>
        
        <div class="form-group">
          <label>課程名稱 *</label>
          <input type="text" id="courseFormName" placeholder="例如: 資訊安全基礎訓練" required>
        </div>
        
        <div class="form-group">
          <label>課程說明</label>
          <textarea id="courseFormDesc" rows="3" placeholder="課程說明"></textarea>
        </div>
        
        <div class="form-group">
          <label>影片連結(Google Drive) *</label>
          <input type="url" id="courseFormVideo" placeholder="https://drive.google.com/..." required>
        </div>
        
        <!-- ✅ 新增：必修對象（部門+個人）-->
        <div class="form-group">
          <label>必修對象</label>
          
          <!-- 部門輸入 -->
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <select style="width: 100px;">
              <option>部門</option>
            </select>
            <input type="text" id="courseFormRequiredDepts" placeholder="例如: IT,HR,Finance" style="flex: 1;">
          </div>
          
          <!-- 個人輸入 -->
          <div style="display: flex; gap: 10px;">
            <select style="width: 100px;">
              <option>個人</option>
            </select>
            <input type="text" id="courseFormRequiredIndividuals" placeholder="例如: E001,E002,E003" style="flex: 1;">
          </div>
          
          <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 5px;">
            💡 提示：部門和個人可以同時設定，系統會自動合併（聯集）
          </small>
        </div>
        
        <!-- ✅ 新增：選修對象（部門+個人）-->
        <div class="form-group">
          <label>選修對象</label>
          
          <!-- 部門輸入 -->
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <select style="width: 100px;">
              <option>部門</option>
            </select>
            <input type="text" id="courseFormOptionalDepts" placeholder="例如: Sales,Marketing" style="flex: 1;">
          </div>
          
          <!-- 個人輸入 -->
          <div style="display: flex; gap: 10px;">
            <select style="width: 100px;">
              <option>個人</option>
            </select>
            <input type="text" id="courseFormOptionalIndividuals" placeholder="例如: E004,E005" style="flex: 1;">
          </div>
          
          <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 5px;">
            💡 提示：部門和個人可以同時設定，系統會自動合併（聯集）
          </small>
        </div>
        
        <div class="form-group">
          <label>開始時間 *</label>
          <input type="date" id="courseFormStart" required>
        </div>
        
        <div class="form-group">
          <label>截止時間 *</label>
          <input type="date" id="courseFormDeadline" required>
        </div>
        
        <div class="form-group">
          <label>點數 *</label>
          <input type="number" id="courseFormPoints" min="0" value="10" required>
        </div>
        
        <div class="form-group">
          <label>前置課程ID</label>
          <input type="text" id="courseFormPrerequisite" placeholder="選填">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeCourseModal()">取消</button>
      <button class="btn btn-primary" onclick="saveCourse()">儲存</button>
    </div>
  </div>
</div>


  <!-- 新增/編輯題目 Modal -->
  <div id="questionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="questionModalTitle">新增題目</h3>
        <button class="modal-close" onclick="closeQuestionModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="questionForm">
          <input type="hidden" id="questionFormId">
          
          <div class="form-group">
            <label>課程 *</label>
                        <select id="questionFormCourse" required>
              <option value="">請選擇課程</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>題目內容 *</label>
            <textarea id="questionFormText" rows="3" placeholder="請輸入題目內容" required></textarea>
          </div>
          
          <div class="form-group">
            <label>選項A *</label>
            <input type="text" id="questionFormOptionA" placeholder="選項A" required>
          </div>
          
          <div class="form-group">
            <label>選項B *</label>
            <input type="text" id="questionFormOptionB" placeholder="選項B" required>
          </div>
          
          <div class="form-group">
            <label>選項C *</label>
            <input type="text" id="questionFormOptionC" placeholder="選項C" required>
          </div>
          
          <div class="form-group">
            <label>選項D *</label>
            <input type="text" id="questionFormOptionD" placeholder="選項D" required>
          </div>
          
          <div class="form-group">
            <label>正確答案 *</label>
            <select id="questionFormAnswer" required>
              <option value="">請選擇</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeQuestionModal()">取消</button>
        <button class="btn btn-primary" onclick="saveQuestion()">儲存</button>
      </div>
    </div>
  </div>

  <!-- 新增/編輯帳號 Modal -->
  <div id="accountModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="accountModalTitle">新增帳號</h3>
        <button class="modal-close" onclick="closeAccountModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="accountForm">
          <div class="form-group">
            <label>工號 *</label>
            <input type="text" id="accountFormEmpId" placeholder="例如: E001" required>
          </div>
          
          <div class="form-group">
            <label>姓名 *</label>
            <input type="text" id="accountFormName" placeholder="例如: 王小明" required>
          </div>
          
          <div class="form-group">
            <label>部門 *</label>
            <input type="text" id="accountFormDept" placeholder="例如: IT" required>
          </div>
          
          <div class="form-group">
            <label>密碼 *</label>
            <input type="password" id="accountFormPassword" placeholder="預設密碼" required>
          </div>
          
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="accountFormEmail" placeholder="example@company.com">
          </div>
          
          <div class="form-group">
            <label>權限 *</label>
            <select id="accountFormPermission" required>
              <option value="s1">s1 - 一般員工</option>
              <option value="s2">s2 - 部門主管</option>
              <option value="s3">s3 - 高階主管</option>
              <option value="s4">s4 - 系統管理員</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAccountModal()">取消</button>
        <button class="btn btn-primary" onclick="saveAccount()">儲存</button>
      </div>
    </div>
  </div>

<!-- 新增公告 Modal -->
<div id="announcementModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">新增公告</h3>
      <button class="modal-close" onclick="closeAnnouncementModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="announcementForm">
        <div class="form-group">
          <label>公告內容 *</label>
          <textarea id="announcementFormContent" rows="4" placeholder="請輸入公告內容" required></textarea>
        </div>
        
        <!-- ✅ 新增：發布對象（部門+個人）-->
        <div class="form-group">
          <label>發布對象</label>
          
          <!-- 部門輸入 -->
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <select style="width: 100px;">
              <option>部門</option>
            </select>
            <input type="text" id="announcementFormTargetDepts" placeholder="留空表示全公司，例如: IT,HR">
          </div>
          
          <!-- 個人輸入 -->
          <div style="display: flex; gap: 10px;">
            <select style="width: 100px;">
              <option>個人</option>
            </select>
            <input type="text" id="announcementFormTargetIndividuals" placeholder="例如: E001,E002,E003">
          </div>
          
          <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 5px;">
            💡 提示：留空表示發送給全公司，部門和個人可以同時設定
          </small>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="announcementFormPinned">
            是否置頂
          </label>
        </div>
        
        <div class="form-group">
          <label>有效期限</label>
          <input type="date" id="announcementFormExpiry">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeAnnouncementModal()">取消</button>
      <button class="btn btn-primary" onclick="saveAnnouncement()">發布</button>
    </div>
  </div>
</div>


<!-- 測驗結果 Modal -->
<div id="examResultModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h3 class="modal-title">測驗結果</h3>
      <button class="modal-close" onclick="closeExamResultModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="exam-result">
        <!-- 結果圖示和標題 -->
        <div class="result-icon" id="resultIcon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h2 class="result-title" id="resultTitle">測驗通過!</h2>
        <div class="result-score" id="resultScore">0</div>
        
        <!-- 統計資訊 -->
        <div class="result-details">
          <div class="result-detail-item">
            <span>正確題數</span>
            <strong id="resultCorrect">0</strong>
          </div>
          <div class="result-detail-item">
            <span>總題數</span>
            <strong id="resultTotal">0</strong>
          </div>
          <div class="result-detail-item">
            <span>及格分數</span>
            <strong id="resultPassScore">60</strong>
          </div>
          <div class="result-detail-item" id="resultPointsRow">
            <span>獲得點數</span>
            <strong id="resultPoints">0</strong>
          </div>
        </div>
        
        <!-- ✅ 新增：錯誤題目檢討區塊 -->
        <div id="wrongAnswersSection" style="display: none; margin-top: 30px; text-align: left;">
          <h3 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
            <i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i>
            錯誤題目檢討
          </h3>
          <div id="wrongAnswersList"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer" style="display: flex; gap: 10px; justify-content: center;">
      <button class="btn btn-secondary" onclick="closeExamResultModal()">
        <i class="fas fa-times"></i> 關閉
      </button>
      <!-- ✅ 新增：重新測驗按鈕（只在未通過時顯示）-->
      <button id="btnRetakeExam" class="btn btn-warning" onclick="retakeExam()" style="display: none;">
        <i class="fas fa-redo"></i> 重新測驗
      </button>
      <!-- ✅ 新增：返回課程列表按鈕（通過時顯示）-->
      <button id="btnBackToCourses" class="btn btn-primary" onclick="closeExamResultAndBackToCourses()" style="display: none;">
        <i class="fas fa-check"></i> 返回課程列表
      </button>
    </div>
  </div>
</div>

  <!-- ✅ 修改密碼 Modal -->
<div id="changePasswordModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h3 class="modal-title">修改密碼</h3>
      <button class="modal-close" onclick="closeChangePasswordModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="changePasswordForm" onsubmit="submitChangePassword(event)">
        <div class="form-group">
          <label>
            <i class="fas fa-lock"></i> 目前密碼 *
          </label>
          <input type="password" id="currentPassword" placeholder="請輸入目前密碼" required autocomplete="current-password">
        </div>
        
        <div class="form-group">
          <label>
            <i class="fas fa-key"></i> 新密碼 *
          </label>
          <input type="password" id="newPassword" placeholder="請輸入新密碼（至少6個字元）" required minlength="6" autocomplete="new-password">
          <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 5px;">
            💡 提示：密碼長度至少 6 個字元
          </small>
        </div>
        
        <div class="form-group">
          <label>
            <i class="fas fa-check-circle"></i> 確認新密碼 *
          </label>
          <input type="password" id="confirmPassword" placeholder="請再次輸入新密碼" required minlength="6" autocomplete="new-password">
        </div>
        
        <!-- ✅ 密碼強度指示器 -->
        <div id="passwordStrength" style="display: none; margin-top: 10px; padding: 10px; border-radius: 8px; font-size: 13px;">
          <strong>密碼強度：</strong>
          <span id="strengthText"></span>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeChangePasswordModal()">取消</button>
      <button class="btn btn-primary" onclick="submitChangePassword(event)">
        <i class="fas fa-save"></i> 確認修改
      </button>
    </div>
  </div>
</div>

  <script>
    /**
 * 格式化日期為 YYYY-MM-DD
 */
function formatDate(date) {
  if (!date) return '';
  if (typeof date === 'string') date = new Date(date);
  
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  
  return `${year}-${month}-${day}`;
}

/**
 * 格式化日期時間為 YYYY-MM-DD HH:MM:SS
 */
function formatDateTime(date) {
  if (!date) return '';
  if (typeof date === 'string') date = new Date(date);
  
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  
  return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

    // ==================== 過濾 Chrome 擴充功能錯誤 ====================
(function() {
  const originalError = console.error;
  console.error = function(...args) {
    const errorMessage = args[0];
    
    // ✅ 過濾掉 Chrome 擴充功能的錯誤
    if (typeof errorMessage === 'string') {
      if (errorMessage.includes('message channel closed') ||
          errorMessage.includes('listener indicated an asynchronous response')) {
        return; // 不顯示此錯誤
      }
    }
    
    // ✅ 其他錯誤正常顯示
    originalError.apply(console, args);
  };
})();

    // ==================== 全域變數 ==================== 
    let API_URL = 'https://script.google.com/macros/s/AKfycbwa5CUSHg6_Dvd-DZJkciOgArBvRjux-1LFrnfA9Wftvzdei3MvI33rMrLe6eDQ_Ac1Hg/exec';
    let sessionToken = null;
    let currentUser = null;
    let currentCourse = null;
    let currentRecordId = null;
    let videoStartTime = null;
    let watchedSeconds = 0;
    let currentVideoDuration = 180;  // ✅ 加入這行!
    let videoCheckInterval = null;
    let allCourses = [];
    let currentExamQuestions = [];
    let isPageVisible = true;  // ✅ 新增這行!用來記錄頁面是否可見
    // ==================== 預載入管理器 ====================
const PreloadManager = {
  // 預載入狀態
  status: {
    dashboard: false,
    courses: false,
    myLearning: false,
    charts: false
  },

  // 預載入的資料
  data: {
    dashboard: null,
    courses: null,
    myLearning: null,
    charts: null
  },

  // 階段一：登入後立即載入（2秒內）
  async stage1() {
    console.log('🚀 預載入階段一：儀錶板 + 課程列表');
    
    try {
      // 並行載入儀錶板和課程列表
      const [dashboardData, coursesData] = await Promise.all([
        this.preloadDashboard(),
        this.preloadCourses()
      ]);

      console.log('✅ 階段一載入完成');
      return true;
    } catch (error) {
      console.error('❌ 階段一載入失敗:', error);
      return false;
    }
  },

  // 階段二：背景延遲載入（3-5秒後）
  async stage2() {
    console.log('🚀 預載入階段二：我的學習 + 圖表');
    
    // 延遲3秒後開始載入
    await new Promise(resolve => setTimeout(resolve, 3000));

    try {
      // 並行載入我的學習和圖表
      await Promise.all([
        this.preloadMyLearning(),
        this.preloadCharts()
      ]);

      console.log('✅ 階段二載入完成');
      return true;
    } catch (error) {
      console.error('❌ 階段二載入失敗:', error);
      return false;
    }
  },

  // 預載入儀錶板資料
  async preloadDashboard() {
    if (this.status.dashboard) {
      console.log('⏭️ 儀錶板已預載入，跳過');
      return this.data.dashboard;
    }

    try {
      console.log('⏳ 預載入儀錶板...');
      
      const result = await callAPI('getPersonalDashboard', {});

      if (result && result.success) {
        this.data.dashboard = result.data;
        this.status.dashboard = true;
        console.log('✅ 儀錶板預載入完成');
        return this.data.dashboard;
      } else {
        throw new Error(result?.message || '載入失敗');
      }
    } catch (error) {
      console.error('❌ 儀錶板預載入失敗:', error);
      throw error;
    }
  },

  // 預載入課程列表
  async preloadCourses() {
    if (this.status.courses) {
      console.log('⏭️ 課程列表已預載入，跳過');
      return this.data.courses;
    }

    try {
      console.log('⏳ 預載入課程列表...');
      
      const result = await callAPI('getCourseList', {});

      if (result && result.success) {
        this.data.courses = result.data;
        this.status.courses = true;
        console.log('✅ 課程列表預載入完成');
        return this.data.courses;
      } else {
        throw new Error(result?.message || '載入失敗');
      }
    } catch (error) {
      console.error('❌ 課程列表預載入失敗:', error);
      throw error;
    }
  },

  // 預載入我的學習紀錄
  async preloadMyLearning() {
    if (this.status.myLearning) {
      console.log('⏭️ 我的學習已預載入，跳過');
      return this.data.myLearning;
    }

    try {
      console.log('⏳ 預載入我的學習...');
      
      const [learningResult, pointsResult] = await Promise.all([
        callAPI('getLearningRecords', {}),
        callAPI('getPointRecords', { empId: currentUser.empId })
      ]);

      if (learningResult && learningResult.success && pointsResult && pointsResult.success) {
        this.data.myLearning = {
          learningRecords: learningResult.data,
          pointRecords: pointsResult.data
        };
        this.status.myLearning = true;
        console.log('✅ 我的學習預載入完成');
        return this.data.myLearning;
      } else {
        throw new Error('載入失敗');
      }
    } catch (error) {
      console.error('❌ 我的學習預載入失敗:', error);
      throw error;
    }
  },

  // 預載入圖表資料
  async preloadCharts() {
    if (this.status.charts) {
      console.log('⏭️ 圖表已預載入，跳過');
      return this.data.charts;
    }

    try {
      console.log('⏳ 預載入圖表...');
      
      const result = await callAPI('getChartData', {});

      if (result && result.success) {
        this.data.charts = result.data;
        this.status.charts = true;
        console.log('✅ 圖表預載入完成');
        return this.data.charts;
      } else {
        throw new Error(result?.message || '載入失敗');
      }
    } catch (error) {
      console.error('❌ 圖表預載入失敗:', error);
      throw error;
    }
  },

  // 開始預載入流程
  async start() {
    console.log('🎯 開始預載入流程...');
    
    // 階段一：立即載入
    await this.stage1();

    // 階段二：背景延遲載入（不等待完成）
    this.stage2().catch(error => {
      console.error('階段二背景載入失敗:', error);
    });
  },

  // 重置預載入狀態（登出時使用）
  reset() {
    console.log('🔄 重置預載入狀態');
    this.status = {
      dashboard: false,
      courses: false,
      myLearning: false,
      charts: false
    };
    this.data = {
      dashboard: null,
      courses: null,
      myLearning: null,
      charts: null
    };
  }
};


    // ==================== 初始化 ==================== 
    document.addEventListener('DOMContentLoaded', function() {
      // 檢查是否已登入
      const savedToken = localStorage.getItem('sessionToken');
      if (savedToken) {
        sessionToken = savedToken;
        validateSession();
      }

      // 登入表單提交
      document.getElementById('loginForm').addEventListener('submit', handleLogin);

      // 導航選單點擊
      document.querySelectorAll('.navbar-item').forEach(item => {
        item.addEventListener('click', function() {
          const page = this.dataset.page;
          navigateToPage(page);
        });
      });

      // 管理後台標籤切換
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.dataset.tab;
          switchAdminTab(tabName);
        });
      });

      // 系統設定表單提交
      document.getElementById('systemSettingsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveSystemSettings();
      });
          // ✅ 新增這段!監聽頁面可見性變化
      document.addEventListener('visibilitychange', handleVisibilityChange);
      
      console.log('✅ 頁面可見性監聽器已啟動');
    
    });
/**
 * 處理頁面可見性變化
 */
function handleVisibilityChange() {
  console.log('=== handleVisibilityChange ===');
  console.log('document.hidden:', document.hidden);
  
  if (document.hidden) {
    // ✅ 頁面不可見 (切換分頁、最小化視窗等)
    console.log('⚠️ 頁面不可見,暫停計時器');
    isPageVisible = false;
    
  } else {
    // ✅ 頁面可見
    console.log('✅ 頁面可見,檢查是否需要恢復計時器');
    isPageVisible = true;
    
    // ✅ 檢查是否在播放頁面
    const playerPage = document.getElementById('playerPage');
    const isPlayerActive = playerPage && playerPage.classList.contains('active');
    
    console.log('播放頁面是否啟用:', isPlayerActive);
    console.log('是否有學習紀錄:', !!currentRecordId);
    console.log('已觀看秒數:', watchedSeconds);
    console.log('影片總長度:', currentVideoDuration);
    
    // ✅ 檢查是否已經看完
    if (watchedSeconds >= currentVideoDuration) {
      console.log('⚠️ 影片已看完,不需要恢復計時器');
      return;
    }
    
    // ✅ 如果在播放頁面、有學習紀錄、且計時器未啟動,則恢復計時器
    if (isPlayerActive && currentRecordId && !videoCheckInterval) {
      console.log('✅ 恢復計時器');
      startVideoTimer();
    } else {
      console.log('⚠️ 不需要恢復計時器');
    }
  }
}


/**
 * 啟動影片計時器
 */
function startVideoTimer() {
  console.log('=== startVideoTimer ===');
  console.log('當前觀看秒數:', watchedSeconds);
  console.log('影片總長度:', currentVideoDuration);
  
  // ✅ 檢查是否已經看完
if (watchedSeconds >= currentVideoDuration) {
  console.log('✅ 影片播放完畢');
  stopVideoTimer();
  
  // ✅ 啟用測驗按鈕
  const btnStartExam = document.getElementById('btnStartExam');
  if (btnStartExam) {
    btnStartExam.disabled = false;
    btnStartExam.textContent = '開始測驗';
  }
  
  // ✅ 更新「開始播放」按鈕狀態
  const btnStartWatching = document.getElementById('btnStartWatching');
  const videoStatus = document.getElementById('videoStatus');
  
  if (btnStartWatching) {
    btnStartWatching.disabled = true;
    btnStartWatching.textContent = '✅ 已觀看完畢';
    btnStartWatching.style.backgroundColor = '#28a745';
  }
  
  if (videoStatus) {
    videoStatus.textContent = '影片已觀看完畢，可以開始測驗了！';
    videoStatus.style.color = '#28a745';
  }
  
  showAlert('影片已觀看完畢,可以開始測驗了!', 'success');
  
  return;
}

  
  // ✅ 如果計時器已經啟動,不要重複啟動
  if (videoCheckInterval) {
    console.log('⚠️ 計時器已經啟動,跳過');
    return;
  }
  
  console.log('✅ 啟動計時器');
  
  videoCheckInterval = setInterval(() => {
    // ✅ 檢查頁面是否可見
    if (!isPageVisible) {
      console.log('⚠️ 頁面不可見,跳過本次計時');
      return;
    }
    
    // ✅ 檢查是否播放完畢
    if (watchedSeconds >= currentVideoDuration) {
      console.log('✅ 影片播放完畢');
      stopVideoTimer();
      
      // ✅ 啟用測驗按鈕
      const btnStartExam = document.getElementById('btnStartExam');
      if (btnStartExam) {
        btnStartExam.disabled = false;
        btnStartExam.textContent = '開始測驗';
        showAlert('影片已觀看完畢,可以開始測驗了!', 'success');
      }
      
      return;
    }
    
    // ✅ 正常計時
    watchedSeconds += 1;
    updateProgressBar();
    updateTimeInfo();  // ✅ 新增：更新時間資訊
    
    // ✅ 每 30 秒更新一次進度到後端
    if (watchedSeconds % 30 === 0) {
      updateProgressToServer(false);
    }

  }, 1000);
  
  console.log('✅ startVideoTimer 完成');
}


/**
 * 停止影片計時器
 */
function stopVideoTimer() {
  console.log('=== stopVideoTimer ===');
  console.log('當前觀看秒數:', watchedSeconds);
  
  // 停止計時器
  if (videoCheckInterval) {
    clearInterval(videoCheckInterval);
    videoCheckInterval = null;
    console.log('✅ 計時器已停止');
  }
  
// 最後一次更新進度到後端
if (currentRecordId && watchedSeconds > 0) {
  console.log('✅ 更新最後進度到後端');
  const isComplete = watchedSeconds >= currentVideoDuration;
  updateProgressToServer(isComplete);
}

// ✅ 最後一次更新時間資訊
updateTimeInfo();

console.log('✅ stopVideoTimer 完成');

}

    // ==================== API 呼叫函數 ==================== 
/**
 * 呼叫後端 API (使用 JSONP)
 */
async function callAPI(action, data = {}) {
  console.log('=== callAPI 開始 ===');
  console.log('action:', action);
  console.log('data:', data);
  
  showLoading();
  
  try {
    // ✅ 建立唯一的 callback 名稱
    const callbackName = 'apiCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    console.log('✅ Callback 名稱:', callbackName);
    
    // ✅ 建立參數
    const params = new URLSearchParams({
      action: action,
      callback: callbackName
    });
    
    if (sessionToken) {
      params.append('sessionToken', sessionToken);
    }
    
    // ✅ 加入其他參數
    for (const key in data) {
      if (data.hasOwnProperty(key)) {
        params.append(key, data[key]);
      }
    }
    
    const url = `${API_URL}?${params.toString()}`;
    
    console.log('✅ 完整 URL:', url);
    
    return new Promise((resolve, reject) => {
      // ✅ 設定超時計時器 (30秒)
      const timeoutId = setTimeout(() => {
        console.error('❌ API 請求超時');
        cleanup();
        hideLoading();
        showAlert('請求超時，請稍後再試', 'error');
        reject(new Error('Request timeout'));
      }, 30000);
      
      // ✅ 建立 callback 函數
      window[callbackName] = function(response) {
        console.log('✅ 收到 API 回應:', response);
        
        clearTimeout(timeoutId);
        cleanup();
        hideLoading();
        
        // ✅ 檢查 Session 是否無效
        if (!response.success && response.message === 'Session 無效') {
          console.log('❌ Session 無效，登出');
          logout();
          resolve(null);
        } else {
          resolve(response);
        }
      };
      
      // ✅ 建立 script 標籤
      const script = document.createElement('script');
      script.src = url;
      script.id = callbackName;
      
      // ✅ 錯誤處理 (修正版)
      script.onerror = function(error) {
        console.error('❌ Script 載入失敗:', error);
        console.error('URL:', url);
        
        clearTimeout(timeoutId);
        cleanup();
        hideLoading();
        
        // ✅ 不要立即 reject，因為可能是 CORS 問題
        // 給 callback 一點時間執行
        setTimeout(() => {
          if (window[callbackName]) {
            console.error('❌ Callback 未被呼叫，確認為載入失敗');
            showAlert('系統錯誤，請稍後再試', 'error');
            reject(new Error('Failed to load script'));
          }
        }, 1000);
      };
      
      // ✅ 載入成功處理
      script.onload = function() {
        console.log('✅ Script 載入成功');
      };
      
      // ✅ 清理函數
      function cleanup() {
        try {
          if (window[callbackName]) {
            delete window[callbackName];
          }
          
          const scriptElement = document.getElementById(callbackName);
          if (scriptElement && scriptElement.parentNode) {
            scriptElement.parentNode.removeChild(scriptElement);
          }
        } catch(e) {
          console.error('清理失敗:', e);
        }
      }
      
      // ✅ 加入 script 標籤到 DOM
      document.body.appendChild(script);
      
      console.log('✅ Script 標籤已加入 DOM');
    });
    
  } catch (error) {
    console.error('❌ callAPI 錯誤:', error);
    hideLoading();
    showAlert('系統錯誤，請稍後再試', 'error');
    return null;
  }
}




    // ==================== 登入相關 ==================== 
async function handleLogin(e) {
  e.preventDefault();

  const empId = document.getElementById('empId').value.trim();
  const password = document.getElementById('password').value;

  if (!empId || !password) {
    showAlert('請輸入工號和密碼', 'warning');
    return;
  }

  showLoading();

  try {
    const result = await callAPI('login', { empId, password });

    if (result && result.success) {
      sessionToken = result.data.sessionToken;
      currentUser = result.data.user;
      
      localStorage.setItem('sessionToken', sessionToken);
      
      showAlert('登入成功!', 'success');

      // ✅ 新增：開始預載入流程
      console.log('🎯 開始預載入資料...');
      PreloadManager.start().catch(error => {
        console.error('預載入失敗:', error);
      });

      showApp();
    } else {
      showAlert(result?.message || '登入失敗', 'error');
    }
  } catch (error) {
    console.error('Login error:', error);
    showAlert('登入時發生錯誤，請稍後再試', 'error');
  } finally {
    hideLoading();
  }
}


async function validateSession() {
  const result = await callAPI('validateSession');
  
  console.log('✅ validateSession 結果:', result);
  
  if (result && result.success) {
    // ✅ 修正: 直接使用 result.data
    currentUser = result.data;
    
    console.log('✅ currentUser 已設定:', currentUser);
    
    showApp();
  } else {
    console.log('❌ Session 驗證失敗');
    logout();
  }
}


function logout() {
  // ✅ 新增：重置預載入狀態
  PreloadManager.reset();
  
  // 清除快取
  CacheManager.clear();
  
  sessionToken = null;
  currentUser = null;
  localStorage.removeItem('sessionToken');

  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('appContainer').classList.remove('active');
  
  showAlert('已登出', 'info');
}


function showApp() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('appContainer').classList.add('active');
  
  // ✅ 加入防呆檢查
  if (!currentUser) {
    console.error('❌ currentUser 未定義');
    logout();
    return;
  }
  
  if (!currentUser.name) {
    console.error('❌ currentUser.name 未定義');
    console.log('currentUser:', currentUser);
    logout();
    return;
  }
  
  // 更新使用者資訊
  document.getElementById('userName').textContent = currentUser.name;
  document.getElementById('userDept').textContent = currentUser.department || '未知部門';
  document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
  document.getElementById('welcomeName').textContent = currentUser.name;

  // ✅ 修正: 只有 s4 才能看到管理後台
  console.log('使用者權限: ' + currentUser.permission);
  
  if (currentUser.permission === 's4') {
    console.log('✅ 顯示管理後台選單 (s4)');
    document.querySelectorAll('.admin-only').forEach(el => {
      el.classList.remove('hidden');
    });
  } else {
    console.log('⚠️ 隱藏管理後台選單 (非 s4)');
    document.querySelectorAll('.admin-only').forEach(el => {
      el.classList.add('hidden');
    });
  }

  // 載入儀錶板
  loadDashboard();
}



    // ==================== 頁面導航 ==================== 
/**
 * 頁面導航
 */
function navigateToPage(pageName) {
  console.log('=== navigateToPage ===');
  console.log('目標頁面:', pageName);
  console.log('使用者權限:', currentUser ? currentUser.permission : '未登入');
  
  // ✅ 檢查當前頁面
  const currentPage = document.querySelector('.page-section.active')?.id.replace('Page', '');
  console.log('當前頁面:', currentPage);
  
  // ✅ 如果從播放頁面離開,停止計時器
  if (currentPage === 'player' && pageName !== 'player') {
    console.log('✅ 離開播放頁面,停止計時器');
    stopVideoTimer();
    watchedSeconds = 0;  // ✅ 重置觀看秒數
  }
  
  // ✅ 權限檢查: 只有 s4 才能進入管理後台
  if (pageName === 'admin') {
    if (!currentUser || currentUser.permission !== 's4') {
      console.log('❌ 權限不足,無法進入管理後台');
      showAlert('您沒有權限進入管理後台', 'error');
      return;
    }
    console.log('✅ 權限檢查通過 (s4)');
  }
  
  // ✅ 更新導航選單
  document.querySelectorAll('.navbar-item').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.page === pageName) {
      item.classList.add('active');
    }
  });

  // ✅ 切換頁面
  document.querySelectorAll('.page-section').forEach(section => {
    section.classList.remove('active');
  });

  const targetPage = document.getElementById(pageName + 'Page');
  if (targetPage) {
    targetPage.classList.add('active');
  }

  // ✅ 載入對應頁面資料
  switch(pageName) {
    case 'dashboard':
      loadDashboard();
      break;
    case 'courses':
      loadCourses();
      break;
    case 'mylearning':
      loadMyLearning();
      break;
    case 'admin':
      loadAdminData();
      break;
  }
  
  console.log('✅ 頁面切換完成:', pageName);
}



async function loadDashboard(forceRefresh = false) {
  try {
    console.log('=== loadDashboard ===');
    console.log('forceRefresh:', forceRefresh);
    
    // ✅ 檢查是否已預載入
    if (!forceRefresh && PreloadManager.status.dashboard && PreloadManager.data.dashboard) {
      console.log('⚡ 使用預載入的儀錶板資料');
      const data = PreloadManager.data.dashboard;

      // 直接渲染資料
      document.getElementById('totalPoints').textContent = data.user.totalPoints;
      document.getElementById('completedCount').textContent = data.completedCourses.length;
      document.getElementById('inProgressCount').textContent = data.inProgressCourses.length;
      document.getElementById('requiredCount').textContent = data.requiredCourses.length;

      displayAnnouncements(data.announcements);
      displayRequiredCourses(data.requiredCourses);
      displayInProgressCourses(data.inProgressCourses);
      
      // 延遲載入圖表
      setTimeout(() => {
        loadCharts(forceRefresh);
      }, 500);
      
      return;
    }

    // ✅ 原有的載入邏輯...
    if (forceRefresh) {
      CacheManager.clear('getPersonalDashboard_{}');
    }
    
    const result = await callAPIWithCache('getPersonalDashboard', {}, !forceRefresh);

    if (result && result.success) {
      const data = result.data;

      document.getElementById('totalPoints').textContent = data.user.totalPoints;
      document.getElementById('completedCount').textContent = data.completedCourses.length;
      document.getElementById('inProgressCount').textContent = data.inProgressCourses.length;
      document.getElementById('requiredCount').textContent = data.requiredCourses.length;

      displayAnnouncements(data.announcements);
      displayRequiredCourses(data.requiredCourses);
      displayInProgressCourses(data.inProgressCourses);
      
      setTimeout(() => {
        loadCharts(forceRefresh);
      }, 500);
    }
  } catch(error) {
    console.error('❌ loadDashboard 失敗:', error);
    showAlert('載入儀錶板失敗', 'error');
  }
}


/**
 * 載入圖表（使用快取）
 */
async function loadCharts(forceRefresh = false) {
  console.log('=== loadCharts 開始 ===');
  console.log('forceRefresh:', forceRefresh);
  
  try {
    // ✅ 檢查是否已預載入
    if (!forceRefresh && PreloadManager.status.charts && PreloadManager.data.charts) {
      console.log('⚡ 使用預載入的圖表資料');
      const chartData = PreloadManager.data.charts;
      
      drawMonthlyCoursesChart(chartData.monthlyCourses);
      drawPointsTrendChart(chartData.pointsTrend);
      drawDepartmentStatsChart(chartData.departmentStats);
      
      console.log('✅ 圖表繪製完成（使用預載入）');
      return;
    }

    // ✅ 原有的載入邏輯...
    if (forceRefresh) {
      CacheManager.clear('getChartData_{}');
    }
    
    const result = await callAPIWithCache('getChartData', {}, !forceRefresh);
    
    if (result && result.success) {
      const chartData = result.data;
      
      console.log('✅ 圖表資料:', chartData);
      
      drawMonthlyCoursesChart(chartData.monthlyCourses);
      drawPointsTrendChart(chartData.pointsTrend);
      drawDepartmentStatsChart(chartData.departmentStats);
      
      console.log('✅ 圖表繪製完成');
    } else {
      console.error('❌ 取得圖表資料失敗:', result?.message);
    }
  } catch(error) {
    console.error('❌ loadCharts 失敗:', error);
  }
}



    // ==================== 學習進度圖表（互動版）====================

let monthlyCoursesChart = null;
let pointsTrendChart = null;
let departmentStatsChart = null;

/**
 * 繪製每月完成課程數圖表（折線圖 + 互動）
 */
function drawMonthlyCoursesChart(data) {
  console.log('=== drawMonthlyCoursesChart ===');
  console.log('data:', data);
  
  const ctx = document.getElementById('monthlyCoursesChart');
  if (!ctx) {
    console.error('❌ 找不到 canvas 元素');
    return;
  }
  
  // 銷毀舊圖表
  if (monthlyCoursesChart) {
    monthlyCoursesChart.destroy();
  }
  
  monthlyCoursesChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: '完成課程數',
        data: data.values,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37, 99, 235, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 10,
        pointBackgroundColor: '#2563eb',
        pointBorderColor: '#fff',
        pointBorderWidth: 3,
        pointHoverBackgroundColor: '#1d4ed8',
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 16,
          titleFont: {
            size: 16,
            weight: 'bold'
          },
          bodyFont: {
            size: 14
          },
          borderColor: '#2563eb',
          borderWidth: 2,
          displayColors: false,
          callbacks: {
            title: function(context) {
              return context[0].label;
            },
            label: function(context) {
              return '完成課程數: ' + context.parsed.y + ' 門';
            },
            afterLabel: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed.y / total) * 100).toFixed(1);
              return '佔比: ' + percentage + '%';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            font: {
              size: 12
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          ticks: {
            font: {
              size: 12
            }
          },
          grid: {
            display: false
          }
        }
      },
      // ✅ 新增：點擊事件
      onClick: (event, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const month = data.labels[index];
          const count = data.values[index];
          
          showAlert(`📊 ${month}完成了 ${count} 門課程`, 'info');
        }
      },
      // ✅ 新增：滑鼠移動效果
      onHover: (event, elements) => {
        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
      }
    }
  });
  
  console.log('✅ 每月完成課程數圖表繪製完成');
}

/**
 * 繪製累積點數趨勢圖表（面積圖 + 互動）
 */
function drawPointsTrendChart(data) {
  console.log('=== drawPointsTrendChart ===');
  console.log('data:', data);
  
  const ctx = document.getElementById('pointsTrendChart');
  if (!ctx) {
    console.error('❌ 找不到 canvas 元素');
    return;
  }
  
  // 銷毀舊圖表
  if (pointsTrendChart) {
    pointsTrendChart.destroy();
  }
  
  pointsTrendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: '累積點數',
        data: data.values,
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.2)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 10,
        pointBackgroundColor: '#10b981',
        pointBorderColor: '#fff',
        pointBorderWidth: 3,
        pointHoverBackgroundColor: '#059669',
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 16,
          titleFont: {
            size: 16,
            weight: 'bold'
          },
          bodyFont: {
            size: 14
          },
          borderColor: '#10b981',
          borderWidth: 2,
          displayColors: false,
          callbacks: {
            title: function(context) {
              return context[0].label;
            },
            label: function(context) {
              return '累積點數: ' + context.parsed.y + ' 點';
            },
            afterLabel: function(context) {
              const index = context.dataIndex;
              if (index > 0) {
                const prevValue = context.dataset.data[index - 1];
                const currentValue = context.parsed.y;
                const increase = currentValue - prevValue;
                return increase > 0 ? '▲ +' + increase + ' 點' : '持平';
              }
              return '';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            font: {
              size: 12
            },
            callback: function(value) {
              return value + ' 點';
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          ticks: {
            font: {
              size: 12
            }
          },
          grid: {
            display: false
          }
        }
      },
      // ✅ 新增：點擊事件
      onClick: (event, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const month = data.labels[index];
          const points = data.values[index];
          
          showAlert(`🏆 ${month}累積點數: ${points} 點`, 'success');
        }
      },
      // ✅ 新增：滑鼠移動效果
      onHover: (event, elements) => {
        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
      }
    }
  });
  
  console.log('✅ 累積點數趨勢圖表繪製完成');
}

/**
 * 繪製部門完成率統計圖表（長條圖 + 互動）
 */
function drawDepartmentStatsChart(data) {
  console.log('=== drawDepartmentStatsChart ===');
  console.log('data:', data);
  
  const ctx = document.getElementById('departmentStatsChart');
  if (!ctx) {
    console.error('❌ 找不到 canvas 元素');
    return;
  }
  
  // 銷毀舊圖表
  if (departmentStatsChart) {
    departmentStatsChart.destroy();
  }
  
  // 計算平均、最高、最低完成率
  const rates = data.completionRates;
  const avgRate = rates.length > 0 ? Math.round(rates.reduce((a, b) => a + b, 0) / rates.length) : 0;
  const maxRate = rates.length > 0 ? Math.max(...rates) : 0;
  const minRate = rates.length > 0 ? Math.min(...rates) : 0;
  
  // 更新統計資訊
  document.getElementById('avgCompletionRate').textContent = avgRate + '%';
  document.getElementById('maxCompletionRate').textContent = maxRate + '%';
  document.getElementById('minCompletionRate').textContent = minRate + '%';
  
  departmentStatsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.departments,
      datasets: [{
        label: '完成率',
        data: data.completionRates,
        backgroundColor: data.completionRates.map(rate => {
          if (rate >= 80) return 'rgba(16, 185, 129, 0.8)';
          if (rate >= 60) return 'rgba(245, 158, 11, 0.8)';
          return 'rgba(239, 68, 68, 0.8)';
        }),
        borderColor: data.completionRates.map(rate => {
          if (rate >= 80) return '#10b981';
          if (rate >= 60) return '#f59e0b';
          return '#ef4444';
        }),
        borderWidth: 2,
        borderRadius: 8,
        hoverBackgroundColor: data.completionRates.map(rate => {
          if (rate >= 80) return 'rgba(16, 185, 129, 1)';
          if (rate >= 60) return 'rgba(245, 158, 11, 1)';
          return 'rgba(239, 68, 68, 1)';
        })
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 16,
          titleFont: {
            size: 16,
            weight: 'bold'
          },
          bodyFont: {
            size: 14
          },
          borderColor: '#2563eb',
          borderWidth: 2,
          displayColors: false,
          callbacks: {
            title: function(context) {
              return context[0].label + ' 部門';
            },
            label: function(context) {
              return '完成率: ' + context.parsed.y + '%';
            },
            afterLabel: function(context) {
              const rate = context.parsed.y;
              if (rate >= 80) return '✅ 表現優異';
              if (rate >= 60) return '⚠️ 需要加油';
              return '❌ 需要改進';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            font: {
              size: 12
            },
            callback: function(value) {
              return value + '%';
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          ticks: {
            font: {
              size: 12
            }
          },
          grid: {
            display: false
          }
        }
      },
      // ✅ 新增：點擊事件
      onClick: (event, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const dept = data.departments[index];
          const rate = data.completionRates[index];
          
          let emoji = '✅';
          let message = '表現優異';
          
          if (rate < 80) {
            emoji = '⚠️';
            message = '需要加油';
          }
          if (rate < 60) {
            emoji = '❌';
            message = '需要改進';
          }
          
          showAlert(`${emoji} ${dept} 部門完成率: ${rate}% (${message})`, 'info');
        }
      },
      // ✅ 新增：滑鼠移動效果
      onHover: (event, elements) => {
        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
      }
    }
  });
  
  console.log('✅ 部門完成率統計圖表繪製完成');
}



    function displayAnnouncements(announcements) {
      const container = document.getElementById('announcementsList');
      
      if (announcements.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">目前沒有公告</p>';
        return;
      }

      container.innerHTML = announcements.map(ann => `
        <div class="announcement-item ${ann.isPinned ? 'pinned' : ''}">
          <div class="announcement-header">
            <span class="announcement-time">${ann.time}</span>
            ${ann.isPinned ? '<span class="announcement-badge">置頂</span>' : ''}
          </div>
          <div class="announcement-content">${ann.content}</div>
        </div>
      `).join('');
    }

function displayRequiredCourses(courses) {
  const container = document.getElementById('requiredCoursesList');
  
  if (courses.length === 0) {
    container.innerHTML = '<p class="text-center" style="color: var(--text-secondary); padding: 20px;">太棒了!您已完成所有必修課程 🎉</p>';
    return;
  }

  container.innerHTML = courses.map(course => {
    const isExpired = course.isExpired;
    const daysLeft = course.daysLeft;
    
    return `
      <div class="course-card">
        <div class="course-card-header required">
          <span class="course-badge">必修</span>
          <h3 class="course-title">${course.courseName}</h3>
          <p class="course-id">${course.courseId}</p>
        </div>
        <div class="course-card-body">
          <div class="course-deadline ${isExpired ? 'danger' : daysLeft <= 5 ? 'warning' : ''}">
            <i class="fas fa-calendar-alt"></i>
            截止日期: ${course.deadline}
            ${!isExpired ? ` (剩餘 ${daysLeft} 天)` : ' (已逾期)'}
          </div>
          <div class="course-actions">
            <button class="btn btn-primary" onclick="startLearning('${course.courseId}')">
              <i class="fas fa-play"></i> 開始學習
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function displayInProgressCourses(courses) {
  const container = document.getElementById('inProgressCoursesList');
  
  if (courses.length === 0) {
    container.innerHTML = '<p class="text-center" style="color: var(--text-secondary); padding: 20px;">目前沒有進行中的課程</p>';
    return;
  }

  container.innerHTML = courses.map(course => `
    <div class="course-card">
      <div class="course-card-header">
        <span class="course-badge">進行中</span>
        <h3 class="course-title">${course.courseName}</h3>
        <p class="course-id">${course.courseId}</p>
      </div>
      <div class="course-card-body">
        <div class="course-meta">
          <span class="course-meta-item">
            <i class="fas fa-clock"></i>
            上次觀看: ${new Date(course.lastWatchTime).toLocaleDateString()}
          </span>
        </div>
        <div class="course-actions">
          <button class="btn btn-primary" onclick="continueLearning('${course.courseId}')">
            <i class="fas fa-play"></i> 繼續學習
          </button>
        </div>
      </div>
    </div>
  `).join('');
}


    function displayInProgressCourses(courses) {
      const container = document.getElementById('inProgressCoursesList');
      
      if (courses.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: var(--text-secondary); padding: 20px;">目前沒有進行中的課程</p>';
        return;
      }

      container.innerHTML = courses.map(course => `
        <div class="course-card" onclick="viewCourse('${course.courseId}')">
          <div class="course-card-header">
            <span class="course-badge">進行中</span>
            <h3 class="course-title">${course.courseName}</h3>
            <p class="course-id">${course.courseId}</p>
          </div>
          <div class="course-card-body">
            <div class="course-meta">
              <span class="course-meta-item">
                <i class="fas fa-clock"></i>
                上次觀看: ${new Date(course.lastWatchTime).toLocaleDateString()}
              </span>
            </div>
            <div class="course-actions">
              <button class="btn btn-primary" onclick="event.stopPropagation(); continueLearning('${course.courseId}')">
                <i class="fas fa-play"></i> 繼續學習
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

// ==================== 使用快取的函數 ====================

/**
 * 載入課程列表（使用快取）
 */
async function loadCourses(forceRefresh = false) {
  try {
    console.log('=== loadCourses ===');
    console.log('forceRefresh:', forceRefresh);
    
    // ✅ 檢查是否已預載入
    if (!forceRefresh && PreloadManager.status.courses && PreloadManager.data.courses) {
      console.log('⚡ 使用預載入的課程列表');
      allCourses = PreloadManager.data.courses;
      displayCourses(allCourses);
      populateCourseCategoryFilter();
      populateCourseGroupFilter();
      return;
    }

    // ✅ 原有的載入邏輯...
    if (forceRefresh) {
      CacheManager.clear('getCourseList_{}');
    }
    
    const result = await callAPIWithCache('getCourseList', {}, !forceRefresh);

    if (result && result.success) {
      allCourses = result.data;
      displayCourses(allCourses);
      populateCourseCategoryFilter();
      populateCourseGroupFilter();
    }
  } catch(error) {
    console.error('❌ loadCourses 失敗:', error);
    showAlert('載入課程失敗', 'error');
  }
}



    /**
 * 填充課程瀏覽頁面的課群選項
 */
function populateCourseGroupFilter() {
  const groups = [...new Set(allCourses.map(c => c.courseGroup))];
  const select = document.getElementById('filterCourseGroup');
  
  if (select) {
    select.innerHTML = '<option value="">全部</option>' + 
      groups.map(group => `<option value="${group}">${group}</option>`).join('');
  }
}

/**
 * 填充課程瀏覽頁面的課門選項
 */
function populateCourseCategoryFilter() {
  const categories = [...new Set(allCourses.map(c => c.courseCategory))];
  const select = document.getElementById('filterCourseCategory');
  
  if (select) {
    select.innerHTML = '<option value="">全部</option>' + 
      categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
  }
}
    function applyCourseFilters() {
      const groupFilter = document.getElementById('filterCourseGroup').value;
      const categoryFilter = document.getElementById('filterCourseCategory').value;
      const typeFilter = document.getElementById('filterCourseType').value;
      const statusFilter = document.getElementById('filterStatus').value;

      let filtered = allCourses;

      if (groupFilter) {
        filtered = filtered.filter(c => c.courseGroup === groupFilter);
      }

      if (categoryFilter) {
        filtered = filtered.filter(c => c.courseCategory === categoryFilter);
      }

      if (typeFilter) {
        if (typeFilter === 'required') {
          filtered = filtered.filter(c => c.isRequired);
        } else if (typeFilter === 'optional') {
          filtered = filtered.filter(c => !c.isRequired);
        }
      }

      if (statusFilter) {
        filtered = filtered.filter(c => {
          if (statusFilter === 'completed') return c.isCompleted;
          if (statusFilter === 'inProgress') return c.hasStarted && !c.isCompleted;
          if (statusFilter === 'notStarted') return !c.hasStarted;
          return true;
        });
      }

      displayCourses(filtered);
    }

function displayCourses(courses) {
  const container = document.getElementById('coursesList');
  
  if (courses.length === 0) {
    container.innerHTML = '<p class="text-center" style="color: var(--text-secondary); grid-column: 1/-1;">找不到符合條件的課程</p>';
    return;
  }

  container.innerHTML = courses.map(course => {
    const headerClass = course.isCompleted ? 'completed' : course.isRequired ? 'required' : '';
    const badgeText = course.isCompleted ? '已完成' : course.isRequired ? '必修' : '選修';
    
    let deadlineHTML = '';
    if (course.deadline) {
      const daysLeft = calculateDaysLeft(course.deadline);
      const deadlineClass = course.isExpired ? 'danger' : daysLeft <= 5 ? 'warning' : '';
      deadlineHTML = `
        <div class="course-deadline ${deadlineClass}">
          <i class="fas fa-calendar-alt"></i>
          截止日期: ${course.deadline}
          ${!course.isExpired && daysLeft !== null ? ` (剩餘 ${daysLeft} 天)` : ''}
          ${course.isExpired ? ' (已逾期)' : ''}
        </div>
      `;
    }

    return `
      <div class="course-card">
        <div class="course-card-header ${headerClass}">
          <span class="course-badge">${badgeText}</span>
          <h3 class="course-title">${course.courseName}</h3>
          <p class="course-id">${course.courseId}</p>
        </div>
        <div class="course-card-body">
          <p class="course-desc">${course.courseDesc || '暫無說明'}</p>
          <div class="course-meta">
            <span class="course-meta-item">
              <i class="fas fa-folder"></i>
              ${course.courseGroup} - ${course.courseCategory}
            </span>
            <span class="course-meta-item">
              <i class="fas fa-star"></i>
              ${course.points} 點
            </span>
          </div>
          ${deadlineHTML}
          <div class="course-actions">
            ${course.isCompleted 
              ? '<button class="btn btn-success" disabled><i class="fas fa-check"></i> 已完成</button>'
              : course.hasStarted
                ? `<button class="btn btn-primary" onclick="startLearning('${course.courseId}')"><i class="fas fa-play"></i> 繼續學習</button>`
                : `<button class="btn btn-primary" onclick="startLearning('${course.courseId}')"><i class="fas fa-play"></i> 開始學習</button>`
            }
          </div>
        </div>
      </div>
    `;
  }).join('');
}


    function calculateDaysLeft(deadline) {
      if (!deadline) return null;
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      const deadlineDate = new Date(deadline);
      deadlineDate.setHours(23, 59, 59, 999);
      
      const diffTime = deadlineDate - now;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      return diffDays > 0 ? diffDays : 0;
    }

/**
 * 查看課程詳細資料 (從課程卡片點選進入)
 */
async function viewCourse(courseId) {
  console.log('=== viewCourse 開始 ===');
  console.log('courseId:', courseId);
  
  const result = await callAPI('getCourseDetail', { courseId });

  if (result && result.success) {
    currentCourse = result.data;
    
    console.log('✅ 課程資料:', currentCourse);
    
    // ✅ 檢查前置課程
    if (!currentCourse.prerequisiteCompleted) {
      showAlert(`請先完成前置課程: ${currentCourse.prerequisiteCourseId}`, 'warning');
      return;
    }

    // ✅ 如果已完成,直接顯示完成訊息
    if (currentCourse.isCompleted) {
      showAlert('您已完成此課程!', 'info');
      return;
    }

    // ⚠️ 注意: viewCourse() 不會建立學習紀錄
    // 使用者需要點選【開始學習】按鈕
    console.log('⚠️ 尚未建立學習紀錄,請點選【開始學習】');
    
    // ✅ 導航到播放頁面
    navigateToPage('player');
    displayPlayer();
  }
}

/**
 * 開始學習 (建立學習紀錄)
 */
async function startLearning(courseId) {
  console.log('=== startLearning 開始 ===');
  console.log('courseId:', courseId);
  
  showLoading();
  
  const result = await callAPI('startLearning', { courseId });

  console.log('✅ API 完整回應:', result);
  // ✅ 加入詳細檢查
  if (result && result.data && result.data.courseDetail) {
    console.log('=== courseDetail 內容 ===');
    console.log('完整 courseDetail:', result.data.courseDetail);
    console.log('videoDuration 值:', result.data.courseDetail.videoDuration);
    console.log('videoDuration 型別:', typeof result.data.courseDetail.videoDuration);
    console.log('videoDuration 是否存在:', 'videoDuration' in result.data.courseDetail);
  }

  hideLoading();

  if (result && result.success) {
    // ✅ 檢查 data 結構
    if (!result.data) {
      console.error('❌ result.data 不存在');
      showAlert('系統錯誤: 無法取得課程資料', 'error');
      return;
    }
    
    if (!result.data.recordId) {
      console.error('❌ result.data.recordId 不存在');
      showAlert('系統錯誤: 無法取得紀錄ID', 'error');
      return;
    }
    
    if (!result.data.courseDetail) {
      console.error('❌ result.data.courseDetail 不存在');
      showAlert('系統錯誤: 無法取得課程詳細資料', 'error');
      return;
    }
    
    // ✅ 設定全域變數
    currentRecordId = result.data.recordId;
    currentCourse = result.data.courseDetail;
    
    console.log('✅ currentRecordId:', currentRecordId);
    console.log('✅ currentCourse:', currentCourse);
    
    // ✅ 導航到播放頁面
    navigateToPage('player');
    displayPlayer();
  } else {
    console.error('❌ 開始學習失敗');
    showAlert(result?.message || '開始學習失敗', 'error');
  }
}

/**
 * 繼續學習 (重新開始學習)
 */
async function continueLearning(courseId) {
  console.log('=== continueLearning 開始 ===');
  console.log('courseId:', courseId);
  
  // ✅ 直接呼叫 startLearning()
  await startLearning(courseId);
}


function displayPlayer() {
  console.log('=== displayPlayer 開始 ===');
  console.log('currentCourse:', currentCourse);
  console.log('currentRecordId:', currentRecordId);
  
  // ✅ 防呆檢查
  if (!currentCourse) {
    console.error('❌ currentCourse 未定義');
    showAlert('課程資料載入失敗,請重新開始學習', 'error');
    backToCourses();
    return;
  }
  
  const requiredFields = ['courseName', 'courseId', 'videoUrl'];
  for (const field of requiredFields) {
    if (!currentCourse[field]) {
      console.error(`❌ currentCourse.${field} 未定義`);
      showAlert(`課程資料不完整: 缺少 ${field}`, 'error');
      backToCourses();
      return;
    }
  }
  
  // ✅ 顯示課程資訊
  document.getElementById('playerCourseTitle').textContent = currentCourse.courseName;
  document.getElementById('playerCourseId').textContent = currentCourse.courseId;
  document.getElementById('playerCoursePoints').textContent = currentCourse.points || 0;
  document.getElementById('playerDeadline').textContent = currentCourse.deadline || '無期限';
  document.getElementById('playerCourseDesc').textContent = currentCourse.courseDesc || '暫無說明';

  // ✅ 載入影片
  const videoUrl = convertDriveUrl(currentCourse.videoUrl);
  
  if (!videoUrl) {
    console.error('❌ 影片連結轉換失敗');
    showAlert('影片連結無效', 'error');
    return;
  }
  
  const videoIframe = document.getElementById('videoPlayer');
  videoIframe.src = videoUrl;

  // ✅ 檢查是否有學習紀錄
  const btnStartExam = document.getElementById('btnStartExam');
  
  if (!currentRecordId) {
    console.log('⚠️ 尚未建立學習紀錄');
    btnStartExam.disabled = true;
    btnStartExam.textContent = '請先點選【開始學習】';
    showAlert('請先點選【開始學習】按鈕以建立學習紀錄', 'info');
    return;
  }
  
  console.log('✅ 學習紀錄ID: ' + currentRecordId);
  
  videoStartTime = new Date();
  watchedSeconds = 0;  // ✅ 重置為 0

  // ✅ 停止舊的計時器 (如果有的話)
  if (videoCheckInterval) {
    clearInterval(videoCheckInterval);
    videoCheckInterval = null;
  }
  
  // ✅ 取得影片長度
  let videoDuration = 180;
  
  console.log('=== 檢查 videoDuration ===');
  console.log('currentCourse.videoDuration:', currentCourse.videoDuration);
  console.log('型別:', typeof currentCourse.videoDuration);
  
  if (currentCourse.videoDuration !== undefined && 
      currentCourse.videoDuration !== null && 
      currentCourse.videoDuration !== '') {
    
    const parsed = parseInt(currentCourse.videoDuration);
    
    if (!isNaN(parsed) && parsed > 0) {
      videoDuration = parsed;
      console.log('✅ 使用課程設定的影片長度:', videoDuration, '秒');
    } else {
      console.log('⚠️ 解析失敗,使用預設值:', videoDuration, '秒');
    }
  } else {
    console.log('⚠️ videoDuration 不存在,使用預設值:', videoDuration, '秒');
  }
  
// ✅ 設定全域變數
currentVideoDuration = videoDuration;

console.log('✅ 最終影片長度:', currentVideoDuration, '秒 (' + Math.floor(currentVideoDuration / 60) + ' 分鐘)');

// ✅ 設定「開始播放」按鈕
setupStartWatchingButton();

// ✅ 初始化時間資訊顯示
updateTimeInfo();

console.log('✅ displayPlayer 完成');


}

/**
 * 設定「開始播放」按鈕
 */
function setupStartWatchingButton() {
  console.log('=== setupStartWatchingButton ===');
  
  const btnStartWatching = document.getElementById('btnStartWatching');
  const videoStatus = document.getElementById('videoStatus');
  
  if (!btnStartWatching) {
    console.error('❌ 找不到「開始播放」按鈕');
    return;
  }
  
  // ✅ 檢查是否已經看完
  if (watchedSeconds >= currentVideoDuration) {
    console.log('⚠️ 影片已看完');
    btnStartWatching.disabled = true;
    btnStartWatching.textContent = '✅ 已觀看完畢';
    btnStartWatching.style.backgroundColor = '#28a745';
    
    if (videoStatus) {
      videoStatus.textContent = '影片已觀看完畢，可以開始測驗了！';
      videoStatus.style.color = '#28a745';
    }
    
    return;
  }
  
  // ✅ 檢查計時器是否已經啟動
  if (videoCheckInterval) {
    console.log('⚠️ 計時器已啟動');
    btnStartWatching.disabled = true;
    btnStartWatching.textContent = '⏱️ 觀看中...';
    btnStartWatching.style.backgroundColor = '#ffc107';
    
    if (videoStatus) {
      videoStatus.textContent = '正在計時中，請繼續觀看影片';
      videoStatus.style.color = '#ffc107';
    }
    
    return;
  }
  
  // ✅ 設定按鈕點擊事件
  btnStartWatching.onclick = function() {
    console.log('✅ 使用者點擊「開始播放」按鈕');
    
    // ✅ 再次檢查是否已經看完
    if (watchedSeconds >= currentVideoDuration) {
      console.log('⚠️ 影片已看完');
      showAlert('影片已觀看完畢', 'info');
      return;
    }
    
    // ✅ 再次檢查計時器是否已經啟動
    if (videoCheckInterval) {
      console.log('⚠️ 計時器已經啟動');
      showAlert('計時器已經啟動', 'info');
      return;
    }
    
// ✅ 啟動計時器
startVideoTimer();

// ✅ 更新按鈕狀態
btnStartWatching.disabled = true;
btnStartWatching.textContent = '⏱️ 觀看中...';
btnStartWatching.style.backgroundColor = '#ffc107';

if (videoStatus) {
  videoStatus.textContent = '正在計時中，請繼續觀看影片';
  videoStatus.style.color = '#ffc107';
}

// ✅ 顯示時間資訊區塊
const videoTimeInfo = document.getElementById('videoTimeInfo');
if (videoTimeInfo) {
  videoTimeInfo.style.display = 'block';
}

// ✅ 更新時間資訊
updateTimeInfo();

showAlert('已開始計時，請觀看影片', 'success');

  };
  
  console.log('✅ setupStartWatchingButton 完成');
}

/**
 * 開始影片追蹤
 */
function startVideoTracking(videoDuration) {
  console.log('=== startVideoTracking ===');
  console.log('影片長度:', videoDuration, '秒');
  
  // ✅ 每 30 秒更新一次前端進度條
  videoCheckInterval = setInterval(() => {
    watchedSeconds += 30;
    updateProgressBar(videoDuration);
  }, 30000);

  // ✅ 影片播放完畢後,更新後端並啟用測驗按鈕
  setTimeout(() => {
    if (videoCheckInterval) {
      clearInterval(videoCheckInterval);
    }
    
    // ✅ 最後一次更新進度 (標記為完成)
    watchedSeconds = videoDuration;
    updateProgressBar(videoDuration);
    updateProgressToServer(videoDuration, true);
    
    const btnStartExam = document.getElementById('btnStartExam');
    btnStartExam.disabled = false;
    btnStartExam.textContent = '開始測驗';
    showAlert('影片已觀看完畢,可以開始測驗了!', 'success');
  }, videoDuration * 1000);
}


/**
 * 更新進度到伺服器
 */
async function updateProgressToServer(videoDuration, isComplete = false) {
  if (!currentRecordId) return;

  const progressPercent = Math.min(100, Math.round((watchedSeconds / videoDuration) * 100));
  
  const progressData = {
    watchedSeconds: watchedSeconds,
    videoDuration: videoDuration,  // ✅ 加入影片長度
    progress: progressPercent,
    isComplete: isComplete || progressPercent >= 100
  };

  console.log('更新進度到伺服器:', progressData);

  try {
    const result = await callAPI('updateProgress', {
      recordId: currentRecordId,
      progressData: JSON.stringify(progressData)
    });

    if (result && result.success) {
      console.log('✅ 進度更新成功');
    } else {
      console.error('❌ 進度更新失敗:', result?.message);
    }
  } catch (error) {
    console.error('❌ 更新進度失敗:', error);
  }
}


/**
 * 更新前端進度條
 */
function updateProgressBar() {
  if (!currentRecordId) return;

  // ✅ 防呆檢查: 如果 currentVideoDuration 無效,使用預設值
  const videoDuration = (currentVideoDuration && currentVideoDuration > 0) 
    ? currentVideoDuration 
    : 180;
  
  const progressPercent = Math.min(100, Math.round((watchedSeconds / videoDuration) * 100));
  
  const progressFill = document.getElementById('progressFill');
  if (progressFill) {
    progressFill.style.width = progressPercent + '%';
    progressFill.textContent = progressPercent + '%';
  }
  
  console.log(`進度更新: ${watchedSeconds}/${videoDuration} 秒 (${progressPercent}%)`);
}

/**
 * 將秒數轉換為 mm:ss 格式
 * @param {number} seconds - 秒數
 * @returns {string} - 格式化後的時間（例如：3:45）
 */
function formatTime(seconds) {
  if (!seconds || seconds < 0) return '0:00';
  
  const minutes = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  
  return `${minutes}:${secs.toString().padStart(2, '0')}`;
}

/**
 * 更新時間資訊顯示
 */
function updateTimeInfo() {
  // ✅ 防呆檢查
  if (!currentRecordId || !currentVideoDuration) {
    return;
  }
  
  // ✅ 計算剩餘時間
  const remainingSeconds = Math.max(0, currentVideoDuration - watchedSeconds);
  
  // ✅ 計算進度百分比
  const progressPercent = Math.min(100, Math.round((watchedSeconds / currentVideoDuration) * 100));
  
  // ✅ 更新 DOM
  const totalDurationEl = document.getElementById('totalDuration');
  const watchedTimeEl = document.getElementById('watchedTime');
  const remainingTimeEl = document.getElementById('remainingTime');
  const progressPercentEl = document.getElementById('progressPercent');
  
  if (totalDurationEl) {
    totalDurationEl.textContent = formatTime(currentVideoDuration);
  }
  
  if (watchedTimeEl) {
    watchedTimeEl.textContent = formatTime(watchedSeconds);
  }
  
  if (remainingTimeEl) {
    remainingTimeEl.textContent = formatTime(remainingSeconds);
  }
  
  if (progressPercentEl) {
    progressPercentEl.textContent = progressPercent + '%';
  }
  
  // ✅ 根據剩餘時間改變顏色
  if (remainingTimeEl) {
    if (remainingSeconds <= 30) {
      remainingTimeEl.style.color = '#ef4444'; // 紅色（快結束了）
    } else if (remainingSeconds <= 60) {
      remainingTimeEl.style.color = '#f59e0b'; // 橙色（即將結束）
    } else {
      remainingTimeEl.style.color = '#f59e0b'; // 橙色（正常）
    }
  }
}



/**
 * 更新進度到伺服器 (使用全域變數 currentVideoDuration)
 */
async function updateProgressToServer(isComplete = false) {
  if (!currentRecordId) return;

  const progressPercent = Math.min(100, Math.round((watchedSeconds / currentVideoDuration) * 100));
  
  const progressData = {
    watchedSeconds: watchedSeconds,
    videoDuration: currentVideoDuration,  // ✅ 使用全域變數
    progress: progressPercent,
    isComplete: isComplete || progressPercent >= 100
  };

  console.log('更新進度到伺服器:', progressData);

  try {
    const result = await callAPI('updateProgress', {
      recordId: currentRecordId,
      progressData: JSON.stringify(progressData)
    });

    if (result && result.success) {
      console.log('✅ 進度更新成功');
    } else {
      console.error('❌ 進度更新失敗:', result?.message);
    }
  } catch (error) {
    console.error('❌ 更新進度失敗:', error);
  }
}


/**
 * 返回課程列表
 */
function backToCourses() {
  console.log('=== backToCourses ===');
  console.log('當前觀看秒數:', watchedSeconds);
  console.log('影片總長度:', currentVideoDuration);
  
  // ✅ 使用新的停止函數
  stopVideoTimer();
  
  // ✅ 重置觀看秒數
  watchedSeconds = 0;
  
  // ✅ 隱藏時間資訊區塊
  const videoTimeInfo = document.getElementById('videoTimeInfo');
  if (videoTimeInfo) {
    videoTimeInfo.style.display = 'none';
  }
  
  console.log('✅ 返回課程列表');
  navigateToPage('courses');
}



function convertDriveUrl(url) {
  console.log('=== convertDriveUrl ===');
  console.log('輸入 URL:', url);
  
  if (!url) {
    console.error('❌ URL 為空');
    return '';
  }
  
  // ✅ 移除空白和換行
  url = String(url).trim();
  
  // ✅ 方法 1: 從分享連結提取 File ID
  if (url.includes('drive.google.com/file/d/')) {
    const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
    if (match && match[1]) {
      const fileId = match[1];
      const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
      console.log('✅ 轉換成功 (方法1):', embedUrl);
      return embedUrl;
    }
  }
  
  // ✅ 方法 2: 從 open?id= 格式提取
  if (url.includes('drive.google.com/open?id=')) {
    const match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    if (match && match[1]) {
      const fileId = match[1];
      const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
      console.log('✅ 轉換成功 (方法2):', embedUrl);
      return embedUrl;
    }
  }
  
  // ✅ 方法 3: 從任何 Drive 連結提取 File ID
  const fileIdMatch = url.match(/[-\w]{25,}/);
  if (fileIdMatch) {
    const fileId = fileIdMatch[0];
    const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
    console.log('✅ 轉換成功 (方法3):', embedUrl);
    return embedUrl;
  }
  
  // ✅ 方法 4: 如果已經是嵌入式連結
  if (url.includes('/preview')) {
    console.log('✅ 已是嵌入式連結');
    return url;
  }
  
  console.error('❌ 無法轉換 URL');
  return '';
}



/**
 * 更新前端進度條
 */
function updateProgressBar() {
  if (!currentRecordId) return;

  // ✅ 防呆檢查: 如果 currentVideoDuration 無效,使用預設值
  const videoDuration = (currentVideoDuration && currentVideoDuration > 0) 
    ? currentVideoDuration 
    : 180;
  
  const progressPercent = Math.min(100, Math.round((watchedSeconds / videoDuration) * 100));
  
  const progressFill = document.getElementById('progressFill');
  if (progressFill) {
    progressFill.style.width = progressPercent + '%';
    progressFill.textContent = progressPercent + '%';
  }
  
  console.log(`進度更新: ${watchedSeconds}/${videoDuration} 秒 (${progressPercent}%)`);
}


/**
 * 更新進度到伺服器 (只在必要時呼叫)
 */
async function updateProgressToServer(isComplete = false) {
  if (!currentRecordId) return;

  const videoDuration = 180;
  const progressPercent = Math.min(100, Math.round((watchedSeconds / videoDuration) * 100));
  
  const progressData = {
    watchedSeconds: watchedSeconds,
    progress: progressPercent,
    isComplete: isComplete || progressPercent >= 100
  };

  console.log('更新進度到伺服器:', progressData);

  try {
    const result = await callAPI('updateProgress', {
      recordId: currentRecordId,
      progressData: JSON.stringify(progressData)
    });

    if (result && result.success) {
      console.log('✅ 進度更新成功');
    } else {
      console.error('❌ 進度更新失敗:', result?.message);
    }
  } catch (error) {
    console.error('❌ 更新進度失敗:', error);
  }
}

/**
 * 更新進度到伺服器 (只在必要時呼叫)
 */
async function updateProgressToServer(isComplete = false) {
  if (!currentRecordId) return;

  const videoDuration = 180;
  const progressPercent = Math.min(100, Math.round((watchedSeconds / videoDuration) * 100));
  
  const progressData = {
    watchedSeconds: watchedSeconds,
    progress: progressPercent,
    isComplete: isComplete || progressPercent >= 100
  };

  console.log('更新進度到伺服器:', progressData);

  try {
    const result = await callAPI('updateProgress', {
      recordId: currentRecordId,
      progressData: JSON.stringify(progressData)  // ✅ 轉換成 JSON 字串
    });

    if (result && result.success) {
      console.log('✅ 進度更新成功');
    } else {
      console.error('❌ 進度更新失敗:', result?.message);
    }
  } catch (error) {
    console.error('❌ 更新進度失敗:', error);
  }
}



    function backToCourses() {
      if (videoCheckInterval) clearInterval(videoCheckInterval);
      navigateToPage('courses');
    }
/**
 * 生成學習建議 UI
 */
async function generateLearningAdviceUI(reportData) {
  try {
    const adviceContainer = document.getElementById('learningAdvice');
    adviceContainer.innerHTML = '<div class="loading-advice"><i class="fas fa-spinner fa-spin"></i> Sophia 正在分析您的學習數據...</div>';
    
    // ✅ 呼叫後端 API 生成建議
    const result = await callAPI('generateLearningAdvice', {
      reportData: JSON.stringify(reportData)
    });
    
    if (result && result.success) {
      adviceContainer.innerHTML = '<div class="advice-content">' + result.data.advice + '</div>';
    } else {
      adviceContainer.innerHTML = '<div class="advice-content"><p>⚠️ 無法生成學習建議，請稍後再試。</p></div>';
    }
    
  } catch(error) {
    console.error('❌ generateLearningAdviceUI 失敗:', error);
    document.getElementById('learningAdvice').innerHTML = '<div class="advice-content"><p>⚠️ 無法生成學習建議，請稍後再試。</p></div>';
  }
}

// ==================== 測驗 ==================== 

/**
 * 開始測驗
 */
async function startExam() {
  console.log('=== startExam 開始 ===');
  console.log('currentCourse:', currentCourse);
  console.log('currentRecordId:', currentRecordId);
  
  // ✅ 防呆檢查 1: currentCourse 是否存在
  if (!currentCourse) {
    console.error('❌ currentCourse 未定義');
    showAlert('課程資料遺失,請重新開始學習', 'error');
    backToCourses();
    return;
  }
  
  // ✅ 防呆檢查 2: currentRecordId 是否存在
  if (!currentRecordId) {
    console.error('❌ currentRecordId 未定義');
    showAlert('學習紀錄遺失,請重新開始學習', 'error');
    backToCourses();
    return;
  }
  
  console.log('✅ 檢查通過,開始取得測驗題目');
  
  showLoading();
  
  try {
    // ✅ 呼叫 API 取得隨機題目
    const result = await callAPI('getRandomQuestions', {
      courseId: currentCourse.courseId
    });
    
    console.log('API 回應:', result);
    
    hideLoading();
    
    if (result && result.success) {
      currentExamQuestions = result.data;
      
      console.log('✅ 成功取得 ' + currentExamQuestions.length + ' 筆題目');
      
      if (currentExamQuestions.length === 0) {
        showAlert('此課程尚無測驗題目', 'warning');
        return;
      }
      
      // ✅ 導航到測驗頁面
      navigateToPage('exam');
      displayExam();
    } else {
      console.error('❌ API 回應失敗:', result?.message);
      showAlert(result?.message || '取得測驗題目失敗', 'error');
    }
  } catch (error) {
    console.error('❌ startExam 失敗:', error);
    hideLoading();
    showAlert('取得測驗題目失敗', 'error');
  }
}

/**
 * 顯示測驗題目
 */
function displayExam() {
  console.log('=== displayExam 開始 ===');
  console.log('currentExamQuestions:', currentExamQuestions);
  
  document.getElementById('examCourseTitle').textContent = currentCourse.courseName + ' - 測驗';
  
  const questionsHTML = currentExamQuestions.map((q, index) => `
    <div class="question-card">
      <span class="question-number">第 ${index + 1} 題</span>
      <div class="question-text">${q.questionText}</div>
      <div class="options-list">
        <div class="option-item">
          <input type="radio" name="question_${q.questionId}" value="A" id="q${index}_a">
          <label for="q${index}_a">${q.optionA}</label>
        </div>
        <div class="option-item">
          <input type="radio" name="question_${q.questionId}" value="B" id="q${index}_b">
          <label for="q${index}_b">${q.optionB}</label>
        </div>
        <div class="option-item">
          <input type="radio" name="question_${q.questionId}" value="C" id="q${index}_c">
          <label for="q${index}_c">${q.optionC}</label>
        </div>
        <div class="option-item">
          <input type="radio" name="question_${q.questionId}" value="D" id="q${index}_d">
          <label for="q${index}_d">${q.optionD}</label>
        </div>
      </div>
    </div>
  `).join('');

  document.getElementById('examQuestions').innerHTML = questionsHTML;
  
  console.log('✅ 測驗題目顯示完成');
}

/**
 * 提交測驗
 */
async function submitExam() {
  console.log('=== submitExam 開始 ===');
  console.log('currentRecordId:', currentRecordId);
  console.log('currentExamQuestions:', currentExamQuestions);
  
  // ✅ 收集答案
  const answers = {};
  let allAnswered = true;

  currentExamQuestions.forEach(q => {
    const selected = document.querySelector(`input[name="question_${q.questionId}"]:checked`);
    if (selected) {
      answers[q.questionId] = selected.value;
      console.log(`題目 ${q.questionId}: 選擇 ${selected.value}`);
    } else {
      allAnswered = false;
      console.log(`題目 ${q.questionId}: 未作答`);
    }
  });

  if (!allAnswered) {
    showAlert('請回答所有題目', 'warning');
    return;
  }
  
  console.log('✅ 所有題目已作答');
  console.log('答案:', answers);
  
  showLoading();
  
  try {
    // ✅ 提交測驗
    const result = await callAPI('submitExam', {
      courseId: currentCourse.courseId,
      recordId: currentRecordId,
      answers: JSON.stringify(answers)
    });
    
    console.log('API 回應:', result);
    
    hideLoading();

    if (result && result.success) {
      console.log('✅ 測驗提交成功');
      displayExamResult(result.data);
    } else {
      console.error('❌ 測驗提交失敗:', result?.message);
      showAlert(result?.message || '提交失敗', 'error');
    }
  } catch (error) {
    console.error('❌ submitExam 失敗:', error);
    hideLoading();
    showAlert('提交失敗', 'error');
  }
}

/**
 * 顯示測驗結果
 */
function displayExamResult(resultData) {
  console.log('=== displayExamResult ===');
  console.log('resultData:', resultData);
  
  const modal = document.getElementById('examResultModal');
  const isPassed = resultData.isPassed;

  // 更新圖示和標題
  const icon = document.getElementById('resultIcon');
  const title = document.getElementById('resultTitle');
  
  if (isPassed) {
    icon.className = 'result-icon pass';
    icon.innerHTML = '<i class="fas fa-check-circle"></i>';
    title.textContent = '恭喜通過測驗!';
  } else {
    icon.className = 'result-icon fail';
    icon.innerHTML = '<i class="fas fa-times-circle"></i>';
    title.textContent = '測驗未通過';
  }

  // 更新分數
  document.getElementById('resultScore').textContent = resultData.score + ' 分';
  document.getElementById('resultCorrect').textContent = resultData.correctCount;
  document.getElementById('resultTotal').textContent = resultData.totalQuestions;
  document.getElementById('resultPassScore').textContent = resultData.passScore;

  // 顯示獲得點數
  const pointsRow = document.getElementById('resultPointsRow');
  if (isPassed) {
    pointsRow.style.display = 'flex';
    document.getElementById('resultPoints').textContent = resultData.earnedPoints || 0;
  } else {
    pointsRow.style.display = 'none';
  }

  // ✅ 新增：顯示錯誤題目檢討
  displayWrongAnswers(resultData.answerDetails);

  // ✅ 新增：控制按鈕顯示
  const btnRetakeExam = document.getElementById('btnRetakeExam');
  const btnBackToCourses = document.getElementById('btnBackToCourses');
  
  if (isPassed) {
    // 通過：顯示【返回課程列表】按鈕
    btnRetakeExam.style.display = 'none';
    btnBackToCourses.style.display = 'inline-block';
    currentCourse.isCompleted = true;
  } else {
    // 未通過：顯示【重新測驗】按鈕
    btnRetakeExam.style.display = 'inline-block';
    btnBackToCourses.style.display = 'none';
  }

  modal.classList.add('active');
  
  console.log('✅ 測驗結果顯示完成');
}

/**
 * 顯示錯誤題目檢討
 */
function displayWrongAnswers(answerDetails) {
  console.log('=== displayWrongAnswers ===');
  console.log('answerDetails:', answerDetails);
  
  if (!answerDetails || answerDetails.length === 0) {
    console.log('⚠️ 沒有答案詳情');
    return;
  }
  
  // 篩選出錯誤的題目
  const wrongAnswers = answerDetails.filter(detail => !detail.isCorrect);
  
  console.log('錯誤題目數量:', wrongAnswers.length);
  
  const wrongAnswersSection = document.getElementById('wrongAnswersSection');
  const wrongAnswersList = document.getElementById('wrongAnswersList');
  
  if (wrongAnswers.length === 0) {
    // 全部答對，隱藏檢討區塊
    wrongAnswersSection.style.display = 'none';
    return;
  }
  
  // 顯示檢討區塊
  wrongAnswersSection.style.display = 'block';
  
  // 建立錯誤題目列表
  wrongAnswersList.innerHTML = wrongAnswers.map((detail, index) => {
    // 從 currentExamQuestions 找到完整題目資訊
    const question = currentExamQuestions.find(q => q.questionId === detail.questionId);
    
    if (!question) {
      console.log('⚠️ 找不到題目:', detail.questionId);
      return '';
    }
    
    // 取得選項文字
    const yourAnswerText = question['option' + detail.userAnswer] || detail.userAnswer;
    const correctAnswerText = question['option' + detail.correctAnswer] || detail.correctAnswer;
    
    return `
      <div class="wrong-answer-item">
        <span class="question-number">第 ${index + 1} 題</span>
        <div class="question-text">${question.questionText}</div>
        
        <div class="answer-row your-answer">
          <span class="answer-label wrong">
            <i class="fas fa-times-circle"></i> 您的答案
          </span>
          <span class="answer-value">
            <strong>${detail.userAnswer}.</strong> ${yourAnswerText}
          </span>
          <span class="answer-icon wrong">
            <i class="fas fa-times"></i>
          </span>
        </div>
        
        <div class="answer-row correct-answer">
          <span class="answer-label correct">
            <i class="fas fa-check-circle"></i> 正確答案
          </span>
          <span class="answer-value">
            <strong>${detail.correctAnswer}.</strong> ${correctAnswerText}
          </span>
          <span class="answer-icon correct">
            <i class="fas fa-check"></i>
          </span>
        </div>
      </div>
    `;
  }).join('');
  
  console.log('✅ 錯誤題目檢討顯示完成');
}

/**
 * 重新測驗
 */
function retakeExam() {
  console.log('=== retakeExam ===');
  
  // 關閉測驗結果 Modal
  document.getElementById('examResultModal').classList.remove('active');
  
  // 重新開始測驗
  startExam();
}

/**
 * 關閉測驗結果並返回課程列表
 */
function closeExamResultAndBackToCourses() {
  console.log('=== closeExamResultAndBackToCourses ===');
  
  // 關閉測驗結果 Modal
  document.getElementById('examResultModal').classList.remove('active');
  
  // 停止計時器
  if (videoCheckInterval) {
    clearInterval(videoCheckInterval);
    videoCheckInterval = null;
  }
  
  // 重置觀看秒數
  watchedSeconds = 0;
  
  // 隱藏時間資訊區塊
  const videoTimeInfo = document.getElementById('videoTimeInfo');
  if (videoTimeInfo) {
    videoTimeInfo.style.display = 'none';
  }
  
  // 返回課程列表
  navigateToPage('courses');
  loadCourses();
}


/**
 * 關閉測驗結果 Modal（只關閉，不返回課程列表）
 */
function closeExamResultModal() {
  console.log('=== closeExamResultModal ===');
  
  document.getElementById('examResultModal').classList.remove('active');
  
  // ✅ 如果測驗通過，才返回課程列表
  if (currentCourse && currentCourse.isCompleted) {
    console.log('✅ 測驗通過，返回課程列表');
    
    // 停止計時器
    if (videoCheckInterval) {
      clearInterval(videoCheckInterval);
      videoCheckInterval = null;
    }
    
    // 重置觀看秒數
    watchedSeconds = 0;
    
    // 隱藏時間資訊區塊
    const videoTimeInfo = document.getElementById('videoTimeInfo');
    if (videoTimeInfo) {
      videoTimeInfo.style.display = 'none';
    }
    
    navigateToPage('courses');
    loadCourses();
  } else {
    console.log('⚠️ 測驗未通過，留在測驗頁面');
    // 留在測驗頁面，讓使用者可以重新測驗
  }
}


/**
 * 返回課程播放頁面
 */
function backToPlayer() {
  navigateToPage('player');
}


    function closeExamResultModal() {
      document.getElementById('examResultModal').classList.remove('active');
      
      // 返回課程列表
      if (videoCheckInterval) clearInterval(videoCheckInterval);
      navigateToPage('courses');
      loadCourses();
    }

    function backToPlayer() {
      navigateToPage('player');
    }

    // ==================== 我的學習 ==================== 
/**
 * 載入我的學習（使用快取）
 */
async function loadMyLearning(forceRefresh = false) {
  try {
    console.log('=== loadMyLearning ===');
    console.log('forceRefresh:', forceRefresh);
    
    // ✅ 檢查是否已預載入
    if (!forceRefresh && PreloadManager.status.myLearning && PreloadManager.data.myLearning) {
      console.log('⚡ 使用預載入的我的學習資料');
      const { learningRecords, pointRecords } = PreloadManager.data.myLearning;
      displayMyLearningRecords(learningRecords);
      displayMyPointRecords(pointRecords);
      return;
    }

    // ✅ 原有的載入邏輯...
    if (forceRefresh) {
      CacheManager.clear('getLearningRecords_{}');
      CacheManager.clear('getPointRecords_{"empId":"' + currentUser.empId + '"}');
    }
    
    const recordsResult = await callAPIWithCache('getLearningRecords', {}, !forceRefresh);
    
    if (recordsResult && recordsResult.success) {
      displayMyLearningRecords(recordsResult.data);
    }

    const pointsResult = await callAPIWithCache('getPointRecords', {
      empId: currentUser.empId
    }, !forceRefresh);

    if (pointsResult && pointsResult.success) {
      displayMyPointRecords(pointsResult.data);
    }
  } catch(error) {
    console.error('❌ loadMyLearning 失敗:', error);
    showAlert('載入學習紀錄失敗', 'error');
  }
}


function displayMyLearningRecords(records) {
  const tbody = document.getElementById('myLearningRecords');
  
  if (records.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">尚無學習紀錄</td></tr>';
    return;
  }

  // ✅ 根據開始時間降序排列
  const sortedRecords = records.sort((a, b) => {
    const timeA = new Date(a.startTime || 0).getTime();
    const timeB = new Date(b.startTime || 0).getTime();
    return timeB - timeA;
  });

  // ✅ 分割為前5筆和其餘
  const visibleRecords = sortedRecords.slice(0, 5);
  const hiddenRecords = sortedRecords.slice(5);

  // ✅ 建立表格內容
  const visibleHTML = visibleRecords.map(record => `
    <tr class="learning-record-row">
      <td>${record.courseName}</td>
      <td>${record.startTime || '-'}</td>
      <td>${record.completeTime || '-'}</td>
      <td>${record.examScore !== null ? record.examScore + ' 分' : '-'}</td>
      <td>${record.earnedPoints || 0} 點</td>
      <td>
        ${record.isCompleted 
          ? '<span class="status-badge pass">已完成</span>' 
          : '<span class="status-badge active">進行中</span>'}
      </td>
    </tr>
  `).join('');

  const hiddenHTML = hiddenRecords.map(record => `
    <tr class="learning-record-row learning-record-hidden" style="display: none;">
      <td>${record.courseName}</td>
      <td>${record.startTime || '-'}</td>
      <td>${record.completeTime || '-'}</td>
      <td>${record.examScore !== null ? record.examScore + ' 分' : '-'}</td>
      <td>${record.earnedPoints || 0} 點</td>
      <td>
        ${record.isCompleted 
          ? '<span class="status-badge pass">已完成</span>' 
          : '<span class="status-badge active">進行中</span>'}
      </td>
    </tr>
  `).join('');

  // ✅ 建立收折按鈕
  const toggleButtonHTML = hiddenRecords.length > 0 ? `
    <tr id="learningRecordToggleRow">
      <td colspan="6" style="text-align: center; padding: 15px; background: var(--light-color);">
        <button id="btnToggleLearningRecords" class="btn btn-secondary btn-sm" onclick="toggleLearningRecords()">
          <i class="fas fa-chevron-down"></i> 顯示更多 (還有 ${hiddenRecords.length} 筆)
        </button>
      </td>
    </tr>
  ` : '';

  // ✅ 組合所有內容
  tbody.innerHTML = visibleHTML + hiddenHTML + toggleButtonHTML;
  
  // ❌ 移除前端自行加總的代碼
  // const totalPoints = records.reduce((sum, r) => sum + (r.earnedPoints || 0), 0);
  // document.getElementById('totalPoints').textContent = totalPoints;
}


/**
 * 切換學習紀錄顯示/隱藏
 */
function toggleLearningRecords() {
  console.log('=== toggleLearningRecords ===');
  
  const hiddenRows = document.querySelectorAll('.learning-record-hidden');
  const button = document.getElementById('btnToggleLearningRecords');
  
  if (!button || hiddenRows.length === 0) {
    console.log('⚠️ 找不到隱藏的紀錄或按鈕');
    return;
  }
  
  // ✅ 檢查當前狀態
  const isHidden = hiddenRows[0].style.display === 'none';
  
  if (isHidden) {
    // ✅ 展開：顯示所有隱藏的紀錄
    hiddenRows.forEach((row, index) => {
      setTimeout(() => {
        row.style.display = 'table-row';
        row.style.animation = 'fadeIn 0.3s ease';
      }, index * 50); // 逐行展開動畫
    });
    
    // ✅ 更新按鈕文字
    button.innerHTML = '<i class="fas fa-chevron-up"></i> 收起';
    
    console.log('✅ 已展開 ' + hiddenRows.length + ' 筆紀錄');
  } else {
    // ✅ 收起：隱藏所有額外的紀錄
    hiddenRows.forEach(row => {
      row.style.display = 'none';
    });
    
    // ✅ 更新按鈕文字
    button.innerHTML = '<i class="fas fa-chevron-down"></i> 顯示更多 (還有 ' + hiddenRows.length + ' 筆)';
    
    // ✅ 捲動到表格頂部
    const table = document.querySelector('.data-table');
    if (table) {
      table.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    console.log('✅ 已收起 ' + hiddenRows.length + ' 筆紀錄');
  }
}


    function displayMyPointRecords(records) {
      const tbody = document.getElementById('myPointRecords');
      
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center">尚無點數紀錄</td></tr>';
        return;
      }

      tbody.innerHTML = records.map(record => `
        <tr>
          <td>${record.courseName}</td>
          <td>${record.points} 點</td>
          <td>${record.earnedTime}</td>
        </tr>
      `).join('');
    }
    // ==================== 載入下拉選單選項 ====================

    /**
     * 載入課群選項
     */
    async function loadCategoryOptions() {
      try {
        console.log('=== loadCategoryOptions ===');
        
        const result = await callAPI('getCategoryOptions', {});
        
        if (result && result.success) {
          const select = document.getElementById('courseFormCategory');
          
          // 清空現有選項 (保留第一個 "請選擇")
          select.innerHTML = '<option value="">請選擇</option>';
          
          // 新增選項
          result.data.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option.value;        // 代號 (例如: RR)
            opt.textContent = option.label;  // 顯示名稱 (例如: 【新人訓練】)
            select.appendChild(opt);
          });
          
          console.log('✅ 課群選項載入成功,共 ' + result.data.length + ' 個');
        } else {
          showAlert(result?.message || '載入課群選項失敗', 'error');
        }
      } catch (error) {
        console.error('❌ 載入課群選項失敗:', error);
        showAlert('載入課群選項失敗', 'error');
      }
    }

    /**
     * 載入課門選項
     */
    async function loadSubjectOptions() {
      try {
        console.log('=== loadSubjectOptions ===');
        
        const result = await callAPI('getSubjectOptions', {});
        
        if (result && result.success) {
          const select = document.getElementById('courseFormSubject');
          
          // 清空現有選項 (保留第一個 "請選擇")
          select.innerHTML = '<option value="">請選擇</option>';
          
          // 新增選項
          result.data.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option.value;        // 代號 (例如: doc)
            opt.textContent = option.label;  // 顯示名稱 (例如: 文書工具)
            select.appendChild(opt);
          });
          
          console.log('✅ 課門選項載入成功,共 ' + result.data.length + ' 個');
        } else {
          showAlert(result?.message || '載入課門選項失敗', 'error');
        }
      } catch (error) {
        console.error('❌ 載入課門選項失敗:', error);
        showAlert('載入課門選項失敗', 'error');
      }
    }

    // ==========================================
// Sophia學習沙龍 - JavaScript 函數
// ==========================================

/**
 * 當前選擇的排行榜時間範圍
 */
let currentRankingPeriod = 'week';

/**
 * 導航到 Sophia 頁面
 */
function navigateToSophia() {
  navigateToPage('sophia');
  loadSophiaData();
}

/**
 * 載入 Sophia 頁面資料
 */
async function loadSophiaData() {
  try {
    console.log('=== loadSophiaData ===');
    
    showLoading();
    
    // ✅ 取得時間範圍
    const timeRange = getTimeRange();
    
    if (!timeRange) {
      hideLoading();
      return;
    }
    
    console.log('時間範圍:', timeRange);
    
    // ✅ 並行載入所有資料
    const [
      behaviorData,
      rankingData,
      reportData,
      achievementsData
    ] = await Promise.all([
      callAPI('getSophiaBehaviorData', {
        startDate: timeRange.startDate,
        endDate: timeRange.endDate
      }),
      callAPI('getSophiaRankingData', { 
        period: currentRankingPeriod 
      }),
      callAPI('getSophiaReportData', {
        startDate: timeRange.startDate,
        endDate: timeRange.endDate
      }),
      callAPI('getSophiaAchievements', {})
    ]);
    
    hideLoading();
    
    // ✅ 渲染各個區塊
    if (behaviorData && behaviorData.success) {
      renderBehaviorAnalysis(behaviorData.data);
    }
    
    if (rankingData && rankingData.success) {
      renderRankings(rankingData.data);
    }
    
    if (reportData && reportData.success) {
      renderReport(reportData.data);
    }
    
    if (achievementsData && achievementsData.success) {
      renderAchievements(achievementsData.data);
    }
    
    // ✅ 生成學習建議
    if (reportData && reportData.success) {
      generateLearningAdviceUI(reportData.data);
    }
    
  } catch(error) {
    console.error('❌ loadSophiaData 失敗:', error);
    hideLoading();
    showAlert('載入資料失敗', 'error');
  }
}


/**
 * 取得時間範圍
 */
function getTimeRange() {
  const timeRangeSelect = document.getElementById('sophiaTimeRange');
  const selectedRange = timeRangeSelect.value;
  
  const now = new Date();
  let startDate, endDate;
  
  switch(selectedRange) {
    case '1month':
      startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
      endDate = now;
      break;
      
    case '3months':
      startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
      endDate = now;
      break;
      
    case '6months':
      startDate = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
      endDate = now;
      break;
      
    case '1year':
      startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
      endDate = now;
      break;
      
    case 'custom':
      const startInput = document.getElementById('sophiaStartDate').value;
      const endInput = document.getElementById('sophiaEndDate').value;
      
      if (!startInput || !endInput) {
        showAlert('請選擇開始和結束日期', 'warning');
        return null;
      }
      
      startDate = new Date(startInput);
      endDate = new Date(endInput);
      break;
      
    default:
      startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
      endDate = now;
  }
  
  return {
    startDate: formatDate(startDate),
    endDate: formatDate(endDate)
  };
}

/**
 * 渲染個人學習行為分析
 */
function renderBehaviorAnalysis(data) {
  console.log('=== renderBehaviorAnalysis ===');
  console.log('data:', data);
  
  // 1. 觀看時段分析（折線圖）
  renderWatchTimeChart(data.watchTimeData);
  
  // 2. 停留時間分析
  document.getElementById('totalStayTime').textContent = formatHours(data.totalStayTime);
  document.getElementById('effectiveTime').textContent = formatHours(data.effectiveTime);
  document.getElementById('avgSessionTime').textContent = formatMinutes(data.avgSessionTime);
  
  // 3. 學習習慣分析
  renderWeekdayChart(data.weekdayData);
  renderCourseTypeChart(data.courseTypeData);
}

/**
 * 繪製觀看時段分析圖表
 */
function renderWatchTimeChart(data) {
  const ctx = document.getElementById('watchTimeChart');
  
  if (window.watchTimeChartInstance) {
    window.watchTimeChartInstance.destroy();
  }
  
  window.watchTimeChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: '每日觀看時數（小時）',
        data: data.values,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37, 99, 235, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 5,
        pointHoverRadius: 8,
        pointBackgroundColor: '#2563eb',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13 },
          callbacks: {
            label: function(context) {
              return '觀看時數: ' + context.parsed.y.toFixed(1) + ' 小時';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value + ' 小時';
            }
          }
        }
      }
    }
  });
}

/**
 * 繪製星期幾分析圖表
 */
function renderWeekdayChart(data) {
  const ctx = document.getElementById('weekdayChart');
  
  if (window.weekdayChartInstance) {
    window.weekdayChartInstance.destroy();
  }
  
  window.weekdayChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: data.labels,
      datasets: [{
        data: data.values,
        backgroundColor: [
          '#ef4444',
          '#f59e0b',
          '#10b981',
          '#06b6d4',
          '#6366f1',
          '#8b5cf6',
          '#ec4899'
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 10,
            font: { size: 11 }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed / total) * 100).toFixed(1);
              return context.label + ': ' + context.parsed + ' 次 (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
}

/**
 * 繪製課程類型分析圖表
 */
function renderCourseTypeChart(data) {
  const ctx = document.getElementById('courseTypeChart');
  
  if (window.courseTypeChartInstance) {
    window.courseTypeChartInstance.destroy();
  }
  
  window.courseTypeChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: data.labels,
      datasets: [{
        data: data.values,
        backgroundColor: [
          '#2563eb',
          '#10b981',
          '#f59e0b',
          '#ef4444',
          '#8b5cf6',
          '#06b6d4'
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 10,
            font: { size: 11 }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed / total) * 100).toFixed(1);
              return context.label + ': ' + context.parsed + ' 次 (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
}

/**
 * 切換排行榜時間範圍
 */
function switchRankingPeriod(period) {
  currentRankingPeriod = period;
  
  // 更新標籤樣式
  document.querySelectorAll('.ranking-tab').forEach(tab => {
    tab.classList.remove('active');
    if (tab.dataset.period === period) {
      tab.classList.add('active');
    }
  });
  
  // 重新載入排行榜
  loadRankingData();
}

/**
 * 載入排行榜資料
 */
async function loadRankingData() {
  try {
    showLoading();
    
    const result = await callAPI('getSophiaRankingData', { 
      period: currentRankingPeriod 
    });
    
    hideLoading();
    
    if (result && result.success) {
      renderRankings(result.data);
    }
  } catch(error) {
    console.error('❌ loadRankingData 失敗:', error);
    hideLoading();
  }
}

/**
 * 渲染排行榜
 */
function renderRankings(data) {
  console.log('=== renderRankings ===');
  console.log('data:', data);
  
  // 1. 觀看次數排行
  renderRankingList('viewCountRanking', data.viewCount, (item) => item.count + ' 次');
  
  // 2. 完成率排行
  renderRankingList('completionRateRanking', data.completionRate, (item) => item.rate + '%');
  
  // 3. 平均分數排行
  renderRankingList('avgScoreRanking', data.avgScore, (item) => item.score + ' 分');
  
  // 4. 學習時長排行
  renderRankingList('studyTimeRanking', data.studyTime, (item) => formatHours(item.hours));
}

/**
 * 渲染單個排行榜列表
 */
function renderRankingList(containerId, data, valueFormatter) {
  const container = document.getElementById(containerId);
  
  if (!data || data.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">暫無資料</p>';
    return;
  }
  
  container.innerHTML = data.map((item, index) => {
    const rank = index + 1;
    let rankClass = 'other';
    
    if (rank === 1) rankClass = 'top1';
    else if (rank === 2) rankClass = 'top2';
    else if (rank === 3) rankClass = 'top3';
    
    return `
      <div class="ranking-item">
        <div class="rank ${rankClass}">${rank}</div>
        <div class="course-name">${item.courseName}</div>
        <div class="value">${valueFormatter(item)}</div>
      </div>
    `;
  }).join('');
}

/**
 * 渲染學習成效報表
 */
function renderReport(data) {
  console.log('=== renderReport ===');
  console.log('data:', data);
  
  // 1. 學習時數統計
  document.getElementById('reportTotalHours').textContent = formatHours(data.totalHours);
  document.getElementById('reportAvgDailyHours').textContent = formatHours(data.avgDailyHours);
  document.getElementById('reportMonthComparison').textContent = formatComparison(data.monthComparison);
  document.getElementById('reportDeptComparison').textContent = formatComparison(data.deptComparison);
  
  // 更新比較徽章
  updateComparisonBadge('timeComparison', data.monthComparison);
  
  // 2. 課程完成數
  document.getElementById('reportCompleted').textContent = data.completed + ' 門';
  document.getElementById('reportInProgress').textContent = data.inProgress + ' 門';
  document.getElementById('reportNotStarted').textContent = data.notStarted + ' 門';
  document.getElementById('reportRequiredRate').textContent = data.requiredRate + '%';
  
  updateComparisonBadge('courseComparison', data.courseComparison);
  
  // 3. 測驗成績統計
  document.getElementById('reportAvgScore').textContent = data.avgScore + ' 分';
  document.getElementById('reportPassRate').textContent = data.passRate + '%';
  document.getElementById('reportMaxScore').textContent = data.maxScore + ' 分';
  document.getElementById('reportMinScore').textContent = data.minScore + ' 分';
  
  // 4. 點數累積
  document.getElementById('reportMonthPoints').textContent = data.monthPoints + ' 點';
  document.getElementById('reportTotalPoints').textContent = data.totalPoints + ' 點';
  document.getElementById('reportRanking').textContent = data.ranking ? '第 ' + data.ranking + ' 名' : '-';
  document.getElementById('reportDeptRanking').textContent = data.deptRanking ? '第 ' + data.deptRanking + ' 名' : '-';
  
  updateComparisonBadge('pointsComparison', data.pointsComparison);
}

/**
 * 更新比較徽章
 */
function updateComparisonBadge(badgeId, value) {
  const badge = document.getElementById(badgeId);
  
  if (value > 0) {
    badge.className = 'comparison-badge positive';
    badge.innerHTML = '<i class="fas fa-arrow-up"></i> +' + value + '%';
  } else if (value < 0) {
    badge.className = 'comparison-badge negative';
    badge.innerHTML = '<i class="fas fa-arrow-down"></i> ' + value + '%';
  } else {
    badge.className = 'comparison-badge';
    badge.innerHTML = '<i class="fas fa-minus"></i> 0%';
  }
}

/**
 * 生成學習建議（使用 ChatGPT API）
 */
async function generateLearningAdvice(reportData) {
  try {
    console.log('=== generateLearningAdvice ===');
    
    const adviceContainer = document.getElementById('learningAdvice');
    adviceContainer.innerHTML = '<div class="loading-advice"><i class="fas fa-spinner fa-spin"></i> Sophia 正在分析您的學習數據...</div>';
    
    // 呼叫後端 API 生成建議
    const result = await callAPI('generateLearningAdvice', {
      reportData: JSON.stringify(reportData)
    });
    
    if (result && result.success) {
      adviceContainer.innerHTML = '<div class="advice-content">' + result.data.advice + '</div>';
    } else {
      adviceContainer.innerHTML = '<div class="advice-content"><p>⚠️ 無法生成學習建議，請稍後再試。</p></div>';
    }
    
  } catch(error) {
    console.error('❌ generateLearningAdvice 失敗:', error);
    document.getElementById('learningAdvice').innerHTML = '<div class="advice-content"><p>⚠️ 無法生成學習建議，請稍後再試。</p></div>';
  }
}

/**
 * 渲染成就系統
 */
function renderAchievements(data) {
  console.log('=== renderAchievements ===');
  console.log('data:', data);
  
  const container = document.getElementById('achievementsGrid');
  
  if (!data || data.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px; grid-column: 1/-1;">暫無成就</p>';
    return;
  }
  
  container.innerHTML = data.map(achievement => {
    const isUnlocked = achievement.unlocked;
    const badgeClass = isUnlocked ? 'unlocked' : 'locked';
    
    return `
      <div class="achievement-badge ${badgeClass}">
        <div class="badge-icon" style="background: ${achievement.color};">
          <i class="${achievement.icon}"></i>
        </div>
        <div class="badge-name">${achievement.name}</div>
        <div class="badge-desc">${achievement.description}</div>
        ${isUnlocked ? '<div class="unlock-date">✅ ' + achievement.unlockDate + '</div>' : '<div class="unlock-date">🔒 尚未解鎖</div>'}
      </div>
    `;
  }).join('');
}

/**
 * 生成個人月報
 */
async function generatePersonalMonthlyReport() {
  try {
    if (!confirm('確定要生成個人月報並寄送到您的 Email 嗎？')) {
      return;
    }
    
    showLoading();
    
    const result = await callAPI('generatePersonalMonthlyReport', {});
    
    hideLoading();
    
    if (result && result.success) {
      showAlert('個人月報已生成並寄送到您的 Email！', 'success');
    } else {
      showAlert(result?.message || '生成失敗', 'error');
    }
    
  } catch(error) {
    console.error('❌ generatePersonalMonthlyReport 失敗:', error); 
    hideLoading();
    showAlert('生成失敗', 'error');
  }
}

/**
 * 生成部門月報
 */
async function generateDepartmentMonthlyReport() {
  try {
    if (!checkPermission(sessionToken, PERMISSION_LEVELS.DEPT_MANAGER)) {
      showAlert('您沒有權限生成部門月報（需要 s2 以上權限）', 'error');
      return;
    }
    
    if (!confirm('確定要生成部門月報並寄送到您的 Email 嗎？')) {
      return;
    }
    
    showLoading();
    
    const result = await callAPI('generateDepartmentMonthlyReport', {});
    
    hideLoading();
    
    if (result && result.success) {
      showAlert('部門月報已生成並寄送到您的 Email！', 'success');
    } else {
      showAlert(result?.message || '生成失敗', 'error');
    }
    
  } catch(error) {
    console.error('❌ generateDepartmentMonthlyReport 失敗:', error);
    hideLoading();
    showAlert('生成失敗', 'error');
  }
}

/**
 * 生成公司季報
 */
async function generateCompanyQuarterlyReport() {
  try {
    if (!checkPermission(sessionToken, PERMISSION_LEVELS.ADMIN)) {
      showAlert('您沒有權限生成公司季報（需要 s4 權限）', 'error');
      return;
    }
    
    if (!confirm('確定要生成公司季報並寄送到您的 Email 嗎？')) {
      return;
    }
    
    showLoading();
    
    const result = await callAPI('generateCompanyQuarterlyReport', {});
    
    hideLoading();
    
    if (result && result.success) {
      showAlert('公司季報已生成並寄送到您的 Email！', 'success');
    } else {
      showAlert(result?.message || '生成失敗', 'error');
    }
    
  } catch(error) {
    console.error('❌ generateCompanyQuarterlyReport 失敗:', error);
    hideLoading();
    showAlert('生成失敗', 'error');
  }
}

/**
 * 格式化小時數
 */
function formatHours(hours) {
  if (!hours || hours === 0) return '0 小時';
  
  if (hours < 1) {
    return Math.round(hours * 60) + ' 分鐘';
  }
  
  return hours.toFixed(1) + ' 小時';
}

/**
 * 格式化分鐘數
 */
function formatMinutes(minutes) {
  if (!minutes || minutes === 0) return '0 分鐘';
  
  if (minutes >= 60) {
    const hours = Math.floor(minutes / 60);
    const mins = Math.round(minutes % 60);
    return hours + ' 小時 ' + mins + ' 分鐘';
  }
  
  return Math.round(minutes) + ' 分鐘';
}

/**
 * 格式化比較百分比
 */
function formatComparison(value) {
  if (value > 0) {
    return '↑ +' + value + '%';
  } else if (value < 0) {
    return '↓ ' + value + '%';
  } else {
    return '→ 0%';
  }
}

/**
 * 監聽時間範圍選擇器
 */
document.addEventListener('DOMContentLoaded', function() {
  const timeRangeSelect = document.getElementById('sophiaTimeRange');
  
  if (timeRangeSelect) {
    timeRangeSelect.addEventListener('change', function() {
      const customDateRange = document.getElementById('customDateRange');
      
      if (this.value === 'custom') {
        customDateRange.style.display = 'flex';
      } else {
        customDateRange.style.display = 'none';
        loadSophiaData();
      }
    });
  }
});

    // ==================== 管理後台 ==================== 
    function switchAdminTab(tabName) {
      // 更新標籤樣式
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        }
      });

      // 切換面板
      document.querySelectorAll('.admin-panel').forEach(panel => {
        panel.classList.remove('active');
      });

      const targetPanel = document.getElementById('admin' + capitalize(tabName) + 'Panel');
      if (targetPanel) {
        targetPanel.classList.add('active');
      }

      // 載入對應資料
      switch(tabName) {
        case 'courses':
          loadAdminCourses();
          break;
        case 'questions':
          loadAdminQuestions();
          break;
        case 'accounts':
          loadAdminAccounts();
          break;
        case 'records':
          loadAdminRecords();
          break;
        case 'announcements':
          loadAdminAnnouncements();
          break;
        case 'settings':
          loadSystemSettings();
          break;
      }
    }

    function loadAdminData() {
      loadAdminCourses();
    }

    // ==================== 課程管理 ==================== 
    async function loadAdminCourses() {
      const result = await callAPI('getAllCourses');

      if (result && result.success) {
        displayAdminCourses(result.data);
      }
    }

function displayAdminCourses(courses) {
  const tbody = document.getElementById('adminCoursesList');
  
  if (courses.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center">尚無課程</td></tr>';
    return;
  }

  tbody.innerHTML = courses.map(course => `
    <tr>
      <td>${course.courseId}</td>
      <td>${course.courseGroup}</td>        <!-- ✅ 已修正 -->
      <td>${course.courseCategory}</td>     <!-- ✅ 已修正 -->
      <td>${course.courseName}</td>         <!-- ✅ 已修正 -->
      <td>${course.points}</td>
      <td>${course.deadline || '-'}</td>
      <td>
        <span class="status-badge ${course.status === '啟用' ? 'active' : 'inactive'}">
          ${course.status}
        </span>
      </td>
      <td>
        <div class="action-buttons">
          <button class="btn-icon btn-primary" onclick="editCourse('${course.courseId}')" title="編輯">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn-icon btn-danger" onclick="deleteCourse('${course.courseId}')" title="刪除">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}


async function showAddCourseModal() {
  document.getElementById('courseModalTitle').textContent = '新增課程';
  document.getElementById('courseForm').reset();
  document.getElementById('courseFormId').value = '';
  
  // ✅ 清空部門+個人輸入框
  document.getElementById('courseFormRequiredDepts').value = '';
  document.getElementById('courseFormRequiredIndividuals').value = '';
  document.getElementById('courseFormOptionalDepts').value = '';
  document.getElementById('courseFormOptionalIndividuals').value = '';
  
  // ✅ 載入下拉選單選項
  await loadCategoryOptions();
  await loadSubjectOptions();
  
  document.getElementById('courseModal').classList.add('active');
}



async function editCourse(courseId) {
  // ✅ 先載入下拉選單選項
  await loadCategoryOptions();
  await loadSubjectOptions();
  
  const result = await callAPI('getCourseDetail', { courseId });

  if (result && result.success) {
    const course = result.data;
    
    document.getElementById('courseModalTitle').textContent = '編輯課程';
    document.getElementById('courseFormId').value = course.courseId;
    document.getElementById('courseFormCategory').value = course.courseGroup;
    document.getElementById('courseFormSubject').value = course.courseCategory;
    document.getElementById('courseFormName').value = course.courseName;
    document.getElementById('courseFormDesc').value = course.courseDesc || '';
    document.getElementById('courseFormVideo').value = course.videoUrl;
    
    // ✅ 解析必修對象（支援新舊格式）
    const required = parseTargetAudienceFrontend(course.requiredDepts);
    document.getElementById('courseFormRequiredDepts').value = required.departments.join(',');
    document.getElementById('courseFormRequiredIndividuals').value = required.individuals.join(',');
    
    // ✅ 解析選修對象（支援新舊格式）
    const optional = parseTargetAudienceFrontend(course.optionalDepts);
    document.getElementById('courseFormOptionalDepts').value = optional.departments.join(',');
    document.getElementById('courseFormOptionalIndividuals').value = optional.individuals.join(',');
    
    document.getElementById('courseFormStart').value = course.startDate ? course.startDate.split(' ')[0] : '';
    document.getElementById('courseFormDeadline').value = course.deadline ? course.deadline.split(' ')[0] : '';
    document.getElementById('courseFormPoints').value = course.points;
    document.getElementById('courseFormPrerequisite').value = course.prerequisiteCourseID || '';
    
    document.getElementById('courseModal').classList.add('active');
  }
}



async function saveCourse() {
  const courseId = document.getElementById('courseFormId').value;
  
  // ✅ 解析部門和個人輸入
  const requiredDeptsInput = document.getElementById('courseFormRequiredDepts').value.trim();
  const requiredIndividualsInput = document.getElementById('courseFormRequiredIndividuals').value.trim();
  const optionalDeptsInput = document.getElementById('courseFormOptionalDepts').value.trim();
  const optionalIndividualsInput = document.getElementById('courseFormOptionalIndividuals').value.trim();
  
  // ✅ 轉換為陣列
  const requiredDepts = requiredDeptsInput ? requiredDeptsInput.split(',').map(d => d.trim()).filter(d => d) : [];
  const requiredIndividuals = requiredIndividualsInput ? requiredIndividualsInput.split(',').map(i => i.trim()).filter(i => i) : [];
  const optionalDepts = optionalDeptsInput ? optionalDeptsInput.split(',').map(d => d.trim()).filter(d => d) : [];
  const optionalIndividuals = optionalIndividualsInput ? optionalIndividualsInput.split(',').map(i => i.trim()).filter(i => i) : [];
  
  const courseData = {
    categoryCode: document.getElementById('courseFormCategory').value,
    subjectCode: document.getElementById('courseFormSubject').value,
    courseName: document.getElementById('courseFormName').value,
    courseDesc: document.getElementById('courseFormDesc').value,
    videoUrl: document.getElementById('courseFormVideo').value,
    requiredDepts: requiredDepts,              // ✅ 新增
    requiredIndividuals: requiredIndividuals,  // ✅ 新增
    optionalDepts: optionalDepts,              // ✅ 新增
    optionalIndividuals: optionalIndividuals,  // ✅ 新增
    startDate: document.getElementById('courseFormStart').value,
    deadline: document.getElementById('courseFormDeadline').value,
    points: parseInt(document.getElementById('courseFormPoints').value),
    prerequisiteCourseId: document.getElementById('courseFormPrerequisite').value
  };

  const action = courseId ? 'updateCourse' : 'createCourse';
  const data = courseId ? { courseId, courseData: JSON.stringify(courseData) } : { courseData: JSON.stringify(courseData) };

  const result = await callAPI(action, data);

  if (result && result.success) {
    showAlert(courseId ? '課程更新成功' : '課程新增成功', 'success');
    closeCourseModal();
    loadAdminCourses();
  } else {
    showAlert(result?.message || '操作失敗', 'error');
  }
}



    async function deleteCourse(courseId) {
      if (!confirm('確定要刪除此課程嗎?此操作無法復原!')) return;

      const result = await callAPI('deleteCourse', { courseId });

      if (result && result.success) {
        showAlert('課程刪除成功', 'success');
        loadAdminCourses();
      } else {
        showAlert(result?.message || '刪除失敗', 'error');
      }
    }

    function closeCourseModal() {
      document.getElementById('courseModal').classList.remove('active');
    }

    // ==================== 題目管理 ==================== 
// ==================== 題目管理 ==================== 

/**
 * 載入題目管理的課程選單
 */
async function loadAdminQuestions() {
  console.log('=== loadAdminQuestions ===');
  
  // ✅ 載入課程選項
  const coursesResult = await callAPI('getAllCourses', {});
  
  if (coursesResult && coursesResult.success) {
    const select1 = document.getElementById('adminQuestionCourseFilter');
    const select2 = document.getElementById('questionFormCourse');
    
    const options = coursesResult.data.map(c => 
      `<option value="${c.courseId}">${c.courseId} - ${c.courseName}</option>`
    ).join('');
    
    select1.innerHTML = '<option value="">選擇課程</option>' + options;
    select2.innerHTML = '<option value="">請選擇課程</option>' + options;
    
    console.log('✅ 課程選單載入完成,共 ' + coursesResult.data.length + ' 筆課程');
  } else {
    console.error('❌ 載入課程失敗');
  }
  
  // ✅ 清空題目列表
  displayAdminQuestions([]);
}

/**
 * 當選擇課程時,載入該課程的題目
 */
async function loadAdminQuestionsByCourse() {
  const courseSelect = document.getElementById('adminQuestionCourseFilter');
  const selectedCourseId = courseSelect.value;
  
  console.log('=== loadAdminQuestionsByCourse ===');
  console.log('選擇的課程ID:', selectedCourseId);
  
  if (!selectedCourseId) {
    console.log('⚠️ 未選擇課程');
    displayAdminQuestions([]);
    return;
  }
  
  showLoading();
  
  try {
    // ✅ 呼叫 getQuestionList API
    const result = await callAPI('getQuestionList', { 
      courseId: selectedCourseId 
    });
    
    console.log('API 回應:', result);
    
    hideLoading();
    
    if (result && result.success) {
      console.log('✅ 成功取得 ' + result.data.length + ' 筆題目');
      displayAdminQuestions(result.data);
      
      if (result.data.length === 0) {
        showAlert('此課程尚無題目', 'info');
      }
    } else {
      console.error('❌ API 回應失敗:', result?.message);
      showAlert(result?.message || '載入題目失敗', 'error');
      displayAdminQuestions([]);
    }
  } catch (error) {
    console.error('❌ 載入題目失敗:', error);
    hideLoading();
    showAlert('載入題目失敗', 'error');
    displayAdminQuestions([]);
  }
}

/**
 * 顯示題目列表
 */
function displayAdminQuestions(questions) {
  const tbody = document.getElementById('adminQuestionsList');
  
  if (questions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-center">請選擇課程</td></tr>';
    return;
  }

  tbody.innerHTML = questions.map(q => `
    <tr>
      <td>${q.questionId}</td>
      <td>${q.questionText}</td>
      <td>${q.correctAnswer}</td>
      <td>
        <div class="action-buttons">
          <button class="btn-icon btn-primary" onclick="editQuestion('${q.questionId}')" title="編輯">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn-icon btn-danger" onclick="deleteQuestion('${q.questionId}')" title="刪除">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}

/**
 * 顯示新增題目 Modal
 */
function showAddQuestionModal() {
  const courseId = document.getElementById('adminQuestionCourseFilter').value;
  
  if (!courseId) {
    showAlert('請先選擇課程', 'warning');
    return;
  }

  document.getElementById('questionModalTitle').textContent = '新增題目';
  document.getElementById('questionForm').reset();
  document.getElementById('questionFormId').value = '';
  document.getElementById('questionFormCourse').value = courseId;
  document.getElementById('questionModal').classList.add('active');
}

/**
 * 編輯題目
 */
async function editQuestion(questionId) {
  showLoading();
  
  try {
    const result = await callAPI('getQuestionDetail', { questionId });

    hideLoading();

    if (result && result.success) {
      const q = result.data;
      
      document.getElementById('questionModalTitle').textContent = '編輯題目';
      document.getElementById('questionFormId').value = q.questionId;
      document.getElementById('questionFormCourse').value = q.courseId;
      document.getElementById('questionFormText').value = q.questionText;
      document.getElementById('questionFormOptionA').value = q.optionA;
      document.getElementById('questionFormOptionB').value = q.optionB;
      document.getElementById('questionFormOptionC').value = q.optionC;
      document.getElementById('questionFormOptionD').value = q.optionD;
      document.getElementById('questionFormAnswer').value = q.correctAnswer;
      
      document.getElementById('questionModal').classList.add('active');
    } else {
      showAlert(result?.message || '載入題目失敗', 'error');
    }
  } catch (error) {
    console.error('編輯題目失敗:', error);
    hideLoading();
    showAlert('載入題目失敗', 'error');
  }
}

/**
 * 儲存題目
 */
async function saveQuestion() {
  const questionId = document.getElementById('questionFormId').value;
  const questionData = {
    courseId: document.getElementById('questionFormCourse').value,
    questionText: document.getElementById('questionFormText').value,
    optionA: document.getElementById('questionFormOptionA').value,
    optionB: document.getElementById('questionFormOptionB').value,
    optionC: document.getElementById('questionFormOptionC').value,
    optionD: document.getElementById('questionFormOptionD').value,
    correctAnswer: document.getElementById('questionFormAnswer').value
  };

  // ✅ 驗證必填欄位
  if (!questionData.courseId || !questionData.questionText || 
      !questionData.optionA || !questionData.optionB || 
      !questionData.optionC || !questionData.optionD || 
      !questionData.correctAnswer) {
    showAlert('請填寫所有欄位', 'warning');
    return;
  }

  showLoading();

  try {
    const action = questionId ? 'updateQuestion' : 'createQuestion';
    const data = questionId 
      ? { questionId, questionData: JSON.stringify(questionData) } 
      : { questionData: JSON.stringify(questionData) };

    const result = await callAPI(action, data);

    hideLoading();

    if (result && result.success) {
      showAlert(questionId ? '題目更新成功' : '題目新增成功', 'success');
      closeQuestionModal();
      loadAdminQuestionsByCourse(); // ✅ 重新載入題目列表
    } else {
      showAlert(result?.message || '操作失敗', 'error');
    }
  } catch (error) {
    console.error('儲存題目失敗:', error);
    hideLoading();
    showAlert('操作失敗', 'error');
  }
}

/**
 * 刪除題目
 */
async function deleteQuestion(questionId) {
  if (!confirm('確定要刪除此題目嗎?')) return;

  showLoading();

  try {
    const result = await callAPI('deleteQuestion', { questionId });

    hideLoading();

    if (result && result.success) {
      showAlert('題目刪除成功', 'success');
      loadAdminQuestionsByCourse(); // ✅ 重新載入題目列表
    } else {
      showAlert(result?.message || '刪除失敗', 'error');
    }
  } catch (error) {
    console.error('刪除題目失敗:', error);
    hideLoading();
    showAlert('刪除失敗', 'error');
  }
}

/**
 * 關閉題目 Modal
 */
function closeQuestionModal() {
  document.getElementById('questionModal').classList.remove('active');
}


    async function loadAdminQuestionsByCourse() {
      const courseId = document.getElementById('adminQuestionCourseFilter').value;
      
      if (!courseId) {
        document.getElementById('adminQuestionsList').innerHTML = 
          '<tr><td colspan="4" class="text-center">請選擇課程</td></tr>';
        return;
      }

      const result = await callAPI('getQuestions', { courseId });

      if (result && result.success) {
        displayAdminQuestions(result.data);
      }
    }

    function displayAdminQuestions(questions) {
      const tbody = document.getElementById('adminQuestionsList');
      
      if (questions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">此課程尚無題目</td></tr>';
        return;
      }

      tbody.innerHTML = questions.map(q => `
        <tr>
          <td>${q.questionId}</td>
          <td>${q.questionText}</td>
          <td>${q.correctAnswer}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-primary" onclick="editQuestion('${q.questionId}')" title="編輯">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon btn-danger" onclick="deleteQuestion('${q.questionId}')" title="刪除">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function showAddQuestionModal() {
      const courseId = document.getElementById('adminQuestionCourseFilter').value;
      
      if (!courseId) {
        showAlert('請先選擇課程', 'warning');
        return;
      }

      document.getElementById('questionModalTitle').textContent = '新增題目';
      document.getElementById('questionForm').reset();
      document.getElementById('questionFormId').value = '';
      document.getElementById('questionFormCourse').value = courseId;
      document.getElementById('questionModal').classList.add('active');
    }

    async function editQuestion(questionId) {
      const result = await callAPI('getQuestionDetail', { questionId });

      if (result && result.success) {
        const q = result.data;
        
        document.getElementById('questionModalTitle').textContent = '編輯題目';
        document.getElementById('questionFormId').value = q.questionId;
        document.getElementById('questionFormCourse').value = q.courseId;
        document.getElementById('questionFormText').value = q.questionText;
        document.getElementById('questionFormOptionA').value = q.optionA;
        document.getElementById('questionFormOptionB').value = q.optionB;
        document.getElementById('questionFormOptionC').value = q.optionC;
        document.getElementById('questionFormOptionD').value = q.optionD;
        document.getElementById('questionFormAnswer').value = q.correctAnswer;
        
        document.getElementById('questionModal').classList.add('active');
      }
    }

    async function saveQuestion() {
      const questionId = document.getElementById('questionFormId').value;
      const questionData = {
        courseId: document.getElementById('questionFormCourse').value,
        questionText: document.getElementById('questionFormText').value,
        optionA: document.getElementById('questionFormOptionA').value,
        optionB: document.getElementById('questionFormOptionB').value,
        optionC: document.getElementById('questionFormOptionC').value,
        optionD: document.getElementById('questionFormOptionD').value,
        correctAnswer: document.getElementById('questionFormAnswer').value
      };

      const action = questionId ? 'updateQuestion' : 'createQuestion';
      const data = questionId ? { questionId, questionData } : { questionData };

      const result = await callAPI(action, data);

      if (result && result.success) {
        showAlert(questionId ? '題目更新成功' : '題目新增成功', 'success');
        closeQuestionModal();
        loadAdminQuestionsByCourse();
      } else {
        showAlert(result?.message || '操作失敗', 'error');
      }
    }

    async function deleteQuestion(questionId) {
      if (!confirm('確定要刪除此題目嗎?')) return;

      const result = await callAPI('deleteQuestion', { questionId });

      if (result && result.success) {
        showAlert('題目刪除成功', 'success');
        loadAdminQuestionsByCourse();
      } else {
        showAlert(result?.message || '刪除失敗', 'error');
      }
    }

    function closeQuestionModal() {
      document.getElementById('questionModal').classList.remove('active');
    }

    // ==================== 帳號管理 ==================== 
    async function loadAdminAccounts() {
      const result = await callAPI('getAllAccounts');

      if (result && result.success) {
        displayAdminAccounts(result.data);
      }
    }

    function displayAdminAccounts(accounts) {
      const tbody = document.getElementById('adminAccountsList');
      
      if (accounts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">尚無帳號</td></tr>';
        return;
      }

      tbody.innerHTML = accounts.map(acc => `
        <tr>
          <td>${acc.empId}</td>
          <td>${acc.name}</td>
          <td>${acc.department}</td>
          <td>${acc.email || '-'}</td>
          <td>${acc.permission}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-primary" onclick="editAccount('${acc.empId}')" title="編輯">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon btn-warning" onclick="resetPassword('${acc.empId}')" title="重設密碼">
                <i class="fas fa-key"></i>
              </button>
              <button class="btn-icon btn-danger" onclick="deleteAccount('${acc.empId}')" title="刪除">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function showAddAccountModal() {
      document.getElementById('accountModalTitle').textContent = '新增帳號';
      document.getElementById('accountForm').reset();
      document.getElementById('accountFormEmpId').readOnly = false;
      document.getElementById('accountModal').classList.add('active');
    }

    async function editAccount(empId) {
      const result = await callAPI('getAccountDetail', { empId });

      if (result && result.success) {
        const acc = result.data;
        
        document.getElementById('accountModalTitle').textContent = '編輯帳號';
        document.getElementById('accountFormEmpId').value = acc.empId;
        document.getElementById('accountFormEmpId').readOnly = true;
        document.getElementById('accountFormName').value = acc.name;
        document.getElementById('accountFormDept').value = acc.department;
        document.getElementById('accountFormPassword').value = '';
        document.getElementById('accountFormPassword').placeholder = '留空表示不修改';
        document.getElementById('accountFormEmail').value = acc.email || '';
        document.getElementById('accountFormPermission').value = acc.permission;
        
        document.getElementById('accountModal').classList.add('active');
      }
    }

    async function saveAccount() {
      const empId = document.getElementById('accountFormEmpId').value;
      const isEdit = document.getElementById('accountFormEmpId').readOnly;
      
      const accountData = {
        empId: empId,
        name: document.getElementById('accountFormName').value,
        department: document.getElementById('accountFormDept').value,
        password: document.getElementById('accountFormPassword').value,
        email: document.getElementById('accountFormEmail').value,
        permission: document.getElementById('accountFormPermission').value
      };

      const action = isEdit ? 'updateAccount' : 'createAccount';

      const result = await callAPI(action, accountData);

      if (result && result.success) {
        showAlert(isEdit ? '帳號更新成功' : '帳號新增成功', 'success');
        closeAccountModal();
        loadAdminAccounts();
      } else {
        showAlert(result?.message || '操作失敗', 'error');
      }
    }

    async function resetPassword(empId) {
      const newPassword = prompt('請輸入新密碼:');
      
      if (!newPassword) return;

      const result = await callAPI('resetPassword', { empId, newPassword });

      if (result && result.success) {
        showAlert('密碼重設成功', 'success');
      } else {
        showAlert(result?.message || '重設失敗', 'error');
      }
    }

    async function deleteAccount(empId) {
      if (!confirm('確定要刪除此帳號嗎?')) return;

      const result = await callAPI('deleteAccount', { empId });

      if (result && result.success) {
        showAlert('帳號刪除成功', 'success');
        loadAdminAccounts();
      } else {
        showAlert(result?.message || '刪除失敗', 'error');
      }
    }

    function closeAccountModal() {
      document.getElementById('accountModal').classList.remove('active');
    }

    // ==================== 學習紀錄管理 ==================== 
    async function loadAdminRecords() {
      const result = await callAPI('getAllLearningRecords');

      if (result && result.success) {
        displayAdminRecords(result.data);
      }
    }

    function displayAdminRecords(records) {
      const tbody = document.getElementById('adminRecordsList');
      
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">尚無學習紀錄</td></tr>';
        return;
      }

      tbody.innerHTML = records.map(record => `
        <tr>
          <td>${record.empId}</td>
          <td>${record.empName}</td>
          <td>${record.courseName}</td>
          <td>${record.startTime || '-'}</td>
          <td>${record.completeTime || '-'}</td>
          <td>${record.examScore !== null ? record.examScore + ' 分' : '-'}</td>
          <td>${record.earnedPoints || 0} 點</td>
        </tr>
      `).join('');
    }

    function exportRecords() {
      showAlert('匯出功能開發中...', 'info');
      // 可以實作匯出 CSV 或 Excel 功能
    }

    // ==================== 公告管理 ==================== 
    async function loadAdminAnnouncements() {
      const result = await callAPI('getAllAnnouncements');

      if (result && result.success) {
        displayAdminAnnouncements(result.data);
      }
    }

function displayAdminAnnouncements(announcements) {
  const tbody = document.getElementById('adminAnnouncementsList');
  
  if (announcements.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">尚無公告</td></tr>';
    return;
  }

  tbody.innerHTML = announcements.map(ann => {
    // ✅ 顯示格式化的對象（支援新格式）
    let targetDisplay = ann.targetDepts || '全公司';
    
    // 如果是新格式，解析後顯示
    if (targetDisplay.includes('部門:') || targetDisplay.includes('個人:')) {
      const parsed = parseTargetAudienceFrontend(targetDisplay);
      const parts = [];
      
      if (parsed.departments.length > 0) {
        parts.push('部門: ' + parsed.departments.join(', '));
      }
      if (parsed.individuals.length > 0) {
        parts.push('個人: ' + parsed.individuals.join(', '));
      }
      
      targetDisplay = parts.join(' | ') || '全公司';
    }
    
    return `
      <tr>
        <td>${ann.time}</td>
        <td>${ann.content}</td>
        <td>${targetDisplay}</td>
        <td>${ann.isPinned ? '是' : '否'}</td>
        <td>${ann.expiryDate || '無期限'}</td>
        <td>
          <div class="action-buttons">
            <button class="btn-icon btn-danger" onclick="deleteAnnouncement('${ann.time}')" title="刪除">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}


    function showAddAnnouncementModal() {
      document.getElementById('announcementForm').reset();
      document.getElementById('announcementModal').classList.add('active');
    }

async function saveAnnouncement() {
  // ✅ 解析部門和個人輸入
  const targetDeptsInput = document.getElementById('announcementFormTargetDepts').value.trim();
  const targetIndividualsInput = document.getElementById('announcementFormTargetIndividuals').value.trim();
  
  // ✅ 轉換為陣列
  const targetDepts = targetDeptsInput ? targetDeptsInput.split(',').map(d => d.trim()).filter(d => d) : [];
  const targetIndividuals = targetIndividualsInput ? targetIndividualsInput.split(',').map(i => i.trim()).filter(i => i) : [];
  
  const announcementData = {
    content: document.getElementById('announcementFormContent').value,
    targetDepts: targetDepts,              // ✅ 新增
    targetIndividuals: targetIndividuals,  // ✅ 新增
    isPinned: document.getElementById('announcementFormPinned').checked,
    expiryDate: document.getElementById('announcementFormExpiry').value
  };

  const result = await callAPI('createAnnouncement', announcementData);

  if (result && result.success) {
    showAlert('公告發布成功', 'success');
    closeAnnouncementModal();
    loadAdminAnnouncements();
  } else {
    showAlert(result?.message || '發布失敗', 'error');
  }
}


    async function deleteAnnouncement(announcementId) {
      if (!confirm('確定要刪除此公告嗎?')) return;

      const result = await callAPI('deleteAnnouncement', { announcementId });

      if (result && result.success) {
        showAlert('公告刪除成功', 'success');
        loadAdminAnnouncements();
      } else {
        showAlert(result?.message || '刪除失敗', 'error');
      }
    }

    function closeAnnouncementModal() {
      document.getElementById('announcementModal').classList.remove('active');
    }
    // ==================== 資料快取系統 ====================

/**
 * 快取管理器
 */
const CacheManager = {
  // 快取儲存
  cache: {},
  
  // 快取有效期（毫秒）
  expiry: {
    courses: 5 * 60 * 1000,      // 課程列表: 5 分鐘
    dashboard: 2 * 60 * 1000,    // 儀錶板: 2 分鐘
    charts: 5 * 60 * 1000,       // 圖表: 5 分鐘
    mylearning: 3 * 60 * 1000,   // 我的學習: 3 分鐘
    announcements: 10 * 60 * 1000 // 公告: 10 分鐘
  },
  
  /**
   * 設定快取
   */
  set: function(key, data) {
    console.log('💾 設定快取:', key);
    this.cache[key] = {
      data: data,
      timestamp: Date.now()
    };
  },
  
  /**
   * 取得快取
   */
  get: function(key, expiryTime) {
    const cached = this.cache[key];
    
    if (!cached) {
      console.log('⚠️ 快取不存在:', key);
      return null;
    }
    
    const now = Date.now();
    const age = now - cached.timestamp;
    
    if (age > expiryTime) {
      console.log('⚠️ 快取已過期:', key, '(', Math.round(age / 1000), '秒)');
      delete this.cache[key];
      return null;
    }
    
    console.log('✅ 使用快取:', key, '(剩餘', Math.round((expiryTime - age) / 1000), '秒)');
    return cached.data;
  },
  
  /**
   * 清除特定快取
   */
  clear: function(key) {
    console.log('🗑️ 清除快取:', key);
    delete this.cache[key];
  },
  
  /**
   * 清除所有快取
   */
  clearAll: function() {
    console.log('🗑️ 清除所有快取');
    this.cache = {};
  },
  
  /**
   * 取得快取狀態
   */
  getStatus: function() {
    const status = {};
    for (const key in this.cache) {
      const age = Date.now() - this.cache[key].timestamp;
      status[key] = {
        age: Math.round(age / 1000) + ' 秒',
        size: JSON.stringify(this.cache[key].data).length + ' bytes'
      };
    }
    return status;
  }
};

/**
 * 帶快取的 API 呼叫
 */
async function callAPIWithCache(action, data = {}, useCache = true) {
  console.log('=== callAPIWithCache ===');
  console.log('action:', action);
  console.log('useCache:', useCache);
  
  // 生成快取鍵
  const cacheKey = action + '_' + JSON.stringify(data);
  
  // 檢查快取
  if (useCache) {
    const expiryTime = CacheManager.expiry[action] || 5 * 60 * 1000;
    const cached = CacheManager.get(cacheKey, expiryTime);
    
    if (cached) {
      console.log('✅ 返回快取資料');
      return cached;
    }
  }
  
  // 呼叫 API
  console.log('📡 呼叫 API');
  const result = await callAPI(action, data);
  
  // 儲存快取
  if (result && result.success && useCache) {
    CacheManager.set(cacheKey, result);
  }
  
  return result;
}


    // ==================== 系統設定 ==================== 
    async function loadSystemSettings() {
      const result = await callAPI('getSystemSettings');

      if (result && result.success) {
        const settings = result.data;
        
        document.getElementById('settingQuestionCount').value = settings['測驗題數'] || 5;
        document.getElementById('settingPassScore').value = settings['測驗及格分數'] || 60;
        document.getElementById('settingReminderDays').value = settings['截止日提醒天數'] || 5;
        document.getElementById('settingSessionTimeout').value = settings['Session有效時間'] || 480;
      }
    }

    async function saveSystemSettings() {
      const settings = {
        '測驗題數': parseInt(document.getElementById('settingQuestionCount').value),
        '測驗及格分數': parseInt(document.getElementById('settingPassScore').value),
        '截止日提醒天數': parseInt(document.getElementById('settingReminderDays').value),
        'Session有效時間': parseInt(document.getElementById('settingSessionTimeout').value)
      };

      const result = await callAPI('updateSystemSettings', { settings });

      if (result && result.success) {
        showAlert('系統設定更新成功', 'success');
      } else {
        showAlert(result?.message || '更新失敗', 'error');
      }
    }
  // ==================== 修改密碼功能 ====================

/**
 * 顯示修改密碼 Modal
 */
function showChangePasswordModal() {
  console.log('=== showChangePasswordModal ===');
  
  // 重置表單
  document.getElementById('changePasswordForm').reset();
  
  // 隱藏密碼強度指示器
  document.getElementById('passwordStrength').style.display = 'none';
  
  // 顯示 Modal
  document.getElementById('changePasswordModal').classList.add('active');
  
  // 監聽新密碼輸入（顯示強度）
  const newPasswordInput = document.getElementById('newPassword');
  newPasswordInput.addEventListener('input', checkPasswordStrength);
}

/**
 * 關閉修改密碼 Modal
 */
function closeChangePasswordModal() {
  console.log('=== closeChangePasswordModal ===');
  
  // 移除事件監聽器
  const newPasswordInput = document.getElementById('newPassword');
  newPasswordInput.removeEventListener('input', checkPasswordStrength);
  
  // 關閉 Modal
  document.getElementById('changePasswordModal').classList.remove('active');
}

/**
 * 檢查密碼強度
 */
function checkPasswordStrength() {
  const password = document.getElementById('newPassword').value;
  const strengthDiv = document.getElementById('passwordStrength');
  const strengthText = document.getElementById('strengthText');
  
  if (password.length === 0) {
    strengthDiv.style.display = 'none';
    return;
  }
  
  let strength = 0;
  let text = '';
  let color = '';
  
  // 長度檢查
  if (password.length >= 6) strength++;
  if (password.length >= 8) strength++;
  if (password.length >= 12) strength++;
  
  // 複雜度檢查
  if (/[a-z]/.test(password)) strength++; // 小寫字母
  if (/[A-Z]/.test(password)) strength++; // 大寫字母
  if (/[0-9]/.test(password)) strength++; // 數字
  if (/[^a-zA-Z0-9]/.test(password)) strength++; // 特殊字元
  
  // 判斷強度
  if (strength <= 2) {
    text = '弱 ⚠️';
    color = '#ef4444';
  } else if (strength <= 4) {
    text = '中等 ⚡';
    color = '#f59e0b';
  } else if (strength <= 6) {
    text = '強 ✅';
    color = '#10b981';
  } else {
    text = '非常強 🔒';
    color = '#059669';
  }
  
  strengthDiv.style.display = 'block';
  strengthDiv.style.backgroundColor = color + '20';
  strengthDiv.style.borderLeft = '4px solid ' + color;
  strengthText.textContent = text;
  strengthText.style.color = color;
}

/**
 * 提交修改密碼
 */
async function submitChangePassword(event) {
  if (event) event.preventDefault();
  
  console.log('=== submitChangePassword ===');
  
  // 取得輸入值
  const currentPassword = document.getElementById('currentPassword').value.trim();
  const newPassword = document.getElementById('newPassword').value.trim();
  const confirmPassword = document.getElementById('confirmPassword').value.trim();
  
  // ✅ 前端驗證
  if (!currentPassword || !newPassword || !confirmPassword) {
    showAlert('請填寫所有欄位', 'warning');
    return;
  }
  
  if (newPassword.length < 6) {
    showAlert('新密碼長度至少 6 個字元', 'warning');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    showAlert('新密碼與確認密碼不一致', 'warning');
    return;
  }
  
  if (currentPassword === newPassword) {
    showAlert('新密碼不能與目前密碼相同', 'warning');
    return;
  }
  
  console.log('✅ 前端驗證通過');
  
  showLoading();
  
  try {
    // ✅ 呼叫後端 API
    const result = await callAPI('changePassword', {
      currentPassword: currentPassword,
      newPassword: newPassword
    });
    
    console.log('API 回應:', result);
    
    hideLoading();
    
    if (result && result.success) {
      console.log('✅ 密碼修改成功');
      showAlert('密碼修改成功！請重新登入', 'success');
      
      // 關閉 Modal
      closeChangePasswordModal();
      
      // 延遲 2 秒後登出
      setTimeout(() => {
        logout();
      }, 2000);
    } else {
      console.error('❌ 密碼修改失敗:', result?.message);
      showAlert(result?.message || '密碼修改失敗', 'error');
    }
  } catch (error) {
    console.error('❌ submitChangePassword 失敗:', error);
    hideLoading();
    showAlert('系統錯誤，請稍後再試', 'error');
  }
}


    // ==================== 工具函數 ==================== 
    function showLoading() {
      document.getElementById('loading').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('active');
    }

    function showAlert(message, type = 'info') {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert alert-${type} active`;
      
      setTimeout(() => {
        alert.classList.remove('active');
      }, 3000);
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // 關閉 Modal 的通用方法(點擊背景)
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
      }
    });

    /**
 * 重新整理儀錶板
 */
function refreshDashboard() {
  console.log('🔄 重新整理儀錶板');
  
  // 顯示載入動畫
  showLoading();
  
  // 清除所有快取
  CacheManager.clearAll();
  
  // 重新載入
  loadDashboard(true);
  
  // 隱藏載入動畫
  setTimeout(() => {
    hideLoading();
    showAlert('資料已更新', 'success');
  }, 1000);
}
    /**
 * 前端解析對象字串（支援新舊格式）
 * @param {string} targetString - 對象字串
 * @return {Object} - { departments: [], individuals: [] }
 */
function parseTargetAudienceFrontend(targetString) {
  if (!targetString || targetString.trim() === '') {
    return { departments: [], individuals: [] };
  }
  
  const result = { departments: [], individuals: [] };
  
  // ✅ 檢查是否為新格式
  if (targetString.includes('部門:') || targetString.includes('個人:')) {
    // 新格式: "部門:IT,HR;個人:E001,E002"
    const parts = targetString.split(';');
    
    parts.forEach(part => {
      part = part.trim();
      
      if (part.startsWith('部門:')) {
        const depts = part.substring(3).split(',').map(d => d.trim()).filter(d => d);
        result.departments = depts;
      } else if (part.startsWith('個人:')) {
        const individuals = part.substring(3).split(',').map(i => i.trim()).filter(i => i);
        result.individuals = individuals;
      }
    });
  } else {
    // 舊格式: "IT,HR,Finance" (視為部門)
    result.departments = targetString.split(',').map(d => d.trim()).filter(d => d);
  }
  
  return result;
}

    // ==================== 使用者下拉選單功能 ====================

/**
 * 切換下拉選單顯示/隱藏
 */
function toggleUserMenu(event) {
  event.stopPropagation(); // 防止事件冒泡
  
  const menu = document.getElementById('userDropdownMenu');
  
  if (menu.classList.contains('active')) {
    menu.classList.remove('active');
  } else {
    menu.classList.add('active');
  }
}

/**
 * 關閉下拉選單
 */
function closeUserMenu() {
  const menu = document.getElementById('userDropdownMenu');
  menu.classList.remove('active');
}

/**
 * 點擊頁面其他地方時關閉選單
 */
document.addEventListener('click', function(event) {
  const menu = document.getElementById('userDropdownMenu');
  const container = document.querySelector('.user-menu-container');
  
  // 如果點擊的不是選單或按鈕，則關閉選單
  if (menu && container && !container.contains(event.target)) {
    menu.classList.remove('active');
  }
});


  </script>
</body>
</html>
